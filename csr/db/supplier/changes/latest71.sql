-- Please update version.sql too -- this keeps clean builds in sync
define version=71

--update version set db_version=70;
/

@update_header

/*
DROP TABLE DOMAIN_BLACKLIST;
DROP TABLE DOMAIN_LOOKUP;

DROP TABLE INVITE_QUESTIONNAIRE;
DROP TABLE INVITE;

DROP TABLE INVITE_STATUS;

DROP TABLE REQUEST_BY_USER;
DROP TABLE REQUEST_TO_USER;
DROP TABLE SUPPLIER_QUESTIONNAIRE_REQUEST;
DROP TABLE REQUEST_VISIBILITY_STATUS;

DROP TABLE ALL_PROCURER_SUPPLIER;
DROP TABLE CONTACT_SHORTLIST;
DROP TABLE CURRENCY;
DROP TABLE SUPPLIER_QUESTIONNAIRE_GROUP;
DROP TABLE QUESTIONNAIRE_GROUP_SUPPLIER;
*/

CREATE TABLE QUESTIONNAIRE_GROUP_SUPPLIER(
    GROUP_ID            NUMBER(10, 0)     NOT NULL,
    NAME                VARCHAR2(1024)    NOT NULL,
    APP_SID             NUMBER(10, 0)     NOT NULL,
    WORKFLOW_TYPE_ID    NUMBER(10, 0)     NOT NULL,
    URL                 VARCHAR2(1024)    NOT NULL,
    CONSTRAINT PK180 PRIMARY KEY (GROUP_ID)
)
;

CREATE TABLE ALL_PROCURER_SUPPLIER(
    PROCURER_COMPANY_SID    NUMBER(10, 0)    NOT NULL,
    SUPPLIER_COMPANY_SID    NUMBER(10, 0)    NOT NULL,
    CONSTRAINT PK155 PRIMARY KEY (PROCURER_COMPANY_SID, SUPPLIER_COMPANY_SID)
)
;

CREATE TABLE CONTACT_SHORTLIST(
    CONTACT_ID                NUMBER(10, 0)    NOT NULL,
    CONTACT_NAME              VARCHAR2(255)    NOT NULL,
    CONTACT_EMAIL             VARCHAR2(255)    NOT NULL,
    JOB_TITLE                 VARCHAR2(255),
    PHONE                     VARCHAR2(255),
    SUPPLIER_NAME             VARCHAR2(255),
    SUPPLIER_COMPANY_SID      NUMBER(10, 0),
    ESTIMATED_ANNUAL_SPEND    NUMBER(10, 0)    NOT NULL,
    CURRENCY_ID               NUMBER(10, 0),
    PROCURER_USER_SID         NUMBER(10, 0)    NOT NULL,
    APP_SID                   NUMBER(10, 0)    NOT NULL,
    CONTACT_GUID                      CHAR(36)         NOT NULL,
    CONSTRAINT PK_CONTACT_SHORTLIST PRIMARY KEY (CONTACT_ID)
)
;

CREATE TABLE CURRENCY(
    CURRENCY_ID     NUMBER(10, 0)    NOT NULL,
    DESCRIPTION     VARCHAR2(255),
    ABBREVIATION    VARCHAR2(10)     NOT NULL,
    CONSTRAINT PK172 PRIMARY KEY (CURRENCY_ID),
    CONSTRAINT UNIQUE_ABBR  UNIQUE (ABBREVIATION)
)
;

CREATE TABLE DOMAIN_BLACKLIST(
    APP_SID    NUMBER(10, 0)     NOT NULL,
    DOMAIN     VARCHAR2(1024)    NOT NULL,
    CONSTRAINT PK147 PRIMARY KEY (APP_SID, DOMAIN)
)
;

CREATE TABLE DOMAIN_LOOKUP(
    APP_SID        NUMBER(10, 0)    NOT NULL,
    DOMAIN         VARCHAR2(256)    NOT NULL,
    COMPANY_SID    NUMBER(10, 0)    NOT NULL,
    CONSTRAINT PK182 PRIMARY KEY (APP_SID, DOMAIN)
)
;

CREATE TABLE INVITE(
    INVITE_ID           NUMBER(10, 0)     NOT NULL,
    CONTACT_ID          NUMBER(10, 0),
    SENT_BY_SID         NUMBER(10, 0)     NOT NULL,
    STATUS_NOTE         VARCHAR2(1024),
    STATUS_DTM          DATE,
    INVITE_STATUS_ID    NUMBER(10, 0)     NOT NULL,
    CONSTRAINT PK8 PRIMARY KEY (INVITE_ID)
)
;

CREATE TABLE INVITE_QUESTIONNAIRE(
    INVITE_ID    NUMBER(10, 0)    NOT NULL,
    GROUP_ID     NUMBER(10, 0)    NOT NULL,
    DUE_DTM      DATE,
    CONSTRAINT PK13 PRIMARY KEY (INVITE_ID, GROUP_ID)
)
;


CREATE TABLE INVITE_STATUS(
    INVITE_STATUS_ID    NUMBER(10, 0)    NOT NULL,
    DESCRIPTION         VARCHAR2(256)    NOT NULL,
    CONSTRAINT PK154 PRIMARY KEY (INVITE_STATUS_ID)
)
;

CREATE TABLE REQUEST_BY_USER(
    PROCURER_COMPANY_SID      NUMBER(10, 0)    NOT NULL,
    SUPPLIER_COMPANY_SID      NUMBER(10, 0)    NOT NULL,
    CSR_USER_SID              NUMBER(10, 0)    NOT NULL,
    REQUEST_DTM               DATE,
    QUESTIONNAIRE_GROUP_ID    NUMBER(10, 0)    NOT NULL,
    CONSTRAINT PK161 PRIMARY KEY (PROCURER_COMPANY_SID, SUPPLIER_COMPANY_SID, CSR_USER_SID, QUESTIONNAIRE_GROUP_ID)
)
;

CREATE TABLE REQUEST_TO_USER(
    PROCURER_COMPANY_SID      NUMBER(10, 0)    NOT NULL,
    SUPPLIER_COMPANY_SID      NUMBER(10, 0)    NOT NULL,
    CSR_USER_SID              NUMBER(10, 0)    NOT NULL,
    REQUEST_DTM               DATE,
    QUESTIONNAIRE_GROUP_ID    NUMBER(10, 0)    NOT NULL,
    CONSTRAINT PK158 PRIMARY KEY (PROCURER_COMPANY_SID, SUPPLIER_COMPANY_SID, CSR_USER_SID, QUESTIONNAIRE_GROUP_ID)
)
;

CREATE TABLE REQUEST_VISIBILITY_STATUS(
    VISIBILITY_STATUS_ID    NUMBER(10, 0)    NOT NULL,
    DESCRIPTION             VARCHAR2(255)    NOT NULL,
    CONSTRAINT PK159 PRIMARY KEY (VISIBILITY_STATUS_ID)
)
;

CREATE TABLE SUPPLIER_QUESTIONNAIRE_REQUEST(
    PROCURER_COMPANY_SID      NUMBER(10, 0)    NOT NULL,
    SUPPLIER_COMPANY_SID      NUMBER(10, 0)    NOT NULL,
    QUESTIONNAIRE_GROUP_ID    NUMBER(10, 0)    NOT NULL,
    VISIBILITY_STATUS_ID      NUMBER(10, 0)    NOT NULL,
    DUE_DTM                   DATE,
    CONSTRAINT PK157 PRIMARY KEY (PROCURER_COMPANY_SID, SUPPLIER_COMPANY_SID, QUESTIONNAIRE_GROUP_ID)
)
;


CREATE TABLE SUPPLIER_QUESTIONNAIRE_GROUP(
    COMPANY_SID                NUMBER(10, 0)    NOT NULL,
    GROUP_ID                   NUMBER(10, 0)    NOT NULL,
    GROUP_STATUS_ID            NUMBER(10, 0)    NOT NULL,
    DECLARATION_MADE_BY_SID    NUMBER(10, 0),
    STATUS_CHANGED_DTM         DATE,
    CONSTRAINT PK175 PRIMARY KEY (COMPANY_SID, GROUP_ID)
)
;


ALTER TABLE ALL_PROCURER_SUPPLIER ADD CONSTRAINT RefALL_COMPANY506 
    FOREIGN KEY (SUPPLIER_COMPANY_SID)
    REFERENCES ALL_COMPANY(COMPANY_SID)
;

ALTER TABLE ALL_PROCURER_SUPPLIER ADD CONSTRAINT RefALL_COMPANY507 
    FOREIGN KEY (PROCURER_COMPANY_SID)
    REFERENCES ALL_COMPANY(COMPANY_SID)
;

ALTER TABLE CONTACT_SHORTLIST ADD CONSTRAINT RefALL_COMPANY526 
    FOREIGN KEY (SUPPLIER_COMPANY_SID)
    REFERENCES ALL_COMPANY(COMPANY_SID)
;





ALTER TABLE INVITE ADD CONSTRAINT RefINVITE_STATUS510 
    FOREIGN KEY (INVITE_STATUS_ID)
    REFERENCES INVITE_STATUS(INVITE_STATUS_ID)
;

ALTER TABLE INVITE ADD CONSTRAINT RefCONTACT_SHORTLIST511 
    FOREIGN KEY (CONTACT_ID)
    REFERENCES CONTACT_SHORTLIST(CONTACT_ID)
;

ALTER TABLE INVITE_QUESTIONNAIRE ADD CONSTRAINT RefQUESTIONNAIRE_GROUP_SUPP547 
    FOREIGN KEY (GROUP_ID)
    REFERENCES QUESTIONNAIRE_GROUP_SUPPLIER(GROUP_ID)
;


ALTER TABLE INVITE_QUESTIONNAIRE ADD CONSTRAINT RefINVITE513 
    FOREIGN KEY (INVITE_ID)
    REFERENCES INVITE(INVITE_ID)
;



ALTER TABLE REQUEST_BY_USER ADD CONSTRAINT RefCOMPANY_USER514 
    FOREIGN KEY (CSR_USER_SID)
    REFERENCES COMPANY_USER(CSR_USER_SID)
;

ALTER TABLE REQUEST_BY_USER ADD CONSTRAINT RefSUPPLIER_QUESTIONNAIRE_R515 
    FOREIGN KEY (PROCURER_COMPANY_SID, SUPPLIER_COMPANY_SID, QUESTIONNAIRE_GROUP_ID)
    REFERENCES SUPPLIER_QUESTIONNAIRE_REQUEST(PROCURER_COMPANY_SID, SUPPLIER_COMPANY_SID, QUESTIONNAIRE_GROUP_ID)
;

ALTER TABLE REQUEST_TO_USER ADD CONSTRAINT RefCOMPANY_USER516 
    FOREIGN KEY (CSR_USER_SID)
    REFERENCES COMPANY_USER(CSR_USER_SID)
;

ALTER TABLE REQUEST_TO_USER ADD CONSTRAINT RefSUPPLIER_QUESTIONNAIRE_R517 
    FOREIGN KEY (PROCURER_COMPANY_SID, SUPPLIER_COMPANY_SID, QUESTIONNAIRE_GROUP_ID)
    REFERENCES SUPPLIER_QUESTIONNAIRE_REQUEST(PROCURER_COMPANY_SID, SUPPLIER_COMPANY_SID, QUESTIONNAIRE_GROUP_ID)
;

ALTER TABLE SUPPLIER_QUESTIONNAIRE_REQUEST ADD CONSTRAINT RefQUESTIONNAIRE_GROUP_SUPP551 
    FOREIGN KEY (QUESTIONNAIRE_GROUP_ID)
    REFERENCES QUESTIONNAIRE_GROUP_SUPPLIER(GROUP_ID)
;

ALTER TABLE SUPPLIER_QUESTIONNAIRE_REQUEST ADD CONSTRAINT RefREQUEST_VISIBILITY_STATU519 
    FOREIGN KEY (VISIBILITY_STATUS_ID)
    REFERENCES REQUEST_VISIBILITY_STATUS(VISIBILITY_STATUS_ID)
;

ALTER TABLE SUPPLIER_QUESTIONNAIRE_REQUEST ADD CONSTRAINT RefALL_PROCURER_SUPPLIER520 
    FOREIGN KEY (PROCURER_COMPANY_SID, SUPPLIER_COMPANY_SID)
    REFERENCES ALL_PROCURER_SUPPLIER(PROCURER_COMPANY_SID, SUPPLIER_COMPANY_SID)
;

ALTER TABLE CONTACT_SHORTLIST ADD CONSTRAINT RefCURRENCY522 
    FOREIGN KEY (CURRENCY_ID)
    REFERENCES CURRENCY(CURRENCY_ID)
;


ALTER TABLE CONTACT_SHORTLIST ADD CONSTRAINT RefCUSTOMER_OPTIONS528 
    FOREIGN KEY (APP_SID)
    REFERENCES CUSTOMER_OPTIONS(APP_SID)
;

ALTER TABLE SUPPLIER_QUESTIONNAIRE_GROUP ADD CONSTRAINT RefQUESTIONNAIRE_GROUP_SUPP550 
    FOREIGN KEY (GROUP_ID)
    REFERENCES QUESTIONNAIRE_GROUP_SUPPLIER(GROUP_ID)
;

ALTER TABLE SUPPLIER_QUESTIONNAIRE_GROUP ADD CONSTRAINT RefGROUP_STATUS536 
    FOREIGN KEY (GROUP_STATUS_ID)
    REFERENCES GROUP_STATUS(GROUP_STATUS_ID)
;

ALTER TABLE SUPPLIER_QUESTIONNAIRE_GROUP ADD CONSTRAINT RefALL_COMPANY537 
    FOREIGN KEY (COMPANY_SID)
    REFERENCES ALL_COMPANY(COMPANY_SID)
;


ALTER TABLE QUESTIONNAIRE_GROUP_SUPPLIER ADD CONSTRAINT RefWORKFLOW_TYPE548 
    FOREIGN KEY (WORKFLOW_TYPE_ID)
    REFERENCES WORKFLOW_TYPE(WORKFLOW_TYPE_ID)
;

ALTER TABLE QUESTIONNAIRE_GROUP_SUPPLIER ADD CONSTRAINT RefCUSTOMER_OPTIONS549 
    FOREIGN KEY (APP_SID)
    REFERENCES CUSTOMER_OPTIONS(APP_SID)
;

ALTER TABLE DOMAIN_BLACKLIST ADD CONSTRAINT RefCUSTOMER_OPTIONS555 
    FOREIGN KEY (APP_SID)
    REFERENCES CUSTOMER_OPTIONS(APP_SID)
;

ALTER TABLE DOMAIN_LOOKUP ADD CONSTRAINT RefCUSTOMER_OPTIONS556 
    FOREIGN KEY (APP_SID)
    REFERENCES CUSTOMER_OPTIONS(APP_SID)
;

ALTER TABLE DOMAIN_LOOKUP ADD CONSTRAINT RefALL_COMPANY557 
    FOREIGN KEY (COMPANY_SID)
    REFERENCES ALL_COMPANY(COMPANY_SID)
;



CREATE SEQUENCE CONTACT_ID_SEQ
    START WITH 1
    INCREMENT BY 1
    NOMINVALUE
    NOMAXVALUE
    CACHE 20
    NOORDER
;


CREATE SEQUENCE INVITE_ID_SEQ
    START WITH 1
    INCREMENT BY 1
    NOMINVALUE
    NOMAXVALUE
    CACHE 20
    NOORDER
;


    INSERT INTO currency (currency_id, description, abbreviation) VALUES (1, 'US Dollars', 'USD');
    INSERT INTO currency (currency_id, description, abbreviation) VALUES (2, 'Euros', 'Eur');
    INSERT INTO currency (currency_id, description, abbreviation) VALUES (3, 'British Sterling', 'GBP');
    
	INSERT INTO invite_status (invite_status_id, description) VALUES (1, 'Pending');
	INSERT INTO invite_status (invite_status_id, description) VALUES (2, 'Accepted');
	INSERT INTO invite_status (invite_status_id, description) VALUES (3, 'Rejected - not a supplier');
	INSERT INTO invite_status (invite_status_id, description) VALUES (4, 'Rejected - refused');
	
	INSERT INTO workflow_type (workflow_type_id, description) VALUES (3 , 'Invite Supplier Workflow');
	
	INSERT INTO REQUEST_VISIBILITY_STATUS (VISIBILITY_STATUS_ID, DESCRIPTION) VALUES (1, 'Shared');
	INSERT INTO REQUEST_VISIBILITY_STATUS (VISIBILITY_STATUS_ID, DESCRIPTION) VALUES (2, 'Private');

@update_tail
