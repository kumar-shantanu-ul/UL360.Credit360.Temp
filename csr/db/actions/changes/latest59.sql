-- Please update version.sql too -- this keeps clean builds in sync
define version=59
@update_header

ALTER TABLE FILE_UPLOAD_GROUP RENAME TO OLD_FILE_UPLOAD_GROUP;
CREATE TABLE FILE_UPLOAD_GROUP(
    APP_SID                 NUMBER(10, 0)     DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    FILE_UPLOAD_GROUP_ID    NUMBER(10, 0)     NOT NULL,
    NAME                    VARCHAR2(256)     NOT NULL,
    LABEL                   VARCHAR2(1024)    NOT NULL,
    CONSTRAINT PK_FILE_UPLOAD_GROUP PRIMARY KEY (APP_SID, FILE_UPLOAD_GROUP_ID)
    USING INDEX
TABLESPACE INDX
)
;
INSERT INTO  FILE_UPLOAD_GROUP (APP_SID, FILE_UPLOAD_GROUP_ID, NAME, LABEL)
	SELECT APP_SID, FILE_UPLOAD_GROUP_ID, NAME, LABEL
	  FROM OLD_FILE_UPLOAD_GROUP;
DROP TABLE OLD_FILE_UPLOAD_GROUP CASCADE CONSTRAINTS;
ALTER TABLE FILE_UPLOAD_GROUP ADD CONSTRAINT RefCUSTOMER190 
    FOREIGN KEY (APP_SID)
    REFERENCES CSR.CUSTOMER(APP_SID)
;
ALTER TABLE FILE_UPLOAD_GROUP_MEMBER ADD CONSTRAINT RefFILE_UPLOAD_GROUP186 
    FOREIGN KEY (APP_SID, FILE_UPLOAD_GROUP_ID)
    REFERENCES FILE_UPLOAD_GROUP(APP_SID, FILE_UPLOAD_GROUP_ID)
;
ALTER TABLE PROJECT_FILE_UPLOAD_GROUP ADD CONSTRAINT RefFILE_UPLOAD_GROUP188 
    FOREIGN KEY (APP_SID, FILE_UPLOAD_GROUP_ID)
    REFERENCES FILE_UPLOAD_GROUP(APP_SID, FILE_UPLOAD_GROUP_ID)
;


ALTER TABLE  FILE_UPLOAD_GROUP_MEMBER RENAME TO OLD_FILE_UPLOAD_GROUP_MEMB;
CREATE TABLE FILE_UPLOAD_GROUP_MEMBER(
    APP_SID                 NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    FILE_UPLOAD_GROUP_ID    NUMBER(10, 0)    NOT NULL,
    FILE_ID                 NUMBER(10, 0)    NOT NULL,
    CONSTRAINT PK_FILE_UPLOAD_GROUP_MEMBER PRIMARY KEY (APP_SID, FILE_UPLOAD_GROUP_ID, FILE_ID)
    USING INDEX
TABLESPACE INDX
)
;
INSERT INTO FILE_UPLOAD_GROUP_MEMBER (APP_SID, FILE_UPLOAD_GROUP_ID, FILE_ID)
	SELECT APP_SID, FILE_UPLOAD_GROUP_ID, FILE_ID
	  FROM OLD_FILE_UPLOAD_GROUP_MEMB;
DROP TABLE OLD_FILE_UPLOAD_GROUP_MEMB CASCADE CONSTRAINTS;
ALTER TABLE FILE_UPLOAD_GROUP_MEMBER ADD CONSTRAINT RefFILE_UPLOAD185 
    FOREIGN KEY (APP_SID, FILE_ID)
    REFERENCES FILE_UPLOAD(APP_SID, FILE_ID)
;

ALTER TABLE FILE_UPLOAD_GROUP_MEMBER ADD CONSTRAINT RefFILE_UPLOAD_GROUP186 
    FOREIGN KEY (APP_SID, FILE_UPLOAD_GROUP_ID)
    REFERENCES FILE_UPLOAD_GROUP(APP_SID, FILE_UPLOAD_GROUP_ID)
;


ALTER TABLE PROJECT_FILE_UPLOAD_GROUP RENAME TO OLD_PROJ_FUG;
CREATE TABLE PROJECT_FILE_UPLOAD_GROUP(
    APP_SID                 NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    FILE_UPLOAD_GROUP_ID    NUMBER(10, 0)    NOT NULL,
    PROJECT_SID             NUMBER(10, 0)    NOT NULL,
    CONSTRAINT PK_PROJECT_FILE_UPLOAD_GROUP PRIMARY KEY (APP_SID, FILE_UPLOAD_GROUP_ID, PROJECT_SID)
    USING INDEX
TABLESPACE INDX
)
;
INSERT INTO PROJECT_FILE_UPLOAD_GROUP (APP_SID, FILE_UPLOAD_GROUP_ID, PROJECT_SID)
	SELECT APP_SID, FILE_UPLOAD_GROUP_ID, PROJECT_SID
	  FROM OLD_PROJ_FUG;
DROP TABLE OLD_PROJ_FUG;
ALTER TABLE PROJECT_FILE_UPLOAD_GROUP ADD CONSTRAINT RefPROJECT187 
    FOREIGN KEY (APP_SID, PROJECT_SID)
    REFERENCES PROJECT(APP_SID, PROJECT_SID)
;

ALTER TABLE PROJECT_FILE_UPLOAD_GROUP ADD CONSTRAINT RefFILE_UPLOAD_GROUP188 
    FOREIGN KEY (APP_SID, FILE_UPLOAD_GROUP_ID)
    REFERENCES FILE_UPLOAD_GROUP(APP_SID, FILE_UPLOAD_GROUP_ID)
;

 
-- 
-- TABLE: RECKONER_TAG 
--

CREATE TABLE RECKONER_TAG(
    APP_SID         NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    PROJECT_SID     NUMBER(10, 0)    NOT NULL,
    TAG_GROUP_ID    NUMBER(10, 0)    NOT NULL,
    TAG_ID          NUMBER(10, 0)    NOT NULL,
    RECKONER_ID     NUMBER(10, 0)    NOT NULL,
    CONSTRAINT PK_RECKONER_TAG PRIMARY KEY (APP_SID, PROJECT_SID, TAG_GROUP_ID, TAG_ID, RECKONER_ID)
    USING INDEX
TABLESPACE INDX
)
;

-- 
-- TABLE: RECKONER_TAG_GROUP 
--

CREATE TABLE RECKONER_TAG_GROUP(
    APP_SID         NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    PROJECT_SID     NUMBER(10, 0)    NOT NULL,
    TAG_GROUP_ID    NUMBER(10, 0)    NOT NULL,
    CONSTRAINT PK_RECKONER_TAG_GROUP PRIMARY KEY (APP_SID, PROJECT_SID, TAG_GROUP_ID)
    USING INDEX
TABLESPACE INDX
)
;
INSERT INTO RECKONER_TAG_GROUP (APP_SID, PROJECT_SID, TAG_GROUP_ID)
	SELECT APP_SID, PROJECT_SID, TAG_GROUP_ID
	  FROM RECKONER_SCOPE
  GROUP BY APP_SID, PROJECT_SID, TAG_GROUP_ID;
	 
	INSERT INTO RECKONER_TAG (APP_SID, PROJECT_SID, TAG_GROUP_ID, TAG_ID, RECKONER_ID)
		SELECT APP_SID, PROJECT_SID, TAG_GROUP_ID, TAG_ID, RECKONER_ID
		  FROM RECKONER_SCOPE;
		  
DROP TABLE RECKONER_SCOPE;

ALTER TABLE RECKONER_TAG ADD CONSTRAINT RefTAG_GROUP_MEMBER218 
    FOREIGN KEY (APP_SID, TAG_GROUP_ID, TAG_ID)
    REFERENCES TAG_GROUP_MEMBER(APP_SID, TAG_GROUP_ID, TAG_ID)
;

ALTER TABLE RECKONER_TAG ADD CONSTRAINT RefRECKONER_TAG_GROUP219 
    FOREIGN KEY (APP_SID, PROJECT_SID, TAG_GROUP_ID)
    REFERENCES RECKONER_TAG_GROUP(APP_SID, PROJECT_SID, TAG_GROUP_ID)
;

ALTER TABLE RECKONER_TAG ADD CONSTRAINT RefRECKONER220 
    FOREIGN KEY (RECKONER_ID)
    REFERENCES RECKONER(RECKONER_ID)
;


-- 
-- TABLE: RECKONER_TAG_GROUP 
--

ALTER TABLE RECKONER_TAG_GROUP ADD CONSTRAINT RefPROJECT_TAG_GROUP217 
    FOREIGN KEY (APP_SID, TAG_GROUP_ID, PROJECT_SID)
    REFERENCES PROJECT_TAG_GROUP(APP_SID, TAG_GROUP_ID, PROJECT_SID)
;

@..\reckoner_pkg
@..\reckoner_body
@..\rls
 
@update_tail
