-- Please update version.sql too -- this keeps clean builds in sync
define version=3139
define minor_version=36
@update_header

-- *** DDL ***
-- Create tables

CREATE SEQUENCE CSR.ISSUE_TEMPLATE_ID_SEQ;

CREATE TABLE CSR.ISSUE_TEMPLATE (
	APP_SID							NUMBER(10)		DEFAULT SYS_CONTEXT('SECURITY', 'APP') NOT NULL,
	ISSUE_TEMPLATE_ID				NUMBER(10)		NOT NULL,
	ISSUE_TYPE_ID					NUMBER(10)		NOT NULL,
	LABEL							VARCHAR2(2048)	NOT NULL,
	DESCRIPTION						CLOB			NULL,
	ASSIGN_TO_USER_SID				NUMBER(10)		NULL,
	DUE_DTM							DATE			NULL,
	DUE_DTM_RELATIVE				NUMBER(10)		NULL,
	DUE_DTM_RELATIVE_UNIT			VARCHAR2(1)		NULL,
	IS_URGENT						NUMBER(1)		NULL,
	IS_CRITICAL						NUMBER(1)		NULL,
	CONSTRAINT PK_ISSUE_TEMPLATE PRIMARY KEY (APP_SID, ISSUE_TEMPLATE_ID),
	CONSTRAINT CHK_IT_IS_URGENT CHECK (IS_URGENT IN (0, 1)),
	CONSTRAINT CHK_IT_IS_CRITICAL CHECK (IS_CRITICAL IN (0, 1)),
	CONSTRAINT CHK_IT_DUE_DTM CHECK((DUE_DTM_RELATIVE IS NULL AND DUE_DTM_RELATIVE_UNIT IS NULL) OR (DUE_DTM_RELATIVE IS NOT NULL AND DUE_DTM_RELATIVE_UNIT IS NOT NULL)),
	CONSTRAINT CHK_IT_DUE_DTM_REL_UNIT CHECK(DUE_DTM_RELATIVE_UNIT IN ('d','m'))
);

create index csr.ix_issue_templat_assign_to_use on csr.issue_template (app_sid, assign_to_user_sid);
create index csr.ix_issue_templat_issue_type_id on csr.issue_template (app_sid, issue_type_id);

CREATE TABLE CSR.ISSUE_TEMPLATE_CUSTOM_FIELD (
	APP_SID							NUMBER(10, 0)	DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
	ISSUE_TEMPLATE_ID				NUMBER(10, 0)	NOT NULL,
	ISSUE_CUSTOM_FIELD_ID			NUMBER(10, 0)	NOT NULL,
	STRING_VALUE					VARCHAR2(255)	NULL,
	DATE_VALUE						DATE			NULL,
	CONSTRAINT PK_ISSUE_TEMP_CUST_FIELD PRIMARY KEY (APP_SID, ISSUE_TEMPLATE_ID, ISSUE_CUSTOM_FIELD_ID)
);

create index csr.ix_itcf_cust_fld_id on csr.issue_template_custom_field (app_sid, issue_custom_field_id);


CREATE TABLE CSR.ISSUE_TEMPLATE_CUST_FIELD_OPT (
	APP_SID							NUMBER(10, 0)	DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
	ISSUE_TEMPLATE_ID				NUMBER(10, 0)	NOT NULL,
	ISSUE_CUSTOM_FIELD_ID			NUMBER(10, 0)	NOT NULL,
	ISSUE_CUSTOM_FIELD_OPT_ID		NUMBER(10, 0)	NOT NULL,
	CONSTRAINT PK_ISSUE_TEMP_CUST_FIELD_OPT PRIMARY KEY (APP_SID, ISSUE_TEMPLATE_ID, ISSUE_CUSTOM_FIELD_ID, ISSUE_CUSTOM_FIELD_OPT_ID)
);

create index csr.ix_itcfo_opt_id on csr.issue_template_cust_field_opt (app_sid, issue_custom_field_id, issue_custom_field_opt_id);

-- CSRIMP

CREATE TABLE CSRIMP.ISSUE_TEMPLATE (
	CSRIMP_SESSION_ID NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	ISSUE_TEMPLATE_ID NUMBER(10,0) NOT NULL,
	ASSIGN_TO_USER_SID NUMBER(10,0),
	DESCRIPTION CLOB,
	DUE_DTM DATE,
	DUE_DTM_RELATIVE NUMBER(10,0),
	DUE_DTM_RELATIVE_UNIT VARCHAR2(1),
	ISSUE_TYPE_ID NUMBER(10,0) NOT NULL,
	IS_CRITICAL NUMBER(1,0),
	IS_URGENT NUMBER(1,0),
	LABEL VARCHAR2(2048) NOT NULL,
	CONSTRAINT PK_ISSUE_TEMPLATE PRIMARY KEY (CSRIMP_SESSION_ID, ISSUE_TEMPLATE_ID),
	CONSTRAINT FK_ISSUE_TEMPLATE_IS FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.ISSUE_TEMPLATE_CUSTOM_FIELD (
	CSRIMP_SESSION_ID NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	ISSUE_TEMPLATE_ID NUMBER(10,0) NOT NULL,
	ISSUE_CUSTOM_FIELD_ID NUMBER(10,0) NOT NULL,
	DATE_VALUE DATE,
	STRING_VALUE VARCHAR2(255),
	CONSTRAINT PK_ISSUE_TEMPLATE_CUSTOM_FIELD PRIMARY KEY (CSRIMP_SESSION_ID, ISSUE_TEMPLATE_ID, ISSUE_CUSTOM_FIELD_ID),
	CONSTRAINT FK_ISSUE_TEMPL_CUSTOM_FIELD_IS FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.ISSUE_TEMPLATE_CUST_FIELD_OPT (
	CSRIMP_SESSION_ID NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	ISSUE_TEMPLATE_ID NUMBER(10,0) NOT NULL,
	ISSUE_CUSTOM_FIELD_ID NUMBER(10,0) NOT NULL,
	ISSUE_CUSTOM_FIELD_OPT_ID NUMBER(10,0) NOT NULL,
	CONSTRAINT PK_ISSUE_TEMPLATE_CUST_FLD_OPT PRIMARY KEY (CSRIMP_SESSION_ID, ISSUE_TEMPLATE_ID, ISSUE_CUSTOM_FIELD_ID, ISSUE_CUSTOM_FIELD_OPT_ID),
	CONSTRAINT FK_ISSU_TEMP_CUST_FIELD_OPT_IS FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.MAP_ISSUE_TEMPLATE (
	CSRIMP_SESSION_ID NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	OLD_ISSUE_TEMPLATE_ID NUMBER(10) NOT NULL,
	NEW_ISSUE_TEMPLATE_ID NUMBER(10) NOT NULL,
	CONSTRAINT PK_MAP_ISSUE_TEMPLATE PRIMARY KEY (CSRIMP_SESSION_ID, OLD_ISSUE_TEMPLATE_ID) USING INDEX,
	CONSTRAINT UK_MAP_ISSUE_TEMPLATE UNIQUE (CSRIMP_SESSION_ID, NEW_ISSUE_TEMPLATE_ID) USING INDEX,
	CONSTRAINT FK_MAP_ISSUE_TEMPLATE_IS FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

-- Alter tables

ALTER TABLE CSR.QUICK_SURVEY_EXPR_ACTION DROP CONSTRAINT CHK_QS_EXPR_ACTION_TYPE_FK;

ALTER TABLE CSR.QUICK_SURVEY_EXPR_ACTION ADD (
	ISSUE_TEMPLATE_ID				NUMBER(10, 0) NULL
);

create index csr.ix_quick_survey_ex_iss_temp on csr.quick_survey_expr_action (app_sid, issue_template_id);

ALTER TABLE CSRIMP.QUICK_SURVEY_EXPR_ACTION ADD (
	ISSUE_TEMPLATE_ID				NUMBER(10, 0) NULL
);

ALTER TABLE CSR.QUICK_SURVEY_EXPR_ACTION ADD CONSTRAINT CHK_QS_EXPR_ACTION_TYPE_FK 
CHECK (
	(ACTION_TYPE = 'nc' AND QS_EXPR_NON_COMPL_ACTION_ID IS NOT NULL
	  AND QS_EXPR_MSG_ACTION_ID IS NULL AND SHOW_QUESTION_ID IS NULL
	  AND MANDATORY_QUESTION_ID IS NULL AND SHOW_PAGE_ID IS NULL
	  AND ISSUE_TEMPLATE_ID IS NULL)
	OR
	(ACTION_TYPE = 'msg' AND QS_EXPR_NON_COMPL_ACTION_ID IS NULL
	  AND QS_EXPR_MSG_ACTION_ID IS NOT NULL AND SHOW_QUESTION_ID IS NULL
	  AND MANDATORY_QUESTION_ID IS NULL AND SHOW_PAGE_ID IS NULL
	  AND ISSUE_TEMPLATE_ID IS NULL)
	OR
	(ACTION_TYPE = 'show_q' AND QS_EXPR_NON_COMPL_ACTION_ID IS NULL
	  AND QS_EXPR_MSG_ACTION_ID IS NULL AND SHOW_QUESTION_ID IS NOT NULL
	  AND MANDATORY_QUESTION_ID IS NULL AND SHOW_PAGE_ID IS NULL
	  AND ISSUE_TEMPLATE_ID IS NULL)
	OR
	(ACTION_TYPE = 'mand_q' AND QS_EXPR_NON_COMPL_ACTION_ID IS NULL
	  AND QS_EXPR_MSG_ACTION_ID IS NULL AND SHOW_QUESTION_ID IS NULL
	  AND MANDATORY_QUESTION_ID IS NOT NULL AND SHOW_PAGE_ID IS NULL
	  AND ISSUE_TEMPLATE_ID IS NULL)
	OR
	(ACTION_TYPE = 'show_p' AND QS_EXPR_NON_COMPL_ACTION_ID IS NULL
	  AND QS_EXPR_MSG_ACTION_ID IS NULL AND SHOW_QUESTION_ID IS NULL
	  AND MANDATORY_QUESTION_ID IS NULL AND SHOW_PAGE_ID IS NOT NULL
	  AND ISSUE_TEMPLATE_ID IS NULL)
	OR
	(ACTION_TYPE = 'issue' AND QS_EXPR_NON_COMPL_ACTION_ID IS NULL
	  AND QS_EXPR_MSG_ACTION_ID IS NULL AND SHOW_QUESTION_ID IS NULL
	  AND MANDATORY_QUESTION_ID IS NULL AND SHOW_PAGE_ID IS NULL
	  AND ISSUE_TEMPLATE_ID IS NOT NULL)
);

ALTER TABLE CSR.QUICK_SURVEY_EXPR_ACTION ADD CONSTRAINT FK_QSEA_ISS_TEMP 
	FOREIGN KEY (APP_SID, ISSUE_TEMPLATE_ID)
	REFERENCES CSR.ISSUE_TEMPLATE (APP_SID, ISSUE_TEMPLATE_ID) ON DELETE CASCADE;

ALTER TABLE CSR.ISSUE_TEMPLATE ADD CONSTRAINT FK_IT_ISSUE_TYPE
	FOREIGN KEY (APP_SID, ISSUE_TYPE_ID)
	REFERENCES CSR.ISSUE_TYPE (APP_SID, ISSUE_TYPE_ID);

ALTER TABLE CSR.ISSUE_TEMPLATE ADD CONSTRAINT FK_IT_ASSIGN_TO_USER
	FOREIGN KEY (APP_SID, ASSIGN_TO_USER_SID)
	REFERENCES CSR.CSR_USER (APP_SID, CSR_USER_SID);

ALTER TABLE CSR.ISSUE_TEMPLATE_CUSTOM_FIELD ADD CONSTRAINT FK_ITCF_ISS_TEMP
	FOREIGN KEY (APP_SID, ISSUE_TEMPLATE_ID)
	REFERENCES CSR.ISSUE_TEMPLATE (APP_SID, ISSUE_TEMPLATE_ID) ON DELETE CASCADE;

ALTER TABLE CSR.ISSUE_TEMPLATE_CUSTOM_FIELD ADD CONSTRAINT FK_ITCF_CUS_FIELD
	FOREIGN KEY (APP_SID, ISSUE_CUSTOM_FIELD_ID)
	REFERENCES CSR.ISSUE_CUSTOM_FIELD (APP_SID, ISSUE_CUSTOM_FIELD_ID);

ALTER TABLE CSR.ISSUE_TEMPLATE_CUST_FIELD_OPT ADD CONSTRAINT FK_ITCFO_ISS_TEMP
	FOREIGN KEY (APP_SID, ISSUE_TEMPLATE_ID)
	REFERENCES CSR.ISSUE_TEMPLATE (APP_SID, ISSUE_TEMPLATE_ID) ON DELETE CASCADE;

ALTER TABLE CSR.ISSUE_TEMPLATE_CUST_FIELD_OPT ADD CONSTRAINT FK_ITCFO_CUST_FIELD_OPT
	FOREIGN KEY (APP_SID, ISSUE_CUSTOM_FIELD_ID, ISSUE_CUSTOM_FIELD_OPT_ID)
	REFERENCES CSR.ISSUE_CUSTOM_FIELD_OPTION (APP_SID, ISSUE_CUSTOM_FIELD_ID, ISSUE_CUSTOM_FIELD_OPT_ID);

-- *** Grants ***
grant select, insert, update, delete on csrimp.issue_template to tool_user;
grant select, insert, update, delete on csrimp.issue_template_custom_field to tool_user;
grant select, insert, update, delete on csrimp.issue_template_cust_field_opt to tool_user;

grant select, insert, update on csr.issue_template to csrimp;
grant select, insert, update on csr.issue_template_custom_field to csrimp;
grant select, insert, update on csr.issue_template_cust_field_opt to csrimp;

grant select on csr.issue_template_id_seq to csrimp;

-- ** Cross schema constraints ***

-- *** Views ***
-- Please paste the content of the view.

-- *** Data changes ***
-- RLS

-- Data

-- ** New package grants **

-- *** Conditional Packages ***

-- *** Packages ***

@..\audit_pkg
@..\quick_survey_pkg
@..\schema_pkg

@..\audit_body
@..\quick_survey_body
@..\schema_body
@..\csrimp\imp_body

@update_tail
