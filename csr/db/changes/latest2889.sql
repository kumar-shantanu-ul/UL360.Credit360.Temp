define version=2889
define minor_version=0
define is_combined=1
@update_header

CREATE SEQUENCE csr.r_report_type_id_seq
	START WITH 1
	INCREMENT BY 1
	NOMINVALUE
	NOMAXVALUE
	CACHE 20
	NOORDER;
CREATE TABLE csr.r_report_type (
	APP_SID							NUMBER(10, 0) DEFAULT SYS_CONTEXT('SECURITY', 'APP') NOT NULL,
	R_REPORT_TYPE_ID				NUMBER(10, 0) NOT NULL,
	LABEL							VARCHAR2(100) NOT NULL,
	PLUGIN_TYPE_ID					NUMBER(10, 0) NOT NULL,
	PLUGIN_ID						NUMBER(10, 0) NOT NULL,
	CONSTRAINT pk_r_report_type PRIMARY KEY (app_sid, r_report_type_id),
	CONSTRAINT uk_r_report_type_label UNIQUE (app_sid, label),
	CONSTRAINT fk_r_report_type_plugin FOREIGN KEY (plugin_type_id, plugin_id) REFERENCES csr.plugin (plugin_type_id, plugin_id),
	CONSTRAINT ck_r_report_type_plugin CHECK (plugin_type_id = 15)
);
CREATE TABLE csr.r_report_job (
	APP_SID							NUMBER(10, 0) DEFAULT SYS_CONTEXT('SECURITY', 'APP') NOT NULL,
	BATCH_JOB_ID					NUMBER(10, 0) NOT NULL,
	R_REPORT_TYPE_ID				NUMBER(10, 0) NOT NULL,
	JS_DATA							CLOB,
	CONSTRAINT pk_r_report_job PRIMARY KEY (app_sid, batch_job_id),
	CONSTRAINT fk_r_report_job_report_type FOREIGN KEY (app_sid, r_report_type_id) REFERENCES csr.r_report_type (app_sid, r_report_type_id)
);
CREATE TABLE csr.r_report (
	APP_SID							NUMBER(10, 0) DEFAULT SYS_CONTEXT('SECURITY', 'APP') NOT NULL,
	R_REPORT_SID					NUMBER(10, 0) NOT NULL,
	R_REPORT_TYPE_ID				NUMBER(10, 0) NOT NULL,
	JS_DATA							CLOB,
	REQUESTED_BY_USER_SID			NUMBER(10, 0) NOT NULL,
	PREPARED_DTM					DATE NOT NULL,
	CONSTRAINT pk_r_report PRIMARY KEY (app_sid, r_report_sid),
	CONSTRAINT fk_r_report_report_type FOREIGN KEY (app_sid, r_report_type_id) REFERENCES csr.r_report_type (app_sid, r_report_type_id),
	CONSTRAINT fk_r_report_user FOREIGN KEY (app_sid, requested_by_user_sid) REFERENCES csr.csr_user (app_sid, csr_user_sid)
);
CREATE SEQUENCE csr.r_report_file_id_seq
	START WITH 1
	INCREMENT BY 1
	NOMINVALUE
	NOMAXVALUE
	CACHE 20
	NOORDER;
CREATE TABLE csr.r_report_file (
	APP_SID							NUMBER(10, 0) DEFAULT SYS_CONTEXT('SECURITY', 'APP') NOT NULL,
	R_REPORT_FILE_ID				NUMBER(10, 0) NOT NULL,
	R_REPORT_SID					NUMBER(10, 0) NOT NULL,
	SHOW_AS_TAB						NUMBER(1) DEFAULT 0 NOT NULL,
	SHOW_AS_DOWNLOAD				NUMBER(1) DEFAULT 0 NOT NULL,
	TITLE							VARCHAR2(255) NOT NULL,
	FILENAME						VARCHAR2(255) NOT NULL,
	MIME_TYPE						VARCHAR2(255) NOT NULL,
	DATA							BLOB NOT NULL,
	CONSTRAINT pk_r_report_file PRIMARY KEY (app_sid, r_report_file_id),
	CONSTRAINT fk_r_report_file_report FOREIGN KEY (app_sid, r_report_sid) REFERENCES csr.r_report (app_sid, r_report_sid),
	CONSTRAINT ck_r_report_file_tab CHECK (show_as_tab IN (0, 1)),
	CONSTRAINT ck_r_report_file_dl CHECK (show_as_download IN (0, 1)),
	CONSTRAINT ck_r_report_file_visible CHECK (show_as_tab = 1 OR show_as_download = 1)
);
CREATE TABLE CSRIMP.R_REPORT_TYPE (
	CSRIMP_SESSION_ID NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	R_REPORT_TYPE_ID NUMBER(10,0) NOT NULL,
	LABEL VARCHAR2(100) NOT NULL,
	PLUGIN_ID NUMBER(10,0) NOT NULL,
	PLUGIN_TYPE_ID NUMBER(10,0) NOT NULL,
	CONSTRAINT PK_R_REPORT_TYPE PRIMARY KEY (CSRIMP_SESSION_ID, R_REPORT_TYPE_ID),
	CONSTRAINT FK_R_REPORT_TYPE_IS FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);
CREATE TABLE CSRIMP.R_REPORT (
	CSRIMP_SESSION_ID NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	R_REPORT_SID NUMBER(10,0) NOT NULL,
	JS_DATA CLOB,
	PREPARED_DTM DATE NOT NULL,
	REQUESTED_BY_USER_SID NUMBER(10,0) NOT NULL,
	R_REPORT_TYPE_ID NUMBER(10,0) NOT NULL,
	CONSTRAINT PK_R_REPORT PRIMARY KEY (CSRIMP_SESSION_ID, R_REPORT_SID),
	CONSTRAINT FK_R_REPORT_IS FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);
CREATE TABLE CSRIMP.R_REPORT_FILE (
	CSRIMP_SESSION_ID NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	R_REPORT_FILE_ID NUMBER(10,0) NOT NULL,
	DATA BLOB NOT NULL,
	FILENAME VARCHAR2(255) NOT NULL,
	MIME_TYPE VARCHAR2(255) NOT NULL,
	R_REPORT_SID NUMBER(10,0) NOT NULL,
	SHOW_AS_DOWNLOAD NUMBER(1,0) NOT NULL,
	SHOW_AS_TAB NUMBER(1,0) NOT NULL,
	TITLE VARCHAR2(255) NOT NULL,
	CONSTRAINT PK_R_REPORT_FILE PRIMARY KEY (CSRIMP_SESSION_ID, R_REPORT_FILE_ID),
	CONSTRAINT FK_R_REPORT_FILE_IS FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);
CREATE TABLE CSRIMP.MAP_R_REPORT_TYPE (
	CSRIMP_SESSION_ID NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	OLD_R_REPORT_TYPE_ID NUMBER(10) NOT NULL,
	NEW_R_REPORT_TYPE_ID NUMBER(10) NOT NULL,
	CONSTRAINT PK_MAP_R_REPORT_TYPE PRIMARY KEY (CSRIMP_SESSION_ID, OLD_R_REPORT_TYPE_ID) USING INDEX,
	CONSTRAINT UK_MAP_R_REPORT_TYPE UNIQUE (CSRIMP_SESSION_ID, NEW_R_REPORT_TYPE_ID) USING INDEX,
	CONSTRAINT FK_MAP_R_REPORT_TYPE_IS FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);
CREATE TABLE CSRIMP.MAP_R_REPORT_FILE (
	CSRIMP_SESSION_ID NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	OLD_R_REPORT_FILE_ID NUMBER(10) NOT NULL,
	NEW_R_REPORT_FILE_ID NUMBER(10) NOT NULL,
	CONSTRAINT PK_MAP_R_REPORT_FILE PRIMARY KEY (CSRIMP_SESSION_ID, OLD_R_REPORT_FILE_ID) USING INDEX,
	CONSTRAINT UK_MAP_R_REPORT_FILE UNIQUE (CSRIMP_SESSION_ID, NEW_R_REPORT_FILE_ID) USING INDEX,
	CONSTRAINT FK_MAP_R_REPORT_FILE_IS FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);
CREATE TABLE csr.auto_exp_retrieval_sp (
	app_sid								NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY', 'APP') NOT NULL,
	auto_exp_retrieval_sp_id			NUMBER(10) NOT NULL,
	stored_procedure					VARCHAR2(255) NOT NULL,
	strip_underscores_from_headers		NUMBER(1) DEFAULT 0 NOT NULL,
	CONSTRAINT pk_auto_exp_retrieval_sp PRIMARY KEY (app_sid, auto_exp_retrieval_sp_id),
	CONSTRAINT ck_auto_exp_rtrvl_strip CHECK (strip_underscores_from_headers IN (0, 1))
);
CREATE SEQUENCE csr.auto_exp_rtrvl_sp_id_seq
	START WITH 1
	INCREMENT BY 1
	NOMINVALUE
	NOMAXVALUE
	CACHE 20;
		
CREATE GLOBAL TEMPORARY TABLE CSR.TT_CSRIMPEXPCHECK_DDL (
	OWNER              VARCHAR2(30) NOT NULL,
	TABLE_NAME         VARCHAR2(30) NOT NULL,
	COLUMN_NAME        VARCHAR2(30) NOT NULL,
	DATA_TYPE          VARCHAR2(106),
	DATA_LENGTH        NUMBER NOT NULL,
	DATA_PRECISION     NUMBER,
	NULLABLE           VARCHAR2(1),
	DATA_DEFAULT       CLOB,
	CHARACTER_SET_NAME VARCHAR2(44)
) ON COMMIT DELETE ROWS;
CREATE TABLE CSRIMP.MAP_ISSUE_SUPPLIER (
	CSRIMP_SESSION_ID NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	OLD_ISSUE_SUPPLIER_ID NUMBER(10) NOT NULL,
	NEW_ISSUE_SUPPLIER_ID NUMBER(10) NOT NULL,
	CONSTRAINT PK_MAP_ISSUE_SUPPLIER PRIMARY KEY (CSRIMP_SESSION_ID, OLD_ISSUE_SUPPLIER_ID) USING INDEX,
	CONSTRAINT UK_MAP_ISSUE_SUPPLIER UNIQUE (CSRIMP_SESSION_ID, NEW_ISSUE_SUPPLIER_ID) USING INDEX,
	CONSTRAINT FK_MAP_ISSUE_SUPPLIER_IS FOREIGN KEY (CSRIMP_SESSION_ID) 
		REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);
CREATE TABLE CSRIMP.MAP_ISSUE_ACTION (
	CSRIMP_SESSION_ID NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	OLD_ISSUE_ACTION_ID NUMBER(10) NOT NULL,
	NEW_ISSUE_ACTION_ID NUMBER(10) NOT NULL,
	CONSTRAINT PK_MAP_ISSUE_ACTION PRIMARY KEY (CSRIMP_SESSION_ID, OLD_ISSUE_ACTION_ID) USING INDEX,
	CONSTRAINT UK_MAP_ISSUE_ACTION UNIQUE (CSRIMP_SESSION_ID, NEW_ISSUE_ACTION_ID) USING INDEX,
	CONSTRAINT FK_MAP_ISSUE_ACTION_IS FOREIGN KEY (CSRIMP_SESSION_ID) 
		REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);
CREATE TABLE CSRIMP.FLOW_ALERT_HELPER(
    CSRIMP_SESSION_ID    NUMBER(10, 0)     DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
    FLOW_ALERT_HELPER    VARCHAR2(256)     NOT NULL,
    LABEL                VARCHAR2(1024)    NOT NULL,
    CONSTRAINT PK_FLOW_ALERT_HELPER PRIMARY KEY (CSRIMP_SESSION_ID, FLOW_ALERT_HELPER),
	CONSTRAINT FK_CUSTOMER_FLALHELPER FOREIGN KEY (CSRIMP_SESSION_ID) 
		REFERENCES CSRIMP.CSRIMP_SESSION(CSRIMP_SESSION_ID) ON DELETE CASCADE
);
CREATE TABLE CSRIMP.ISSUE_CUSTOM_FIELD_DATE_VAL(
    CSRIMP_SESSION_ID        NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY','CSRIMP_SESSION_ID') NOT NULL,
    DATE_VALUE               DATE             NOT NULL,
    ISSUE_ID                 NUMBER(10, 0)    NOT NULL,
    ISSUE_CUSTOM_FIELD_ID    NUMBER(10, 0)    NOT NULL,
    CONSTRAINT PK_ISSUE_CUST_FIELD_DATE_VAL PRIMARY KEY (CSRIMP_SESSION_ID, ISSUE_ID, ISSUE_CUSTOM_FIELD_ID),
	CONSTRAINT FK_ISS_CUST_FLD_DATE_FLD FOREIGN KEY (CSRIMP_SESSION_ID, ISSUE_CUSTOM_FIELD_ID)
		REFERENCES CSRIMP.ISSUE_CUSTOM_FIELD(CSRIMP_SESSION_ID, ISSUE_CUSTOM_FIELD_ID),
	CONSTRAINT FK_ISSUE_CUST_FLD_DATE_VAL FOREIGN KEY (CSRIMP_SESSION_ID, ISSUE_ID)
		REFERENCES CSRIMP.ISSUE(CSRIMP_SESSION_ID, ISSUE_ID),
	CONSTRAINT FK_ISSUE_CUST_IS FOREIGN KEY (CSRIMP_SESSION_ID) 
		REFERENCES CSRIMP.CSRIMP_SESSION(CSRIMP_SESSION_ID) ON DELETE CASCADE
);
CREATE TABLE CSRIMP.QUICK_SURVEY_CSS (
    CSRIMP_SESSION_ID		NUMBER(10)		DEFAULT SYS_CONTEXT('SECURITY','CSRIMP_SESSION_ID') NOT NULL,
    CLASS_NAME		 		VARCHAR2(1024)	NOT NULL,
    DESCRIPTION		 		VARCHAR2(1024)	NOT NULL,
    TYPE					NUMBER(1)		NOT NULL,
	POSITION				NUMBER(10)    	NOT NULL,
    CONSTRAINT PK_QUICK_SURVEY_CSS PRIMARY KEY (CSRIMP_SESSION_ID, CLASS_NAME),
	CONSTRAINT FK_QS_CSS_IS FOREIGN KEY (CSRIMP_SESSION_ID) 
		REFERENCES CSRIMP.CSRIMP_SESSION(CSRIMP_SESSION_ID) ON DELETE CASCADE
);
CREATE TABLE CSRIMP.QUICK_SURVEY_SCORE_THRESHOLD(
    CSRIMP_SESSION_ID     NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
    SURVEY_SID            NUMBER(10, 0)    NOT NULL,
    SCORE_THRESHOLD_ID    NUMBER(10, 0)    NOT NULL,
    MAPS_TO_IND_SID       NUMBER(10, 0),
    CONSTRAINT PK_QUICK_SURVEY_SCORE_THRESHOL PRIMARY KEY (CSRIMP_SESSION_ID, SURVEY_SID, SCORE_THRESHOLD_ID),
	CONSTRAINT FK_IND_QSST FOREIGN KEY (CSRIMP_SESSION_ID, MAPS_TO_IND_SID)
		REFERENCES CSRIMP.IND(CSRIMP_SESSION_ID, IND_SID),
	CONSTRAINT FK_QS_QSST FOREIGN KEY (CSRIMP_SESSION_ID, SURVEY_SID)
		REFERENCES CSRIMP.QUICK_SURVEY(CSRIMP_SESSION_ID, SURVEY_SID),
	CONSTRAINT FK_ST_QSST FOREIGN KEY (CSRIMP_SESSION_ID, SCORE_THRESHOLD_ID)
		REFERENCES CSRIMP.SCORE_THRESHOLD(CSRIMP_SESSION_ID, SCORE_THRESHOLD_ID),
    CONSTRAINT FK_QSST_IS FOREIGN KEY
    	(CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID)
    	ON DELETE CASCADE
)
;
CREATE TABLE CSRIMP.SUPPLIER_SURVEY_RESPONSE(
    CSRIMP_SESSION_ID     NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
    SUPPLIER_SID          NUMBER(10, 0)    NOT NULL,
    SURVEY_RESPONSE_ID    NUMBER(10, 0)    NOT NULL,
    SURVEY_SID            NUMBER(10, 0)    NOT NULL,
    COMPONENT_ID          NUMBER(10, 0)    NULL,
    CONSTRAINT PK_SUPPLIER_SURVEY_RESPONSE PRIMARY KEY (CSRIMP_SESSION_ID, SURVEY_RESPONSE_ID),
	CONSTRAINT FK_SUPP_SURV_RESP_QK_SURV_RESP FOREIGN KEY (CSRIMP_SESSION_ID, SURVEY_SID, SURVEY_RESPONSE_ID)
		REFERENCES CSRIMP.QUICK_SURVEY_RESPONSE(CSRIMP_SESSION_ID, SURVEY_SID, SURVEY_RESPONSE_ID),
	CONSTRAINT FK_SUPP_SURV_RESP_SUPPLIER FOREIGN KEY (CSRIMP_SESSION_ID, SUPPLIER_SID)
		REFERENCES CSRIMP.SUPPLIER(CSRIMP_SESSION_ID, COMPANY_SID),
    CONSTRAINT FK_SUPP_SURV_RESP_IS FOREIGN KEY
    	(CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID)
    	ON DELETE CASCADE
)
;
CREATE TABLE chain.filter_item_config (
	app_sid					NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY', 'APP') NOT NULL,
	card_group_id			NUMBER(10) NOT NULL,
	card_id					NUMBER(10) NOT NULL,
	item_name				VARCHAR2(255) NOT NULL,
	company_tab_id			NUMBER(10),
	label					VARCHAR2(1024) NOT NULL,
	pos						NUMBER(10) NOT NULL,
	include_in_filter		NUMBER(1) DEFAULT 1 NOT NULL,
	include_in_breakdown	NUMBER(1) DEFAULT 0 NOT NULL,
	include_in_advanced		NUMBER(1) DEFAULT 0 NOT NULL,
	group_sid				NUMBER(10),
	path					VARCHAR2(1024),
	CONSTRAINT chk_fltr_itm_cfg_inc_fil_1_0 CHECK (include_in_filter IN (1, 0)),
	CONSTRAINT chk_fltr_itm_cfg_inc_brkd_1_0 CHECK (include_in_breakdown IN (1, 0)),
	CONSTRAINT chk_fltr_itm_cfg_inc_adv_1_0 CHECK (include_in_advanced IN (1, 0))
);
CREATE UNIQUE INDEX chain.uk_filter_item_config ON chain.filter_item_config(app_sid, card_group_id, card_id, item_name, company_tab_id, path);
CREATE TABLE csrimp.chain_filter_item_config (
	csrimp_session_id		NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	card_group_id			NUMBER(10) NOT NULL,
	card_id					NUMBER(10) NOT NULL,
	item_name				VARCHAR2(255) NOT NULL,
	company_tab_id			NUMBER(10),
	label					VARCHAR2(1024) NOT NULL,
	pos						NUMBER(10) NOT NULL,
	include_in_filter		NUMBER(1) NOT NULL,
	include_in_breakdown	NUMBER(1) NOT NULL,
	include_in_advanced		NUMBER(1) NOT NULL,
	group_sid				NUMBER(10),
	path					VARCHAR2(1024),
	CONSTRAINT chk_fltr_itm_cfg_inc_fil_1_0 CHECK (include_in_filter IN (1, 0)),
	CONSTRAINT chk_fltr_itm_cfg_inc_brkd_1_0 CHECK (include_in_breakdown IN (1, 0)),
	CONSTRAINT chk_fltr_itm_cfg_inc_adv_1_0 CHECK (include_in_advanced IN (1, 0))
);
CREATE UNIQUE INDEX csrimp.uk_filter_item_config ON csrimp.chain_filter_item_config(csrimp_session_id, card_group_id, card_id, item_name, company_tab_id, path);
CREATE SEQUENCE  "CSR"."IMAGE_UPLOAD_PORTLET_SEQ"  MINVALUE 1 MAXVALUE 999999999999999999999999999 INCREMENT BY 1 START WITH 129 CACHE 20 NOORDER  NOCYCLE;
CREATE TABLE CSR.IMAGE_UPLOAD_PORTLET(
  APP_SID     NUMBER(10) 		DEFAULT SYS_CONTEXT('SECURITY', 'APP') NOT NULL,
  IMG_ID      NUMBER(10) 		NOT NULL,
  FILE_NAME   VARCHAR(255) 	    NOT NULL,
  IMAGE       BLOB  			NOT NULL,
  MIME_TYPE   VARCHAR(255) 		NOT NULL,
	CONSTRAINT PK_IMAGE_UPLOAD_PORTLET PRIMARY KEY (APP_SID, IMG_ID)
);
CREATE TABLE CSRIMP.IMAGE_UPLOAD_PORTLET (
	CSRIMP_SESSION_ID 	NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	FILE_NAME 			VARCHAR2(255) NOT NULL,
	IMAGE BLOB 			NOT NULL,
	IMG_ID 				NUMBER(10,0) NOT NULL,
	MIME_TYPE 			VARCHAR2(255) NOT NULL,
	CONSTRAINT FK_IMAGE_UPLOAD_PORTLET_IS FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);
CREATE TABLE CSRIMP.MAP_IMAGE_UPLOAD_PORTLET (
	CSRIMP_SESSION_ID 			NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	OLD_IMAGE_UPLOAD_PORTLET_ID NUMBER(10) NOT NULL,
	NEW_IMAGE_UPLOAD_PORTLET_ID NUMBER(10) NOT NULL,
	CONSTRAINT PK_MAP_IMAGE_UPLOAD_PORTLET PRIMARY KEY (CSRIMP_SESSION_ID, OLD_IMAGE_UPLOAD_PORTLET_ID) USING INDEX,
	CONSTRAINT UK_MAP_IMAGE_UPLOAD_PORTLET UNIQUE (CSRIMP_SESSION_ID, NEW_IMAGE_UPLOAD_PORTLET_ID) USING INDEX,
	CONSTRAINT FK_MAP_IMAGE_UPLOAD_PORTLET_IS FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);


ALTER TABLE csr.plugin ADD (
	R_SCRIPT_PATH					VARCHAR2(1024)
);
DROP INDEX csr.plugin_js_class;
CREATE UNIQUE INDEX csr.plugin_js_class ON csr.plugin (app_sid, js_class, form_path, group_key, saved_filter_sid, result_mode, portal_sid, r_script_path);
ALTER TABLE csr.automated_import_class_step
  RENAME COLUMN helper_pkg to on_completion_sp;
DECLARE 
	v_data_default		all_tab_columns.data_default%TYPE;
BEGIN
	SELECT data_default
	  INTO v_data_default
	  FROM all_tab_columns
	 WHERE owner = 'CHAIN'
	   AND table_name = 'CUSTOMER_OPTIONS'
	   AND column_name = 'USE_COMPANY_TYPE_CSS_CLASS';
	
	IF v_data_default IS NULL OR UPPER(v_data_default)='NULL' THEN
		EXECUTE IMMEDIATE 'ALTER TABLE chain.customer_options MODIFY use_company_type_css_class DEFAULT 0';
	END IF;
END;
/
ALTER TABLE csr.automated_export_class
ADD auto_exp_retrieval_sp_id NUMBER(10);
ALTER TABLE CSRIMP.CHAIN_ACT_OUTC_TYPE_ACT
MODIFY DEFAULT_ACT_DATE_RELATIVE_UNIT DEFAULT NULL;
ALTER TABLE CSRIMP.CHAIN_ACT_OUTC_TYPE_ACT
MODIFY DEFAULT_SHARE_WITH_TARGET DEFAULT NULL;
ALTER TABLE CSRIMP.CHAIN_ACT_OUTC_TYPE_ACT
MODIFY COPY_TAGS DEFAULT NULL;
ALTER TABLE CSRIMP.CHAIN_ACT_OUTC_TYPE_ACT
MODIFY COPY_ASSIGNED_TO DEFAULT NULL;
ALTER TABLE CSRIMP.CHAIN_ACT_OUTC_TYPE_ACT
MODIFY COPY_TARGET DEFAULT NULL;
ALTER TABLE CSRIMP.CHAIN_ACTIVI_TYPE_ACTION
MODIFY COPY_TAGS DEFAULT NULL;
ALTER TABLE CSRIMP.CHAIN_ACTIVI_TYPE_ACTION
MODIFY COPY_ASSIGNED_TO DEFAULT NULL;
ALTER TABLE CSRIMP.CHAIN_ACTIVI_TYPE_ACTION
MODIFY COPY_TARGET DEFAULT NULL;
ALTER TABLE CSRIMP.CHAIN_ACTIVI_TYPE_ACTION
MODIFY DEFAULT_ACT_DATE_RELATIVE_UNIT DEFAULT NULL;
ALTER TABLE CSRIMP.CHAIN_ACTIVI_TYPE_ACTION
MODIFY DEFAULT_SHARE_WITH_TARGET DEFAULT NULL;
ALTER TABLE CSRIMP.CHAIN_ACTIVIT_TYPE_ALERT
MODIFY SEND_TO_ASSIGNEE DEFAULT NULL;
ALTER TABLE CSRIMP.CHAIN_ACTIVIT_TYPE_ALERT
MODIFY SEND_TO_TARGET DEFAULT NULL;
ALTER TABLE CSRIMP.CHAIN_ACTIVITY
MODIFY SHARE_WITH_TARGET DEFAULT NULL;
ALTER TABLE CSRIMP.CHAIN_ACTIVITY_TYPE
MODIFY CAN_SHARE DEFAULT NULL;
ALTER TABLE CSRIMP.CHAIN_COMPANY_TYPE
MODIFY CREATE_SUBSIDS_UNDER_PARENT DEFAULT NULL;
ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY SHOW_ONE_ISSUE_POPUP DEFAULT NULL;
ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY ALLOW_OWNER_RESOLVE_AND_CLOSE DEFAULT NULL;
ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY APPLIES_TO_AUDIT DEFAULT NULL;
ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY REGION_LINK_TYPE DEFAULT NULL;
ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY REQUIRE_DUE_DTM_COMMENT DEFAULT NULL;
ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY CREATE_RAW DEFAULT NULL;
ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY DELETED DEFAULT NULL;
ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY INVOLVE_MIN_USERS_IN_ISSUE DEFAULT NULL;
ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY SHOW_FORECAST_DTM DEFAULT NULL;
ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY REQUIRE_VAR_EXPL DEFAULT NULL;
ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY ENABLE_REJECT_ACTION DEFAULT NULL;
ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY PUBLIC_BY_DEFAULT DEFAULT NULL;
ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY OWNER_CAN_BE_CHANGED DEFAULT NULL;
ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY DELETABLE_BY_RAISER DEFAULT NULL;
ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY SEND_ALERT_ON_ISSUE_RAISED DEFAULT NULL;
ALTER TABLE CSRIMP.ISSUE_TYPE_RAG_STATUS
MODIFY POS DEFAULT NULL;
ALTER TABLE CSRIMP.ISSUE
MODIFY IS_PENDING_ASSIGNMENT DEFAULT NULL;
ALTER TABLE CSRIMP.ISSUE_CUSTOM_FIELD
MODIFY IS_MANDATORY DEFAULT NULL;
ALTER TABLE CSRIMP.QUICK_SURVEY_TYPE
MODIFY SHOW_ANSWER_SET_DTM DEFAULT NULL;
ALTER TABLE CSRIMP.QS_RESPONSE_FILE
MODIFY UPLOADED_DTM DEFAULT NULL;
ALTER TABLE CSRIMP.QS_ANSWER_LOG
MODIFY VERSION_STAMP DEFAULT NULL;
ALTER TABLE CSRIMP.NON_COMPLIANCE_TYPE
MODIFY CAN_HAVE_ACTIONS DEFAULT NULL;
ALTER TABLE CSRIMP.NON_COMPLIANCE_TYPE
MODIFY CLOSURE_BEHAVIOUR_ID DEFAULT NULL;
ALTER TABLE CSRIMP.INTERNAL_AUDIT_TYPE
MODIFY ACTIVE DEFAULT NULL;
ALTER TABLE CSRIMP.INTERNAL_AUDIT_TYPE
MODIFY NC_AUDIT_CHILD_REGION DEFAULT NULL;
ALTER TABLE CSRIMP.NON_COMP_DEFAULT
MODIFY CSRIMP_SESSION_ID DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID');
ALTER TABLE CSRIMP.NON_COMP_DEFAULT_ISSUE
MODIFY CSRIMP_SESSION_ID DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID');
ALTER TABLE CSRIMP.AUDIT_TYPE_NON_COMP_DEFAULT
MODIFY CSRIMP_SESSION_ID DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID');
ALTER TABLE CSRIMP.NON_COMP_DEFAULT_FOLDER
MODIFY CSRIMP_SESSION_ID DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID');
ALTER TABLE CSRIMP.NON_COMP_DEFAULT_TAG
MODIFY CSRIMP_SESSION_ID DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID');
DECLARE
    column_exists EXCEPTION;
    null_not_nullable EXCEPTION;
    constraint_exists EXCEPTION;
    PRAGMA exception_init (column_exists , -01430);
    PRAGMA exception_init (null_not_nullable , -01442);
    PRAGMA exception_init (constraint_exists , -02275);
    null_fail EXCEPTION;
    PRAGMA exception_init (null_fail , -01451);
BEGIN
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.FLOW_TRANSITION_ALERT ADD FLOW_ALERT_HELPER VARCHAR2(256)';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_BUSINE_RELATI_TIER ADD LOOKUP_KEY VARCHAR2(255)';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_BUSINE_RELATI_TYPE ADD LOOKUP_KEY VARCHAR2(255)';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_COMPAN_TYPE_RELATI ADD FLOW_SID NUMBER(10, 0)';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_FILTERSUPPLIERREPO ADD POSITION NUMBER(10) NULL';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_COMPANY ADD EMAIL VARCHAR2(255)';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_CUSTOMER_OPTIONS ADD EDIT_COMPANY_USE_POSTCODE_DATA NUMBER(1, 0) NOT NULL';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_CUSTOMER_OPTIONS ADD INVITATION_EXPIRATION_REM_DAYS NUMBER(10, 0) NOT NULL';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_CUSTOMER_OPTIONS ADD INVITATION_EXPIRATION_REM NUMBER(1) NOT NULL';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_SAVED_FILTER ADD EXCLUDE_FROM_REPORTS NUMBER(1) NOT NULL';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.ISSUE_ACTION_LOG ADD OWNER_USER_SID NUMBER(10, 0)';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.ISSUE_CUSTOM_FIELD ADD FIELD_REFERENCE_NAME VARCHAR2(255)';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.QS_CAMPAIGN ADD SEND_ALERT NUMBER(1) NOT NULL';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.QS_CAMPAIGN ADD DYNAMIC NUMBER(1) NOT NULL';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.QS_CAMPAIGN ADD RESEND NUMBER(1) NOT NULL';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.SCORE_THRESHOLD ADD SUPPLIER_SCORE_IND_SID NUMBER(10, 0)';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.QUICK_SURVEY_ANSWER ADD LOG_ITEM CLOB';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.NON_COMPLIANCE ADD SURVEY_RESPONSE_ID NUMBER(10, 0)';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.NON_COMPLIANCE ADD REGION_SID NUMBER(10,0) NULL';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.INTERNAL_AUDIT_TYPE ADD ADD_NC_PER_QUESTION NUMBER(1,0)';
	EXCEPTION WHEN column_exists THEN NULL; END;
	
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.INTERNAL_AUDIT ADD COMPARISON_RESPONSE_ID	NUMBER(10) NULL';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.INTERNAL_AUDIT ADD AUDITOR_COMPANY_SID NUMBER(10)';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.INTERNAL_AUDIT ADD OVW_VALIDITY_DTM DATE NULL';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.INTERNAL_AUDIT ADD NC_SCORE_THRSH_ID NUMBER(10)';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.INTERNAL_AUDIT ADD OVW_NC_SCORE_THRSH_ID NUMBER(10)';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.INTERNAL_AUDIT ADD OVW_NC_SCORE_THRSH_DTM DATE';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.INTERNAL_AUDIT ADD OVW_NC_SCORE_THRSH_USR_SID NUMBER(10)';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.INTERNAL_AUDIT_TYPE_GROUP ADD GROUP_COORDINATOR_NOUN VARCHAR2(100) NULL';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.FLOW_TRANSITION_ALERT ADD FLOW_ALERT_HELPER VARCHAR2(256)';
	EXCEPTION WHEN column_exists THEN NULL; END;
		
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.FLOW_ALERT_TYPE ADD LOOKUP_KEY VARCHAR2(256)';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.ISSUE_SUPPLIER ADD COMPANY_SID NUMBER(10, 0) NOT NULL';
	EXCEPTION WHEN column_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_BUSINE_RELATI_TIER MODIFY CREATE_NEW_COMPANY NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_ACTIVITY_INVOLVEMENT MODIFY ROLE_SID NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_CAPABILITY MODIFY SUPPLIER_ON_PURCHASER NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_COMPANY MODIFY COUNTRY_IS_HIDDEN NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_CUSTOMER_OPTIONS MODIFY ENABLE_USER_VISIBILITY_OPTIONS NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_CUSTOMER_OPTIONS MODIFY REINVITE_SUPPLIER NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_CUSTOMER_OPTIONS MODIFY SHOW_ALL_COMPONENTS NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_CUSTOMER_OPTIONS MODIFY SHOW_INVITATION_PREVIEW NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_FILE_UPLOAD MODIFY LAST_MODIFIED_BY_SID NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_PRODUCT_REVISION MODIFY VALIDATION_STATUS_ID NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_QUESTIONNAIRE MODIFY REJECTED NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_QUESTIONNAIRE_TYPE MODIFY ENABLE_STATUS_LOG NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_QUESTIONNAIRE_TYPE MODIFY ENABLE_TRANSITION_ALERT NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_QUESTIONNAIRE_TYPE MODIFY PROCURER_CAN_REVIEW NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_ACTIVITY MODIFY ASSIGNED_TO_USER_SID NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_ACTIVITY MODIFY ASSIGNED_TO_ROLE_SID NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.ISSUE_TYPE MODIFY DELETED NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.ISSUE_TYPE MODIFY DELETABLE_BY_RAISER NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.SCORE_TYPE MODIFY ASK_FOR_COMMENT NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.SCORE_TYPE MODIFY START_SCORE NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.SCORE_TYPE MODIFY NORMALISE_TO_MAX_SCORE NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.INTERNAL_AUDIT_TYPE MODIFY SHOW_PRIMARY_SURVEY_IN_HEADER NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.INTERNAL_AUDIT_TYPE MODIFY PRIMARY_SURVEY_ACTIVE NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.INTERNAL_AUDIT_TYPE MODIFY PRIMARY_SURVEY_MANDATORY NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.INTERNAL_AUDIT_TYPE MODIFY PRIMARY_SURVEY_FIXED NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.SCORE_THRESHOLD MODIFY BACKGROUND_COLOUR NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CHAIN.ACTIVITY_TYPE_ALERT MODIFY SEND_TO_TARGET NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CHAIN.ACTIVITY_TYPE_ALERT MODIFY SEND_TO_ASSIGNEE NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSR.QS_CAMPAIGN MODIFY CARRY_FORWARD_ANSWERS NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.FLOW_TRANSITION_ALERT ADD CONSTRAINT FK_TRANS_FLALERT_HELPER 
			FOREIGN KEY (CSRIMP_SESSION_ID, FLOW_ALERT_HELPER)
			REFERENCES CSRIMP.FLOW_ALERT_HELPER(CSRIMP_SESSION_ID, FLOW_ALERT_HELPER)';
	EXCEPTION WHEN constraint_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSR.QS_CAMPAIGN 
			ADD CONSTRAINT CHK_CARRY_FORWARD_ANSWERS CHECK (CARRY_FORWARD_ANSWERS IN (0,1)) ENABLE';
	EXCEPTION WHEN constraint_exists THEN NULL; END;
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.QS_CAMPAIGN 
			ADD CONSTRAINT CHK_CARRY_FORWARD_ANSWERS CHECK (CARRY_FORWARD_ANSWERS IN (0,1)) ENABLE';
	EXCEPTION WHEN constraint_exists THEN NULL; END;
END;
/
DECLARE
	v_data_precision	NUMBER(10);
BEGIN
	SELECT COUNT(*)
	  INTO v_data_precision
	  FROM dba_tab_cols 
	 WHERE UPPER(owner) = 'CHAIN' 
	   AND UPPER(table_name) = 'REFERENCE' 
	   AND UPPER(column_name) = 'SHOW_IN_FILTER' 
	   AND DATA_PRECISION = 10;
	IF v_data_precision > 0 THEN
		EXECUTE IMMEDIATE 'ALTER TABLE CHAIN.REFERENCE ADD TEMP_SHOW_IN_FILTER NUMBER(1)';
		EXECUTE IMMEDIATE 'UPDATE CHAIN.REFERENCE SET TEMP_SHOW_IN_FILTER = SHOW_IN_FILTER';
		EXECUTE IMMEDIATE 'ALTER TABLE CHAIN.REFERENCE DROP CONSTRAINT CHK_SHOW_IN_FILTER'; 
		EXECUTE IMMEDIATE 'ALTER TABLE CHAIN.REFERENCE DROP COLUMN SHOW_IN_FILTER';
		EXECUTE IMMEDIATE 'ALTER TABLE CHAIN.REFERENCE RENAME COLUMN TEMP_SHOW_IN_FILTER TO SHOW_IN_FILTER';
		EXECUTE IMMEDIATE 'ALTER TABLE CHAIN.REFERENCE MODIFY SHOW_IN_FILTER NOT NULL';
		
		EXECUTE IMMEDIATE 'ALTER TABLE CHAIN.REFERENCE ADD CONSTRAINT CHK_SHOW_IN_FILTER CHECK (SHOW_IN_FILTER IN (0,1)) ENABLE';
	
	END IF;
END;
/
DECLARE
	v_data_precision	NUMBER(10);
BEGIN
	SELECT COUNT(*)
	  INTO v_data_precision
	  FROM dba_tab_cols 
	 WHERE UPPER(owner) = 'CHAIN' 
	   AND UPPER(table_name) = 'ACTIVITY_LOG_FILE' 
	   AND UPPER(column_name) = 'SHA1' 
	   AND DATA_TYPE = 'RAW';
	IF v_data_precision > 0 THEN
		EXECUTE IMMEDIATE 'ALTER TABLE CHAIN.ACTIVITY_LOG_FILE ADD TEMP_SHA1 VARCHAR2(40)';
		EXECUTE IMMEDIATE 'UPDATE CHAIN.ACTIVITY_LOG_FILE SET TEMP_SHA1 = CAST(SHA1 AS VARCHAR2(40))';
		EXECUTE IMMEDIATE 'ALTER TABLE CHAIN.ACTIVITY_LOG_FILE DROP COLUMN SHA1';
		EXECUTE IMMEDIATE 'ALTER TABLE CHAIN.ACTIVITY_LOG_FILE RENAME COLUMN TEMP_SHA1 TO SHA1';
		EXECUTE IMMEDIATE 'ALTER TABLE CHAIN.ACTIVITY_LOG_FILE MODIFY SHA1 NOT NULL';
	END IF;
END;
/
ALTER TABLE CSRIMP.CHAIN_FILTER_VALUE
MODIFY MIN_NUM_VAL NUMBER(24,10);
ALTER TABLE CSRIMP.CHAIN_ACTIVITY_LOG_FILE 
DROP COLUMN SHA1;
ALTER TABLE CSRIMP.CHAIN_ACTIVITY_LOG_FILE 
ADD SHA1 VARCHAR2(40) NOT NULL;
ALTER TABLE chain.customer_options DROP CONSTRAINT chk_edit_co_use_po_data;
ALTER TABLE chain.customer_options DROP COLUMN edit_company_use_postcode_data;
CREATE UNIQUE INDEX csr.uk_ia_summary_response_id ON csr.internal_audit (
	CASE WHEN summary_response_id IS NOT NULL THEN app_sid END,
	summary_response_id
);
ALTER TABLE chain.company DROP CONSTRAINT chk_company_city;
ALTER TABLE chain.company DROP CONSTRAINT chk_company_state;
UPDATE chain.company c
   SET c.state = (
	SELECT r.name
	  FROM postcode.region r
	 WHERE r.region = c.state_id
	   AND r.country = c.country_code
	)
 WHERE c.state_id IS NOT NULL
   AND c.state IS NULL;
UPDATE chain.company c
   SET c.city = (
	SELECT r.city_name
	  FROM postcode.city r
	 WHERE r.city_id = c.city_id
	)
 WHERE c.city_id IS NOT NULL
   AND c.city IS NULL;
ALTER TABLE chain.company RENAME COLUMN city_id TO xxx_city_id;
ALTER TABLE chain.company RENAME COLUMN state_id TO xxx_state_id;
ALTER TABLE csrimp.chain_company DROP COLUMN city_id;
ALTER TABLE csrimp.chain_company DROP COLUMN state_id;
ALTER TABLE csr.customer 
  ADD copy_forward_allow_na NUMBER(1) DEFAULT 0 NOT NULL;
ALTER TABLE csr.customer 
  ADD CONSTRAINT ck_customer_copy_for_allow_na CHECK (copy_forward_allow_na IN (0,1));
ALTER TABLE csrimp.customer 
  ADD copy_forward_allow_na number(1) not null;
ALTER TABLE csrimp.customer 
  ADD CONSTRAINT ck_customer_copy_for_allow_na CHECK (copy_forward_allow_na IN (0,1));
BEGIN
	-- Delete the schema, if it already exists.
	DBMS_XMLSCHEMA.DeleteSchema('http://www.cr360.com/XMLSchemas/recurrences.xsd',4);
EXCEPTION
	WHEN OTHERS THEN
		NULL;
END;
/
BEGIN
	-- Register the schema
	DBMS_XMLSCHEMA.RegisterSchema(
	OWNER => 'CSR',
	SCHEMAURL => 'http://www.cr360.com/XMLSchemas/recurrences.xsd',
	SCHEMADOC => '<?xml version="1.0" encoding="utf-8"?>
<xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema" elementFormDefault="qualified" attributeFormDefault="unqualified">
  <xs:complexType name="day-type">
    <xs:attribute name="number" use="required">
      <xs:simpleType>
        <xs:restriction base="xs:positiveInteger">
          <xs:minInclusive value="1"/>
          <xs:maxInclusive value="31"/>
        </xs:restriction>
      </xs:simpleType>
      </xs:attribute>
    <xs:attribute name="month" type="month-type" use="optional"/>
  </xs:complexType>
  <xs:simpleType name="month-type">
    <xs:restriction base="xs:string">
      <xs:enumeration value="jan"/>
      <xs:enumeration value="feb"/>
      <xs:enumeration value="mar"/>
      <xs:enumeration value="apr"/>
      <xs:enumeration value="may"/>
      <xs:enumeration value="jun"/>
      <xs:enumeration value="jul"/>
      <xs:enumeration value="aug"/>
      <xs:enumeration value="sep"/>
      <xs:enumeration value="oct"/>
      <xs:enumeration value="nov"/>
      <xs:enumeration value="dec"/>
    </xs:restriction>
  </xs:simpleType>
  <xs:simpleType name="weekday">
    <xs:restriction base="xs:string">
      <xs:enumeration value="sunday"/>
      <xs:enumeration value="monday"/>
      <xs:enumeration value="tuesday"/>
      <xs:enumeration value="wednesday"/>
      <xs:enumeration value="thursday"/>
      <xs:enumeration value="friday"/>
      <xs:enumeration value="saturday"/>
    </xs:restriction>
  </xs:simpleType>
  <xs:complexType name="everyn">
    <xs:attribute name="every-n" use="optional"/>
  </xs:complexType>
  <xs:complexType name="day-varying-type">
    <xs:attribute name="day" type="weekday" use="required"/>
    <xs:attribute name="type" use="required">
      <xs:simpleType>
        <xs:restriction base="xs:string">
          <xs:enumeration value="first"/>
          <xs:enumeration value="second"/>
          <xs:enumeration value="third"/>
          <xs:enumeration value="fourth"/>
          <xs:enumeration value="last"/>
        </xs:restriction>
      </xs:simpleType>
    </xs:attribute>
    <xs:attribute name="month" use="optional" type="month-type"/>
  </xs:complexType>
  <xs:complexType name="x-day-b-yearly">
    <xs:attribute name="number" use="required">
      <xs:simpleType>
        <xs:restriction base="xs:positiveInteger">
          <xs:minInclusive value="1"/>
          <xs:maxInclusive value="365"/>
        </xs:restriction>
      </xs:simpleType>
    </xs:attribute>
    <xs:attribute name="month" type="month-type" use="required"/>
  </xs:complexType>
  <xs:complexType name="x-day-b-monthly">
    <xs:attribute name="number" use="required">
      <xs:simpleType>
        <xs:restriction base="xs:positiveInteger">
          <xs:minInclusive value="1"/>
          <xs:maxInclusive value="180"/>
        </xs:restriction>
      </xs:simpleType>
    </xs:attribute>
    <xs:attribute name="month" type="month-type" use="optional"/>
  </xs:complexType>
  <xs:complexType name="recurrence-weekly">
    <xs:choice>
      <xs:sequence>
        <xs:element name="monday"/>
        <xs:element name="tuesday" minOccurs="0"/>
        <xs:element name="wednesday" minOccurs="0"/>
        <xs:element name="thursday" minOccurs="0"/>
        <xs:element name="friday" minOccurs="0"/>
        <xs:element name="saturday" minOccurs="0"/>
        <xs:element name="sunday" minOccurs="0"/>
      </xs:sequence>
      <xs:sequence>
        <xs:element name="tuesday"/>
        <xs:element name="wednesday" minOccurs="0"/>
        <xs:element name="thursday" minOccurs="0"/>
        <xs:element name="friday" minOccurs="0"/>
        <xs:element name="saturday" minOccurs="0"/>
        <xs:element name="sunday" minOccurs="0"/>
      </xs:sequence>
      <xs:sequence>
        <xs:element name="wednesday"/>
        <xs:element name="thursday" minOccurs="0"/>
        <xs:element name="friday" minOccurs="0"/>
        <xs:element name="saturday" minOccurs="0"/>
        <xs:element name="sunday" minOccurs="0"/>
      </xs:sequence>
      <xs:sequence>
        <xs:element name="thursday"/>
        <xs:element name="friday" minOccurs="0"/>
        <xs:element name="saturday" minOccurs="0"/>
        <xs:element name="sunday" minOccurs="0"/>
      </xs:sequence>
      <xs:sequence>
        <xs:element name="friday"/>
        <xs:element name="saturday" minOccurs="0"/>
        <xs:element name="sunday" minOccurs="0"/>
      </xs:sequence>
      <xs:sequence>
        <xs:element name="saturday"/>
        <xs:element name="sunday" minOccurs="0"/>
      </xs:sequence>
      <xs:sequence>
        <xs:element name="sunday"/>
      </xs:sequence>
    </xs:choice>
  </xs:complexType>
  <xs:complexType name="recurrence-monthly">
    <xs:sequence>
      <xs:choice minOccurs="1" maxOccurs="1">
        <xs:element name="x-day-b" type="x-day-b-monthly"/>
        <xs:element name="day-varying" type="day-varying-type"/>
        <xs:element name="day" type="day-type"/>
      </xs:choice>
    </xs:sequence>
    <xs:attribute name="every-n" use="required">
      <xs:simpleType>
        <xs:restriction base="xs:string">
          <xs:enumeration value="1"/>
          <xs:enumeration value="2"/>
          <xs:enumeration value="3"/>
          <xs:enumeration value="4"/>
          <xs:enumeration value="5"/>
          <xs:enumeration value="6"/>
          <xs:enumeration value="7"/>
          <xs:enumeration value="8"/>
          <xs:enumeration value="9"/>
          <xs:enumeration value="10"/>
          <xs:enumeration value="11"/>
          <xs:enumeration value="12"/>
          <xs:enumeration value="weekday"/>
        </xs:restriction>
      </xs:simpleType>
    </xs:attribute>
  </xs:complexType>
  <xs:complexType name="recurrence-yearly">
    <xs:sequence>
      <xs:choice minOccurs="1" maxOccurs="1">
        <xs:element name="x-day-b" type="x-day-b-yearly"/>
        <xs:element name="day-varying" type="day-varying-type"/>
        <xs:element name="day" type="day-type"/>
      </xs:choice>
    </xs:sequence>
    <xs:attribute name="every-n" use="required">
      <xs:simpleType>
        <xs:restriction base="xs:integer">
          <xs:enumeration value="1"/>
        </xs:restriction>
      </xs:simpleType>
    </xs:attribute>
  </xs:complexType>
  <xs:element name="recurrences">
    <xs:complexType>
      <xs:sequence>
        <xs:choice minOccurs="1" maxOccurs="1">
          <xs:element name="monthly" type="recurrence-monthly"/>
          <xs:element name="yearly" type="recurrence-yearly"/>
          <xs:element name="weekly" type="recurrence-weekly"/>
          <xs:element name="daily" type="everyn"/>
          <xs:element name="hourly" type="everyn"/>
        </xs:choice>
      </xs:sequence>
    </xs:complexType>
  </xs:element>
</xs:schema>',
	LOCAL => FALSE
	);
END;
/
CREATE OR REPLACE TRIGGER csr.validate_schedule_xml
BEFORE INSERT OR UPDATE
	ON csr.delegation
	FOR EACH ROW
DECLARE
	v_schedule_xml			XMLTYPE;
	v_schema_url			VARCHAR2(255) := 'http://www.cr360.com/XMLSchemas/recurrences.xsd';
BEGIN
	IF :new.schedule_xml IS NOT NULL THEN 
		v_schedule_xml := XMLTYPE(:new.schedule_xml, v_schema_url);
		v_schedule_xml.SchemaValidate();
	END IF;
END;
/
ALTER TABLE CSR.TEMP_METER_READING_ROWS ADD (
	METER_INPUT_ID      NUMBER(10, 0)
);
ALTER TABLE CSR.TEMP_METER_READING_ROWS DROP (
	COST
) CASCADE CONSTRAINTS;
DROP SEQUENCE csr.property_tab_mobile_id_seq;
DROP TABLE csr.property_tab_mobile;
DROP TABLE csrimp.property_tab_mobile;
DROP TABLE csrimp.map_property_tab_mobile;


grant select, insert, update, delete on csrimp.r_report_type to web_user;
grant select, insert, update, delete on csrimp.r_report to web_user;
grant select, insert, update, delete on csrimp.r_report_file to web_user;
grant select, insert, update on csr.r_report_type to csrimp;
grant select, insert, update on csr.r_report to csrimp;
grant select, insert, update on csr.r_report_file to csrimp;
grant select on csr.r_report_type_id_seq to csrimp;
grant select on csr.r_report_file_id_seq to csrimp;
GRANT INSERT ON CSR.FLOW_ALERT_HELPER TO CSRIMP;
GRANT INSERT ON CSR.ISSUE_CUSTOM_FIELD_DATE_VAL TO CSRIMP;
GRANT INSERT ON CSR.QUICK_SURVEY_SCORE_THRESHOLD TO CSRIMP;
GRANT INSERT ON CSR.QUICK_SURVEY_CSS TO CSRIMP;
GRANT INSERT ON CSR.SUPPLIER_SURVEY_RESPONSE TO CSRIMP;
GRANT SELECT, INSERT, UPDATE, DELETE ON CSRIMP.QUICK_SURVEY_SCORE_THRESHOLD TO WEB_USER;
GRANT SELECT, INSERT, UPDATE, DELETE ON CSRIMP.SUPPLIER_SURVEY_RESPONSE TO WEB_USER;
GRANT SELECT ON chain.filter_item_config TO csr;
grant select, insert, update on chain.filter_item_config to csrimp;
grant select, insert, update, delete on csrimp.chain_filter_item_config to web_user;




CREATE OR REPLACE VIEW CHAIN.v$company AS
	SELECT c.app_sid, c.company_sid, c.created_dtm, c.name, c.active, c.activated_dtm, c.deactivated_dtm,
		   c.address_1, c.address_2, c.address_3, c.address_4, c.state, c.city, c.postcode, c.country_code,
		   c.phone, c.fax, c.website, c.email, c.deleted, c.details_confirmed, c.stub_registration_guid, 
		   c.allow_stub_registration, c.approve_stub_registration, c.mapping_approval_required, 
		   c.user_level_messaging, c.sector_id,
		   cou.name country_name, s.description sector_description, c.can_see_all_companies, c.company_type_id,
		   ct.lookup_key company_type_lookup, ct.singular company_type_description, c.supp_rel_code_label, c.supp_rel_code_label_mand,
		   c.parent_sid, p.name parent_name, p.country_code parent_country_code, pcou.name parent_country_name,
		   c.country_is_hidden, cs.region_sid
	  FROM company c
	  JOIN customer_options co ON co.app_sid = c.app_sid
	  LEFT JOIN postcode.country cou ON c.country_code = cou.country
	  LEFT JOIN sector s ON c.sector_id = s.sector_id AND c.app_sid = s.app_sid
	  LEFT JOIN company_type ct ON c.company_type_id = ct.company_type_id
	  LEFT JOIN company p ON c.parent_sid = p.company_sid AND c.app_sid = p.app_sid
	  LEFT JOIN postcode.country pcou ON p.country_code = pcou.country
	  LEFT JOIN csr.supplier cs ON cs.company_sid = c.company_sid AND cs.app_sid = c.app_sid
	 WHERE c.deleted = 0
;
CREATE OR REPLACE VIEW csr.v$temp_meter_reading_rows AS
       SELECT t.source_row, t.region_sid, t.start_dtm, t.end_dtm, t.reference, t.note, t.reset_val, t.error_msg, 
              v.consumption consumption, c.consumption cost
	    FROM ( SELECT DISTINCT source_row,
			    region_sid,
			    start_dtm,
			    end_dtm,
			    REFERENCE,
			    note,
			    reset_val,
			    error_msg
    			FROM csr.temp_meter_reading_rows
			  ) t 
	LEFT JOIN csr.temp_meter_reading_rows v
		   ON v.source_row       = t.source_row
		  AND t.region_sid      =v.region_sid
		  AND v.meter_input_id IN (SELECT meter_input_id
									FROM csr.meter_input
									WHERE app_sid  = SYS_CONTEXT('SECURITY', 'APP')
									AND lookup_key = 'CONSUMPTION'
								  )
	LEFT JOIN csr.temp_meter_reading_rows c
		   ON c.source_row       = t.source_row
		  AND t.region_sid      =c.region_sid
		  AND c.meter_input_id IN (SELECT meter_input_id
									FROM csr.meter_input
									WHERE app_sid  = SYS_CONTEXT('SECURITY', 'APP')
									AND lookup_key = 'COST'
								  );




BEGIN
	INSERT INTO postcode.country (country, name, latitude, longitude, area_in_sqkm, continent, currency, iso3, is_standard)
	VALUES ('cw', 'Curacao', 12.7, -68.6, 444, 'SA', 'ANG', 'cuw', 1);
EXCEPTION 
	WHEN DUP_VAL_ON_INDEX THEN NULL;
END;
/
BEGIN
	INSERT INTO postcode.country (country, name, latitude, longitude, area_in_sqkm, continent, currency, iso3, is_standard)
	VALUES ('bq', 'Bonaire, Sint Eustatius and Saba', 12.11, -68.14, 328, 'SA', 'USD', 'bes', 1);
EXCEPTION 
	WHEN DUP_VAL_ON_INDEX THEN NULL;
END;
/
BEGIN
	INSERT INTO postcode.country (country, name, latitude, longitude, area_in_sqkm, continent, currency, iso3, is_standard)
	VALUES ('sx', 'Sint Maarten', 18.02, -63.03, 34, 'SA', 'ANG', 'sxm', 1);
EXCEPTION 
	WHEN DUP_VAL_ON_INDEX THEN NULL;
END;
/
DECLARE
    v_class_id    NUMBER(10);
BEGIN   
    security.user_pkg.logonadmin;
    security.class_pkg.CreateClass(SYS_CONTEXT('SECURITY','ACT'), null, 'CSRRReport', 'csr.r_report_pkg', null, v_class_id);
EXCEPTION
    WHEN security.security_pkg.DUPLICATE_OBJECT_NAME THEN NULL;
END;
/
BEGIN
	INSERT INTO csr.module (module_id, module_name, enable_sp, description)
		 VALUES (9999, 'R Reports', 'EnableRReports', 'Enables R reports');
EXCEPTION
	WHEN DUP_VAL_ON_INDEX THEN NULL;
END;
/
BEGIN
	INSERT INTO csr.plugin_type (plugin_type_id, description) VALUES (15, 'R Report');
	INSERT INTO csr.plugin (plugin_type_id, plugin_id, description,
							js_include, js_class, cs_class, r_script_path)
	VALUES (15, csr.plugin_id_seq.NEXTVAL, 'Validation report',
			'/csr/site/rreports/reports/Validation.js', 'Credit360.RReports.Validation',
			'Credit360.RReports.Runners.ValidationReportRunner', '/csr/rreports/validation_V5/validation_V5.R');
EXCEPTION
	WHEN DUP_VAL_ON_INDEX THEN NULL;
END;
/
BEGIN
    INSERT INTO csr.batch_job_type (batch_job_type_id, description, plugin_name, one_at_a_time)
         VALUES (22, 'R Reports', 'r-reports', 1);
EXCEPTION
	WHEN DUP_VAL_ON_INDEX THEN NULL;
END;
/
INSERT INTO csr.auto_exp_exporter_plugin (plugin_id, label, exporter_assembly, outputter_assembly)
VALUES (13, 'Stored Procedure - Dsv', 'Credit360.AutomatedExportImport.Export.Exporters.StoredProcedure.StoredProcedureExporter', 'Credit360.AutomatedExportImport.Export.Exporters.StoredProcedure.StoredProcedureDsvOutputter');
INSERT INTO csr.auto_exp_exporter_plugin (plugin_id, label, exporter_assembly, outputter_assembly)
VALUES (14, 'ABInBev - Mean Scores (dsv) ', 'Credit360.AutomatedExportImport.Export.Exporters.AbInBev.MeanScoresExporter', 'Credit360.AutomatedExportImport.Export.Exporters.AbInBev.MeanScoresDsvOutputter');
INSERT INTO csr.auto_exp_exporter_plugin (plugin_id, label, exporter_assembly, outputter_assembly)
VALUES (15, 'ABInBev - Suep Mean Scores (dsv) ', 'Credit360.AutomatedExportImport.Export.Exporters.AbInBev.SuepMeanScoresExporter', 'Credit360.AutomatedExportImport.Export.Exporters.AbInBev.SuepMeanScoresDsvOutputter');
INSERT INTO chain.filter_item_config (app_sid, card_group_id, card_id, item_name, label, pos, include_in_filter, include_in_breakdown, include_in_advanced)
SELECT cip.app_sid, cip.card_group_id, cip.card_id, 'invitationStatusId', 'Invitation status', 11,
	   CASE WHEN LOWER(cip.value)='true' THEN 0 ELSE 1 END,
	   CASE WHEN LOWER(cip.value)='true' THEN 0 ELSE 1 END,
	   CASE WHEN LOWER(cip.value)='true' THEN 0 ELSE 1 END
  FROM chain.card_init_param cip
 WHERE cip.key='hideInvitationStatusFilter';
DELETE FROM chain.card_init_param WHERE key='hideInvitationStatusFilter';
UPDATE csr.module_param SET param_hint = 'Site name' where param_name = 'siteName' AND module_id = 7;
UPDATE csr.module_param SET param_hint = 'Company name' where param_name = 'in_company_name' AND module_id = 13;
UPDATE csr.module_param SET param_hint = 'User name' where param_name = 'in_user' AND module_id = 15;
UPDATE csr.module_param SET param_hint = 'Password' where param_name = 'in_password' AND module_id = 15;
UPDATE csr.module_param SET param_hint = 'The path to the client''s Urjanet folder on our SFTP server (cyanoxantha): "client_name.urjanet"' WHERE param_name = 'in_ftp_path' AND module_id = 60;
UPDATE chain.filter_page_column
   SET column_name = 'city'
 WHERE card_group_id = 23
   AND column_name = 'cityName';
UPDATE chain.filter_page_column
   SET column_name = 'state'
 WHERE card_group_id = 23
   AND column_name = 'stateName';
INSERT INTO CSR.portlet (PORTLET_ID,NAME,TYPE,DEFAULT_STATE,SCRIPT_PATH) VALUES (1058,'Image Upload Button', 'Credit360.Portlets.ImageUploadButton', EMPTY_CLOB(), '/csr/site/portal/Portlets/ImageUploadButton.js');

DECLARE
	v_module_id NUMBER(2);
BEGIN	
	v_module_id := 61;
	INSERT INTO CSR.MODULE (module_id, module_name, enable_sp, description)
		VALUES (v_module_id, 'Enable Client Connect', 'EnableClientConnect', 'Enable Client Connect');	 
	--Add the params
	INSERT INTO CSR.MODULE_PARAM (MODULE_ID, PARAM_NAME, POS, PARAM_HINT)
	  VALUES (v_module_id, 'in_admin_access', 0, 'Admin Access (default=y)');
	INSERT INTO CSR.MODULE_PARAM (MODULE_ID, PARAM_NAME, POS, PARAM_HINT)
	  VALUES (v_module_id, 'in_handling_office', 1, 'Handling Office (eg=Cambridge)');
	INSERT INTO CSR.MODULE_PARAM (MODULE_ID, PARAM_NAME, POS, PARAM_HINT)
	  VALUES (v_module_id, 'in_customer_name', 2, 'Customer Name');
	INSERT INTO CSR.MODULE_PARAM (MODULE_ID, PARAM_NAME, POS, PARAM_HINT)
	  VALUES (v_module_id, 'in_parent_host', 3, 'Parent Host (www.credit360.com)');
	v_module_id := 62;
	INSERT INTO CSR.MODULE (module_id, module_name, enable_sp, description)
		VALUES (v_module_id, 'Enable Fogbugz', 'EnableFogbugz', 'Enable Support Cases for Client Connect');	 
	--Add the params
	INSERT INTO CSR.MODULE_PARAM (MODULE_ID, PARAM_NAME, POS, PARAM_HINT)
	  VALUES (v_module_id, 'in_customer_fogbugz_project_id', 0, 'Old id for pulling historical cases, or 0 if none');
	INSERT INTO CSR.MODULE_PARAM (MODULE_ID, PARAM_NAME, POS, PARAM_HINT)
	  VALUES (v_module_id, 'in_customer_fogbugz_area', 1, 'Text of the new area to search for in XLog projects');
END;
/
INSERT INTO csr.batch_job_type (batch_job_type_id, description, plugin_name, one_at_a_time, notify_address, notify_after_attempts)
VALUES (21, 'Batch Property Geocode', 'batch-prop-geocode', 1, 'support@credit360.com', 3);


UNDEFINE ex_if
COLUMN ex_if NEW_VALUE ex_if
SELECT CASE WHEN COUNT(*) = 0 THEN 'null_script' ELSE '..\ethics\course_body' END AS ex_if FROM all_users WHERE username = 'ETHICS';
@&ex_if
UNDEFINE ex_if


CREATE OR REPLACE PACKAGE csr.r_report_pkg AS END;
/
grant execute on csr.r_report_pkg to web_user;
grant execute on csr.r_report_pkg to security;
CREATE OR REPLACE PACKAGE CSR.IMAGE_UPLOAD_PORTLET_PKG AS END;
/
GRANT execute ON CSR.IMAGE_UPLOAD_PORTLET_PKG TO web_user;
GRANT SELECT, INSERT, UPDATE ON CSR.IMAGE_UPLOAD_PORTLET to csrimp;
GRANT SELECT ON CSR.IMAGE_UPLOAD_PORTLET_SEQ to csrimp;
GRANT SELECT ON CSR.IMAGE_UPLOAD_PORTLET_SEQ to csr;


@..\batch_job_pkg
@..\calc_pkg
@..\csr_data_pkg
@..\enable_pkg
@..\indicator_pkg
@..\region_pkg
@..\plugin_pkg
@..\r_report_pkg
@..\schema_pkg
@..\csrimp\imp_pkg
@..\automated_import_pkg
@..\audit_pkg
@..\automated_export_pkg
@..\chain\filter_pkg
@..\supplier_pkg
@..\region_metric_pkg
@..\chain\company_pkg
@..\chain\chain_pkg
@..\chain\invitation_pkg
@..\..\..\postcode\db\geo_region_pkg
@..\image_upload_portlet_pkg
@..\property_pkg
@..\meter_monitor_pkg
@..\meter_pkg
@..\actions\gantt_pkg
@..\supplier\company_pkg
@..\issue_pkg
@..\region_tree_pkg
@..\templated_report_pkg


@..\calc_body
@..\csr_app_body
@..\csr_user_body
@..\enable_body
@..\indicator_body
@..\region_body
@..\plugin_body
@..\r_report_body
@..\schema_body
@..\csrimp\imp_body
@..\automated_import_body
@..\automated_export_body
@..\audit_body
@..\activity_body
@..\chain\filter_body
@..\chain\company_filter_body
@..\supplier_body
@..\meter_body
@..\region_metric_body
@..\chain\helper_body
@..\chain\company_body
@..\chain\report_body
@..\chain\chain_body
@..\chain\invitation_body
@..\..\..\postcode\db\geo_region_body
@..\quick_survey_body
@..\image_upload_portlet_body
@..\customer_body
@..\sheet_body
@..\section_body
@..\delegation_body
@..\alert_body
@..\property_body
@..\meter_monitor_body
@..\..\..\aspen2\db\tree_body
@..\..\..\aspen2\cms\db\pivot_body
@..\..\..\aspen2\DynamicTables\db\schema_body
@..\actions\gantt_body
@..\actions\initiative_body
@..\actions\importer_body
@..\actions\periodic_alert_body
@..\actions\task_body
@..\chain\setup_body
@..\chain\type_capability_body
@..\chem\substance_body
@..\supplier\company_body
@..\supplier\chain\message_body
@..\doc_body
@..\energy_star_job_body
@..\initiative_aggr_body
@..\initiative_doc_body
@..\initiative_alert_body
@..\initiative_body
@..\issue_body
@..\meter_alarm_body
@..\meter_patch_body
@..\meter_report_body
@..\region_tree_body
@..\ruleset_body
@..\stored_calc_datasource_body
@..\teamroom_body
@..\templated_report_body
@..\templated_report_schedule_body
@..\user_cover_body
@..\unit_test_body


@update_tail
