-- Please update version.sql too -- this keeps clean builds in sync
define version=1237
@update_header

DROP INDEX CSR.IX_USER_METER_APPROVED;
ALTER TABLE CSR.ALL_METER DROP CONSTRAINT FK_USER_METER_APPROVED;

ALTER TABLE CSR.ALL_METER RENAME COLUMN APPPROVED_BY_SID TO APPROVED_BY_SID;

ALTER TABLE CSR.ALL_METER ADD CONSTRAINT FK_USER_METER_APPROVED 
    FOREIGN KEY (APP_SID, APPROVED_BY_SID)
    REFERENCES CSR.CSR_USER(APP_SID, CSR_USER_SID)
;

CREATE INDEX CSR.IX_USER_METER_APPROVED ON CSR.ALL_METER (APP_SID, APPROVED_BY_SID);

CREATE OR REPLACE VIEW csr.METER
	(APP_SID,REGION_SID, NOTE, PRIMARY_IND_SID, PRIMARY_MEASURE_CONVERSION_ID, METER_SOURCE_TYPE_ID, REFERENCE, CRC_METER, COST_IND_SID, COST_MEASURE_CONVERSION_ID, DAYS_IND_SID, DAYS_MEASURE_CONVERSION_ID, COSTDAYS_IND_SID, COSTDAYS_MEASURE_CONVERSION_ID, APPROVED_BY_SID, APPROVED_DTM) AS
  SELECT APP_SID,REGION_SID, NOTE, PRIMARY_IND_SID, PRIMARY_MEASURE_CONVERSION_ID, METER_SOURCE_TYPE_ID, REFERENCE, CRC_METER,
	COST_IND_SID, COST_MEASURE_CONVERSION_ID, DAYS_IND_SID, DAYS_MEASURE_CONVERSION_ID, COSTDAYS_IND_SID, COSTDAYS_MEASURE_CONVERSION_ID,
	APPROVED_BY_SID, APPROVED_DTM
    FROM ALL_METER
   WHERE ACTIVE = 1;

@update_tail
