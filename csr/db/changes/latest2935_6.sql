-- Please update version.sql too -- this keeps clean builds in sync
define version=2935
define minor_version=6
@update_header

-- *** DDL ***
-- Create tables

-- Alter tables
CREATE SEQUENCE CHAIN.REFERENCE_ID_SEQ
	START WITH 1
	INCREMENT BY 1
	NOMINVALUE
	NOMAXVALUE
	CACHE 20
	NOORDER
;

CREATE SEQUENCE CHAIN.COMPANY_REFERENCE_ID_SEQ
	START WITH 1
	INCREMENT BY 1
	NOMINVALUE
	NOMAXVALUE
	CACHE 20
	NOORDER
;


ALTER TABLE CHAIN.REFERENCE ADD REFERENCE_ID NUMBER(10, 0);
ALTER TABLE CHAIN.COMPANY_REFERENCE ADD REFERENCE_ID NUMBER(10, 0);
ALTER TABLE CHAIN.COMPANY_REFERENCE ADD COMPANY_REFERENCE_ID NUMBER(10, 0);

BEGIN
	security.user_pkg.logonadmin; --all sites
	
	UPDATE chain.reference
	   SET reference_id = chain.reference_id_seq.nextval;
	   
	UPDATE chain.company_reference
	   SET company_reference_id = chain.company_reference_id_seq.nextval;
		 
	UPDATE chain.company_reference cr
	   SET cr.reference_id = (
			SELECT reference_id
			  FROM chain.reference r
			 WHERE r.app_sid = cr.app_sid
			   AND r.lookup_key = cr.lookup_key
	   );
	
END;
/

ALTER TABLE CHAIN.REFERENCE MODIFY REFERENCE_ID NUMBER(10, 0) NOT NULL;

ALTER TABLE CHAIN.COMPANY_REFERENCE DROP PRIMARY KEY DROP INDEX;
ALTER TABLE CHAIN.COMPANY_REFERENCE DROP CONSTRAINT FK_REF_COMPANY_REF;
ALTER TABLE CHAIN.COMPANY_REFERENCE RENAME COLUMN LOOKUP_KEY TO XXX_LOOKUP_KEY;

ALTER TABLE CHAIN.REFERENCE DROP PRIMARY KEY DROP INDEX;
ALTER TABLE CHAIN.REFERENCE ADD CONSTRAINT UC_REFERENCE UNIQUE (APP_SID, LOOKUP_KEY);
ALTER TABLE CHAIN.REFERENCE ADD CONSTRAINT PK_REFERENCE PRIMARY KEY (APP_SID, REFERENCE_ID);

ALTER TABLE CHAIN.COMPANY_REFERENCE ADD CONSTRAINT FK_REF_COMPANY_REF 
	FOREIGN KEY (APP_SID, REFERENCE_ID) REFERENCES CHAIN.REFERENCE(APP_SID, REFERENCE_ID);

ALTER TABLE CHAIN.COMPANY_REFERENCE MODIFY REFERENCE_ID NUMBER(10, 0) NOT NULL;

ALTER TABLE CHAIN.COMPANY_REFERENCE ADD CONSTRAINT PK_COMPANY_REFERENCE PRIMARY KEY (APP_SID, COMPANY_REFERENCE_ID);
ALTER TABLE CHAIN.COMPANY_REFERENCE ADD CONSTRAINT UC_COMPANY_REFERENCE UNIQUE (APP_SID, REFERENCE_ID, COMPANY_SID);

--csrimp
ALTER TABLE CSRIMP.CHAIN_REFERENCE ADD REFERENCE_ID NUMBER(10, 0) NOT NULL;
ALTER TABLE CSRIMP.CHAIN_COMPANY_REFERENCE ADD COMPANY_REFERENCE_ID NUMBER(10, 0) NOT NULL; 
ALTER TABLE CSRIMP.CHAIN_COMPANY_REFERENCE ADD REFERENCE_ID NUMBER(10, 0) NOT NULL;

ALTER TABLE CSRIMP.CHAIN_REFERENCE DROP CONSTRAINT PK_CHAIN_REFERENCE;
ALTER TABLE CSRIMP.CHAIN_COMPANY_REFERENCE DROP CONSTRAINT PK_CHAIN_COMPANY_REFERENCE;
ALTER TABLE CSRIMP.CHAIN_COMPANY_REFERENCE DROP COLUMN LOOKUP_KEY;

ALTER TABLE CSRIMP.CHAIN_REFERENCE ADD CONSTRAINT PK_CHAIN_REFERENCE PRIMARY KEY (CSRIMP_SESSION_ID, REFERENCE_ID);
ALTER TABLE CSRIMP.CHAIN_COMPANY_REFERENCE ADD CONSTRAINT PK_CHAIN_COMPANY_REFERENCE PRIMARY KEY (CSRIMP_SESSION_ID, COMPANY_REFERENCE_ID);

CREATE TABLE CSRIMP.MAP_CHAIN_REFERENCE (
	CSRIMP_SESSION_ID NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	OLD_REFERENCE_ID NUMBER(10) NOT NULL,
	NEW_REFERENCE_ID  NUMBER(10) NOT NULL,
	CONSTRAINT PK_MAP_CHAIN_REFERENCE primary key (csrimp_session_id, OLD_REFERENCE_ID) USING INDEX,
	CONSTRAINT UK_MAP_CHAIN_REFERENCE unique (csrimp_session_id, NEW_REFERENCE_ID) USING INDEX,
	CONSTRAINT FK_MAP_CHAIN_REFERENCE FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

-- *** Grants ***
grant select on chain.reference_id_seq to csrimp;
grant select on chain.company_reference_id_seq to csrimp;

-- ** Cross schema constraints ***

-- *** Views ***
-- Please paste the content of the view and add a comment referencing the path of the create_views file which will contain your view changes.
--C:\cvs\csr\db\chain\create_views.sql
CREATE OR REPLACE VIEW chain.v$company_reference AS
	SELECT cr.app_sid, cr.company_reference_id, cr.company_sid, cr.value, cr.reference_id, r.lookup_key
	  FROM chain.company_reference cr
	  JOIN chain.reference r ON r.app_sid = cr.app_sid AND r.reference_id = cr.reference_id;
-- *** Data changes ***
-- RLS

-- Data

-- ** New package grants **

-- *** Conditional Packages ***

-- *** Packages ***
@../chain/company_pkg
@../chain/company_body
@../chain/company_filter_body
@../chain/helper_body
@../chain/report_body
@../schema_body
@../csrimp/imp_body

@update_tail
