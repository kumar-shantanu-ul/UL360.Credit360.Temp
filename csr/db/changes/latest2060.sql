-- Please update version.sql too -- this keeps clean builds in sync
define version=2060
@update_header

ALTER TABLE CSRIMP.CHAIN_COMPAN_TYPE_CAPABI DROP PRIMARY KEY;

ALTER TABLE CSRIMP.CHAIN_IMPLEMENTATION DROP PRIMARY KEY;

-- Data tables
CREATE TABLE CSRIMP.CHAIN_CAPABILITY (
	CSRIMP_SESSION_ID NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	CAPABILITY_ID NUMBER(10,0) NOT NULL,
	CAPABILITY_NAME VARCHAR2(100) NOT NULL,
	CAPABILITY_TYPE_ID NUMBER(10,0) NOT NULL,
	IS_SUPPLIER NUMBER(1,0) NOT NULL,
	PERM_TYPE NUMBER(10,0) NOT NULL,
	CONSTRAINT PK_CHAIN_CAPABILITY PRIMARY KEY (CSRIMP_SESSION_ID, CAPABILITY_ID),
	CONSTRAINT FK_CHAIN_CAPABILITY_IS FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

-- Map tables
CREATE TABLE CSRIMP.MAP_CHAIN_CAPABILITY (
	CSRIMP_SESSION_ID NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	OLD_CAPABILITY_ID NUMBER(10) NOT NULL,
	NEW_CAPABILITY_ID NUMBER(10) NOT NULL,
	CONSTRAINT PK_MAP_CHAIN_CAPABILITY PRIMARY KEY (OLD_CAPABILITY_ID) USING INDEX,
	CONSTRAINT UK_MAP_CHAIN_CAPABILITY UNIQUE (NEW_CAPABILITY_ID) USING INDEX,
	CONSTRAINT FK_MAP_CHAIN_CAPABILITY_IS FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

-- Package grants
grant select, insert, update, delete on csrimp.chain_capability to web_user;

-- Object grants
grant select, insert, update on chain.capability to csrimp;
grant select, insert, update on chain.capability to CSR;

grant select on chain.capability_id_seq to csrimp;
grant select on chain.capability_id_seq to CSR;

@update_tail
