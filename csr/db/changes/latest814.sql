-- Please update version.sql too -- this keeps clean builds in sync
define version=814
@update_header

INSERT INTO csr.source_type (source_type_id, description)
VALUES (12, 'Aggregate group');

ALTER TABLE CSR.IND DROP CONSTRAINT CK_IND_TYPE;
ALTER TABLE CSR.IND ADD (
	CONSTRAINT CK_IND_TYPE CHECK (IND_TYPE IN (0,1,2,3))
);

CREATE SEQUENCE CSR.AGGREGATE_IND_GROUP_ID_SEQ
    START WITH 1
    INCREMENT BY 1
    NOMINVALUE
    NOMAXVALUE
    CACHE 5
    NOORDER
;

CREATE TABLE CSR.AGGREGATE_IND_GROUP(
    APP_SID                   NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    AGGREGATE_IND_GROUP_ID    NUMBER(10, 0)    NOT NULL,
    HELPER_PROC               VARCHAR2(255)    NOT NULL,
    NAME                      VARCHAR2(64),
    CONSTRAINT PK_AGGREGATE_IND_GROUP PRIMARY KEY (APP_SID, AGGREGATE_IND_GROUP_ID)
)
;

CREATE TABLE CSR.AGGREGATE_IND_GROUP_MEMBER(
    APP_SID                   NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    AGGREGATE_IND_GROUP_ID    NUMBER(10, 0)    NOT NULL,
    IND_SID                   NUMBER(10, 0)    NOT NULL,
    CONSTRAINT PK_AGGREGATE_IND_GROUP_MEMBER PRIMARY KEY (APP_SID, AGGREGATE_IND_GROUP_ID, IND_SID),
    CONSTRAINT UC_AGG_IND_GRP_MBR_IND  UNIQUE (APP_SID, IND_SID)
)
;


CREATE TABLE CSR.AGGREGATE_IND_CALC_JOB(
    APP_SID                   NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    AGGREGATE_IND_GROUP_ID    NUMBER(10, 0)    NOT NULL,
    PROCESSING                NUMBER(1, 0)     NOT NULL,
    START_DTM                 DATE             NOT NULL,
    END_DTM                   DATE             NOT NULL,
    CONSTRAINT CK_AGG_CALC_JOB_DATES CHECK (END_DTM > START_DTM AND TRUNC(END_DTM,'MONTH')=END_DTM AND TRUNC(START_DTM,'MONTH')=START_DTM),
    CONSTRAINT CK_AGG_CALC_JOB_PROCESSING CHECK (PROCESSING IN (0,1)),
    CONSTRAINT PK_AGG_IND_RECALC_JOB PRIMARY KEY (APP_SID, AGGREGATE_IND_GROUP_ID, PROCESSING)
)
;

CREATE INDEX CSR.IX_AGG_CALC_JOB_GRP ON CSR.AGGREGATE_IND_CALC_JOB(APP_SID, AGGREGATE_IND_GROUP_ID)
;

ALTER TABLE CSR.AGGREGATE_IND_CALC_JOB ADD CONSTRAINT FK_AGG_CALC_JOB_IND_GRP 
    FOREIGN KEY (APP_SID, AGGREGATE_IND_GROUP_ID)
    REFERENCES CSR.AGGREGATE_IND_GROUP(APP_SID, AGGREGATE_IND_GROUP_ID)
;


ALTER TABLE CSR.AGGREGATE_IND_GROUP ADD CONSTRAINT FK_AGG_IND_GRP_APP_SID 
    FOREIGN KEY (APP_SID)
    REFERENCES CSR.CUSTOMER(APP_SID)
;


ALTER TABLE CSR.AGGREGATE_IND_GROUP_MEMBER ADD CONSTRAINT FK_AGGREGATE_IND_GRP 
    FOREIGN KEY (APP_SID, AGGREGATE_IND_GROUP_ID)
    REFERENCES CSR.AGGREGATE_IND_GROUP(APP_SID, AGGREGATE_IND_GROUP_ID)
;

ALTER TABLE CSR.AGGREGATE_IND_GROUP_MEMBER ADD CONSTRAINT FK_AGGREGATE_IND_IND 
    FOREIGN KEY (APP_SID, IND_SID)
    REFERENCES CSR.IND(APP_SID, IND_SID)
;

@..\calc_pkg
@..\stored_calc_datasource_pkg
@..\csr_data_pkg

@..\calc_body
@..\stored_calc_datasource_body
@..\templated_report_body
@..\sheet_body
@..\indicator_body
@..\system_status_body

@update_tail