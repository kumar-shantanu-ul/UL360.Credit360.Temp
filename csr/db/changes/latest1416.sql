-- Please update version.sql too -- this keeps clean builds in sync
define version=1416
@update_header

ALTER TABLE CSR.QUICK_SURVEY_SUBMISSION DROP COLUMN PERIOD_START_DTM;
ALTER TABLE CSR.QUICK_SURVEY_SUBMISSION DROP COLUMN PERIOD_END_DTM;

ALTER TABLE CSR.QUICK_SURVEY DROP CONSTRAINT CHK_QS_END_UOM_VALID;
ALTER TABLE CSR.QUICK_SURVEY DROP CONSTRAINT CHK_QS_END_OFFSET_POSITIVE;
ALTER TABLE CSR.QUICK_SURVEY DROP CONSTRAINT CHK_QUICK_SURVEY_PERIOD_OFFSET;
ALTER TABLE CSR.QUICK_SURVEY RENAME COLUMN SUBMISSION_PERIOD_END_OFFSET TO SUBMISSION_VALIDITY_MONTHS;
UPDATE CSR.QUICK_SURVEY SET SUBMISSION_VALIDITY_MONTHS = 36;
ALTER TABLE CSR.QUICK_SURVEY MODIFY SUBMISSION_VALIDITY_MONTHS DEFAULT 36 NOT NULL;
ALTER TABLE CSR.QUICK_SURVEY DROP COLUMN SUBMISSION_PERIOD_END_UOM;
ALTER TABLE CSR.QUICK_SURVEY DROP COLUMN SUBMISSION_PERIOD_START;

ALTER TABLE CSR.QUICK_SURVEY ADD CONSTRAINT CHK_QS_VALID_MONTHS_POSITIVE CHECK (SUBMISSION_VALIDITY_MONTHS > 0);

declare
	v_exists number;
begin
	select count(*)
	  into v_exists
	  from all_tab_columns
	 where owner='CSR' and table_name='SUPPLIER_SURVEY_RESPONSE' and column_name='DEP_PERIOD_START_DTM';
	if v_exists = 1 then
		execute immediate 'ALTER TABLE CSR.SUPPLIER_SURVEY_RESPONSE DROP COLUMN DEP_PERIOD_START_DTM';
	end if;
	
	select count(*)
	  into v_exists
	  from all_tab_columns
	 where owner='CSR' and table_name='SUPPLIER_SURVEY_RESPONSE' and column_name='DEP_PERIOD_END_DTM';
	if v_exists = 1 then
		execute immediate 'ALTER TABLE CSR.SUPPLIER_SURVEY_RESPONSE DROP COLUMN DEP_PERIOD_END_DTM';
	end if;
end;
/

DROP TABLE CSR.TEMP_RESPONSE_REGION;

CREATE GLOBAL TEMPORARY TABLE CSR.TEMP_RESPONSE_REGION
(
	RESPONSE_ID			NUMBER(10)	NOT NULL,
	REGION_SID			NUMBER(10)	NOT NULL,
	SUBMISSION_ID		NUMBER(10)  NOT NULL,
	PERIOD_START_DTM	DATE		NOT NULL,
	PERIOD_END_DTM		DATE		NOT NULL,
	CONSTRAINT PK_TEMP_RESPONSE_REGION PRIMARY KEY (RESPONSE_ID, SUBMISSION_ID)
) ON COMMIT DELETE ROWS;

ALTER TABLE CSR.SCORE_THRESHOLD ADD(
    MEASURE_LIST_INDEX        NUMBER(10, 0)
)
;

@..\quick_survey_body
@..\supplier_body
@..\indicator_body

@update_tail
