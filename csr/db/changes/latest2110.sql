-- Please update version.sql too -- this keeps clean builds in sync
define version=2110
@update_header

ALTER TABLE CSR.EST_ERROR DROP CONSTRAINT FK_EST_BUILDING_ERROR;
ALTER TABLE CSR.EST_ERROR ADD CONSTRAINT FK_EST_BUILDING_ERROR 
    FOREIGN KEY (APP_SID, EST_ACCOUNT_SID, PM_CUSTOMER_ID, PM_BUILDING_ID)
    REFERENCES CSR.EST_BUILDING(APP_SID, EST_ACCOUNT_SID, PM_CUSTOMER_ID, PM_BUILDING_ID)
DEFERRABLE INITIALLY DEFERRED
;

ALTER TABLE CSR.EST_ERROR DROP CONSTRAINT FK_EST_SPACE_ERROR;
ALTER TABLE CSR.EST_ERROR ADD CONSTRAINT FK_EST_SPACE_ERROR 
    FOREIGN KEY (APP_SID, EST_ACCOUNT_SID, PM_CUSTOMER_ID, PM_BUILDING_ID, PM_SPACE_ID)
    REFERENCES CSR.EST_SPACE(APP_SID, EST_ACCOUNT_SID, PM_CUSTOMER_ID, PM_BUILDING_ID, PM_SPACE_ID)
DEFERRABLE INITIALLY DEFERRED
;

ALTER TABLE CSR.EST_ERROR DROP CONSTRAINT FK_EST_EMETER_ERROR;
ALTER TABLE CSR.EST_ERROR ADD CONSTRAINT FK_EST_EMETER_ERROR 
    FOREIGN KEY (APP_SID, EST_ACCOUNT_SID, PM_CUSTOMER_ID, PM_BUILDING_ID, PM_ENERGY_METER_ID)
    REFERENCES CSR.EST_ENERGY_METER(APP_SID, EST_ACCOUNT_SID, PM_CUSTOMER_ID, PM_BUILDING_ID, PM_ENERGY_METER_ID)
DEFERRABLE INITIALLY DEFERRED
;

ALTER TABLE CSR.EST_ERROR DROP CONSTRAINT FK_EST_WMETER_ERROR;
ALTER TABLE CSR.EST_ERROR ADD CONSTRAINT FK_EST_WMETER_ERROR 
    FOREIGN KEY (APP_SID, EST_ACCOUNT_SID, PM_CUSTOMER_ID, PM_BUILDING_ID, PM_WATER_METER_ID)
    REFERENCES CSR.EST_WATER_METER(APP_SID, EST_ACCOUNT_SID, PM_CUSTOMER_ID, PM_BUILDING_ID, PM_WATER_METER_ID)
DEFERRABLE INITIALLY DEFERRED
;

@../energy_star_body

@update_tail