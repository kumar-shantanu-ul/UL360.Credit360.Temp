-- Please update version.sql too -- this keeps clean builds in sync
define version=509
@update_header


CREATE SEQUENCE VAR_EXPL_GROUP_ID_SEQ
    START WITH 1
    INCREMENT BY 1
    NOMINVALUE
    NOMAXVALUE
    CACHE 20
    NOORDER
;

CREATE SEQUENCE VAR_EXPL_ID_SEQ
    START WITH 1
    INCREMENT BY 1
    NOMINVALUE
    NOMAXVALUE
    CACHE 20
    NOORDER
;

ALTER TABLE IND ADD CONSTRAINT CK_IND_NORMALIZE CHECK (NORMALIZE IN (0,1));
 
ALTER TABLE DELEGATION_IND ADD (
	VAR_EXPL_GROUP_ID     NUMBER(10, 0)
)
;


CREATE TABLE VAR_EXPL(
    APP_SID              NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    VAR_EXPL_ID          NUMBER(10, 0)    NOT NULL,
    VAR_EXPL_GROUP_ID    NUMBER(10, 0)    NOT NULL,
    LABEL                VARCHAR2(255)    NOT NULL,
    POS					 NUMBER(10)        DEFAULT 0 NOT NULL,
    CONSTRAINT PK_VAR_EXPL PRIMARY KEY (APP_SID, VAR_EXPL_ID)
)
;

CREATE TABLE VAR_EXPL_GROUP(
    APP_SID              NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    VAR_EXPL_GROUP_ID    NUMBER(10, 0)    NOT NULL,
    LABEL                VARCHAR2(255)    NOT NULL,
    CONSTRAINT PK_VAR_EXPL_GROUP PRIMARY KEY (APP_SID, VAR_EXPL_GROUP_ID)
)
;



CREATE TABLE SHEET_VALUE_VAR_EXPL(
    APP_SID           NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    SHEET_VALUE_ID    NUMBER(10, 0)    NOT NULL,
    VAR_EXPL_ID       NUMBER(10, 0)    NOT NULL,
    CONSTRAINT PK_SHEET_VALUE_VAR_EXPL PRIMARY KEY (APP_SID, SHEET_VALUE_ID, VAR_EXPL_ID)
)
;

 
ALTER TABLE DELEGATION_IND ADD CONSTRAINT FK_DELEG_IND_VAR_EXPL_GR 
    FOREIGN KEY (APP_SID, VAR_EXPL_GROUP_ID)
    REFERENCES VAR_EXPL_GROUP(APP_SID, VAR_EXPL_GROUP_ID)
;
 

ALTER TABLE SHEET_VALUE_VAR_EXPL ADD CONSTRAINT FK_SH_VAL_SH_VAL_VAR_EXPL 
    FOREIGN KEY (APP_SID, SHEET_VALUE_ID)
    REFERENCES SHEET_VALUE(APP_SID, SHEET_VALUE_ID)
;

 ALTER TABLE VAR_EXPL ADD CONSTRAINT FK_VAR_EXPL_CUS
     FOREIGN KEY (APP_SID)
     REFERENCES CUSTOMER(APP_SID)
 ;
 
ALTER TABLE VAR_EXPL ADD CONSTRAINT FK_VAR_EXPL_VAR_EXPL_GROUP 
    FOREIGN KEY (APP_SID, VAR_EXPL_GROUP_ID)
    REFERENCES VAR_EXPL_GROUP(APP_SID, VAR_EXPL_GROUP_ID)
;
 
ALTER TABLE VAR_EXPL_GROUP ADD CONSTRAINT FK_VAR_EXPL_GROUP_CUST 
     FOREIGN KEY (APP_SID)
     REFERENCES CUSTOMER(APP_SID)
 ;


@update_tail
