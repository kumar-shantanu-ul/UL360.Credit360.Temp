-- Please update version.sql too -- this keeps clean builds in sync
define version=2755
define minor_version=24
@update_header

alter table aspen2.translated modify translated_id not null;
GRANT SELECT ON aspen2.translation_set_include TO csr;

drop table csrimp.translation_application;
drop table csrimp.translation_set;

grant insert on aspen2.translated to csrimp;
grant insert on aspen2.translation to csrimp;
grant insert on aspen2.translation_application to csrimp;
grant insert on aspen2.translation_set to csrimp;
grant insert on aspen2.translation_set_include to csrimp;
grant select on aspen2.translated_id_seq to csrimp;

CREATE TABLE CSRIMP.MAP_ASPEN2_TRANSLATED (
	CSRIMP_SESSION_ID				NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	OLD_TRANSLATED_ID				NUMBER(10) NOT NULL,
	NEW_TRANSLATED_ID				NUMBER(10) NOT NULL,
	CONSTRAINT PK_MAP_ASPEN2_TRANSLATED PRIMARY KEY (CSRIMP_SESSION_ID, OLD_TRANSLATED_ID),
	CONSTRAINT UK_MAP_ASPEN2_TRANSLATED UNIQUE (CSRIMP_SESSION_ID, NEW_TRANSLATED_ID),
    CONSTRAINT FK_MAP_ASPEN2_TRANSLATED_IS FOREIGN KEY
    	(CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID)
    	ON DELETE CASCADE
);

CREATE TABLE CSRIMP.ASPEN2_TRANSLATED
(
	CSRIMP_SESSION_ID 				NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	LANG            				VARCHAR2(10) NOT NULL,
	ORIGINAL_HASH   				RAW(20) NOT NULL,
	TRANSLATED      				VARCHAR2(4000) NOT NULL,
	TRANSLATED_ID           		NUMBER(10) NOT NULL,
    CONSTRAINT PK_ASPEN2_TRANSLATED PRIMARY KEY (LANG, ORIGINAL_HASH),
    CONSTRAINT FK_ASPEN2_TRANSLATED_IS FOREIGN KEY (CSRIMP_SESSION_ID)
	REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.ASPEN2_TRANSLATION
(
	CSRIMP_SESSION_ID 				NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	ORIGINAL_HASH					RAW(20) NOT NULL,
	ORIGINAL						VARCHAR2(4000) NOT NULL,
    CONSTRAINT PK_ASPEN2_TRANSLATION PRIMARY KEY (ORIGINAL_HASH),
    CONSTRAINT FK_ASPEN2_TRANSLATION_IS FOREIGN KEY (CSRIMP_SESSION_ID)
	REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.ASPEN2_TRANSLATION_APP
(
	CSRIMP_SESSION_ID 				NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	BASE_LANG               		VARCHAR2(10) NOT NULL,
	STATIC_TRANSLATION_PATH			VARCHAR2(1000),
    CONSTRAINT PK_ASPEN2_TRANSLATION_APP PRIMARY KEY (CSRIMP_SESSION_ID),
    CONSTRAINT FK_ASPEN2_TRANSLATION_APP_IS FOREIGN KEY (CSRIMP_SESSION_ID)
	REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.ASPEN2_TRANSLATION_SET
(
	CSRIMP_SESSION_ID 				NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	LANG							VARCHAR2(10) NOT NULL,
	REVISION						NUMBER(10) NOT NULL,
	HIDDEN							NUMBER(1) NOT NULL,
    CONSTRAINT PK_ASPEN2_TRANSLATION_SET PRIMARY KEY (LANG),
    CONSTRAINT FK_ASPEN2_TRANSLATION_SET_IS FOREIGN KEY (CSRIMP_SESSION_ID)
	REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.ASPEN2_TRANSLATION_SET_INCL
(
	CSRIMP_SESSION_ID 				NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	LANG							VARCHAR2(10) NOT NULL,
	POS								NUMBER(10) NOT NULL,
	TO_APPLICATION					VARCHAR2(4000),
	TO_LANG							VARCHAR2(10) NOT NULL,
    CONSTRAINT PK_ASPEN2_TRANS_SET_INCL PRIMARY KEY (LANG, POS),
    CONSTRAINT FK_ASPEN2_TRANS_SET_INCL_IS FOREIGN KEY (CSRIMP_SESSION_ID)
	REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

grant insert,select,update,delete on csrimp.aspen2_translated to web_user;
grant insert,select,update,delete on csrimp.aspen2_translation to web_user;
grant insert,select,update,delete on csrimp.aspen2_translation_app to web_user;
grant insert,select,update,delete on csrimp.aspen2_translation_set to web_user;
grant insert,select,update,delete on csrimp.aspen2_translation_set_incl to web_user;

@../csrimp/imp_body
@../schema_pkg
@../schema_body

@update_tail
