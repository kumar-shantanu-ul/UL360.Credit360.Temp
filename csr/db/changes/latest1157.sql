-- Please update version.sql too -- this keeps clean builds in sync
define version=1157
@update_header

CREATE TABLE CT.WORKSHEET_VALUE_HELPER (
    WORKSHEET_VALUE_HELPER_ID NUMBER(10) NOT NULL,
    CLASS_TYPE VARCHAR2(100) NOT NULL,
    MAPPER_NAME VARCHAR2(200),
    MAPPER_DESCRIPTION VARCHAR2(2000),
    PRIMARY KEY (WORKSHEET_VALUE_HELPER_ID)
);

DELETE FROM CT.VALUE_MAP;
DELETE FROM CT.WORKSHEET_COLUMN_TYPE;

ALTER TABLE CT.WORKSHEET_COLUMN_TYPE DROP CONSTRAINT TUC_WS_COLUMN_TYPE_1;
ALTER TABLE CT.WORKSHEET_COLUMN_TYPE DROP COLUMN KEY;
ALTER TABLE CT.WORKSHEET_COLUMN_TYPE DROP COLUMN DESCRIPTION;
ALTER TABLE CT.WORKSHEET_COLUMN_TYPE DROP COLUMN CLASS_TYPE;

ALTER TABLE CT.WORKSHEET_COLUMN_TYPE ADD (NAME VARCHAR2(100) NOT NULL);
ALTER TABLE CT.WORKSHEET_COLUMN_TYPE ADD (DESCRIPTION VARCHAR2(2000) NOT NULL);
ALTER TABLE CT.WORKSHEET_COLUMN_TYPE ADD (WORKSHEET_VALUE_HELPER_ID NUMBER(10) NOT NULL);
ALTER TABLE CT.WORKSHEET_COLUMN_TYPE ADD (POSITION NUMBER(10) NOT NULL);

ALTER TABLE CT.WORKSHEET_COLUMN_TYPE ADD CONSTRAINT WS_VALUE_HELPER_WS_COLUMN_TYPE 
    FOREIGN KEY (WORKSHEET_VALUE_HELPER_ID) REFERENCES CT.WORKSHEET_VALUE_HELPER (WORKSHEET_VALUE_HELPER_ID);

DROP INDEX CT.IDX_BD_TYPE_1;
DROP INDEX CT.IDX_BD_TYPE_2;
DROP INDEX CT.IDX_BD_TYPE_3;

CREATE UNIQUE INDEX CT.IDX_BD_TYPE_1 ON CT.BREAKDOWN_TYPE (APP_SID,LOWER(SINGULAR),IS_HOTSPOT);
CREATE UNIQUE INDEX CT.IDX_BD_TYPE_2 ON CT.BREAKDOWN_TYPE (APP_SID,LOWER(PLURAL),IS_HOTSPOT);
CREATE UNIQUE INDEX CT.IDX_BD_TYPE_3 ON CT.BREAKDOWN_TYPE (APP_SID, CASE WHEN IS_REGION = 1  THEN -1 ELSE BREAKDOWN_TYPE_ID END,IS_HOTSPOT);

@..\ct\excel_pkg
@..\ct\excel_body

@update_tail
