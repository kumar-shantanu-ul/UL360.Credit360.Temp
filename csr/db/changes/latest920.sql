-- Please update version.sql too -- this keeps clean builds in sync
define version=920
@update_header

CREATE SEQUENCE CSR.DELEG_DATA_CHANGE_ALERT_ID_SEQ
    START WITH 1
    INCREMENT BY 1
    NOMINVALUE
    NOMAXVALUE
    NOCACHE
    NOORDER
;

CREATE TABLE CSR.DELEG_DATA_CHANGE_ALERT (
	APP_SID							NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
	DELEG_DATA_CHANGE_ALERT_ID		NUMBER(10) NOT NULL,
	NOTIFY_USER_SID					NUMBER(10) NOT NULL,
	RAISED_BY_USER_SID				NUMBER(10) NOT NULL,
	SHEET_ID						NUMBER(10) NOT NULL,
	CONSTRAINT PK_DELEG_DATA_CHANGE_ALERT	PRIMARY KEY (APP_SID, DELEG_DATA_CHANGE_ALERT_ID) 
);

ALTER TABLE CSR.DELEG_DATA_CHANGE_ALERT ADD CONSTRAINT FK_DELEG_D_CHG_ALT_NOTIFY_USER 
    FOREIGN KEY (APP_SID, NOTIFY_USER_SID)
    REFERENCES CSR.CSR_USER(APP_SID, CSR_USER_SID)
;

ALTER TABLE CSR.DELEG_DATA_CHANGE_ALERT ADD CONSTRAINT FK_DELEG_D_CHG_ALT_RAISED_USER 
    FOREIGN KEY (APP_SID, RAISED_BY_USER_SID)
    REFERENCES CSR.CSR_USER(APP_SID, CSR_USER_SID)
;

ALTER TABLE CSR.DELEG_DATA_CHANGE_ALERT ADD CONSTRAINT FK_DELEG_D_CHG_ALT_SHEET 
    FOREIGN KEY (APP_SID, SHEET_ID)
    REFERENCES CSR.SHEET(APP_SID, SHEET_ID)
;

BEGIN
	dbms_rls.add_policy(
		object_schema   => 'CSR',
		object_name     => 'DELEG_DATA_CHANGE_ALERT',
		policy_name     => 'DELEG_DATA_CHANGE_ALERT_POLICY',
		function_schema => 'CSR',
		policy_function => 'appSidCheck',
		statement_types => 'select, insert, update, delete',
		update_check	=> true,
		policy_type     => dbms_rls.context_sensitive );
END;
/

@update_tail
