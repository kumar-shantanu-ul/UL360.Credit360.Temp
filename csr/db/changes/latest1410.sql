-- Please update version.sql too -- this keeps clean builds in sync
define version=1410
@update_header

ALTER TABLE CSR.METER_RAW_DATA ADD (
	FILE_NAME	VARCHAR2(1024)
);

ALTER TABLE CSR.METER_ORPHAN_DATA MODIFY (
	END_DTM		TIMESTAMP WITH TIME ZONE	NULL
);

ALTER TABLE CSR.METER_SOURCE_DATA ADD (
	RAW_UOM              VARCHAR2(256),
    RAW_CONSUMPTION      NUMBER(24, 10)
);

CREATE TABLE CSR.METER_READING_DATA(
    APP_SID              NUMBER(10, 0)     			DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    REGION_SID           NUMBER(10, 0)     			NOT NULL,
    READING_DTM          TIMESTAMP WITH TIME ZONE	NOT NULL,
    METER_RAW_DATA_ID    NUMBER(10, 0),
    RAW_UOM              VARCHAR2(256),
    RAW_VAL              NUMBER(24, 10)				NOT NULL
);

ALTER TABLE CSR.METER_READING_DATA ADD CONSTRAINT FK_METER_METER_READING_DATA 
    FOREIGN KEY (APP_SID, REGION_SID)
    REFERENCES CSR.ALL_METER(APP_SID, REGION_SID)
;

ALTER TABLE CSR.METER_READING_DATA ADD CONSTRAINT FK_METER_RAW_READING_DATA 
    FOREIGN KEY (APP_SID, METER_RAW_DATA_ID)
    REFERENCES CSR.METER_RAW_DATA(APP_SID, METER_RAW_DATA_ID)
;

CREATE UNIQUE INDEX CSR.UK_METER_READING_DATA ON CSR.METER_READING_DATA(APP_SID, REGION_SID, READING_DTM);
CREATE INDEX CSR.IDX_METER_READING_DATA_REGION ON CSR.METER_READING_DATA(APP_SID, REGION_SID);
CREATE INDEX CSR.IDX_METER_RAW_READING_DATA ON CSR.METER_READING_DATA(APP_SID, METER_RAW_DATA_ID);

BEGIN
	UPDATE csr.meter_source_data
	   SET raw_consumption = consumption;
END;
/

ALTER TABLE CSR.METER_SOURCE_DATA MODIFY (
    RAW_CONSUMPTION      NUMBER(24, 10)    NOT NULL
);

DROP TABLE CSR.METER_INSERT_DATA;
CREATE GLOBAL TEMPORARY TABLE CSR.METER_INSERT_DATA 
(
  START_DTM   TIMESTAMP WITH TIME ZONE  NOT NULL,
  END_DTM     TIMESTAMP WITH TIME ZONE,
  CONSUMPTION NUMBER(24,10) NOT NULL
)
ON COMMIT DELETE ROWS;

-----

ALTER TABLE CSRIMP.METER_RAW_DATA MODIFY (
    START_DTM            DATE	NULL,
    END_DTM              DATE	NULL
);

ALTER TABLE CSRIMP.METER_ORPHAN_DATA MODIFY (
	START_DTM	TIMESTAMP WITH TIME ZONE,
	END_DTM		TIMESTAMP WITH TIME ZONE	NULL,
	UOM			VARCHAR(256)				NULL
);

ALTER TABLE CSRIMP.METER_SOURCE_DATA MODIFY (
    START_DTM            TIMESTAMP WITH TIME ZONE,
    END_DTM              TIMESTAMP WITH TIME ZONE
);

ALTER TABLE CSRIMP.METER_SOURCE_DATA ADD (
    RAW_UOM              VARCHAR2(256),
    RAW_CONSUMPTION      NUMBER(24, 10)				NOT NULL
);

CREATE TABLE CSRIMP.METER_READING_DATA(
    CSRIMP_SESSION_ID    NUMBER(10, 0)     			DEFAULT SYS_CONTEXT('SECURITY','CSRIMP_SESSION_ID') NOT NULL,
    REGION_SID           NUMBER(10, 0)     			NOT NULL,
    READING_DTM          TIMESTAMP WITH TIME ZONE	NOT NULL,
    METER_RAW_DATA_ID    NUMBER(10, 0),
    RAW_UOM              VARCHAR2(256),
    RAW_VAL              NUMBER(24, 10)				NOT NULL
);

grant select,insert on csr.meter_reading_data to csrimp;
grant select,insert,update,delete on csrimp.meter_reading_data to web_user;


@../meter_monitor_pkg
@../meter_monitor_body

@../schema_pkg
@../schema_body
@../csrimp/imp_body
@../csrimp/rls

@update_tail
