define version=3412
define minor_version=0
define is_combined=1
@update_header

-- clean out junk in csrimp
BEGIN
	FOR r IN (
		SELECT table_name
		  FROM all_tables
		 WHERE owner='CSRIMP' AND table_name!='CSRIMP_SESSION'
		)
	LOOP
		EXECUTE IMMEDIATE 'TRUNCATE TABLE csrimp.'||r.table_name;
	END LOOP;
	DELETE FROM csrimp.csrimp_session;
	commit;
END;
/

-- clean out debug log
TRUNCATE TABLE security.debug_log;

CREATE TABLE CSR.NOTIFICATION_TYPE(
	APP_SID						NUMBER(10, 0)	DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
	NOTIFICATION_TYPE_ID		VARCHAR2(36) NOT NULL,
	DESCRIPTION					VARCHAR2(255) NOT NULL,
	SEND_TRIGGER				VARCHAR2(2000) NOT NULL,
	SENT_FROM					VARCHAR2(2000) NOT NULL,
	GROUP_NAME					VARCHAR2(255) NOT NULL,
	CONSTRAINT PK_NOTIFICATION_TYPE PRIMARY KEY (APP_SID, NOTIFICATION_TYPE_ID)
);
CREATE TABLE CSR.NOTIFICATION_TYPE_PARAM(
	APP_SID						NUMBER(10, 0)	DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
	NOTIFICATION_TYPE_ID		VARCHAR2(36) NOT NULL,
	FIELD_NAME					VARCHAR2(100) NOT NULL,
	DESCRIPTION					VARCHAR2(200) NOT NULL,
	HELP_TEXT					VARCHAR2(2000) NOT NULL,
	REPEATS						NUMBER(1) NOT NULL,
	DISPLAY_POS					NUMBER(10) NOT NULL,
	CONSTRAINT PK_NOTIFICATION_TYPE_PARAM PRIMARY KEY (APP_SID, NOTIFICATION_TYPE_ID, FIELD_NAME),
	CONSTRAINT CK_NOTIFICATION_TYPE_PARAM_REPEATS CHECK (REPEATS IN (0, 1)),
	CONSTRAINT CK_NOTIFICATION_TYPE_PARAM_NAME_UPPER CHECK (FIELD_NAME = UPPER(FIELD_NAME))
);
ALTER TABLE CSR.CUSTOMER_ALERT_TYPE ADD NOTIFICATION_TYPE_ID VARCHAR2(36);
ALTER TABLE CSR.CUSTOMER_ALERT_TYPE ADD CONSTRAINT FK_CUSTOMER_ALERT_TYPE_NOTIF_TYPE_ID
    FOREIGN KEY (APP_SID, NOTIFICATION_TYPE_ID)
    REFERENCES CSR.NOTIFICATION_TYPE(APP_SID, NOTIFICATION_TYPE_ID);
;
ALTER TABLE CSR.NOTIFICATION_TYPE_PARAM ADD CONSTRAINT FK_NOTIFICATION_TYPE_PARAM_NOT_TYPE
    FOREIGN KEY (APP_SID, NOTIFICATION_TYPE_ID)
    REFERENCES CSR.NOTIFICATION_TYPE(APP_SID, NOTIFICATION_TYPE_ID)
;
CREATE INDEX csr.ix_customer_aler_notification_ ON csr.customer_alert_type (app_sid, notification_type_id);
CREATE TABLE CSR.TRANSLATION_SET_INCLUDE_PATH(
    APPLICATION_SID_ID    NUMBER(10, 0)    NOT NULL,
    APP_PATH_SID_ID       NUMBER(10, 0)    NOT NULL,
    APP_PATH              VARCHAR2(1000)   NOT NULL,
    CONSTRAINT PK_TRANSLATION_SET_INCLUDE_PATH PRIMARY KEY (APPLICATION_SID_ID, APP_PATH_SID_ID)
)
;
CREATE OR REPLACE TYPE CHAIN.T_FILTER_OBJECT_DATA_ROW AS
	 OBJECT (
		DATA_TYPE_ID					NUMBER(10),
		AGG_TYPE_ID						NUMBER(10),
		OBJECT_ID						NUMBER(10),
		VAL_NUMBER						NUMBER(24, 10),
		FILTER_VALUE_ID					NUMBER(10)
	 );
/
CREATE OR REPLACE TYPE CHAIN.T_FILTER_OBJECT_DATA_TABLE AS
	TABLE OF CHAIN.T_FILTER_OBJECT_DATA_ROW;
/
CREATE OR REPLACE TYPE CHAIN.T_GROUP_BY_PIVOT_ROW AS
	 OBJECT (
		OBJECT_ID NUMBER(10),
		FILTER_VALUE_ID1 NUMBER(10),
		FILTER_VALUE_ID2 NUMBER(10),
		FILTER_VALUE_ID3 NUMBER(10),
		FILTER_VALUE_ID4 NUMBER(10)
	 );
/
CREATE OR REPLACE TYPE CHAIN.T_GROUP_BY_PIVOT_TABLE AS
	TABLE OF CHAIN.T_GROUP_BY_PIVOT_ROW;
/


ALTER TABLE csrimp.compliance_item_description MODIFY title VARCHAR2(2048);














create or replace package csr.notification_pkg as
procedure dummy;
end;
/
create or replace package body csr.notification_pkg as
procedure dummy
as
begin
	null;
end;
end;
/
GRANT EXECUTE ON csr.notification_pkg TO web_user;


@..\audit_pkg
@..\notification_pkg
@..\..\..\security\db\oracle\accountpolicy_pkg
@..\..\..\security\db\oracle\securableobject_pkg
@..\delegation_pkg
@..\measure_api_pkg


@..\compliance_body
@..\audit_body
@..\notification_body
@..\..\..\security\db\oracle\accountpolicy_body
@..\..\..\security\db\oracle\securableobject_body
@..\schema_body
@..\csrimp\imp_body
@..\delegation_body
@..\measure_api_body
@..\chain\filter_body



@update_tail
