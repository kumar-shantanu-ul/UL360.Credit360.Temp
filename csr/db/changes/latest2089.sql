-- Please update version.sql too -- this keeps clean builds in sync
define version=2089
@update_header

CREATE TABLE CSR.EST_ERROR(
    APP_SID               NUMBER(10, 0)     DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    EST_ACCOUNT_SID       NUMBER(10, 0)     NOT NULL,
    PM_CUSTOMER_ID        VARCHAR2(256)     NOT NULL,
    PM_BUILDING_ID        VARCHAR2(256)     NOT NULL,
    PM_SPACE_ID           VARCHAR2(256),
    PM_WATER_METER_ID     VARCHAR2(256),
    PM_ENERGY_METER_ID    VARCHAR2(256),
    ERROR                 VARCHAR2(4000)    NOT NULL
)
;

CREATE UNIQUE INDEX CSR.UK_EST_ERROR ON CSR.EST_ERROR(APP_SID, EST_ACCOUNT_SID, PM_CUSTOMER_ID, PM_BUILDING_ID, NVL(PM_SPACE_ID, PM_BUILDING_ID), NVL(PM_WATER_METER_ID, PM_BUILDING_ID), NVL(PM_ENERGY_METER_ID, PM_BUILDING_ID))
;

ALTER TABLE CSR.EST_ERROR ADD CONSTRAINT FK_EST_BUILDING_ERROR 
    FOREIGN KEY (APP_SID, EST_ACCOUNT_SID, PM_CUSTOMER_ID, PM_BUILDING_ID)
    REFERENCES CSR.EST_BUILDING(APP_SID, EST_ACCOUNT_SID, PM_CUSTOMER_ID, PM_BUILDING_ID)
;

ALTER TABLE CSR.EST_ERROR ADD CONSTRAINT FK_EST_SPACE_ERROR 
    FOREIGN KEY (APP_SID, EST_ACCOUNT_SID, PM_CUSTOMER_ID, PM_BUILDING_ID, PM_SPACE_ID)
    REFERENCES CSR.EST_SPACE(APP_SID, EST_ACCOUNT_SID, PM_CUSTOMER_ID, PM_BUILDING_ID, PM_SPACE_ID)
;

ALTER TABLE CSR.EST_ERROR ADD CONSTRAINT FK_EST_EMETER_ERROR 
    FOREIGN KEY (APP_SID, EST_ACCOUNT_SID, PM_CUSTOMER_ID, PM_BUILDING_ID, PM_ENERGY_METER_ID)
    REFERENCES CSR.EST_ENERGY_METER(APP_SID, EST_ACCOUNT_SID, PM_CUSTOMER_ID, PM_BUILDING_ID, PM_ENERGY_METER_ID)
;

ALTER TABLE CSR.EST_ERROR ADD CONSTRAINT FK_EST_WMETER_ERROR 
    FOREIGN KEY (APP_SID, EST_ACCOUNT_SID, PM_CUSTOMER_ID, PM_BUILDING_ID, PM_WATER_METER_ID)
    REFERENCES CSR.EST_WATER_METER(APP_SID, EST_ACCOUNT_SID, PM_CUSTOMER_ID, PM_BUILDING_ID, PM_WATER_METER_ID)
;

CREATE INDEX IX_EST_BUILDING_ERROR ON CSR.EST_ERROR (APP_SID, EST_ACCOUNT_SID, PM_CUSTOMER_ID, PM_BUILDING_ID);
CREATE INDEX IX_EST_SPACE_ERROR ON CSR.EST_ERROR (APP_SID, EST_ACCOUNT_SID, PM_CUSTOMER_ID, PM_BUILDING_ID, PM_SPACE_ID);
CREATE INDEX IX_EST_EMETER_ERROR ON CSR.EST_ERROR (APP_SID, EST_ACCOUNT_SID, PM_CUSTOMER_ID, PM_BUILDING_ID, PM_ENERGY_METER_ID);
CREATE INDEX IX_EST_WMETER_ERROR ON CSR.EST_ERROR (APP_SID, EST_ACCOUNT_SID, PM_CUSTOMER_ID, PM_BUILDING_ID, PM_WATER_METER_ID);

BEGIN
    INSERT INTO csr.est_error (app_sid, est_account_sid, pm_customer_id, pm_building_id, error)
        SELECT app_sid, est_account_sid, pm_customer_id, pm_building_id, mapping_error
          FROM csr.est_building
         WHERE mapping_error IS NOT NULL;

    INSERT INTO csr.est_error (app_sid, est_account_sid, pm_customer_id, pm_building_id, pm_energy_meter_id, error)
        SELECT app_sid, est_account_sid, pm_customer_id, pm_building_id, pm_energy_meter_id, mapping_error
          FROM csr.est_energy_meter
         WHERE mapping_error IS NOT NULL;

    INSERT INTO csr.est_error (app_sid, est_account_sid, pm_customer_id, pm_building_id, pm_water_meter_id, error)
        SELECT app_sid, est_account_sid, pm_customer_id, pm_building_id, pm_water_meter_id, mapping_error
          FROM csr.est_water_meter
         WHERE mapping_error IS NOT NULL;
END;
/

@../energy_star_pkg
@../energy_star_body
@../property_body

ALTER TABLE CSR.EST_BUILDING DROP COLUMN MAPPING_ERROR;
ALTER TABLE CSR.EST_ENERGY_METER DROP COLUMN MAPPING_ERROR;
ALTER TABLE CSR.EST_WATER_METER DROP COLUMN MAPPING_ERROR;

@update_tail
