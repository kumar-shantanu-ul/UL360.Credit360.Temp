-- Please update version.sql too -- this keeps clean builds in sync
define version=381
@update_header

-- ERstudio renumbers all the constraints randomly so just drop & recreate all of them
BEGIN
	FOR r IN (SELECT constraint_name 
	  			FROM user_constraints
			   WHERE table_name = 'ISSUE' and constraint_type = 'R') LOOP
		EXECUTE IMMEDIATE 'ALTER TABLE ISSUE DROP CONSTRAINT '||r.constraint_name;
	END LOOP;
END;
/

ALTER TABLE ISSUE ADD CONSTRAINT RefISSUE_PENDING_VAL1368 
    FOREIGN KEY (APP_SID, ISSUE_PENDING_VAL_ID)
    REFERENCES ISSUE_PENDING_VAL(APP_SID, ISSUE_PENDING_VAL_ID)
;

ALTER TABLE ISSUE ADD CONSTRAINT RefISSUE_SHEET_VALUE1369 
    FOREIGN KEY (APP_SID, ISSUE_SHEET_VALUE_ID)
    REFERENCES ISSUE_SHEET_VALUE(APP_SID, ISSUE_SHEET_VALUE_ID)
;

ALTER TABLE ISSUE ADD CONSTRAINT RefCSR_USER1370 
    FOREIGN KEY (APP_SID, ASSIGNED_TO_USER_SID)
    REFERENCES CSR.CSR_USER(APP_SID, CSR_USER_SID)
;

ALTER TABLE ISSUE ADD CONSTRAINT RefISSUE_SURVEY_ANSWER1371 
    FOREIGN KEY (APP_SID, ISSUE_SURVEY_ANSWER_ID)
    REFERENCES ISSUE_SURVEY_ANSWER(APP_SID, ISSUE_SURVEY_ANSWER_ID)
;

ALTER TABLE ISSUE ADD CONSTRAINT RefISSUE_TYPE1372 
    FOREIGN KEY (APP_SID, ISSUE_TYPE_ID)
    REFERENCES ISSUE_TYPE(APP_SID, ISSUE_TYPE_ID)
;

ALTER TABLE ISSUE ADD CONSTRAINT RefISSUE_NON_COMPLIANCE1373 
    FOREIGN KEY (APP_SID, ISSUE_NON_COMPLIANCE_ID)
    REFERENCES ISSUE_NON_COMPLIANCE(APP_SID, ISSUE_NON_COMPLIANCE_ID)
;

ALTER TABLE ISSUE ADD CONSTRAINT RefCSR_USER1374 
    FOREIGN KEY (APP_SID, RESOLVED_BY_USER_SID)
    REFERENCES CSR.CSR_USER(APP_SID, CSR_USER_SID)
;

ALTER TABLE ISSUE ADD CONSTRAINT RefCSR_USER1375 
    FOREIGN KEY (APP_SID, CLOSED_BY_USER_SID)
    REFERENCES CSR.CSR_USER(APP_SID, CSR_USER_SID)
;

ALTER TABLE ISSUE ADD CONSTRAINT RefCSR_USER1376 
    FOREIGN KEY (APP_SID, RAISED_BY_USER_SID)
    REFERENCES CSR.CSR_USER(APP_SID, CSR_USER_SID)
;

@..\audit_pkg
@..\issue_pkg
@..\audit_body
@..\issue_body

@update_tail

