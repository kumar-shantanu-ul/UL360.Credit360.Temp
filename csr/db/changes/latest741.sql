-- Please update version.sql too -- this keeps clean builds in sync
define version=741
@update_header

CREATE SEQUENCE csr.DASHBOARD_INSTANCE_ID_SEQ
    START WITH 1
    INCREMENT BY 1
    NOMINVALUE
    NOMAXVALUE
    CACHE 20
    NOORDER;


CREATE TABLE csr.APPROVAL_DASHBOARD(
    APP_SID                   NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    APPROVAL_DASHBOARD_SID    NUMBER(10, 0)    NOT NULL,
    LABEL                     VARCHAR2(255)    NOT NULL,    
    FLOW_SID                  NUMBER(10, 0),
    CONSTRAINT PK_APPROVAL_DASHBOARD PRIMARY KEY (APP_SID, APPROVAL_DASHBOARD_SID)
);


CREATE TABLE csr.APPROVAL_DASHBOARD_INSTANCE(
    APP_SID                   NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    DASHBOARD_INSTANCE_ID     NUMBER(10, 0)    NOT NULL,
    APPROVAL_DASHBOARD_SID    NUMBER(10, 0)    NOT NULL,
    REGION_SID                NUMBER(10, 0)    NOT NULL,
    START_DTM                 DATE             NOT NULL,
    END_DTM                   DATE             NOT NULL,
    CONSTRAINT PK_APPROVAL_DASHBOARD_INSTANCE PRIMARY KEY (APP_SID, DASHBOARD_INSTANCE_ID),
    CONSTRAINT UK_APPR_DASHBOARD_INSTANCE  UNIQUE (APP_SID, APPROVAL_DASHBOARD_SID, REGION_SID, START_DTM, END_DTM)
);

CREATE TABLE csr.APPROVAL_DASHBOARD_REGION(
    APP_SID                   NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    APPROVAL_DASHBOARD_SID    NUMBER(10, 0)    NOT NULL,
    REGION_SID                NUMBER(10, 0)    NOT NULL,
    CONSTRAINT PK_APPROVAL_DASHBOARD_REGION PRIMARY KEY (APP_SID, APPROVAL_DASHBOARD_SID, REGION_SID)
);


CREATE TABLE csr.APPROVAL_DASHBOARD_TAB(
    APP_SID                   NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    APPROVAL_DASHBOARD_SID    NUMBER(10, 0)    NOT NULL,
    TAB_ID                    NUMBER(10, 0)    NOT NULL,
    POS                       NUMBER(10, 0)    DEFAULT 1 NOT NULL,
    CONSTRAINT PK_APPROVAL_DASHBOARD_TAB PRIMARY KEY (APP_SID, APPROVAL_DASHBOARD_SID, TAB_ID)
);


ALTER TABLE csr.FLOW_ITEM ADD (
    DASHBOARD_INSTANCE_ID    NUMBER(10, 0)
 );

 
ALTER TABLE csr.APPROVAL_DASHBOARD ADD CONSTRAINT RefCUSTOMER2355 
    FOREIGN KEY (APP_SID)
    REFERENCES csr.CUSTOMER(APP_SID);


ALTER TABLE csr.APPROVAL_DASHBOARD_INSTANCE ADD CONSTRAINT RefCUSTOMER2358 
    FOREIGN KEY (APP_SID)
    REFERENCES csr.CUSTOMER(APP_SID);

ALTER TABLE csr.APPROVAL_DASHBOARD_INSTANCE ADD CONSTRAINT FK_APP_DASH_APP_DASH_INST 
    FOREIGN KEY (APP_SID, APPROVAL_DASHBOARD_SID)
    REFERENCES csr.APPROVAL_DASHBOARD(APP_SID, APPROVAL_DASHBOARD_SID);

ALTER TABLE csr.APPROVAL_DASHBOARD_INSTANCE ADD CONSTRAINT FK_APP_DASH_REG_INSTANCE 
    FOREIGN KEY (APP_SID, APPROVAL_DASHBOARD_SID, REGION_SID)
    REFERENCES csr.APPROVAL_DASHBOARD_REGION(APP_SID, APPROVAL_DASHBOARD_SID, REGION_SID);


ALTER TABLE csr.APPROVAL_DASHBOARD_REGION ADD CONSTRAINT FK_APP_DASH_APP_DASH_REG 
    FOREIGN KEY (APP_SID, APPROVAL_DASHBOARD_SID)
    REFERENCES csr.APPROVAL_DASHBOARD(APP_SID, APPROVAL_DASHBOARD_SID);

ALTER TABLE csr.APPROVAL_DASHBOARD_REGION ADD CONSTRAINT FK_REGION_APP_DASH_REGION 
    FOREIGN KEY (APP_SID, REGION_SID)
    REFERENCES csr.REGION(APP_SID, REGION_SID);

ALTER TABLE csr.APPROVAL_DASHBOARD_TAB ADD CONSTRAINT FK_APP_DASH_APP_DASH_TAB 
    FOREIGN KEY (APP_SID, APPROVAL_DASHBOARD_SID)
    REFERENCES csr.APPROVAL_DASHBOARD(APP_SID, APPROVAL_DASHBOARD_SID);

ALTER TABLE csr.APPROVAL_DASHBOARD_TAB ADD CONSTRAINT FK_TAB_APP_DASH_TAB 
    FOREIGN KEY (APP_SID, TAB_ID)
    REFERENCES csr.TAB(APP_SID, TAB_ID);


ALTER TABLE csr.APPROVAL_DASHBOARD ADD CONSTRAINT FK_FLOW_APPR_DASHBOARD 
    FOREIGN KEY (APP_SID, FLOW_SID)
    REFERENCES csr.FLOW(APP_SID, FLOW_SID);

ALTER TABLE csr.FLOW_ITEM ADD CONSTRAINT FK_APP_DASH_INST_FLOW_ITEM 
    FOREIGN KEY (APP_SID, DASHBOARD_INSTANCE_ID)
    REFERENCES csr.APPROVAL_DASHBOARD_INSTANCE(APP_SID, DASHBOARD_INSTANCE_ID);


DECLARE
	new_class_id 	security_pkg.T_SID_ID;
	v_act 			security_pkg.T_ACT_ID;
BEGIN
	user_pkg.LogonAuthenticated(security_pkg.SID_BUILTIN_ADMINISTRATOR, NULL, v_ACT);	
	BEGIN	
		class_pkg.CreateClass(v_act, NULL, 'CSRApprovalDashboard', 'csr.approval_dashboard_pkg', NULL, new_class_id);
	EXCEPTION
		WHEN security_pkg.DUPLICATE_OBJECT_NAME THEN
			NULL;
	END;
END;
/

@..\approval_dashboard_pkg
@..\flow_pkg

@..\approval_dashboard_body
@..\flow_body

GRANT EXECUTE ON csr.approval_dashboard_pkg TO web_user;
GRANT EXECUTE ON csr.approval_dashboard_pkg TO SECURITY;


@update_tail
