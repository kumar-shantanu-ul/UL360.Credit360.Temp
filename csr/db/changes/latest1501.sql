-- Please update version.sql too -- this keeps clean builds in sync
define version=1501
@update_header


ALTER TABLE CSR.REGION_METRIC DROP CONSTRAINT FK_CONV_REGION_METRIC;
ALTER TABLE CSR.REGION_METRIC DROP COLUMN MEASURE_CONVERSION_ID;
	
ALTER TABLE CSR.REGION_METRIC_REGION ADD (
    MEASURE_SID           NUMBER(10),
    MEASURE_CONVERSION_ID NUMBER(10)
);

BEGIN
    FOR r IN (  
        SELECT DISTINCT i.measure_sid, rmr.ind_sid
          FROM csr.region_metric_region rmr
            JOIN csr.ind i ON rmr.ind_sid = i.ind_sid
    )
    LOOP
            UPDATE csr.region_metric_region  
               SET measure_sid = r.measure_sid
             WHERE ind_sid = r.ind_sid;
    END LOOP;
END;
/

ALTER TABLE CSR.REGION_METRIC_REGION MODIFY MEASURE_SID NOT NULL;

DROP INDEX csr.ix_indm_region_metric;
ALTER TABLE CSR.REGION_METRIC DROP CONSTRAINT FK_IND_REGION_METRIC;

ALTER TABLE CSR.REGION_METRIC ADD CONSTRAINT UK_REGION_METRIC UNIQUE (APP_SID, IND_SID, MEASURE_SID);

ALTER TABLE CSR.REGION_METRIC_REGION ADD CONSTRAINT FK_MEAS_CONV_REG_MET_REG 
    FOREIGN KEY (APP_SID, MEASURE_CONVERSION_ID, MEASURE_SID)
    REFERENCES CSR.MEASURE_CONVERSION(APP_SID, MEASURE_CONVERSION_ID, MEASURE_SID);

ALTER TABLE CSR.REGION_METRIC_REGION DROP CONSTRAINT FK_RMETRIC_RMETRICR;
 
ALTER TABLE CSR.REGION_METRIC_REGION ADD CONSTRAINT FK_RMETRIC_RMETRICR 
    FOREIGN KEY (APP_SID, IND_SID, MEASURE_SID)
    REFERENCES CSR.REGION_METRIC(APP_SID, IND_SID, MEASURE_SID);


@..\region_metric_pkg
@..\region_metric_body

@update_tail