-- Please update version.sql too -- this keeps clean builds in sync
define version=2886
define minor_version=21
@update_header

-- *** DDL ***
-- Create tables

CREATE GLOBAL TEMPORARY TABLE CSR.TT_CSRIMPEXPCHECK_DDL (
	OWNER              VARCHAR2(30) NOT NULL,
	TABLE_NAME         VARCHAR2(30) NOT NULL,
	COLUMN_NAME        VARCHAR2(30) NOT NULL,
	DATA_TYPE          VARCHAR2(106),
	DATA_LENGTH        NUMBER NOT NULL,
	DATA_PRECISION     NUMBER,
	NULLABLE           VARCHAR2(1),
	DATA_DEFAULT       CLOB,
	CHARACTER_SET_NAME VARCHAR2(44)
) ON COMMIT DELETE ROWS;


CREATE TABLE CSRIMP.MAP_ISSUE_SUPPLIER (
	CSRIMP_SESSION_ID NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	OLD_ISSUE_SUPPLIER_ID NUMBER(10) NOT NULL,
	NEW_ISSUE_SUPPLIER_ID NUMBER(10) NOT NULL,
	CONSTRAINT PK_MAP_ISSUE_SUPPLIER PRIMARY KEY (CSRIMP_SESSION_ID, OLD_ISSUE_SUPPLIER_ID) USING INDEX,
	CONSTRAINT UK_MAP_ISSUE_SUPPLIER UNIQUE (CSRIMP_SESSION_ID, NEW_ISSUE_SUPPLIER_ID) USING INDEX,
	CONSTRAINT FK_MAP_ISSUE_SUPPLIER_IS FOREIGN KEY (CSRIMP_SESSION_ID) 
		REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.MAP_ISSUE_ACTION (
	CSRIMP_SESSION_ID NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	OLD_ISSUE_ACTION_ID NUMBER(10) NOT NULL,
	NEW_ISSUE_ACTION_ID NUMBER(10) NOT NULL,
	CONSTRAINT PK_MAP_ISSUE_ACTION PRIMARY KEY (CSRIMP_SESSION_ID, OLD_ISSUE_ACTION_ID) USING INDEX,
	CONSTRAINT UK_MAP_ISSUE_ACTION UNIQUE (CSRIMP_SESSION_ID, NEW_ISSUE_ACTION_ID) USING INDEX,
	CONSTRAINT FK_MAP_ISSUE_ACTION_IS FOREIGN KEY (CSRIMP_SESSION_ID) 
		REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.FLOW_ALERT_HELPER(
    CSRIMP_SESSION_ID    NUMBER(10, 0)     DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
    FLOW_ALERT_HELPER    VARCHAR2(256)     NOT NULL,
    LABEL                VARCHAR2(1024)    NOT NULL,
    CONSTRAINT PK_FLOW_ALERT_HELPER PRIMARY KEY (CSRIMP_SESSION_ID, FLOW_ALERT_HELPER),
	CONSTRAINT FK_CUSTOMER_FLALHELPER FOREIGN KEY (CSRIMP_SESSION_ID) 
		REFERENCES CSRIMP.CSRIMP_SESSION(CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.ISSUE_CUSTOM_FIELD_DATE_VAL(
    CSRIMP_SESSION_ID        NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY','CSRIMP_SESSION_ID') NOT NULL,
    DATE_VALUE               DATE             NOT NULL,
    ISSUE_ID                 NUMBER(10, 0)    NOT NULL,
    ISSUE_CUSTOM_FIELD_ID    NUMBER(10, 0)    NOT NULL,
    CONSTRAINT PK_ISSUE_CUST_FIELD_DATE_VAL PRIMARY KEY (CSRIMP_SESSION_ID, ISSUE_ID, ISSUE_CUSTOM_FIELD_ID),
	CONSTRAINT FK_ISS_CUST_FLD_DATE_FLD FOREIGN KEY (CSRIMP_SESSION_ID, ISSUE_CUSTOM_FIELD_ID)
		REFERENCES CSRIMP.ISSUE_CUSTOM_FIELD(CSRIMP_SESSION_ID, ISSUE_CUSTOM_FIELD_ID),
	CONSTRAINT FK_ISSUE_CUST_FLD_DATE_VAL FOREIGN KEY (CSRIMP_SESSION_ID, ISSUE_ID)
		REFERENCES CSRIMP.ISSUE(CSRIMP_SESSION_ID, ISSUE_ID),
	CONSTRAINT FK_ISSUE_CUST_IS FOREIGN KEY (CSRIMP_SESSION_ID) 
		REFERENCES CSRIMP.CSRIMP_SESSION(CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.QUICK_SURVEY_CSS (
    CSRIMP_SESSION_ID		NUMBER(10)		DEFAULT SYS_CONTEXT('SECURITY','CSRIMP_SESSION_ID') NOT NULL,
    CLASS_NAME		 		VARCHAR2(1024)	NOT NULL,
    DESCRIPTION		 		VARCHAR2(1024)	NOT NULL,
    TYPE					NUMBER(1)		NOT NULL,
	POSITION				NUMBER(10)    	NOT NULL,
    CONSTRAINT PK_QUICK_SURVEY_CSS PRIMARY KEY (CSRIMP_SESSION_ID, CLASS_NAME),
	CONSTRAINT FK_QS_CSS_IS FOREIGN KEY (CSRIMP_SESSION_ID) 
		REFERENCES CSRIMP.CSRIMP_SESSION(CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.QUICK_SURVEY_SCORE_THRESHOLD(
    CSRIMP_SESSION_ID     NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
    SURVEY_SID            NUMBER(10, 0)    NOT NULL,
    SCORE_THRESHOLD_ID    NUMBER(10, 0)    NOT NULL,
    MAPS_TO_IND_SID       NUMBER(10, 0),
    CONSTRAINT PK_QUICK_SURVEY_SCORE_THRESHOL PRIMARY KEY (CSRIMP_SESSION_ID, SURVEY_SID, SCORE_THRESHOLD_ID),
	CONSTRAINT FK_IND_QSST FOREIGN KEY (CSRIMP_SESSION_ID, MAPS_TO_IND_SID)
		REFERENCES CSRIMP.IND(CSRIMP_SESSION_ID, IND_SID),
	CONSTRAINT FK_QS_QSST FOREIGN KEY (CSRIMP_SESSION_ID, SURVEY_SID)
		REFERENCES CSRIMP.QUICK_SURVEY(CSRIMP_SESSION_ID, SURVEY_SID),
	CONSTRAINT FK_ST_QSST FOREIGN KEY (CSRIMP_SESSION_ID, SCORE_THRESHOLD_ID)
		REFERENCES CSRIMP.SCORE_THRESHOLD(CSRIMP_SESSION_ID, SCORE_THRESHOLD_ID),
    CONSTRAINT FK_QSST_IS FOREIGN KEY
    	(CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID)
    	ON DELETE CASCADE
)
;

CREATE TABLE CSRIMP.SUPPLIER_SURVEY_RESPONSE(
    CSRIMP_SESSION_ID     NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
    SUPPLIER_SID          NUMBER(10, 0)    NOT NULL,
    SURVEY_RESPONSE_ID    NUMBER(10, 0)    NOT NULL,
    SURVEY_SID            NUMBER(10, 0)    NOT NULL,
    COMPONENT_ID          NUMBER(10, 0)    NULL,
    CONSTRAINT PK_SUPPLIER_SURVEY_RESPONSE PRIMARY KEY (CSRIMP_SESSION_ID, SURVEY_RESPONSE_ID),
	CONSTRAINT FK_SUPP_SURV_RESP_QK_SURV_RESP FOREIGN KEY (CSRIMP_SESSION_ID, SURVEY_SID, SURVEY_RESPONSE_ID)
		REFERENCES CSRIMP.QUICK_SURVEY_RESPONSE(CSRIMP_SESSION_ID, SURVEY_SID, SURVEY_RESPONSE_ID),
	CONSTRAINT FK_SUPP_SURV_RESP_SUPPLIER FOREIGN KEY (CSRIMP_SESSION_ID, SUPPLIER_SID)
		REFERENCES CSRIMP.SUPPLIER(CSRIMP_SESSION_ID, COMPANY_SID),
    CONSTRAINT FK_SUPP_SURV_RESP_IS FOREIGN KEY
    	(CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID)
    	ON DELETE CASCADE
)
;


-- Alter tables


ALTER TABLE CSRIMP.CHAIN_ACT_OUTC_TYPE_ACT
MODIFY DEFAULT_ACT_DATE_RELATIVE_UNIT DEFAULT NULL;

ALTER TABLE CSRIMP.CHAIN_ACT_OUTC_TYPE_ACT
MODIFY DEFAULT_SHARE_WITH_TARGET DEFAULT NULL;

ALTER TABLE CSRIMP.CHAIN_ACT_OUTC_TYPE_ACT
MODIFY COPY_TAGS DEFAULT NULL;

ALTER TABLE CSRIMP.CHAIN_ACT_OUTC_TYPE_ACT
MODIFY COPY_ASSIGNED_TO DEFAULT NULL;

ALTER TABLE CSRIMP.CHAIN_ACT_OUTC_TYPE_ACT
MODIFY COPY_TARGET DEFAULT NULL;

ALTER TABLE CSRIMP.CHAIN_ACTIVI_TYPE_ACTION
MODIFY COPY_TAGS DEFAULT NULL;

ALTER TABLE CSRIMP.CHAIN_ACTIVI_TYPE_ACTION
MODIFY COPY_ASSIGNED_TO DEFAULT NULL;

ALTER TABLE CSRIMP.CHAIN_ACTIVI_TYPE_ACTION
MODIFY COPY_TARGET DEFAULT NULL;

ALTER TABLE CSRIMP.CHAIN_ACTIVI_TYPE_ACTION
MODIFY DEFAULT_ACT_DATE_RELATIVE_UNIT DEFAULT NULL;

ALTER TABLE CSRIMP.CHAIN_ACTIVI_TYPE_ACTION
MODIFY DEFAULT_SHARE_WITH_TARGET DEFAULT NULL;

ALTER TABLE CSRIMP.CHAIN_ACTIVIT_TYPE_ALERT
MODIFY SEND_TO_ASSIGNEE DEFAULT NULL;

ALTER TABLE CSRIMP.CHAIN_ACTIVIT_TYPE_ALERT
MODIFY SEND_TO_TARGET DEFAULT NULL;

ALTER TABLE CSRIMP.CHAIN_ACTIVITY
MODIFY SHARE_WITH_TARGET DEFAULT NULL;

ALTER TABLE CSRIMP.CHAIN_ACTIVITY_TYPE
MODIFY CAN_SHARE DEFAULT NULL;

ALTER TABLE CSRIMP.CHAIN_COMPANY_TYPE
MODIFY CREATE_SUBSIDS_UNDER_PARENT DEFAULT NULL;

ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY SHOW_ONE_ISSUE_POPUP DEFAULT NULL;

ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY ALLOW_OWNER_RESOLVE_AND_CLOSE DEFAULT NULL;

ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY APPLIES_TO_AUDIT DEFAULT NULL;

ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY REGION_LINK_TYPE DEFAULT NULL;

ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY REQUIRE_DUE_DTM_COMMENT DEFAULT NULL;

ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY CREATE_RAW DEFAULT NULL;

ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY DELETED DEFAULT NULL;

ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY INVOLVE_MIN_USERS_IN_ISSUE DEFAULT NULL;

ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY SHOW_FORECAST_DTM DEFAULT NULL;

ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY REQUIRE_VAR_EXPL DEFAULT NULL;

ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY ENABLE_REJECT_ACTION DEFAULT NULL;

ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY PUBLIC_BY_DEFAULT DEFAULT NULL;

ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY OWNER_CAN_BE_CHANGED DEFAULT NULL;

ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY DELETABLE_BY_RAISER DEFAULT NULL;

ALTER TABLE CSRIMP.ISSUE_TYPE
MODIFY SEND_ALERT_ON_ISSUE_RAISED DEFAULT NULL;

ALTER TABLE CSRIMP.ISSUE_TYPE_RAG_STATUS
MODIFY POS DEFAULT NULL;

ALTER TABLE CSRIMP.ISSUE
MODIFY IS_PENDING_ASSIGNMENT DEFAULT NULL;

ALTER TABLE CSRIMP.ISSUE_CUSTOM_FIELD
MODIFY IS_MANDATORY DEFAULT NULL;

ALTER TABLE CSRIMP.QUICK_SURVEY_TYPE
MODIFY SHOW_ANSWER_SET_DTM DEFAULT NULL;

ALTER TABLE CSRIMP.QS_RESPONSE_FILE
MODIFY UPLOADED_DTM DEFAULT NULL;

ALTER TABLE CSRIMP.QS_ANSWER_LOG
MODIFY VERSION_STAMP DEFAULT NULL;

ALTER TABLE CSRIMP.NON_COMPLIANCE_TYPE
MODIFY CAN_HAVE_ACTIONS DEFAULT NULL;

ALTER TABLE CSRIMP.NON_COMPLIANCE_TYPE
MODIFY CLOSURE_BEHAVIOUR_ID DEFAULT NULL;

ALTER TABLE CSRIMP.INTERNAL_AUDIT_TYPE
MODIFY ACTIVE DEFAULT NULL;

ALTER TABLE CSRIMP.INTERNAL_AUDIT_TYPE
MODIFY NC_AUDIT_CHILD_REGION DEFAULT NULL;

ALTER TABLE CSRIMP.NON_COMP_DEFAULT
MODIFY CSRIMP_SESSION_ID DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID');

ALTER TABLE CSRIMP.NON_COMP_DEFAULT_ISSUE
MODIFY CSRIMP_SESSION_ID DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID');

ALTER TABLE CSRIMP.AUDIT_TYPE_NON_COMP_DEFAULT
MODIFY CSRIMP_SESSION_ID DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID');

ALTER TABLE CSRIMP.NON_COMP_DEFAULT_FOLDER
MODIFY CSRIMP_SESSION_ID DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID');

ALTER TABLE CSRIMP.NON_COMP_DEFAULT_TAG
MODIFY CSRIMP_SESSION_ID DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID');

DECLARE
    column_exists EXCEPTION;
    null_not_nullable EXCEPTION;
    constraint_exists EXCEPTION;
    PRAGMA exception_init (column_exists , -01430);
    PRAGMA exception_init (null_not_nullable , -01442);
    PRAGMA exception_init (constraint_exists , -02275);
    null_fail EXCEPTION;
    PRAGMA exception_init (null_fail , -01451);
BEGIN

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.FLOW_TRANSITION_ALERT ADD FLOW_ALERT_HELPER VARCHAR2(256)';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_BUSINE_RELATI_TIER ADD LOOKUP_KEY VARCHAR2(255)';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_BUSINE_RELATI_TYPE ADD LOOKUP_KEY VARCHAR2(255)';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_COMPAN_TYPE_RELATI ADD FLOW_SID NUMBER(10, 0)';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_FILTERSUPPLIERREPO ADD POSITION NUMBER(10) NULL';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_COMPANY ADD EMAIL VARCHAR2(255)';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_CUSTOMER_OPTIONS ADD EDIT_COMPANY_USE_POSTCODE_DATA NUMBER(1, 0) NOT NULL';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_CUSTOMER_OPTIONS ADD INVITATION_EXPIRATION_REM_DAYS NUMBER(10, 0) NOT NULL';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_CUSTOMER_OPTIONS ADD INVITATION_EXPIRATION_REM NUMBER(1) NOT NULL';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_CUSTOMER_OPTIONS ADD DASHBOARD_TASK_SCHEME_ID NUMBER(10, 0)';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_SAVED_FILTER ADD EXCLUDE_FROM_REPORTS NUMBER(1) NOT NULL';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.ISSUE_ACTION_LOG ADD OWNER_USER_SID NUMBER(10, 0)';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.ISSUE_CUSTOM_FIELD ADD FIELD_REFERENCE_NAME VARCHAR2(255)';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.QS_CAMPAIGN ADD SEND_ALERT NUMBER(1) NOT NULL';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.QS_CAMPAIGN ADD DYNAMIC NUMBER(1) NOT NULL';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.QS_CAMPAIGN ADD RESEND NUMBER(1) NOT NULL';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.SCORE_THRESHOLD ADD SUPPLIER_SCORE_IND_SID NUMBER(10, 0)';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.QUICK_SURVEY_ANSWER ADD LOG_ITEM CLOB';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.NON_COMPLIANCE ADD SURVEY_RESPONSE_ID NUMBER(10, 0)';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.NON_COMPLIANCE ADD REGION_SID NUMBER(10,0) NULL';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.INTERNAL_AUDIT_TYPE ADD ADD_NC_PER_QUESTION NUMBER(1,0)';
	EXCEPTION WHEN column_exists THEN NULL; END;
	
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.INTERNAL_AUDIT ADD COMPARISON_RESPONSE_ID	NUMBER(10) NULL';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.INTERNAL_AUDIT ADD AUDITOR_COMPANY_SID NUMBER(10)';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.INTERNAL_AUDIT ADD OVW_VALIDITY_DTM DATE NULL';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.INTERNAL_AUDIT ADD NC_SCORE_THRSH_ID NUMBER(10)';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.INTERNAL_AUDIT ADD OVW_NC_SCORE_THRSH_ID NUMBER(10)';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.INTERNAL_AUDIT ADD OVW_NC_SCORE_THRSH_DTM DATE';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.INTERNAL_AUDIT ADD OVW_NC_SCORE_THRSH_USR_SID NUMBER(10)';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.INTERNAL_AUDIT_TYPE_GROUP ADD GROUP_COORDINATOR_NOUN VARCHAR2(100) NULL';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.FLOW_TRANSITION_ALERT ADD FLOW_ALERT_HELPER VARCHAR2(256)';
	EXCEPTION WHEN column_exists THEN NULL; END;
		
	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.FLOW_ALERT_TYPE ADD LOOKUP_KEY VARCHAR2(256)';
	EXCEPTION WHEN column_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.ISSUE_SUPPLIER ADD COMPANY_SID NUMBER(10, 0) NOT NULL';
	EXCEPTION WHEN column_exists THEN NULL; END;



	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_BUSINE_RELATI_TIER MODIFY CREATE_NEW_COMPANY NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_ACTIVITY_INVOLVEMENT MODIFY ROLE_SID NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_CAPABILITY MODIFY SUPPLIER_ON_PURCHASER NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_COMPANY MODIFY COUNTRY_IS_HIDDEN NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_CUSTOMER_OPTIONS MODIFY ENABLE_USER_VISIBILITY_OPTIONS NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_CUSTOMER_OPTIONS MODIFY REINVITE_SUPPLIER NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_CUSTOMER_OPTIONS MODIFY SHOW_ALL_COMPONENTS NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_CUSTOMER_OPTIONS MODIFY SHOW_INVITATION_PREVIEW NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_FILE_UPLOAD MODIFY LAST_MODIFIED_BY_SID NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_PRODUCT_REVISION MODIFY VALIDATION_STATUS_ID NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_QUESTIONNAIRE MODIFY REJECTED NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_QUESTIONNAIRE_TYPE MODIFY ENABLE_STATUS_LOG NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_QUESTIONNAIRE_TYPE MODIFY ENABLE_TRANSITION_ALERT NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_QUESTIONNAIRE_TYPE MODIFY PROCURER_CAN_REVIEW NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_ACTIVITY MODIFY ASSIGNED_TO_USER_SID NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.CHAIN_ACTIVITY MODIFY ASSIGNED_TO_ROLE_SID NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.ISSUE_TYPE MODIFY DELETED NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.ISSUE_TYPE MODIFY DELETABLE_BY_RAISER NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.SCORE_TYPE MODIFY ASK_FOR_COMMENT NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.SCORE_TYPE MODIFY START_SCORE NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.SCORE_TYPE MODIFY NORMALISE_TO_MAX_SCORE NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.INTERNAL_AUDIT_TYPE MODIFY SHOW_PRIMARY_SURVEY_IN_HEADER NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.INTERNAL_AUDIT_TYPE MODIFY PRIMARY_SURVEY_ACTIVE NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.INTERNAL_AUDIT_TYPE MODIFY PRIMARY_SURVEY_MANDATORY NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.INTERNAL_AUDIT_TYPE MODIFY PRIMARY_SURVEY_FIXED NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.SCORE_THRESHOLD MODIFY BACKGROUND_COLOUR NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CHAIN.ACTIVITY_TYPE_ALERT MODIFY SEND_TO_TARGET NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CHAIN.ACTIVITY_TYPE_ALERT MODIFY SEND_TO_ASSIGNEE NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSR.QS_CAMPAIGN MODIFY CARRY_FORWARD_ANSWERS NOT NULL';
	EXCEPTION
		WHEN null_not_nullable
			THEN NULL;
		WHEN null_fail
			THEN NULL;
	END;


	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.FLOW_TRANSITION_ALERT ADD CONSTRAINT FK_TRANS_FLALERT_HELPER 
			FOREIGN KEY (CSRIMP_SESSION_ID, FLOW_ALERT_HELPER)
			REFERENCES CSRIMP.FLOW_ALERT_HELPER(CSRIMP_SESSION_ID, FLOW_ALERT_HELPER)';
	EXCEPTION WHEN constraint_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSR.QS_CAMPAIGN 
			ADD CONSTRAINT CHK_CARRY_FORWARD_ANSWERS CHECK (CARRY_FORWARD_ANSWERS IN (0,1)) ENABLE';
	EXCEPTION WHEN constraint_exists THEN NULL; END;

	BEGIN
		EXECUTE IMMEDIATE 'ALTER TABLE CSRIMP.QS_CAMPAIGN 
			ADD CONSTRAINT CHK_CARRY_FORWARD_ANSWERS CHECK (CARRY_FORWARD_ANSWERS IN (0,1)) ENABLE';
	EXCEPTION WHEN constraint_exists THEN NULL; END;

END;
/

DECLARE
	v_data_precision	NUMBER(10);
BEGIN
	SELECT COUNT(*)
	  INTO v_data_precision
	  FROM dba_tab_cols 
	 WHERE UPPER(owner) = 'CHAIN' 
	   AND UPPER(table_name) = 'REFERENCE' 
	   AND UPPER(column_name) = 'SHOW_IN_FILTER' 
	   AND DATA_PRECISION = 10;

	IF v_data_precision > 0 THEN
		EXECUTE IMMEDIATE 'ALTER TABLE CHAIN.REFERENCE ADD TEMP_SHOW_IN_FILTER NUMBER(1)';
		EXECUTE IMMEDIATE 'UPDATE CHAIN.REFERENCE SET TEMP_SHOW_IN_FILTER = SHOW_IN_FILTER';
		EXECUTE IMMEDIATE 'ALTER TABLE CHAIN.REFERENCE DROP CONSTRAINT CHK_SHOW_IN_FILTER'; 

		EXECUTE IMMEDIATE 'ALTER TABLE CHAIN.REFERENCE DROP COLUMN SHOW_IN_FILTER';
		EXECUTE IMMEDIATE 'ALTER TABLE CHAIN.REFERENCE RENAME COLUMN TEMP_SHOW_IN_FILTER TO SHOW_IN_FILTER';
		EXECUTE IMMEDIATE 'ALTER TABLE CHAIN.REFERENCE MODIFY SHOW_IN_FILTER NOT NULL';
		
		EXECUTE IMMEDIATE 'ALTER TABLE CHAIN.REFERENCE ADD CONSTRAINT CHK_SHOW_IN_FILTER CHECK (SHOW_IN_FILTER IN (0,1)) ENABLE';
	
	END IF;
END;
/

DECLARE
	v_data_precision	NUMBER(10);
BEGIN
	SELECT COUNT(*)
	  INTO v_data_precision
	  FROM dba_tab_cols 
	 WHERE UPPER(owner) = 'CHAIN' 
	   AND UPPER(table_name) = 'ACTIVITY_LOG_FILE' 
	   AND UPPER(column_name) = 'SHA1' 
	   AND DATA_TYPE = 'RAW';

	IF v_data_precision > 0 THEN
		EXECUTE IMMEDIATE 'ALTER TABLE CHAIN.ACTIVITY_LOG_FILE ADD TEMP_SHA1 VARCHAR2(40)';
		EXECUTE IMMEDIATE 'UPDATE CHAIN.ACTIVITY_LOG_FILE SET TEMP_SHA1 = CAST(SHA1 AS VARCHAR2(40))';

		EXECUTE IMMEDIATE 'ALTER TABLE CHAIN.ACTIVITY_LOG_FILE DROP COLUMN SHA1';
		EXECUTE IMMEDIATE 'ALTER TABLE CHAIN.ACTIVITY_LOG_FILE RENAME COLUMN TEMP_SHA1 TO SHA1';
		EXECUTE IMMEDIATE 'ALTER TABLE CHAIN.ACTIVITY_LOG_FILE MODIFY SHA1 NOT NULL';
	END IF;
END;
/




ALTER TABLE CSRIMP.CHAIN_FILTER_VALUE
MODIFY MIN_NUM_VAL NUMBER(24,10);




ALTER TABLE CSRIMP.CHAIN_ACTIVITY_LOG_FILE 
DROP COLUMN SHA1;

ALTER TABLE CSRIMP.CHAIN_ACTIVITY_LOG_FILE 
ADD SHA1 VARCHAR2(40) NOT NULL;

-- *** Grants ***

GRANT INSERT ON CSR.FLOW_ALERT_HELPER TO CSRIMP;
GRANT INSERT ON CSR.ISSUE_CUSTOM_FIELD_DATE_VAL TO CSRIMP;
GRANT INSERT ON CSR.QUICK_SURVEY_SCORE_THRESHOLD TO CSRIMP;
GRANT INSERT ON CSR.QUICK_SURVEY_CSS TO CSRIMP;
GRANT INSERT ON CSR.SUPPLIER_SURVEY_RESPONSE TO CSRIMP;
GRANT SELECT, INSERT, UPDATE, DELETE ON CSRIMP.QUICK_SURVEY_SCORE_THRESHOLD TO WEB_USER;
GRANT SELECT, INSERT, UPDATE, DELETE ON CSRIMP.SUPPLIER_SURVEY_RESPONSE TO WEB_USER;

-- ** Cross schema constraints ***

-- *** Views ***
-- Please paste the content of the view and add a comment referencing the path of the create_views file which will contain your view changes.

-- *** Data changes ***
-- RLS

-- Data

-- ** New package grants **

-- *** Conditional Packages ***

-- *** Packages ***
@..\schema_pkg
@..\schema_body
@..\csrimp\imp_body
@..\activity_body

@update_tail
