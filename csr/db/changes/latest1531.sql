-- Please update version.sql too -- this keeps clean builds in sync
define version=1531
@update_header

-- SEQUENCE: CSR.FUND_ID_SEQ 
--

CREATE SEQUENCE CSR.FUND_ID_SEQ
    START WITH 1
    INCREMENT BY 1
    NOMINVALUE
    NOMAXVALUE
    CACHE 20
    NOORDER;

-- TABLE: CSR.FUND 
--
DROP TABLE CSR.FUND PURGE;

CREATE TABLE CSR.FUND(
    APP_SID        NUMBER(10, 0)    NOT NULL,
    FUND_ID        NUMBER(10, 0)    NOT NULL,
    COMPANY_SID    NUMBER(10, 0)	DEFAULT SYS_CONTEXT('SECURITY','CHAIN_COMPANY'),
    NAME           VARCHAR2(255)    NOT NULL,
    CONSTRAINT PK_FUND PRIMARY KEY (APP_SID, FUND_ID)
);
 
ALTER TABLE CSR.PROPERTY ADD (
	PROPERTY_SUB_TYPE_ID    NUMBER(10, 0),
    FUND_ID                NUMBER(10, 0)
);
 
-- TABLE: CSR.PROPERTY_SUB_TYPE 
--

CREATE TABLE CSR.PROPERTY_SUB_TYPE(
    APP_SID                 NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    PROPERTY_SUB_TYPE_ID    NUMBER(10, 0)    NOT NULL,
    PROPERTY_TYPE_ID        NUMBER(10, 0)    NOT NULL,
    LABEL                   VARCHAR2(255)    NOT NULL,
    CONSTRAINT PK_PROPERTY_SUB_TYPE PRIMARY KEY (APP_SID, PROPERTY_SUB_TYPE_ID),
    CONSTRAINT UK_PROPERTY_SUB_TYPE  UNIQUE (APP_SID, PROPERTY_TYPE_ID, PROPERTY_SUB_TYPE_ID)
);

-- TABLE: CSR.FUND 
--

ALTER TABLE CSR.FUND ADD CONSTRAINT FK_SUPPLIER_FUND 
    FOREIGN KEY (APP_SID, COMPANY_SID)
    REFERENCES CSR.SUPPLIER(APP_SID, SUPPLIER_SID);

ALTER TABLE CSR.PROPERTY ADD CONSTRAINT FK_FUND_PROPERTY 
    FOREIGN KEY (APP_SID, FUND_ID)
    REFERENCES CSR.FUND(APP_SID, FUND_ID);


ALTER TABLE CSR.PROPERTY ADD CONSTRAINT FK_PROP_SUB_TYP_PROP 
    FOREIGN KEY (APP_SID, PROPERTY_TYPE_ID, PROPERTY_SUB_TYPE_ID)
    REFERENCES CSR.PROPERTY_SUB_TYPE(APP_SID, PROPERTY_TYPE_ID, PROPERTY_SUB_TYPE_ID);


-- TABLE: CSR.PROPERTY_SUB_TYPE 
--

ALTER TABLE CSR.PROPERTY_SUB_TYPE ADD CONSTRAINT FK_PROP_TYP_PROP_SUB_TYP 
    FOREIGN KEY (APP_SID, PROPERTY_TYPE_ID)
    REFERENCES CSR.PROPERTY_TYPE(APP_SID, PROPERTY_TYPE_ID);


@update_tail