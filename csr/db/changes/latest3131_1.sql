-- Please update version.sql too -- this keeps clean builds in sync
define version=3131
define minor_version=1
@update_header

-- *** DDL ***
-- Create tables


-- move existing tables out of the way


@latestUS10822_packages

begin
	security.user_pkg.logonadmin;
	for r in (select distinct t.app_sid, c.host from cms.tab t
				join csr.customer c on c.app_sid = t.app_sid
			   where t.oracle_schema = 'CHAIN' and t.oracle_table = 'BSCI_SUPPLIER') loop
		security.security_pkg.debugmsg('Unregistering BSCI tables from ' || r.host);
		security.security_pkg.setapp(r.app_sid);

		CMS.temp_tab_pkg.UnregisterTable('CHAIN','BSCI_SUPPLIER');
		CMS.temp_tab_pkg.UnregisterTable('CHAIN','BSCI_RSP');
		commit;
	end loop;
	security.user_pkg.logonadmin;
end;
/

DROP PACKAGE cms.TEMP_TAB_PKG;


ALTER TABLE chain.bsci_supplier
  RENAME TO xxx_bsci_supplier;

DROP INDEX CHAIN.IX_BSCI_SUPPLIER_COMPANY_SID;
DROP INDEX CHAIN.IX_BSCI_SUPPLIER_RSP_ID;
ALTER TABLE chain.XXX_BSCI_SUPPLIER DROP CONSTRAINT CHK_IS_AUDIT_IN_PROGRESS;
ALTER TABLE chain.XXX_BSCI_SUPPLIER DROP CONSTRAINT FK_BSCI_SUPPLIER_COMP;
ALTER TABLE chain.XXX_BSCI_SUPPLIER RENAME CONSTRAINT PK_BSCI_SUPPLIER TO PK_XXX_BSCI_SUPPLIER;
ALTER INDEX chain.PK_BSCI_SUPPLIER RENAME TO PK_XXX_BSCI_SUPPLIER;
ALTER TABLE chain.XXX_BSCI_SUPPLIER DROP CONSTRAINT FK_BSCI_SUPPLIER_RSP;

ALTER TABLE chain.bsci_audit
  RENAME TO xxx_bsci_audit;
ALTER TABLE chain.XXX_BSCI_AUDIT RENAME CONSTRAINT PK_BSCI_AUDIT TO PK_XXX_BSCI_AUDIT;
ALTER INDEX chain.PK_BSCI_AUDIT RENAME TO PK_XXX_BSCI_AUDIT;

-- create new schema
CREATE SEQUENCE CHAIN.BSCI_LOG_ID_SEQ
    START WITH 1
    INCREMENT BY 1
    NOMINVALUE
    NOMAXVALUE
    CACHE 20
    NOORDER
;

CREATE TABLE CHAIN.BSCI_LOG(
	APP_SID							NUMBER(10, 0)	DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
	BSCI_LOG_ID						NUMBER(10, 0)	NOT NULL,
	OUTBOUND_MESSAGE				CLOB,
	INBOUND_MESSAGE					CLOB,
	LOG_DTM							DATE			DEFAULT SYSDATE NOT NULL,
	CONSTRAINT PK_BSCI_LOG PRIMARY KEY (APP_SID, BSCI_LOG_ID)
);

CREATE SEQUENCE CHAIN.BSCI_INTEGRATION_REPORT_ID_SEQ
    START WITH 1
    INCREMENT BY 1
    NOMINVALUE
    NOMAXVALUE
    CACHE 20
    NOORDER
;

CREATE TABLE CHAIN.BSCI_INTEGRATION_REPORT(
	APP_SID							NUMBER(10)		DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
	BSCI_INTEGRATION_REPORT_ID		NUMBER(10)		NOT NULL,
	START_DTM						DATE			NOT NULL,
	END_DTM 						DATE			NOT NULL,
	SUPPLIERS_CLEANED 				VARCHAR2(4000),
	N_SUPPLIERS_CLEANED 			NUMBER(10)		NOT NULL,
	SIZE_OF_BSCI_SUPPLY_CHAIN		NUMBER(10)		NOT NULL,
	N_UNIQUE_IDS_ENTERED 			NUMBER(10)		NOT NULL,
	FAULTY_BSCI_IDS 				VARCHAR2(4000),
	N_FAULTY_BSCI_IDS 				NUMBER(10)		NOT NULL,
	MISSING_BSCI_IDS 				VARCHAR2(4000),
	N_MISSING_BSCI_IDS 				NUMBER(10)		NOT NULL,
	SUPPLIER_SYNC_ENABLED 			NUMBER(1)		NOT NULL,
	AUDIT_SYNC_ENABLED 				NUMBER(1)		NOT NULL,
	NO_UPDATE_NEEDED_SUPS 			VARCHAR2(4000),
	N_NO_UPDATE_NEEDED_SUPS 		NUMBER(10)		NOT NULL,
	UPDATED_SUPPLIERS 				VARCHAR2(4000),
	N_UPDATED_SUPPLIERS 			NUMBER(10)		NOT NULL,
	ERRORED_SUPPLIERS 				VARCHAR2(4000),
	N_ERRORED_SUPPLIERS 			NUMBER(10)		NOT NULL,
	TOTAL_SUPPLIERS_PROCESSED		NUMBER(10)		NOT NULL,
	NO_UPDATE_NEEDED_AUDS 			VARCHAR2(4000),
	N_NO_UPDATE_NEEDED_AUDS 		NUMBER(10)		NOT NULL,
	OUTSIDE_WINDOW_AUDS 			VARCHAR2(4000),
	N_OUTSIDE_WINDOW_AUDS 			NUMBER(10)		NOT NULL,
	UPDATED_AUDITS 					VARCHAR2(4000),
	N_UPDATED_AUDITS 				NUMBER(10)		NOT NULL,
	ERRORED_AUDITS 					VARCHAR2(4000),
	N_ERRORED_AUDITS 				NUMBER(10)		NOT NULL,
	TOTAL_AUDITS_PROCESSED			NUMBER(10)		NOT NULL,
	CONSTRAINT PK_BSCI_INTEGRATION_REPORT PRIMARY KEY (APP_SID, BSCI_INTEGRATION_REPORT_ID),
	CONSTRAINT CHK_RPT_SUPPLIER_SYNC_ENABLED CHECK (SUPPLIER_SYNC_ENABLED IN (0,1)),
	CONSTRAINT CHK_RPT_AUDIT_SYNC_ENABLED CHECK (AUDIT_SYNC_ENABLED IN (0,1))
);

CREATE SEQUENCE CHAIN.BSCI_SUPPLIER_ID_SEQ
    START WITH 1
    INCREMENT BY 1
    NOMINVALUE
    NOMAXVALUE
    CACHE 20
    NOORDER
;

CREATE TABLE CHAIN.BSCI_SUPPLIER(
	APP_SID							NUMBER(10)		DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
	BSCI_SUPPLIER_ID				NUMBER(10)		NOT NULL,
	COMPANY_SID						NUMBER(10)		NOT NULL,
	BSCI_FACTORY_ID					NUMBER(10)		NOT NULL,
	LATEST_VERSION					NUMBER(10)		NOT NULL,
	IS_AUDIT_IN_PROGRESS			NUMBER(1)		DEFAULT 0 NOT NULL,
	LAST_UPDATED_DTM				DATE,
	CONSTRAINT PK_BSCI_SUPPLIER PRIMARY KEY (APP_SID, BSCI_SUPPLIER_ID),
	CONSTRAINT CHK_IS_AUDIT_IN_PROGRESS CHECK(IS_AUDIT_IN_PROGRESS IN (0,1))
);



ALTER TABLE CHAIN.BSCI_SUPPLIER ADD (CONSTRAINT FK_BSCI_SUPPLIER_COMP
	FOREIGN KEY (APP_SID, COMPANY_SID) REFERENCES CHAIN.COMPANY (APP_SID, COMPANY_SID));


CREATE UNIQUE INDEX CHAIN.UK_BSCI_SUPPLIER ON CHAIN.BSCI_SUPPLIER (COMPANY_SID, BSCI_FACTORY_ID, LATEST_VERSION);

CREATE INDEX CHAIN.IX_BSCI_SUPPLIER_COMPANY_SID ON CHAIN.BSCI_SUPPLIER (APP_SID, COMPANY_SID);

CREATE TABLE CHAIN.BSCI_SUPPLIER_DET(
	APP_SID							NUMBER(10)		DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
	BSCI_SUPPLIER_ID				NUMBER(10)		NOT NULL,
	VERSION_NUMBER					NUMBER(10)		NOT NULL,
	XML								CLOB			NOT NULL,
	ADDRESS							VARCHAR2(4000)	NULL,
	CITY							VARCHAR2(255)	NULL,
	INDUSTRY						VARCHAR2(255)	NULL,
	COUNTRY							VARCHAR2(255)	NOT NULL,
	POSTCODE						VARCHAR2(255)	NULL,
	REGION							VARCHAR2(255)	NULL,
	TERRITORY						VARCHAR2(255)	NULL,
	ADDRESS_LOCATION_TYPE			VARCHAR2(255)	NOT NULL,
	AUDIT_ANNOUNCEMENT_METHOD		VARCHAR2(255)	NULL,
	FACTORY_CONTACT					VARCHAR2(255)	NOT NULL,
	AUDIT_EXPIRATION_DTM			DATE			NULL,
	AUDIT_IN_PROGRESS				VARCHAR2(255)	NULL,
	AUDIT_RESULT					VARCHAR2(255)	NULL,
	BSCI_COMMENTS					VARCHAR2(4000)	NULL,
	LINKED_PARTICIPANTS				VARCHAR2(255)	NULL,
	IN_COMMITMENTS					VARCHAR2(255)	NULL,
	IN_SUPPLY_CHAIN					VARCHAR2(255)	NULL,
	LEGAL_STATUS					VARCHAR2(255)	NULL,
	NAME							VARCHAR2(255)	NULL,
	NUMBER_OF_ASSOCIATES			NUMBER(10)		NULL,
	NUMBER_OF_BUILDINGS				NUMBER(10)		NULL,
	PARTICIPANT_NAME				VARCHAR2(255)	NULL,
	PRODUCT_GROUP					VARCHAR2(255)	NULL,
	PRODUCT_TYPE					VARCHAR2(255)	NULL,
	CODE_OF_CONDUCT_ACCEPTED		VARCHAR2(255)	NULL,
	CODE_OF_CONDUCT_SIGNED			VARCHAR2(255)	NULL,
	AUDIT_DTM						DATE			NULL,
	SECTOR							VARCHAR2(255)	NULL,
	WEBSITE							VARCHAR2(255)	NULL,
	YEAR_FOUNDED					NUMBER(10),
	AUDIT_TYPE						VARCHAR2(255)	NULL,
	RSP_ID							NUMBER(10)		NULL,
	IS_AUDIT_IN_PROGRESS			NUMBER(1)		NULL,
	AUDIT_IN_PROGRESS_DTM			DATE			NULL,
	CODE_OF_CONDUCT_SIGN_INT		VARCHAR2(255)	NULL,
	SA8000_CERTIFIED				VARCHAR2(255)	NULL,
	AUDIT_CERTIFICATION				VARCHAR2(4000)	NULL,
	ADDRESS_TYPE					VARCHAR2(255)	NULL,
	ALIAS							VARCHAR2(4000)	NULL,
	BRANDS							VARCHAR2(4000)	NULL,
	BUSINESS_UNIT					VARCHAR2(4000)	NULL,
	EMAIL_ADDRESS					VARCHAR2(255)	NULL,
	CONSTRAINT PK_BSCI_SUPPLIER_DET PRIMARY KEY (APP_SID, BSCI_SUPPLIER_ID, VERSION_NUMBER),
	CONSTRAINT CHK_BSD_IS_AUDIT_IN_PROGRESS CHECK(IS_AUDIT_IN_PROGRESS IN (0,1))
);

ALTER TABLE CHAIN.BSCI_SUPPLIER_DET ADD (CONSTRAINT FK_BSCI_SUPPLIER_RSP
	FOREIGN KEY (RSP_ID) REFERENCES CHAIN.BSCI_RSP (RSP_ID));

ALTER TABLE CHAIN.BSCI_SUPPLIER_DET ADD (CONSTRAINT FK_CHAIN_BSCI_SUPPLIER_DET
	FOREIGN KEY (APP_SID, BSCI_SUPPLIER_ID) REFERENCES chain.BSCI_SUPPLIER (APP_SID, BSCI_SUPPLIER_ID));

CREATE INDEX CHAIN.IX_BSCI_SUPPLIER_DET_RSP_ID ON CHAIN.BSCI_SUPPLIER_DET (RSP_ID);

CREATE INDEX CHAIN.IX_BSCI_SUPPLIER_DET_ID ON CHAIN.BSCI_SUPPLIER_DET (BSCI_SUPPLIER_ID);

CREATE SEQUENCE CHAIN.BSCI_AUDIT_ID_SEQ
	START WITH 1
	INCREMENT BY 1
	NOMINVALUE
	NOMAXVALUE
	CACHE 20
	NOORDER
;

CREATE TABLE CHAIN.BSCI_AUDIT(
	APP_SID							NUMBER(10)		DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
	BSCI_AUDIT_ID					NUMBER(10)		NOT NULL,
	INTERNAL_AUDIT_SID				NUMBER(10)		NOT NULL,
	AUDIT_REF						NUMBER(10)		NOT NULL,
	LATEST_VERSION    				NUMBER(10)		NOT NULL,
	LAST_UPDATED_DTM				DATE,
	BSCI_AUDIT_TYPE					NUMBER(1)		NOT NULL,
	CONSTRAINT PK_BSCI_AUDIT PRIMARY KEY (APP_SID, BSCI_AUDIT_ID),
	CONSTRAINT CHK_BSCI_AUDIT_TYPE CHECK (BSCI_AUDIT_TYPE IN (0,1,2))
);

CREATE UNIQUE INDEX CHAIN.UK_BSCI_AUDIT ON CHAIN.BSCI_AUDIT (INTERNAL_AUDIT_SID, AUDIT_REF, LATEST_VERSION);

CREATE INDEX CHAIN.IX_BSCI_AUDIT_AUDIT_SID ON CHAIN.BSCI_AUDIT (APP_SID, INTERNAL_AUDIT_SID);

CREATE TABLE CHAIN.BSCI_2009_AUDIT(
	APP_SID							NUMBER(10)		DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
	BSCI_2009_AUDIT_ID				NUMBER(10)		NOT NULL,
	BSCI_AUDIT_ID					NUMBER(10)		NOT NULL,
	VERSION_NUMBER					NUMBER(10)		NOT NULL,
	XML								CLOB			NOT NULL,
	AUDIT_REF 						NUMBER(10)		NOT NULL,
	DTM								DATE			NOT NULL,
	EXPIRY_DTM						DATE			NOT NULL,
	SCORE							VARCHAR2(255),
	AUDIT_ANNOUNCED					NUMBER(1)		NOT NULL,
	AUDIT_STAGE						VARCHAR2(255)	NOT NULL,
	AUDIT_METHODOLOGY				VARCHAR2(255),
	LEAD_AUDITOR_NAME				VARCHAR2(255),
	MAN_DAYS						NUMBER(10,3),
	CYCLE							VARCHAR2(255),
	TOTAL_TURNOVER					NUMBER(24, 10),
	INTERVIEW_ESSENTIALS			CLOB,
	B_1								NUMBER(10),
	B_2								NUMBER(10),
	B_3								NUMBER(10),
	B_4								NUMBER(10),
	B_5_1							NUMBER(10),
	B_5_2							NUMBER(10),
	B_6								NUMBER(10),
	B_7								NUMBER(10),
	B_8								NUMBER(10),
	B_9								NUMBER(10),
	B_10							NUMBER(10),
	B_11							NUMBER(10),
	B_12							NUMBER(10),
	B_13							NUMBER(10),
	CONSTRAINT PK_BSCI_2009_AUDIT PRIMARY KEY (APP_SID, BSCI_2009_AUDIT_ID),
	CONSTRAINT CHK_2009_AUDIT_ANNOUNCED CHECK (AUDIT_ANNOUNCED IN (0,1))
);

ALTER TABLE CHAIN.BSCI_2009_AUDIT ADD CONSTRAINT FK_CHAIN_2009_BSCI_AUDIT
	FOREIGN KEY (APP_SID, BSCI_AUDIT_ID) REFERENCES CHAIN.BSCI_AUDIT (APP_SID, BSCI_AUDIT_ID);

CREATE INDEX CHAIN.IX_BSCI_2009_AUDIT_AUDIT_ID ON CHAIN.BSCI_2009_AUDIT (APP_SID, BSCI_AUDIT_ID);

CREATE SEQUENCE CHAIN.BSCI_2009_AUDIT_ID_SEQ
	START WITH 1
	INCREMENT BY 1
	NOMINVALUE
	NOMAXVALUE
	CACHE 20
	NOORDER
;

CREATE SEQUENCE CHAIN.BSCI_2009_A_FINDING_ID_SEQ
	START WITH 1
	INCREMENT BY 1
	NOMINVALUE
	NOMAXVALUE
	CACHE 20
	NOORDER
;

CREATE TABLE CHAIN.BSCI_2009_AUDIT_FINDING (
	APP_SID							NUMBER(10,0)	DEFAULT SYS_CONTEXT('SECURITY', 'APP') NOT NULL,
	BSCI_2009_AUDIT_FINDING_ID		NUMBER(10)		NOT NULL,
	BSCI_2009_AUDIT_ID				NUMBER(10)		NOT NULL,
	MSI_CATEGORY					VARCHAR2(255)	NOT NULL,
	MSI_SUB_CATEGORY				VARCHAR2(255)	NULL,
	SCORE							NUMBER(10,0)	NOT NULL,
	QUESTION						CLOB			NULL,
	GUIDELINES						CLOB			NULL,
	RATING							CLOB			NULL,
	CONSTRAINT PK_BSCI_2009_AUDIT_FINDING PRIMARY KEY (BSCI_2009_AUDIT_FINDING_ID)
);

ALTER TABLE CHAIN.BSCI_2009_AUDIT_FINDING ADD CONSTRAINT FK_BSCI_2009_AUDIT_FIND
	FOREIGN KEY (APP_SID, BSCI_2009_AUDIT_ID) REFERENCES CHAIN.BSCI_2009_AUDIT (APP_SID, BSCI_2009_AUDIT_ID);

CREATE INDEX CHAIN.IX_BSCI_2009_FIND_AUDIT_ID ON CHAIN.BSCI_2009_AUDIT_FINDING (APP_SID, BSCI_2009_AUDIT_ID);

CREATE SEQUENCE CHAIN.BSCI_2009_A_ASSOCIATE_ID_SEQ
	START WITH 1
	INCREMENT BY 1
	NOMINVALUE
	NOMAXVALUE
	CACHE 20
	NOORDER
;

CREATE TABLE CHAIN.BSCI_2009_AUDIT_ASSOCIATE (
	APP_SID							NUMBER(10,0)	DEFAULT SYS_CONTEXT('SECURITY', 'APP') NOT NULL,
	BSCI_2009_AUDIT_ASSOCIATE_ID	NUMBER(10)		NOT NULL,
	BSCI_2009_AUDIT_ID				NUMBER(10)		NOT NULL,
	ASSOCIATE						VARCHAR2(255)	NOT NULL,
	ASSOCIATE_COUNT					NUMBER(10,0)	NOT NULL,
	CONSTRAINT PK_BSCI_2009_AUDIT_ASSOC_ID PRIMARY KEY (BSCI_2009_AUDIT_ASSOCIATE_ID)
 );

ALTER TABLE CHAIN.BSCI_2009_AUDIT_ASSOCIATE ADD CONSTRAINT FK_BSCI_2009_AUDIT_ASSOC
	FOREIGN KEY (APP_SID, BSCI_2009_AUDIT_ID) REFERENCES CHAIN.BSCI_2009_AUDIT (APP_SID, BSCI_2009_AUDIT_ID);

CREATE INDEX CHAIN.IX_BSCI_2009_ASSOC_AUDIT_ID ON CHAIN.BSCI_2009_AUDIT_ASSOCIATE (APP_SID, BSCI_2009_AUDIT_ID);


CREATE SEQUENCE CHAIN.BSCI_2014_AUDIT_ID_SEQ
	START WITH 1
	INCREMENT BY 1
	NOMINVALUE
	NOMAXVALUE
	CACHE 20
	NOORDER
;

CREATE TABLE CHAIN.BSCI_2014_AUDIT(
	APP_SID						NUMBER(10)		DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
	BSCI_2014_AUDIT_ID			NUMBER(10)		NOT NULL,
	BSCI_AUDIT_ID				NUMBER(10)		NOT NULL,
	VERSION_NUMBER				NUMBER(10)		NOT NULL,
	XML							CLOB			NOT NULL,
	AUDIT_REF 					NUMBER(10)		DEFAULT 0 NOT NULL,
	DTM							DATE			NOT NULL,
	EXPIRY_DTM					DATE			NOT NULL,
	SCORE						VARCHAR2(255),
	AUDIT_ANNOUNCED				NUMBER(1)		NOT NULL,
	AUDIT_STAGE					VARCHAR2(255)	NOT NULL,
	AUDIT_ENVIRONMENT			VARCHAR2(255),
	AUDITING_COMPANY			VARCHAR2(255),
	AUDITING_COMPANY_BRANCH		VARCHAR2(255),
	MAN_DAYS					NUMBER(10,3),
	NEED_FOLLOW_UP				VARCHAR2(255),
	AUDITOR_COMMENTS			CLOB,
	EXECUTIVE_SUMMARY_AUDIT_RPT	CLOB,
	INTERVIEW_ESSENTIALS		CLOB,
	LEAD_AUDITOR_NAME			VARCHAR2(255),
	PA1							VARCHAR2(255),
	PA2							VARCHAR2(255),
	PA3							VARCHAR2(255),
	PA4							VARCHAR2(255),
	PA5							VARCHAR2(255),
	PA6							VARCHAR2(255),
	PA7							VARCHAR2(255),
	PA8							VARCHAR2(255),
	PA9							VARCHAR2(255),
	PA10						VARCHAR2(255),
	PA11						VARCHAR2(255),
	PA12						VARCHAR2(255),
	PA13						VARCHAR2(255),
	CONSTRAINT PK_BSCI_2014_AUDIT PRIMARY KEY (APP_SID, BSCI_2014_AUDIT_ID)
);

ALTER TABLE CHAIN.BSCI_2014_AUDIT ADD CONSTRAINT FK_CHAIN_2014_BSCI_AUDIT
	FOREIGN KEY (APP_SID, BSCI_AUDIT_ID) REFERENCES CHAIN.BSCI_AUDIT (APP_SID, BSCI_AUDIT_ID);

CREATE INDEX CHAIN.IX_BSCI_2014_AUDIT_AUDIT_ID ON CHAIN.BSCI_2014_AUDIT (APP_SID, BSCI_AUDIT_ID);

CREATE SEQUENCE CHAIN.BSCI_2014_A_FINDING_ID_SEQ
	START WITH 1
	INCREMENT BY 1
	NOMINVALUE
	NOMAXVALUE
	CACHE 20
	NOORDER
;

CREATE TABLE CHAIN.BSCI_2014_AUDIT_FINDING (
	APP_SID						NUMBER(10,0)	DEFAULT SYS_CONTEXT('SECURITY', 'APP') NOT NULL,
	BSCI_2014_AUDIT_FINDING_ID	NUMBER(10)		NOT NULL,
	BSCI_2014_AUDIT_ID			NUMBER(10)		NOT NULL,
	SUBHEADER_VAL				VARCHAR2(255)	NOT NULL,
	SUBHEADER_DESC				VARCHAR2(255)	NULL,
	SCORE						NUMBER(10,0)	NOT NULL,
	QUESTION					CLOB			NULL,
	GUIDELINES					CLOB			NULL,
	RATING						CLOB			NULL,
	CONSTRAINT PK_BSCI_2014_AUDIT_FINDING PRIMARY KEY (BSCI_2014_AUDIT_FINDING_ID)
);

ALTER TABLE CHAIN.BSCI_2014_AUDIT_FINDING ADD CONSTRAINT FK_BSCI_2014_AUDIT_FIND
	FOREIGN KEY (APP_SID, BSCI_2014_AUDIT_ID) REFERENCES CHAIN.BSCI_2014_AUDIT (APP_SID, BSCI_2014_AUDIT_ID);

CREATE INDEX CHAIN.IX_BSCI_2014_FIND_AUDIT_ID ON CHAIN.BSCI_2014_AUDIT_FINDING (APP_SID, BSCI_2014_AUDIT_ID);


CREATE SEQUENCE CHAIN.BSCI_2014_A_ASSOCIATE_ID_SEQ
	START WITH 1
	INCREMENT BY 1
	NOMINVALUE
	NOMAXVALUE
	CACHE 20
	NOORDER
;

CREATE TABLE CHAIN.BSCI_2014_AUDIT_ASSOCIATE (
	APP_SID							NUMBER(10,0)	DEFAULT SYS_CONTEXT('SECURITY', 'APP') NOT NULL,
	BSCI_2014_AUDIT_ASSOCIATE_ID	NUMBER(10)		NOT NULL,
	BSCI_2014_AUDIT_ID				NUMBER(10)		NOT NULL,
	ASSOCIATE						VARCHAR2(255)	NOT NULL,
	ASSOCIATE_COUNT					NUMBER(10,0)	NOT NULL,
	CONSTRAINT PK_BSCI_2014_AUDIT_ASSOC_ID PRIMARY KEY (BSCI_2014_AUDIT_ASSOCIATE_ID)
 );

ALTER TABLE CHAIN.BSCI_2014_AUDIT_ASSOCIATE ADD CONSTRAINT FK_BSCI_2014_AUDIT_ASSOC
	FOREIGN KEY (APP_SID, BSCI_2014_AUDIT_ID) REFERENCES CHAIN.BSCI_2014_AUDIT (APP_SID, BSCI_2014_AUDIT_ID);

CREATE INDEX CHAIN.IX_BSCI_2014_ASSOC_AUDIT_ID ON CHAIN.BSCI_2014_AUDIT_ASSOCIATE (APP_SID, BSCI_2014_AUDIT_ID);


CREATE SEQUENCE CHAIN.BSCI_EXT_AUDIT_ID_SEQ
	START WITH 1
	INCREMENT BY 1
	NOMINVALUE
	NOMAXVALUE
	CACHE 20
	NOORDER
;

CREATE TABLE CHAIN.BSCI_EXT_AUDIT(
	APP_SID							NUMBER(10)		DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
	BSCI_EXT_AUDIT_ID				NUMBER(10)		NOT NULL,
	BSCI_AUDIT_ID					NUMBER(10)		NOT NULL,
	VERSION_NUMBER					NUMBER(10)		NOT NULL,
	XML								CLOB			NOT NULL,
	AUDIT_REF						NUMBER(10)		DEFAULT 0 NOT NULL,
	DTM								DATE			NOT NULL,
	EXPIRY_DTM						DATE			NOT NULL,
	AUDIT_SCORE						VARCHAR2(255),
	AUDIT_TYPE						VARCHAR2(255),
	EXTERNAL_AUDIT_TYPE				VARCHAR2(255),
	AUDITING_COMPANY				VARCHAR2(255),
	SEQUENCE_NUMBER					NUMBER(10),
	CONSTRAINT PK_BSCI_EXT_AUDIT PRIMARY KEY (APP_SID, BSCI_AUDIT_ID, VERSION_NUMBER)
);

ALTER TABLE CHAIN.BSCI_EXT_AUDIT ADD CONSTRAINT FK_CHAIN_EXT_BSCI_AUDIT
	FOREIGN KEY (APP_SID, BSCI_AUDIT_ID) REFERENCES chain.BSCI_AUDIT (APP_SID, BSCI_AUDIT_ID);

CREATE INDEX CHAIN.IX_BSCI_EXT_AUDIT_AUDIT_ID ON CHAIN.BSCI_EXT_AUDIT (APP_SID, BSCI_AUDIT_ID);








------------------------------------------------------------------------------------------------
-- CSRIMP
------------------------------------------------------------------------------------------------

DROP TABLE CSRIMP.CHAIN_BSCI_OPTIONS;
DROP TABLE CSRIMP.CHAIN_BSCI_SUPPLIER;
DROP TABLE CSRIMP.CHAIN_BSCI_AUDIT;


DROP TABLE CSRIMP.CHAIN_BSCI_ASSOCIATE;
DROP TABLE CSRIMP.CHAIN_BSCI_FINDING;

DROP TABLE CSRIMP.CHAIN_CUSTOMER_GRID_EXT;


CREATE TABLE CSRIMP.CHAIN_CUSTOMER_GRID_EXT (
	CSRIMP_SESSION_ID				NUMBER(10, 0)	DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	GRID_EXTENSION_ID				NUMBER(10),
	ENABLED							NUMBER(1),
	CONSTRAINT PK_CUSTOMER_GRID_EXTENSION PRIMARY KEY (CSRIMP_SESSION_ID, GRID_EXTENSION_ID),
	CONSTRAINT FK_CUSTOMER_GRID_EXTENSION FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.CHAIN_BSCI_OPTIONS (
	CSRIMP_SESSION_ID				NUMBER(10, 0)	DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	USER_NAME						VARCHAR2(255)	NOT NULL,
	PASSWORD						VARCHAR2(255)	NOT NULL,
	AUDIT_TYPE_2009_ID				NUMBER(10),
	AUDIT_TYPE_2014_ID				NUMBER(10),
	AUDIT_TYPE_EXT_ID				NUMBER(10),
	AUDIT_SYNC_ENABLED				NUMBER(1) NOT NULL,
	LAST_AUDIT_SYNC_DTM				DATE NULL,
	SUPPLIER_SYNC_ENABLED 			NUMBER(1) NOT NULL,
	LAST_SUPPLIER_SYNC_DTM 			DATE NULL,
	USE_TEST_SERVER		 			NUMBER(1) NOT NULL,
	UPDATE_LATEST_AUDIT_ONLY		NUMBER(1) NOT NULL,
	ONLY_AUDITS_WITHIN_REL 			NUMBER(1) NOT NULL,
	CONSTRAINT PK_BSCI_OPTIONS PRIMARY KEY (CSRIMP_SESSION_ID),
	CONSTRAINT FK_BO_SESSION FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.CHAIN_BSCI_SUPPLIER (
	CSRIMP_SESSION_ID				NUMBER(10, 0)	DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	BSCI_SUPPLIER_ID				NUMBER(10)		NOT NULL,
	COMPANY_SID						NUMBER(10)		NOT NULL,
	BSCI_FACTORY_ID					NUMBER(10)		NOT NULL,
	LATEST_VERSION					NUMBER(10)		NOT NULL,
	IS_AUDIT_IN_PROGRESS			NUMBER(1) NOT NULL,
	LAST_UPDATED_DTM				DATE,
	CONSTRAINT PK_BSCI_SUPPLIER PRIMARY KEY (CSRIMP_SESSION_ID, BSCI_SUPPLIER_ID),
	CONSTRAINT FK_BSCI_SUPPLIER_SESSION FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.CHAIN_BSCI_SUPPLIER_DET (
	CSRIMP_SESSION_ID				NUMBER(10, 0)	DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	BSCI_SUPPLIER_ID				NUMBER(10)		NOT NULL,
	VERSION_NUMBER					NUMBER(10)		NOT NULL,
	XML								CLOB			NOT NULL,
	ADDRESS							VARCHAR2(4000)	NULL,
	CITY							VARCHAR2(255)	NULL,
	INDUSTRY						VARCHAR2(255)	NULL,
	COUNTRY							VARCHAR2(255)	NOT NULL,
	POSTCODE						VARCHAR2(255)	NULL,
	REGION							VARCHAR2(255)	NULL,
	TERRITORY						VARCHAR2(255)	NULL,
	ADDRESS_LOCATION_TYPE			VARCHAR2(255)	NOT NULL,
	AUDIT_ANNOUNCEMENT_METHOD		VARCHAR2(255)	NULL,
	FACTORY_CONTACT					VARCHAR2(255)	NOT NULL,
	AUDIT_EXPIRATION_DTM			DATE			NULL,
	AUDIT_IN_PROGRESS				VARCHAR2(255)	NULL,
	AUDIT_RESULT					VARCHAR2(255)	NULL,
	BSCI_COMMENTS					VARCHAR2(4000)	NULL,
	LINKED_PARTICIPANTS				VARCHAR2(255)	NULL,
	IN_COMMITMENTS					VARCHAR2(255)	NULL,
	IN_SUPPLY_CHAIN					VARCHAR2(255)	NULL,
	LEGAL_STATUS					VARCHAR2(255)	NULL,
	NAME							VARCHAR2(255)	NULL,
	NUMBER_OF_ASSOCIATES			NUMBER(10)		NULL,
	NUMBER_OF_BUILDINGS				NUMBER(10)		NULL,
	PARTICIPANT_NAME				VARCHAR2(255)	NULL,
	PRODUCT_GROUP					VARCHAR2(255)	NULL,
	PRODUCT_TYPE					VARCHAR2(255)	NULL,
	CODE_OF_CONDUCT_ACCEPTED		VARCHAR2(255)	NULL,
	CODE_OF_CONDUCT_SIGNED			VARCHAR2(255)	NULL,
	AUDIT_DTM						DATE			NULL,
	SECTOR							VARCHAR2(255)	NULL,
	WEBSITE							VARCHAR2(255)	NULL,
	YEAR_FOUNDED					NUMBER(10),
	AUDIT_TYPE						VARCHAR2(255)	NULL,
	RSP_ID							NUMBER(10)		NULL,
	IS_AUDIT_IN_PROGRESS			NUMBER(1)		NULL,
	AUDIT_IN_PROGRESS_DTM			DATE			NULL,
	CODE_OF_CONDUCT_SIGN_INT		VARCHAR2(255)	NULL,
	SA8000_CERTIFIED				VARCHAR2(255)	NULL,
	AUDIT_CERTIFICATION				VARCHAR2(4000)	NULL,
	ADDRESS_TYPE					VARCHAR2(255)	NULL,
	ALIAS							VARCHAR2(4000)	NULL,
	BRANDS							VARCHAR2(4000)	NULL,
	BUSINESS_UNIT					VARCHAR2(4000)	NULL,
	EMAIL_ADDRESS					VARCHAR2(255)	NULL,
	CONSTRAINT PK_BSCI_SUPPLIER_DET PRIMARY KEY (CSRIMP_SESSION_ID, BSCI_SUPPLIER_ID, VERSION_NUMBER),
	CONSTRAINT FK_BSCI_SUPPLIER_DET_SESSION FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.CHAIN_BSCI_AUDIT (
	CSRIMP_SESSION_ID				NUMBER(10, 0)	DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	BSCI_AUDIT_ID					NUMBER(10)		NOT NULL,
	INTERNAL_AUDIT_SID				NUMBER(10)		NOT NULL,
	AUDIT_REF						NUMBER(10)		NOT NULL,
	LATEST_VERSION    				NUMBER(10)		NOT NULL,
	LAST_UPDATED_DTM				DATE,
	BSCI_AUDIT_TYPE					NUMBER(1)		NOT NULL,
	CONSTRAINT PK_BSCI_AUDIT PRIMARY KEY (CSRIMP_SESSION_ID, BSCI_AUDIT_ID),
	CONSTRAINT FK_BSCI_AUDIT_SESSION FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.CHAIN_BSCI_2009_AUDIT (
	CSRIMP_SESSION_ID				NUMBER(10, 0)	DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	BSCI_2009_AUDIT_ID				NUMBER(10)		NOT NULL,
	BSCI_AUDIT_ID					NUMBER(10)		NOT NULL,
	VERSION_NUMBER					NUMBER(10)		NOT NULL,
	XML								CLOB			NOT NULL,
	AUDIT_REF 						NUMBER(10)		NOT NULL,
	DTM								DATE			NOT NULL,
	EXPIRY_DTM						DATE			NOT NULL,
	SCORE							VARCHAR2(255),
	AUDIT_ANNOUNCED					NUMBER(1)		NOT NULL,
	AUDIT_STAGE						VARCHAR2(255)	NOT NULL,
	AUDIT_METHODOLOGY				VARCHAR2(255),
	LEAD_AUDITOR_NAME				VARCHAR2(255),
	MAN_DAYS						NUMBER(10,3),
	CYCLE							VARCHAR2(255),
	TOTAL_TURNOVER					NUMBER(24, 10),
	INTERVIEW_ESSENTIALS			CLOB,
	B_1								NUMBER(10),
	B_2								NUMBER(10),
	B_3								NUMBER(10),
	B_4								NUMBER(10),
	B_5_1							NUMBER(10),
	B_5_2							NUMBER(10),
	B_6								NUMBER(10),
	B_7								NUMBER(10),
	B_8								NUMBER(10),
	B_9								NUMBER(10),
	B_10							NUMBER(10),
	B_11							NUMBER(10),
	B_12							NUMBER(10),
	B_13							NUMBER(10),
	CONSTRAINT PK_BSCI_2009_AUDIT PRIMARY KEY (CSRIMP_SESSION_ID, BSCI_2009_AUDIT_ID),
	CONSTRAINT FK_BSCI_2009_AUDIT_SESSION FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.CHAIN_BSCI_2009_A_FINDING (
	CSRIMP_SESSION_ID				NUMBER(10, 0)	DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	BSCI_2009_AUDIT_FINDING_ID		NUMBER(10)		NOT NULL,
	BSCI_2009_AUDIT_ID				NUMBER(10)		NOT NULL,
	MSI_CATEGORY					VARCHAR2(255)	NOT NULL,
	MSI_SUB_CATEGORY				VARCHAR2(255)	NULL,
	SCORE							NUMBER(10,0)	NOT NULL,
	QUESTION						CLOB			NULL,
	GUIDELINES						CLOB			NULL,
	RATING							CLOB			NULL,
	CONSTRAINT PK_BSCI_2009_AUDIT_FINDING PRIMARY KEY (BSCI_2009_AUDIT_FINDING_ID),
	CONSTRAINT FK_BSCI_2009_A_FIND_SESSION FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.CHAIN_BSCI_2009_A_ASSOCIATE (
	CSRIMP_SESSION_ID				NUMBER(10, 0)	DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	BSCI_2009_AUDIT_ASSOCIATE_ID	NUMBER(10)		NOT NULL,
	BSCI_2009_AUDIT_ID				NUMBER(10)		NOT NULL,
	ASSOCIATE						VARCHAR2(255)	NOT NULL,
	ASSOCIATE_COUNT					NUMBER(10,0)	NOT NULL,
	CONSTRAINT PK_BSCI_2009_AUDIT_ASSOC_ID PRIMARY KEY (BSCI_2009_AUDIT_ASSOCIATE_ID),
	CONSTRAINT FK_BSCI_2009_A_ASSOC_SESSION FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.CHAIN_BSCI_2014_AUDIT (
	CSRIMP_SESSION_ID				NUMBER(10, 0)	DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	BSCI_2014_AUDIT_ID				NUMBER(10)		NOT NULL,
	BSCI_AUDIT_ID					NUMBER(10)		NOT NULL,
	VERSION_NUMBER					NUMBER(10)		NOT NULL,
	XML								CLOB			NOT NULL,
	AUDIT_REF 						NUMBER(10)		NOT NULL,
	DTM								DATE			NOT NULL,
	EXPIRY_DTM						DATE			NOT NULL,
	SCORE							VARCHAR2(255),
	AUDIT_ANNOUNCED					NUMBER(1)		NOT NULL,
	AUDIT_STAGE						VARCHAR2(255)	NOT NULL,
	AUDIT_ENVIRONMENT				VARCHAR2(255),
	AUDITING_COMPANY				VARCHAR2(255),
	AUDITING_COMPANY_BRANCH			VARCHAR2(255),
	MAN_DAYS						NUMBER(10,3),
	NEED_FOLLOW_UP					VARCHAR2(255),
	AUDITOR_COMMENTS				CLOB,
	EXECUTIVE_SUMMARY_AUDIT_RPT		CLOB,
	INTERVIEW_ESSENTIALS			CLOB,
	LEAD_AUDITOR_NAME				VARCHAR2(255),
	PA1								VARCHAR2(255),
	PA2								VARCHAR2(255),
	PA3								VARCHAR2(255),
	PA4								VARCHAR2(255),
	PA5								VARCHAR2(255),
	PA6								VARCHAR2(255),
	PA7								VARCHAR2(255),
	PA8								VARCHAR2(255),
	PA9								VARCHAR2(255),
	PA10							VARCHAR2(255),
	PA11							VARCHAR2(255),
	PA12							VARCHAR2(255),
	PA13							VARCHAR2(255),
	CONSTRAINT PK_BSCI_2014_AUDIT PRIMARY KEY (CSRIMP_SESSION_ID, BSCI_2014_AUDIT_ID),
	CONSTRAINT FK_BSCI_2014_AUDIT_SESSION FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.CHAIN_BSCI_2014_A_FINDING (
	CSRIMP_SESSION_ID				NUMBER(10, 0)	DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	BSCI_2014_AUDIT_FINDING_ID		NUMBER(10)		NOT NULL,
	BSCI_2014_AUDIT_ID				NUMBER(10)		NOT NULL,
	SUBHEADER_VAL					VARCHAR2(255)	NOT NULL,
	SUBHEADER_DESC					VARCHAR2(255)	NULL,
	SCORE							NUMBER(10,0)	NOT NULL,
	QUESTION						CLOB			NULL,
	GUIDELINES						CLOB			NULL,
	RATING							CLOB			NULL,
	CONSTRAINT PK_BSCI_2014_AUDIT_FINDING PRIMARY KEY (BSCI_2014_AUDIT_FINDING_ID),
	CONSTRAINT FK_BSCI_2014_A_FIND_SESSION FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.CHAIN_BSCI_2014_A_ASSOCIATE (
	CSRIMP_SESSION_ID				NUMBER(10, 0)	DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	BSCI_2014_AUDIT_ASSOCIATE_ID	NUMBER(10)		NOT NULL,
	BSCI_2014_AUDIT_ID				NUMBER(10)		NOT NULL,
	ASSOCIATE						VARCHAR2(255)	NOT NULL,
	ASSOCIATE_COUNT					NUMBER(10,0)	NOT NULL,
	CONSTRAINT PK_BSCI_2014_AUDIT_ASSOC_ID PRIMARY KEY (BSCI_2014_AUDIT_ASSOCIATE_ID),
	CONSTRAINT FK_BSCI_2014_A_ASSOC_SESSION FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.CHAIN_BSCI_EXT_AUDIT (
	CSRIMP_SESSION_ID				NUMBER(10, 0)	DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	BSCI_EXT_AUDIT_ID				NUMBER(10)		NOT NULL,
	BSCI_AUDIT_ID					NUMBER(10)		NOT NULL,
	VERSION_NUMBER					NUMBER(10)		NOT NULL,
	XML								CLOB			NOT NULL,
	AUDIT_REF						NUMBER(10)		NOT NULL,
	DTM								DATE			NOT NULL,
	EXPIRY_DTM						DATE			NOT NULL,
	AUDIT_SCORE						VARCHAR2(255),
	AUDIT_TYPE						VARCHAR2(255),
	EXTERNAL_AUDIT_TYPE				VARCHAR2(255),
	AUDITING_COMPANY				VARCHAR2(255),
	SEQUENCE_NUMBER					NUMBER(10),
	CONSTRAINT PK_BSCI_EXT_AUDIT PRIMARY KEY (CSRIMP_SESSION_ID, BSCI_AUDIT_ID, VERSION_NUMBER),
	CONSTRAINT FK_BSCI_EXT_AUDIT_SESSION FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);



CREATE TABLE CSRIMP.MAP_CHAIN_BSCI_SUPPLIER (
	CSRIMP_SESSION_ID				NUMBER(10)		DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	OLD_BSCI_SUPPLIER_ID			NUMBER(10)		NOT NULL,
	NEW_BSCI_SUPPLIER_ID			NUMBER(10)		NOT NULL,
	CONSTRAINT PK_MAP_CHAIN_BSCI_SUPPLIER PRIMARY KEY (CSRIMP_SESSION_ID, OLD_BSCI_SUPPLIER_ID) USING INDEX,
	CONSTRAINT UK_MAP_CHAIN_BSCI_SUPPLIER UNIQUE (CSRIMP_SESSION_ID, NEW_BSCI_SUPPLIER_ID) USING INDEX,
	CONSTRAINT FK_MAP_CHAIN_BSCI_SUPPLIER FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.MAP_CHAIN_BSCI_AUDIT (
	CSRIMP_SESSION_ID				NUMBER(10)		DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	OLD_BSCI_AUDIT_ID				NUMBER(10)		NOT NULL,
	NEW_BSCI_AUDIT_ID				NUMBER(10)		NOT NULL,
	CONSTRAINT PK_MAP_CHAIN_BSCI_AUDIT PRIMARY KEY (CSRIMP_SESSION_ID, OLD_BSCI_AUDIT_ID) USING INDEX,
	CONSTRAINT UK_MAP_CHAIN_BSCI_AUDIT UNIQUE (CSRIMP_SESSION_ID, NEW_BSCI_AUDIT_ID) USING INDEX,
	CONSTRAINT FK_MAP_CHAIN_BSCI_AUDIT FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.MAP_CHAIN_BSCI_2009_AUDIT (
	CSRIMP_SESSION_ID				NUMBER(10)		DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	OLD_BSCI_2009_AUDIT_ID			NUMBER(10)		NOT NULL,
	NEW_BSCI_2009_AUDIT_ID			NUMBER(10)		NOT NULL,
	CONSTRAINT PK_MAP_CHAIN_BSCI_2009_AUDIT PRIMARY KEY (CSRIMP_SESSION_ID, OLD_BSCI_2009_AUDIT_ID) USING INDEX,
	CONSTRAINT UK_MAP_CHAIN_BSCI_2009_AUDIT UNIQUE (CSRIMP_SESSION_ID, NEW_BSCI_2009_AUDIT_ID) USING INDEX,
	CONSTRAINT FK_MAP_CHAIN_BSCI_2009_AUDIT FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.MAP_CHAIN_BSCI_2014_AUDIT (
	CSRIMP_SESSION_ID				NUMBER(10)		DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	OLD_BSCI_2014_AUDIT_ID			NUMBER(10)		NOT NULL,
	NEW_BSCI_2014_AUDIT_ID			NUMBER(10)		NOT NULL,
	CONSTRAINT PK_MAP_CHAIN_BSCI_2014_AUDIT PRIMARY KEY (CSRIMP_SESSION_ID, OLD_BSCI_2014_AUDIT_ID) USING INDEX,
	CONSTRAINT UK_MAP_CHAIN_BSCI_2014_AUDIT UNIQUE (CSRIMP_SESSION_ID, NEW_BSCI_2014_AUDIT_ID) USING INDEX,
	CONSTRAINT FK_MAP_CHAIN_BSCI_2014_AUDIT FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.MAP_CHAIN_BSCI_EXT_AUDIT (
	CSRIMP_SESSION_ID				NUMBER(10)		DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	OLD_BSCI_EXT_AUDIT_ID			NUMBER(10)		NOT NULL,
	NEW_BSCI_EXT_AUDIT_ID			NUMBER(10)		NOT NULL,
	CONSTRAINT PK_MAP_CHAIN_BSCI_EXT_AUDIT PRIMARY KEY (CSRIMP_SESSION_ID, OLD_BSCI_EXT_AUDIT_ID) USING INDEX,
	CONSTRAINT UK_MAP_CHAIN_BSCI_EXT_AUDIT UNIQUE (CSRIMP_SESSION_ID, NEW_BSCI_EXT_AUDIT_ID) USING INDEX,
	CONSTRAINT FK_MAP_CHAIN_BSCI_EXT_AUDIT FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.MAP_CHAIN_BSCI_2009_A_FIND (
	CSRIMP_SESSION_ID				NUMBER(10)		DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	OLD_BSCI_2009_A_FINDING_ID		NUMBER(10)		NOT NULL,
	NEW_BSCI_2009_A_FINDING_ID		NUMBER(10)		NOT NULL,
	CONSTRAINT PK_MAP_CHAIN_BSCI_2009_A_FIND PRIMARY KEY (CSRIMP_SESSION_ID, OLD_BSCI_2009_A_FINDING_ID) USING INDEX,
	CONSTRAINT UK_MAP_CHAIN_BSCI_2009_A_FIND UNIQUE (CSRIMP_SESSION_ID, NEW_BSCI_2009_A_FINDING_ID) USING INDEX,
	CONSTRAINT FK_MAP_CHAIN_BSCI_2009_A_FIND FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.MAP_CHAIN_BSCI_2009_A_ASSOC (
	CSRIMP_SESSION_ID				NUMBER(10)		DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	OLD_BSCI_2009_A_ASSOCIATE_ID	NUMBER(10)		NOT NULL,
	NEW_BSCI_2009_A_ASSOCIATE_ID	NUMBER(10)		NOT NULL,
	CONSTRAINT PK_MAP_CHAIN_BSCI_2009_A_ASSOC PRIMARY KEY (CSRIMP_SESSION_ID, OLD_BSCI_2009_A_ASSOCIATE_ID) USING INDEX,
	CONSTRAINT UK_MAP_CHAIN_BSCI_2009_A_ASSOC UNIQUE (CSRIMP_SESSION_ID, NEW_BSCI_2009_A_ASSOCIATE_ID) USING INDEX,
	CONSTRAINT FK_MAP_CHAIN_BSCI_2009_A_ASSOC FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.MAP_CHAIN_BSCI_2014_A_FIND (
	CSRIMP_SESSION_ID				NUMBER(10)		DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	OLD_BSCI_2014_A_FINDING_ID		NUMBER(10)		NOT NULL,
	NEW_BSCI_2014_A_FINDING_ID		NUMBER(10)		NOT NULL,
	CONSTRAINT PK_MAP_CHAIN_BSCI_2014_A_FIND PRIMARY KEY (CSRIMP_SESSION_ID, OLD_BSCI_2014_A_FINDING_ID) USING INDEX,
	CONSTRAINT UK_MAP_CHAIN_BSCI_2014_A_FIND UNIQUE (CSRIMP_SESSION_ID, NEW_BSCI_2014_A_FINDING_ID) USING INDEX,
	CONSTRAINT FK_MAP_CHAIN_BSCI_2014_A_FIND FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);

CREATE TABLE CSRIMP.MAP_CHAIN_BSCI_2014_A_ASSOC (
	CSRIMP_SESSION_ID				NUMBER(10)		DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	OLD_BSCI_2014_A_ASSOCIATE_ID	NUMBER(10)		NOT NULL,
	NEW_BSCI_2014_A_ASSOCIATE_ID	NUMBER(10)		NOT NULL,
	CONSTRAINT PK_MAP_CHAIN_BSCI_2014_A_ASSOC PRIMARY KEY (CSRIMP_SESSION_ID, OLD_BSCI_2014_A_ASSOCIATE_ID) USING INDEX,
	CONSTRAINT UK_MAP_CHAIN_BSCI_2014_A_ASSOC UNIQUE (CSRIMP_SESSION_ID, NEW_BSCI_2014_A_ASSOCIATE_ID) USING INDEX,
	CONSTRAINT FK_MAP_CHAIN_BSCI_2014_A_ASSOC FOREIGN KEY (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID) ON DELETE CASCADE
);










-- Alter tables

ALTER TABLE CHAIN.BSCI_OPTIONS RENAME COLUMN LAST_AUDIT_SCORE_SYNC_DTM TO LAST_AUDIT_SYNC_DTM;

ALTER TABLE CHAIN.BSCI_OPTIONS RENAME COLUMN AUDIT_SCORE_SYNC_ENABLED TO AUDIT_SYNC_ENABLED;

ALTER TABLE CHAIN.BSCI_OPTIONS ADD (ONLY_AUDITS_WITHIN_REL NUMBER(1) DEFAULT 0 NOT NULL);

ALTER TABLE CHAIN.BSCI_OPTIONS ADD (CONSTRAINT CHK_ONLY_AUDITS_WITHIN_REL CHECK (ONLY_AUDITS_WITHIN_REL IN (0,1)));

ALTER TABLE CHAIN.BSCI_OPTIONS ADD (AUDIT_TYPE_EXT_ID NUMBER(10));

CREATE INDEX CHAIN.IX_BSCI_OPTIONS_AUD_TYPE_EXT ON CHAIN.BSCI_OPTIONS (APP_SID, AUDIT_TYPE_EXT_ID);

-- *** Grants ***

grant select on chain.bsci_supplier to csr;
grant select on chain.bsci_supplier_det to csr;
grant select on chain.bsci_audit to csr;
grant select on chain.bsci_2009_audit to csr;
grant select on chain.bsci_2014_audit to csr;
grant select on chain.bsci_ext_audit to csr;
grant select on chain.bsci_2009_audit_finding to csr;
grant select on chain.bsci_2009_audit_associate to csr;
grant select on chain.bsci_2014_audit_finding to csr;
grant select on chain.bsci_2014_audit_associate to csr;
grant select on csr.internal_audit to chain with grant option;

grant select, insert, update on chain.bsci_supplier to csrimp;
grant select, insert, update on chain.bsci_supplier_det to csrimp;
grant select, insert, update on chain.bsci_audit to csrimp;
grant select, insert, update on chain.bsci_2009_audit to csrimp;
grant select, insert, update on chain.bsci_2009_audit_finding to csrimp;
grant select, insert, update on chain.bsci_2009_audit_associate to csrimp;
grant select, insert, update on chain.bsci_2014_audit to csrimp;
grant select, insert, update on chain.bsci_2014_audit_finding to csrimp;
grant select, insert, update on chain.bsci_2014_audit_associate to csrimp;
grant select, insert, update on chain.bsci_ext_audit to csrimp;
grant select on chain.bsci_log_id_seq to csrimp;
grant select on chain.bsci_integration_report_id_seq to csrimp;
grant select on chain.bsci_supplier_id_seq to csrimp;
grant select on chain.bsci_audit_id_seq to csrimp;
grant select on chain.bsci_2009_audit_id_seq to csrimp;
grant select on chain.bsci_2009_a_finding_id_seq to csrimp;
grant select on chain.bsci_2009_a_associate_id_seq to csrimp;
grant select on chain.bsci_2014_audit_id_seq to csrimp;
grant select on chain.bsci_2014_a_finding_id_seq to csrimp;
grant select on chain.bsci_2014_a_associate_id_seq to csrimp;
grant select on chain.bsci_ext_audit_id_seq to csrimp;

grant select, insert, update, delete on csrimp.chain_customer_grid_ext to tool_user;
grant select, insert, update, delete on csrimp.chain_bsci_options to tool_user;
grant select, insert, update, delete on csrimp.chain_bsci_supplier to tool_user;
grant select, insert, update, delete on csrimp.chain_bsci_supplier_det to tool_user;
grant select, insert, update, delete on csrimp.chain_bsci_audit to tool_user;
grant select, insert, update, delete on csrimp.chain_bsci_2009_audit to tool_user;
grant select, insert, update, delete on csrimp.chain_bsci_2009_a_finding to tool_user;
grant select, insert, update, delete on csrimp.chain_bsci_2009_a_associate to tool_user;
grant select, insert, update, delete on csrimp.chain_bsci_2014_audit to tool_user;
grant select, insert, update, delete on csrimp.chain_bsci_2014_a_associate to tool_user;
grant select, insert, update, delete on csrimp.chain_bsci_2014_a_finding to tool_user;
grant select, insert, update, delete on csrimp.chain_bsci_ext_audit to tool_user;

-- ** Cross schema constraints ***

ALTER TABLE CHAIN.BSCI_AUDIT ADD (CONSTRAINT FK_BSCI_AUDIT_AUDIT
	FOREIGN KEY (APP_SID, INTERNAL_AUDIT_SID) REFERENCES CSR.INTERNAL_AUDIT (APP_SID, INTERNAL_AUDIT_SID));

-- *** Views ***
-- Please paste the content of the view and add a comment referencing the path of the create_views file which will contain your view changes.
-- ../chain/create_views.sql

CREATE OR REPLACE VIEW chain.v$bsci_supplier AS
	SELECT bs.app_sid, bs.bsci_supplier_id, bs.company_sid, bs.bsci_factory_id, bsd.version_number, bs.last_updated_dtm,
		   bsd.address,
		   bsd.city,
		   bsd.industry,
		   bsd.country,
		   bsd.postcode,
		   bsd.region,
		   bsd.territory,
		   bsd.address_location_type,
		   bsd.audit_announcement_method,
		   bsd.factory_contact,
		   bsd.audit_expiration_dtm,
		   bsd.audit_in_progress,
		   bsd.audit_result,
		   bsd.bsci_comments,
		   bsd.linked_participants,
		   bsd.in_commitments,
		   bsd.in_supply_chain,
		   bsd.legal_status,
		   bsd.name,
		   bsd.number_of_associates,
		   bsd.number_of_buildings,
		   bsd.participant_name,
		   bsd.product_group,
		   bsd.product_type,
		   bsd.code_of_conduct_accepted,
		   bsd.code_of_conduct_signed,
		   bsd.audit_dtm,
		   bsd.sector,
		   bsd.website,
		   bsd.year_founded,
		   bsd.audit_type,
		   bsd.rsp_id,
		   bsd.is_audit_in_progress,
		   bsd.audit_in_progress_dtm,
		   bsd.code_of_conduct_sign_int,
		   bsd.sa8000_certified,
		   bsd.audit_certification,
		   bsd.address_type,
		   bsd.alias,
		   bsd.brands,
		   bsd.business_unit,
		   bsd.email_address,
		   s.region_sid
    FROM chain.bsci_supplier bs
    JOIN chain.bsci_supplier_det bsd ON bs.bsci_supplier_id = bsd.bsci_supplier_id AND bs.latest_version = bsd.version_number
    JOIN csr.supplier s ON s.company_sid = bs.company_sid
;

CREATE OR REPLACE VIEW chain.v$bsci_2009_audit AS
	SELECT ba.app_sid, ba.bsci_audit_id bsci_2009_audit_id, ba.internal_audit_sid, bad.version_number, ba.last_updated_dtm,
		   bad.audit_ref,
		   bad.dtm,
		   bad.expiry_dtm,
		   bad.score,
		   bad.audit_announced,
		   bad.audit_stage,
		   bad.audit_methodology,
		   bad.man_days,
		   bad.cycle,
		   bad.total_turnover,
		   bad.interview_essentials,
		   bad.lead_auditor_name,
		   bad.b_1,
		   bad.b_2,
		   bad.b_3,
		   bad.b_4,
		   bad.b_5_1,
		   bad.b_5_2,
		   bad.b_6,
		   bad.b_7,
		   bad.b_8,
		   bad.b_9,
		   bad.b_10,
		   bad.b_11,
		   bad.b_12,
		   bad.b_13,
		   ia.region_sid
    FROM chain.bsci_audit ba
    JOIN chain.bsci_2009_audit bad ON ba.bsci_audit_id = bad.bsci_audit_id AND ba.latest_version = bad.version_number
    JOIN csr.internal_audit ia ON ia.internal_audit_sid = ba.internal_audit_sid
;

CREATE OR REPLACE VIEW chain.v$bsci_2014_audit AS
	SELECT ba.app_sid, ba.bsci_audit_id bsci_2014_audit_id, ba.internal_audit_sid, bad.version_number, ba.last_updated_dtm,
		   bad.audit_ref,
		   bad.dtm,
		   bad.expiry_dtm,
		   bad.score,
		   bad.audit_announced,
		   bad.audit_stage,
		   bad.audit_environment,
		   bad.auditing_company,
		   bad.auditing_company_branch,
		   bad.man_days,
		   bad.need_follow_up,
		   bad.auditor_comments,
		   bad.executive_summary_audit_rpt,
		   bad.interview_essentials,
		   bad.lead_auditor_name,
		   bad.pa1,
		   bad.pa2,
		   bad.pa3,
		   bad.pa4,
		   bad.pa5,
		   bad.pa6,
		   bad.pa7,
		   bad.pa8,
		   bad.pa9,
		   bad.pa10,
		   bad.pa11,
		   bad.pa12,
		   bad.pa13,
		   ia.region_sid
    FROM chain.bsci_audit ba
    JOIN chain.bsci_2014_audit bad ON ba.bsci_audit_id = bad.bsci_audit_id AND ba.latest_version = bad.version_number
    JOIN csr.internal_audit ia ON ia.internal_audit_sid = ba.internal_audit_sid
;

CREATE OR REPLACE VIEW chain.v$bsci_ext_audit AS
	SELECT ba.app_sid, ba.bsci_audit_id bsci_ext_audit_id, ba.internal_audit_sid, bad.version_number, ba.last_updated_dtm,
		   bad.audit_ref,
		   bad.dtm,
		   bad.expiry_dtm,
		   bad.audit_score,
		   bad.audit_type,
		   bad.external_audit_type,
		   bad.auditing_company,
		   bad.sequence_number,
		   ia.region_sid
    FROM chain.bsci_audit ba
    JOIN chain.bsci_ext_audit bad ON ba.bsci_audit_id = bad.bsci_audit_id AND ba.latest_version = bad.version_number
    JOIN csr.internal_audit ia ON ia.internal_audit_sid = ba.internal_audit_sid
;

grant select on chain.v$bsci_supplier to csr;

grant select on chain.v$bsci_2009_audit to csr;
grant select on chain.v$bsci_2014_audit to csr;
grant select on chain.v$bsci_ext_audit to csr;

-- *** Data changes ***
-- RLS

-- Data

DELETE FROM csr.module_param WHERE module_id = 75;

DECLARE
	v_card_id			chain.card.card_id%TYPE;
	v_desc				chain.card.description%TYPE;
	v_class				chain.card.class_type%TYPE;
	v_js_path			chain.card.js_include%TYPE;
	v_js_class			chain.card.js_class_type%TYPE;
	v_css_path			chain.card.css_include%TYPE;
	v_actions			chain.T_STRING_LIST;
BEGIN
	v_desc := 'BSCI Supplier Filter';
	v_class := 'Credit360.Chain.Cards.Filters.BsciSupplierFilter';
	v_js_path := '/csr/site/chain/cards/filters/bsciSupplierFilter.js';
	v_js_class := 'Chain.Cards.Filters.BsciSupplierFilter';
	v_css_path := '';

	BEGIN
		INSERT INTO chain.card (card_id, description, class_type, js_include, js_class_type, css_include)
		VALUES (chain.card_id_seq.NEXTVAL, v_desc, v_class, v_js_path, v_js_class, v_css_path)
		RETURNING card_id INTO v_card_id;
	EXCEPTION
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE chain.card
			   SET description = v_desc, class_type = v_class, js_include = v_js_path, css_include = v_css_path
			 WHERE js_class_type = v_js_class
			RETURNING card_id INTO v_card_id;
	END;

	DELETE FROM chain.card_progression_action
	 WHERE card_id = v_card_id
	   AND action NOT IN ('default');

	v_actions := chain.T_STRING_LIST('default');

	FOR i IN v_actions.FIRST .. v_actions.LAST
	LOOP
		BEGIN
			INSERT INTO chain.card_progression_action (card_id, action)
			VALUES (v_card_id, v_actions(i));
		EXCEPTION
			WHEN DUP_VAL_ON_INDEX THEN
				NULL;
		END;
	END LOOP;
END;
/

DECLARE
	v_card_id						NUMBER(10);
	v_audit_filter_card_id			NUMBER(10);
	v_sid							NUMBER(10);
BEGIN
	BEGIN
		INSERT INTO chain.card_group(card_group_id, name, description, helper_pkg, list_page_url)
		VALUES(64 /*chain.filter_pkg.FILTER_TYPE_BSCI_SUPPLIERS*/, 'BSCI Supplier Filter', 'Allows filtering of BSCI suppliers.', 'chain.bsci_supplier_report_pkg', NULL);
	EXCEPTION
		WHEN DUP_VAL_ON_INDEX THEN
			NULL;
	END;

	SELECT card_id
	  INTO v_card_id
	  FROM chain.card
	 WHERE js_class_type = 'Chain.Cards.Filters.BsciSupplierFilter';

	BEGIN
		INSERT INTO chain.filter_type (filter_type_id,description,helper_pkg,card_id)
		    VALUES (chain.filter_type_id_seq.NEXTVAL, 'BSCI Supplier Filter', 'chain.bsci_supplier_report_pkg', v_card_id);
	EXCEPTION
		WHEN DUP_VAL_ON_INDEX THEN
			NULL;
	END;

	FOR r IN (
		SELECT app_sid FROM chain.customer_options
	) LOOP
		BEGIN
			INSERT INTO chain.card_group_card (app_sid, card_group_id, card_id, position)
					VALUES (r.app_sid, 64 /*chain.filter_pkg.FILTER_TYPE_BSCI_SUPPLIERS*/, v_card_id, 0);
		EXCEPTION
			WHEN DUP_VAL_ON_INDEX THEN
				NULL;
		END;
	END LOOP;
END;
/

BEGIN
	BEGIN
		INSERT INTO chain.aggregate_type (card_group_id, aggregate_type_id, description)
		VALUES (64 /*chain.filter_pkg.FILTER_TYPE_BSCI_SUPPLIERS*/, 1 /*chain.bsci_supplier_report_pkg.AGG_TYPE_COUNT*/, 'Number of records');
	EXCEPTION
		WHEN DUP_VAL_ON_INDEX THEN
			NULL;
	END;
	BEGIN
		INSERT INTO chain.card_group_column_type (card_group_id, column_id, column_type, description)
		VALUES (64 /*chain.filter_pkg.FILTER_TYPE_BSCI_SUPPLIERS*/, 1 /*chain.bsci_supplier_report_pkg.COL_TYPE_SUPPLIER_REGION*/, 1 /*chain.filter_pkg.COLUMN_TYPE_REGION*/, 'BSCI supplier region');
	EXCEPTION
		WHEN DUP_VAL_ON_INDEX THEN
			NULL;
	END;
END;
/



DECLARE
	v_card_id			chain.card.card_id%TYPE;
	v_desc				chain.card.description%TYPE;
	v_class				chain.card.class_type%TYPE;
	v_js_path			chain.card.js_include%TYPE;
	v_js_class			chain.card.js_class_type%TYPE;
	v_css_path			chain.card.css_include%TYPE;
	v_actions			chain.T_STRING_LIST;
BEGIN
	v_desc := 'BSCI 2009 Audit Filter';
	v_class := 'Credit360.Chain.Cards.Filters.Bsci2009AuditFilter';
	v_js_path := '/csr/site/chain/cards/filters/bsci2009AuditFilter.js';
	v_js_class := 'Chain.Cards.Filters.Bsci2009AuditFilter';
	v_css_path := '';

	BEGIN
		INSERT INTO chain.card (card_id, description, class_type, js_include, js_class_type, css_include)
		VALUES (chain.card_id_seq.NEXTVAL, v_desc, v_class, v_js_path, v_js_class, v_css_path)
		RETURNING card_id INTO v_card_id;
	EXCEPTION
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE chain.card
			   SET description = v_desc, class_type = v_class, js_include = v_js_path, css_include = v_css_path
			 WHERE js_class_type = v_js_class
			RETURNING card_id INTO v_card_id;
	END;

	DELETE FROM chain.card_progression_action
	 WHERE card_id = v_card_id
	   AND action NOT IN ('default');

	v_actions := chain.T_STRING_LIST('default');

	FOR i IN v_actions.FIRST .. v_actions.LAST
	LOOP
		BEGIN
			INSERT INTO chain.card_progression_action (card_id, action)
			VALUES (v_card_id, v_actions(i));
		EXCEPTION
			WHEN DUP_VAL_ON_INDEX THEN
				NULL;
		END;
	END LOOP;
END;
/

DECLARE
	v_card_id						NUMBER(10);
	v_audit_filter_card_id			NUMBER(10);
	v_sid							NUMBER(10);
BEGIN
	BEGIN
		INSERT INTO chain.card_group(card_group_id, name, description, helper_pkg, list_page_url)
		VALUES(65 /*chain.filter_pkg.FILTER_TYPE_BSCI_2009_AUDITS*/, 'BSCI 2009 Audit Filter', 'Allows filtering of BSCI 2009 audits.', 'chain.bsci_2009_audit_report_pkg', NULL);
	EXCEPTION
		WHEN DUP_VAL_ON_INDEX THEN
			NULL;
	END;

	SELECT card_id
	  INTO v_card_id
	  FROM chain.card
	 WHERE js_class_type = 'Chain.Cards.Filters.Bsci2009AuditFilter';

	BEGIN
		INSERT INTO chain.filter_type (filter_type_id,description,helper_pkg,card_id)
		    VALUES (chain.filter_type_id_seq.NEXTVAL, 'BSCI 2009 Audit Filter', 'chain.bsci_2009_audit_report_pkg', v_card_id);
	EXCEPTION
		WHEN DUP_VAL_ON_INDEX THEN
			NULL;
	END;

	FOR r IN (
		SELECT app_sid FROM chain.customer_options
	) LOOP
		BEGIN
			INSERT INTO chain.card_group_card (app_sid, card_group_id, card_id, position)
					VALUES (r.app_sid, 65 /*chain.filter_pkg.FILTER_TYPE_BSCI_2009_AUDITS*/, v_card_id, 0);
		EXCEPTION
			WHEN DUP_VAL_ON_INDEX THEN
				NULL;
		END;
	END LOOP;
END;
/

BEGIN
	BEGIN
		INSERT INTO chain.aggregate_type (card_group_id, aggregate_type_id, description)
		VALUES (65 /*chain.filter_pkg.FILTER_TYPE_BSCI_2009_AUDITS*/, 1 /*chain.bsci_2009_audit_report_pkg.AGG_TYPE_COUNT*/, 'Number of records');
	EXCEPTION
		WHEN DUP_VAL_ON_INDEX THEN
			NULL;
	END;
	BEGIN
		INSERT INTO chain.card_group_column_type (card_group_id, column_id, column_type, description)
		VALUES (65 /*chain.filter_pkg.FILTER_TYPE_BSCI_2009_AUDITS*/, 1 /*chain.bsci_2009_audit_report_pkg.COL_TYPE_SUPPLIER_REGION*/, 1 /*chain.filter_pkg.COLUMN_TYPE_REGION*/, 'BSCI 2009 audit region');
	EXCEPTION
		WHEN DUP_VAL_ON_INDEX THEN
			NULL;
	END;
END;
/



DECLARE
	v_card_id			chain.card.card_id%TYPE;
	v_desc				chain.card.description%TYPE;
	v_class				chain.card.class_type%TYPE;
	v_js_path			chain.card.js_include%TYPE;
	v_js_class			chain.card.js_class_type%TYPE;
	v_css_path			chain.card.css_include%TYPE;
	v_actions			chain.T_STRING_LIST;
BEGIN
	v_desc := 'BSCI 2014 Audit Filter';
	v_class := 'Credit360.Chain.Cards.Filters.Bsci2014AuditFilter';
	v_js_path := '/csr/site/chain/cards/filters/bsci2014AuditFilter.js';
	v_js_class := 'Chain.Cards.Filters.Bsci2014AuditFilter';
	v_css_path := '';

	BEGIN
		INSERT INTO chain.card (card_id, description, class_type, js_include, js_class_type, css_include)
		VALUES (chain.card_id_seq.NEXTVAL, v_desc, v_class, v_js_path, v_js_class, v_css_path)
		RETURNING card_id INTO v_card_id;
	EXCEPTION
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE chain.card
			   SET description = v_desc, class_type = v_class, js_include = v_js_path, css_include = v_css_path
			 WHERE js_class_type = v_js_class
			RETURNING card_id INTO v_card_id;
	END;

	DELETE FROM chain.card_progression_action
	 WHERE card_id = v_card_id
	   AND action NOT IN ('default');

	v_actions := chain.T_STRING_LIST('default');

	FOR i IN v_actions.FIRST .. v_actions.LAST
	LOOP
		BEGIN
			INSERT INTO chain.card_progression_action (card_id, action)
			VALUES (v_card_id, v_actions(i));
		EXCEPTION
			WHEN DUP_VAL_ON_INDEX THEN
				NULL;
		END;
	END LOOP;
END;
/

DECLARE
	v_card_id						NUMBER(10);
	v_audit_filter_card_id			NUMBER(10);
	v_sid							NUMBER(10);
BEGIN
	BEGIN
		INSERT INTO chain.card_group(card_group_id, name, description, helper_pkg, list_page_url)
		VALUES(66 /*chain.filter_pkg.FILTER_TYPE_BSCI_2014_AUDITS*/, 'BSCI 2014 Audit Filter', 'Allows filtering of BSCI 2014 audits.', 'chain.bsci_2014_audit_report_pkg', NULL);
	EXCEPTION
		WHEN DUP_VAL_ON_INDEX THEN
			NULL;
	END;

	SELECT card_id
	  INTO v_card_id
	  FROM chain.card
	 WHERE js_class_type = 'Chain.Cards.Filters.Bsci2014AuditFilter';

	BEGIN
		INSERT INTO chain.filter_type (filter_type_id,description,helper_pkg,card_id)
		    VALUES (chain.filter_type_id_seq.NEXTVAL, 'BSCI 2014 Audit Filter', 'chain.bsci_2014_audit_report_pkg', v_card_id);
	EXCEPTION
		WHEN DUP_VAL_ON_INDEX THEN
			NULL;
	END;

	FOR r IN (
		SELECT app_sid FROM chain.customer_options
	) LOOP
		BEGIN
			INSERT INTO chain.card_group_card (app_sid, card_group_id, card_id, position)
					VALUES (r.app_sid, 66 /*chain.filter_pkg.FILTER_TYPE_BSCI_2014_AUDITS*/, v_card_id, 0);
		EXCEPTION
			WHEN DUP_VAL_ON_INDEX THEN
				NULL;
		END;
	END LOOP;
END;
/

BEGIN
	BEGIN
		INSERT INTO chain.aggregate_type (card_group_id, aggregate_type_id, description)
		VALUES (66 /*chain.filter_pkg.FILTER_TYPE_BSCI_2014_AUDITS*/, 1 /*chain.bsci_2014_audit_report_pkg.AGG_TYPE_COUNT*/, 'Number of records');
	EXCEPTION
		WHEN DUP_VAL_ON_INDEX THEN
			NULL;
	END;
	BEGIN
		INSERT INTO chain.card_group_column_type (card_group_id, column_id, column_type, description)
		VALUES (66 /*chain.filter_pkg.FILTER_TYPE_BSCI_2014_AUDITS*/, 1 /*chain.bsci_2014_audit_report_pkg.COL_TYPE_SUPPLIER_REGION*/, 1 /*chain.filter_pkg.COLUMN_TYPE_REGION*/, 'BSCI 2014 audit region');
	EXCEPTION
		WHEN DUP_VAL_ON_INDEX THEN
			NULL;
	END;
END;
/



DECLARE
	v_card_id			chain.card.card_id%TYPE;
	v_desc				chain.card.description%TYPE;
	v_class				chain.card.class_type%TYPE;
	v_js_path			chain.card.js_include%TYPE;
	v_js_class			chain.card.js_class_type%TYPE;
	v_css_path			chain.card.css_include%TYPE;
	v_actions			chain.T_STRING_LIST;
BEGIN
	v_desc := 'BSCI External Audit Filter';
	v_class := 'Credit360.Chain.Cards.Filters.BsciExternalAuditFilter';
	v_js_path := '/csr/site/chain/cards/filters/bsciExternalAuditFilter.js';
	v_js_class := 'Chain.Cards.Filters.BsciExternalAuditFilter';
	v_css_path := '';

	BEGIN
		INSERT INTO chain.card (card_id, description, class_type, js_include, js_class_type, css_include)
		VALUES (chain.card_id_seq.NEXTVAL, v_desc, v_class, v_js_path, v_js_class, v_css_path)
		RETURNING card_id INTO v_card_id;
	EXCEPTION
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE chain.card
			   SET description = v_desc, class_type = v_class, js_include = v_js_path, css_include = v_css_path
			 WHERE js_class_type = v_js_class
			RETURNING card_id INTO v_card_id;
	END;

	DELETE FROM chain.card_progression_action
	 WHERE card_id = v_card_id
	   AND action NOT IN ('default');

	v_actions := chain.T_STRING_LIST('default');

	FOR i IN v_actions.FIRST .. v_actions.LAST
	LOOP
		BEGIN
			INSERT INTO chain.card_progression_action (card_id, action)
			VALUES (v_card_id, v_actions(i));
		EXCEPTION
			WHEN DUP_VAL_ON_INDEX THEN
				NULL;
		END;
	END LOOP;
END;
/

DECLARE
	v_card_id						NUMBER(10);
	v_audit_filter_card_id			NUMBER(10);
	v_sid							NUMBER(10);
BEGIN
	BEGIN
		INSERT INTO chain.card_group(card_group_id, name, description, helper_pkg, list_page_url)
		VALUES(67 /*chain.filter_pkg.FILTER_TYPE_BSCI_EXT_AUDITS*/, 'BSCI External Audit Filter', 'Allows filtering of BSCI external audits.', 'chain.bsci_ext_audit_report_pkg', NULL);
	EXCEPTION
		WHEN DUP_VAL_ON_INDEX THEN
			NULL;
	END;

	SELECT card_id
	  INTO v_card_id
	  FROM chain.card
	 WHERE js_class_type = 'Chain.Cards.Filters.BsciExternalAuditFilter';

	BEGIN
		INSERT INTO chain.filter_type (filter_type_id,description,helper_pkg,card_id)
		    VALUES (chain.filter_type_id_seq.NEXTVAL, 'BSCI External Audit Filter', 'chain.bsci_ext_audit_report_pkg', v_card_id);
	EXCEPTION
		WHEN DUP_VAL_ON_INDEX THEN
			NULL;
	END;

	FOR r IN (
		SELECT app_sid FROM chain.customer_options
	) LOOP
		BEGIN
			INSERT INTO chain.card_group_card (app_sid, card_group_id, card_id, position)
					VALUES (r.app_sid, 67 /*chain.filter_pkg.FILTER_TYPE_BSCI_EXT_AUDITS*/, v_card_id, 0);
		EXCEPTION
			WHEN DUP_VAL_ON_INDEX THEN
				NULL;
		END;
	END LOOP;
END;
/

BEGIN
	BEGIN
		INSERT INTO chain.aggregate_type (card_group_id, aggregate_type_id, description)
		VALUES (67 /*chain.filter_pkg.FILTER_TYPE_BSCI_EXT_AUDITS*/, 1 /*chain.bsci_ext_audit_report_pkg.AGG_TYPE_COUNT*/, 'Number of records');
	EXCEPTION
		WHEN DUP_VAL_ON_INDEX THEN
			NULL;
	END;
	BEGIN
		INSERT INTO chain.card_group_column_type (card_group_id, column_id, column_type, description)
		VALUES (67 /*chain.filter_pkg.FILTER_TYPE_BSCI_EXT_AUDITS*/, 1 /*chain.bsci_ext_audit_report_pkg.COL_TYPE_SUPPLIER_REGION*/, 1 /*chain.filter_pkg.COLUMN_TYPE_REGION*/, 'BSCI external audit region');
	EXCEPTION
		WHEN DUP_VAL_ON_INDEX THEN
			NULL;
	END;
END;
/

-- ** New package grants **
CREATE OR REPLACE PACKAGE chain.bsci_supplier_report_pkg AS
    PROCEDURE dummy;
END;
/
CREATE OR REPLACE PACKAGE BODY chain.bsci_supplier_report_pkg AS
    PROCEDURE dummy
    AS
    BEGIN
        NULL;
    END;
END;
/


CREATE OR REPLACE PACKAGE chain.bsci_2009_audit_report_pkg AS
    PROCEDURE dummy;
END;
/
CREATE OR REPLACE PACKAGE BODY chain.bsci_2009_audit_report_pkg AS
    PROCEDURE dummy
    AS
    BEGIN
        NULL;
    END;
END;
/

CREATE OR REPLACE PACKAGE chain.bsci_2014_audit_report_pkg AS
    PROCEDURE dummy;
END;
/
CREATE OR REPLACE PACKAGE BODY chain.bsci_2014_audit_report_pkg AS
    PROCEDURE dummy
    AS
    BEGIN
        NULL;
    END;
END;
/

CREATE OR REPLACE PACKAGE chain.bsci_ext_audit_report_pkg AS
    PROCEDURE dummy;
END;
/
CREATE OR REPLACE PACKAGE BODY chain.bsci_ext_audit_report_pkg AS
    PROCEDURE dummy
    AS
    BEGIN
        NULL;
    END;
END;
/





GRANT EXECUTE ON chain.bsci_supplier_report_pkg TO cms;
GRANT EXECUTE ON chain.bsci_supplier_report_pkg TO csr;

GRANT EXECUTE ON chain.bsci_2009_audit_report_pkg TO cms;
GRANT EXECUTE ON chain.bsci_2009_audit_report_pkg TO csr;

GRANT EXECUTE ON chain.bsci_2014_audit_report_pkg TO cms;
GRANT EXECUTE ON chain.bsci_2014_audit_report_pkg TO csr;

GRANT EXECUTE ON chain.bsci_ext_audit_report_pkg TO cms;
GRANT EXECUTE ON chain.bsci_ext_audit_report_pkg TO csr;

GRANT EXECUTE ON chain.bsci_pkg TO cms;
GRANT EXECUTE ON chain.bsci_pkg TO csr;




INSERT INTO chain.grid_extension(grid_extension_id, base_card_group_id, extension_card_group_id, record_name) values (5,23,64,'bsciSupplier');
INSERT INTO chain.grid_extension(grid_extension_id, base_card_group_id, extension_card_group_id, record_name) values (6,41,64,'bsciSupplier');
INSERT INTO chain.grid_extension(grid_extension_id, base_card_group_id, extension_card_group_id, record_name) values (7,42,64,'bsciSupplier');


INSERT INTO chain.grid_extension(grid_extension_id, base_card_group_id, extension_card_group_id, record_name) values (8,41,65,'bsci2009Audit');
INSERT INTO chain.grid_extension(grid_extension_id, base_card_group_id, extension_card_group_id, record_name) values (9,42,65,'bsci2009Audit');

INSERT INTO chain.grid_extension(grid_extension_id, base_card_group_id, extension_card_group_id, record_name) values (10,41,66,'bsci2014Audit');
INSERT INTO chain.grid_extension(grid_extension_id, base_card_group_id, extension_card_group_id, record_name) values (11,42,66,'bsci2014Audit');

INSERT INTO chain.grid_extension(grid_extension_id, base_card_group_id, extension_card_group_id, record_name) values (12,41,67,'bsciExternalAudit');
INSERT INTO chain.grid_extension(grid_extension_id, base_card_group_id, extension_card_group_id, record_name) values (13,42,67,'bsciExternalAudit');


-- *** Conditional Packages ***

-- *** Packages ***
@../chain/activity_report_pkg
@../chain/bsci_2009_audit_report_pkg
@../chain/bsci_2014_audit_report_pkg
@../chain/bsci_ext_audit_report_pkg
@../chain/bsci_pkg
@../chain/bsci_supplier_report_pkg
@../chain/business_rel_report_pkg
@../chain/certification_report_pkg
@../chain/company_filter_pkg
@../chain/company_request_report_pkg
@../chain/dedupe_proc_record_report_pkg
@../chain/filter_pkg
@../chain/prdct_supp_mtrc_report_pkg
@../chain/product_metric_report_pkg
@../chain/product_report_pkg
@../chain/product_supplier_report_pkg
@../audit_report_pkg
@../compliance_library_report_pkg
@../compliance_register_report_pkg
@../enable_pkg
@../initiative_report_pkg
@../issue_report_pkg
@../meter_list_pkg
@../meter_report_pkg
@../non_compliance_report_pkg
@../permit_report_pkg
@../property_report_pkg
@../quick_survey_report_pkg
@../region_report_pkg
@../user_report_pkg
@../schema_pkg


@../chain/activity_report_body
@../chain/bsci_2009_audit_report_body
@../chain/bsci_2014_audit_report_body
@../chain/bsci_body
@../chain/bsci_ext_audit_report_body
@../chain/bsci_supplier_report_body
@../chain/business_rel_report_body
@../chain/certification_report_body
@../chain/chain_body
@../chain/company_body
@../chain/company_filter_body
@../chain/company_request_report_body
@../chain/dedupe_proc_record_report_body
@../chain/filter_body
@../chain/prdct_supp_mtrc_report_body
@../chain/product_metric_report_body
@../chain/product_report_body
@../chain/product_supplier_report_body
@../audit_body
@../audit_report_body
@../compliance_library_report_body
@../compliance_register_report_body
@../enable_body
@../initiative_report_body
@../issue_body
@../issue_report_body
@../meter_list_body
@../meter_report_body
@../non_compliance_report_body
@../permit_report_body
@../property_report_body
@../quick_survey_report_body
@../region_report_body
@../user_report_body
@../schema_body
@../csrimp/imp_body

@update_tail
