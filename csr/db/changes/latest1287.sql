-- Please update version.sql too -- this keeps clean builds in sync
define version=1287
@update_header

CREATE SEQUENCE CSR.UTILITY_INVOICE_FIELD_ID_SEQ
    START WITH 1
    INCREMENT BY 1
    NOMINVALUE
    NOMAXVALUE
    CACHE 20
    NOORDER
;

CREATE TABLE CSR.UTILITY_INVOICE_FIELD(
    APP_SID        NUMBER(10, 0)     DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    FIELD_ID       NUMBER(10, 0)     NOT NULL,
    MEASURE_SID    NUMBER(10, 0)     NOT NULL,
    NAME           VARCHAR2(1024)    NOT NULL,
    DESCRIPTION    VARCHAR2(1024)    NOT NULL,
    CONSTRAINT PK1444 PRIMARY KEY (APP_SID, FIELD_ID)
)
;

CREATE TABLE CSR.UTILITY_INVOICE_FIELD_VAL(
    APP_SID                  NUMBER(10, 0)     DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    FIELD_ID                 NUMBER(10, 0)     NOT NULL,
    UTILITY_INVOICE_ID       NUMBER(10, 0)     NOT NULL,
    MEASURE_CONVERSION_ID    NUMBER(10, 0),
    VAL                      NUMBER(24, 10),
    CONSTRAINT PK1446 PRIMARY KEY (APP_SID, FIELD_ID, UTILITY_INVOICE_ID)
)
;

ALTER TABLE CSR.UTILITY_INVOICE ADD(
    COST_MEASURE_SID			NUMBER(10, 0),
    COST_CONV_ID				NUMBER(10, 0),
    CONSUMPTION_MEASURE_SID		NUMBER(10, 0),
    CONSUMPTION_CONV_ID			NUMBER(10, 0)
)
;

ALTER TABLE CSR.UTILITY_INVOICE ADD CONSTRAINT FK_INV_COST_CONV 
    FOREIGN KEY (APP_SID, COST_CONV_ID)
    REFERENCES CSR.MEASURE_CONVERSION(APP_SID, MEASURE_CONVERSION_ID)
;

ALTER TABLE CSR.UTILITY_INVOICE ADD CONSTRAINT FK_INV_CONSUPTION_CONV
    FOREIGN KEY (APP_SID, CONSUMPTION_CONV_ID)
    REFERENCES CSR.MEASURE_CONVERSION(APP_SID, MEASURE_CONVERSION_ID)
;

ALTER TABLE CSR.UTILITY_INVOICE ADD CONSTRAINT FK_INV_COST_MEASURE 
    FOREIGN KEY (APP_SID, COST_MEASURE_SID)
    REFERENCES CSR.MEASURE(APP_SID, MEASURE_SID)
;

ALTER TABLE CSR.UTILITY_INVOICE ADD CONSTRAINT FK_INV_CONS_MEASURE 
    FOREIGN KEY (APP_SID, CONSUMPTION_MEASURE_SID)
    REFERENCES CSR.MEASURE(APP_SID, MEASURE_SID)
;


ALTER TABLE CSR.UTILITY_INVOICE_FIELD ADD CONSTRAINT FK_UTIL_INV_CUST 
    FOREIGN KEY (APP_SID)
    REFERENCES CSR.CUSTOMER(APP_SID)
;

ALTER TABLE CSR.UTILITY_INVOICE_FIELD ADD CONSTRAINT FK_UTIL_INV_MEASURE 
    FOREIGN KEY (APP_SID, MEASURE_SID)
    REFERENCES CSR.MEASURE(APP_SID, MEASURE_SID)
;


ALTER TABLE CSR.UTILITY_INVOICE_FIELD_VAL ADD CONSTRAINT FK_UTIL_INV_VAL_FIELD 
    FOREIGN KEY (APP_SID, FIELD_ID)
    REFERENCES CSR.UTILITY_INVOICE_FIELD(APP_SID, FIELD_ID)
;

ALTER TABLE CSR.UTILITY_INVOICE_FIELD_VAL ADD CONSTRAINT FK_UTIL_INV_VAL_INV 
    FOREIGN KEY (APP_SID, UTILITY_INVOICE_ID)
    REFERENCES CSR.UTILITY_INVOICE(APP_SID, UTILITY_INVOICE_ID)
;

ALTER TABLE CSR.UTILITY_INVOICE_FIELD_VAL ADD CONSTRAINT FK_UTIL_INV_VAL_MCONV 
    FOREIGN KEY (APP_SID, MEASURE_CONVERSION_ID)
    REFERENCES CSR.MEASURE_CONVERSION(APP_SID, MEASURE_CONVERSION_ID)
;

CREATE INDEX CSR.IX_INV_COST_CONV ON CSR.UTILITY_INVOICE(APP_SID, COST_CONV_ID);
CREATE INDEX CSR.IX_INV_CONSUPTION_CONV ON CSR.UTILITY_INVOICE(APP_SID, CONSUMPTION_CONV_ID);
CREATE INDEX CSR.IX_INV_COST_MEASURE ON CSR.UTILITY_INVOICE (APP_SID, COST_MEASURE_SID);
CREATE INDEX CSR.IX_INV_CONS_MEASURE ON CSR.UTILITY_INVOICE (APP_SID, CONSUMPTION_MEASURE_SID);
CREATE INDEX CSR.IX_UTIL_INV_CUST ON CSR.UTILITY_INVOICE_FIELD (APP_SID);
CREATE INDEX CSR.IX_UTIL_INV_MEASURE ON CSR.UTILITY_INVOICE_FIELD (APP_SID, MEASURE_SID);
CREATE INDEX CSR.IX_UTIL_INV_VAL_FIELD ON CSR.UTILITY_INVOICE_FIELD_VAL (APP_SID, FIELD_ID);
CREATE INDEX CSR.IX_UTIL_INV_VAL_INV ON CSR.UTILITY_INVOICE_FIELD_VAL (APP_SID, UTILITY_INVOICE_ID);
CREATE INDEX CSR.IX_UTIL_INV_VAL_MCONV ON CSR.UTILITY_INVOICE_FIELD_VAL (APP_SID, MEASURE_CONVERSION_ID);

@../meter_pkg
@../utility_pkg

@../meter_body
@../utility_body
@../utility_report_body

@update_tail

