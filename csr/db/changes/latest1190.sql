-- Please update version.sql too -- this keeps clean builds in sync
define version=1190
@update_header

BEGIN
	DELETE FROM CT.WORKSHEET_VALUE_MAP_CURRENCY;
	DELETE FROM CT.WORKSHEET_VALUE_MAP_SUPPLIER;
	DELETE FROM CT.WORKSHEET_VALUE_MAP_BREAKDOWN;
	DELETE FROM CT.WORKSHEET_VALUE_MAP_REGION;
	DELETE FROM CT.PS_ITEM WHERE WORKSHEET_ID IS NOT NULL;
	DELETE FROM CT.WORKSHEET_FILE_UPLOAD;
	
	DELETE FROM CSR.WORKSHEET_ROW;
	DELETE FROM CSR.WORKSHEET_COLUMN_VALUE_MAP;
	DELETE FROM CSR.WORKSHEET_VALUE_MAP_VALUE;
	DELETE FROM CSR.WORKSHEET_VALUE_MAP;
	DELETE FROM CSR.WORKSHEET_COLUMN;
	DELETE FROM CSR.WORKSHEET_COLUMN_TYPE;
	DELETE FROM CSR.WORKSHEET_VALUE_MAPPER;
	DELETE FROM CSR.WORKSHEET;
	DELETE FROM CSR.WORKSHEET_TYPE;

	INSERT INTO CSR.WORKSHEET_TYPE (WORKSHEET_TYPE_ID, DESCRIPTION) VALUES (100, 'Products and Services');
	
	INSERT INTO CSR.WORKSHEET_VALUE_MAPPER (VALUE_MAPPER_ID, CLASS_TYPE, MAPPER_NAME, MAPPER_DESCRIPTION, JS_COMPONENT_PATH, JS_COMPONENT) VALUES (100, 'Credit360.CarbonTrust.Excel.CurrencyMapper', 'Currency codes', 'Map the currency codes that were found in the worksheet to currencies that the system uses', '/csr/site/ct/components/excel/CurrencyCombo.js', 'CarbonTrust.excel.CurrencyCombo');
	INSERT INTO CSR.WORKSHEET_VALUE_MAPPER (VALUE_MAPPER_ID, CLASS_TYPE, MAPPER_NAME, MAPPER_DESCRIPTION, JS_COMPONENT_PATH, JS_COMPONENT) VALUES (101, 'Credit360.CarbonTrust.Excel.RegionMapper', 'Regions', 'Map the regions that were found in the worksheet to regions that the system uses', '/csr/site/ct/components/excel/CountryCombo.js', 'CarbonTrust.excel.CountryCombo');
	INSERT INTO CSR.WORKSHEET_VALUE_MAPPER (VALUE_MAPPER_ID, CLASS_TYPE, MAPPER_NAME, MAPPER_DESCRIPTION, JS_COMPONENT_PATH, JS_COMPONENT) VALUES (102, 'Credit360.CarbonTrust.Excel.BreakdownMapper', '{breakdownTypePlural}', 'Map the {breakdownTypePlural} that were found in the worksheet to {breakdownTypePlural} that the system uses', '/csr/site/ct/components/excel/BreakdownPicker.js', 'CarbonTrust.excel.BreakdownPicker');
	INSERT INTO CSR.WORKSHEET_VALUE_MAPPER (VALUE_MAPPER_ID, CLASS_TYPE, MAPPER_NAME, MAPPER_DESCRIPTION, JS_COMPONENT_PATH, JS_COMPONENT) VALUES (103, 'Credit360.CarbonTrust.Excel.SupplierMapper', 'Suppliers', 'Map the suppliers that were found in the worksheet to suppliers that the system uses', '/csr/site/ct/components/excel/SupplierCombo.js', 'CarbonTrust.excel.SupplierCombo');	
		
	INSERT INTO CSR.WORKSHEET_COLUMN_TYPE (COLUMN_TYPE_ID, WORKSHEET_TYPE_ID, POSITION, VALUE_MAPPER_ID, NAME, DESCRIPTION) VALUES (1000, 100,  1, NULL, 'Description', 'The description of the product or service');
	INSERT INTO CSR.WORKSHEET_COLUMN_TYPE (COLUMN_TYPE_ID, WORKSHEET_TYPE_ID, POSITION, VALUE_MAPPER_ID, NAME, DESCRIPTION) VALUES (1001, 100,  2, NULL, 'Purchase date', 'The date when the product or service was purchased');
	INSERT INTO CSR.WORKSHEET_COLUMN_TYPE (COLUMN_TYPE_ID, WORKSHEET_TYPE_ID, POSITION, VALUE_MAPPER_ID, NAME, DESCRIPTION) VALUES (1002, 100,  3, NULL, 'Spend', 'Spend amount');
	INSERT INTO CSR.WORKSHEET_COLUMN_TYPE (COLUMN_TYPE_ID, WORKSHEET_TYPE_ID, POSITION, VALUE_MAPPER_ID, NAME, DESCRIPTION) VALUES (1003, 100,  4, 100, 'Currency', 'The currency of purchase of the product or service');
	INSERT INTO CSR.WORKSHEET_COLUMN_TYPE (COLUMN_TYPE_ID, WORKSHEET_TYPE_ID, POSITION, VALUE_MAPPER_ID, NAME, DESCRIPTION) VALUES (1004, 100,  4, 101, 'Country of manufacture', 'Country where the product was manufactured');
	INSERT INTO CSR.WORKSHEET_COLUMN_TYPE (COLUMN_TYPE_ID, WORKSHEET_TYPE_ID, POSITION, VALUE_MAPPER_ID, NAME, DESCRIPTION) VALUES (1005, 100,  5, 102, '{breakdownTypeSingular}', 'The {breakdownTypeSingular} that purchased the product or service');
	INSERT INTO CSR.WORKSHEET_COLUMN_TYPE (COLUMN_TYPE_ID, WORKSHEET_TYPE_ID, POSITION, VALUE_MAPPER_ID, NAME, DESCRIPTION) VALUES (1006, 100,  6, 102, '{breakdownTypeSingular} country', 'The country of operation of the {breakdownTypeSingular} that purchased the product or service');
	INSERT INTO CSR.WORKSHEET_COLUMN_TYPE (COLUMN_TYPE_ID, WORKSHEET_TYPE_ID, POSITION, VALUE_MAPPER_ID, NAME, DESCRIPTION) VALUES (1007, 100,  7, 103, 'Supplier Id', 'User reference id for the supplier');
	INSERT INTO CSR.WORKSHEET_COLUMN_TYPE (COLUMN_TYPE_ID, WORKSHEET_TYPE_ID, POSITION, VALUE_MAPPER_ID, NAME, DESCRIPTION) VALUES (1008, 100,  8, 103, 'Supplier name', 'The name of the supplier of the product or service');
	INSERT INTO CSR.WORKSHEET_COLUMN_TYPE (COLUMN_TYPE_ID, WORKSHEET_TYPE_ID, POSITION, VALUE_MAPPER_ID, NAME, DESCRIPTION) VALUES (1009, 100,  9, NULL, 'Supplier contact name', 'The name of the contact for the supplier');
	INSERT INTO CSR.WORKSHEET_COLUMN_TYPE (COLUMN_TYPE_ID, WORKSHEET_TYPE_ID, POSITION, VALUE_MAPPER_ID, NAME, DESCRIPTION) VALUES (1010, 100, 10, NULL, 'Supplier contact email', 'The email address of the supplier contact');
END;
/

DROP TABLE CT.WORKSHEET_FILE_UPLOAD;

CREATE TABLE CHAIN.WORKSHEET_FILE_UPLOAD(
    APP_SID            NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY', 'APP') NOT NULL,
    WORKSHEET_ID       NUMBER(10, 0)    NOT NULL,
    FILE_UPLOAD_SID    NUMBER(10, 0)    NOT NULL,
    CONSTRAINT PK_WS_FU PRIMARY KEY (APP_SID, WORKSHEET_ID, FILE_UPLOAD_SID)
);

ALTER TABLE CHAIN.WORKSHEET_FILE_UPLOAD ADD CONSTRAINT FK_FU_WSFU 
    FOREIGN KEY (APP_SID, FILE_UPLOAD_SID)
    REFERENCES CHAIN.FILE_UPLOAD(APP_SID, FILE_UPLOAD_SID)
;

GRANT SELECT, REFERENCES ON CSR.WORKSHEET TO CHAIN;
GRANT EXECUTE ON CSR.EXCEL_PKG TO CHAIN;

ALTER TABLE CHAIN.WORKSHEET_FILE_UPLOAD ADD CONSTRAINT FK_WS_WSFU 
    FOREIGN KEY (APP_SID, WORKSHEET_ID)
    REFERENCES CSR.WORKSHEET(APP_SID, WORKSHEET_ID)
;

INSERT INTO CHAIN.CARD_GROUP (card_group_id, name, description)
VALUES (35, 'CT Products and Services Upload Manager', 'CT Products and Services Upload Manager');

@..\chain\excel_pkg;
@..\chain\excel_body;

@..\ct\excel_pkg;
@..\ct\excel_body;


@update_tail
