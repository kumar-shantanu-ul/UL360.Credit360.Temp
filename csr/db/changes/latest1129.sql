-- Please update version.sql too -- this keeps clean builds in sync
define version=1129
@update_header

CREATE SEQUENCE CT.BREAKDOWN_GROUP_ID_SEQ
    START WITH 1
    INCREMENT BY 1
    NOMINVALUE
    NOMAXVALUE
    nocycle
    CACHE 20
    noorder;

ALTER TABLE CT.BREAKDOWN_GROUP ADD NAME VARCHAR2(1024) NOT NULL;	
ALTER TABLE CT.BREAKDOWN_GROUP ADD GROUP_KEY VARCHAR2(40) NOT NULL;
ALTER TABLE CT.BREAKDOWN_GROUP ADD DELETED NUMBER(1) DEFAULT 0 NOT NULL;
ALTER TABLE CT.BREAKDOWN_GROUP ADD CONSTRAINT CC_BD_GROUP_DELETED 
    CHECK (DELETED IN (1,0));
	
CREATE TABLE CT.EC_OPTIONS (
    APP_SID NUMBER(10) NOT NULL,
    COMPANY_SID NUMBER(10) NOT NULL,
    ANNUAL_LEAVE_DAYS NUMBER(20,10) NOT NULL,
    BREAKDOWN_TYPE_ID NUMBER(10) NOT NULL,
    CONSTRAINT PK_EC_OPT PRIMARY KEY (APP_SID, COMPANY_SID, BREAKDOWN_TYPE_ID)
);

ALTER TABLE CT.EC_OPTIONS ADD CONSTRAINT CC_EC_OPT_ANNUAL_LEAVE_DAYS 
    CHECK (ANNUAL_LEAVE_DAYS >= 0 AND ANNUAL_LEAVE_DAYS <=366);

ALTER TABLE CT.EC_OPTIONS ADD CONSTRAINT COMPANY_EC_OPT 
    FOREIGN KEY (APP_SID, COMPANY_SID) REFERENCES CT.COMPANY (APP_SID,COMPANY_SID);

ALTER TABLE CT.EC_OPTIONS ADD CONSTRAINT BD_TYPE_EC_OPT 
    FOREIGN KEY (APP_SID, BREAKDOWN_TYPE_ID) REFERENCES CT.BREAKDOWN_TYPE (APP_SID,BREAKDOWN_TYPE_ID);
	
CREATE TABLE CT.BT_OPTIONS (
    APP_SID NUMBER(10) NOT NULL,
    COMPANY_SID NUMBER(10) NOT NULL,
    INCLUDE_HOTEL_STAYS NUMBER(1) DEFAULT 0 NOT NULL,
    BREAKDOWN_TYPE_ID NUMBER(10) NOT NULL,
    CONSTRAINT PK_BT_OPT PRIMARY KEY (APP_SID, COMPANY_SID, BREAKDOWN_TYPE_ID)
);

ALTER TABLE CT.BT_OPTIONS ADD CONSTRAINT CC_BT_OPT_INCLUDE_HOTEL_STAYS 
    CHECK (INCLUDE_HOTEL_STAYS IN (1,0));

ALTER TABLE CT.BT_OPTIONS ADD CONSTRAINT COMPANY_BT_OPT 
    FOREIGN KEY (APP_SID, COMPANY_SID) REFERENCES CT.COMPANY (APP_SID,COMPANY_SID);

ALTER TABLE CT.BT_OPTIONS ADD CONSTRAINT BD_TYPE_BT_OPT 
    FOREIGN KEY (APP_SID, BREAKDOWN_TYPE_ID) REFERENCES CT.BREAKDOWN_TYPE (APP_SID,BREAKDOWN_TYPE_ID);
		
CREATE TABLE CT.UP_OPTIONS (
    APP_SID NUMBER(10) NOT NULL,
    COMPANY_SID NUMBER(10) NOT NULL,
    BREAKDOWN_TYPE_ID NUMBER(10) NOT NULL,
    CONSTRAINT PK_UP_OPT PRIMARY KEY (APP_SID, COMPANY_SID, BREAKDOWN_TYPE_ID)
);

ALTER TABLE CT.UP_OPTIONS ADD CONSTRAINT COMPANY_UP_OPT 
    FOREIGN KEY (APP_SID, COMPANY_SID) REFERENCES CT.COMPANY (APP_SID,COMPANY_SID);

ALTER TABLE CT.UP_OPTIONS ADD CONSTRAINT BD_TYPE_UP_OPT 
    FOREIGN KEY (APP_SID, BREAKDOWN_TYPE_ID) REFERENCES CT.BREAKDOWN_TYPE (APP_SID,BREAKDOWN_TYPE_ID);

CREATE TABLE CT.PS_OPTIONS (
    APP_SID NUMBER(10) NOT NULL,
    COMPANY_SID NUMBER(10) NOT NULL,
    BREAKDOWN_TYPE_ID NUMBER(10) NOT NULL,
    CONSTRAINT PK_PS_OPT PRIMARY KEY (APP_SID, COMPANY_SID, BREAKDOWN_TYPE_ID)
);

ALTER TABLE CT.PS_OPTIONS ADD CONSTRAINT COMPANY_PS_OPT 
    FOREIGN KEY (APP_SID, COMPANY_SID) REFERENCES CT.COMPANY (APP_SID,COMPANY_SID);

ALTER TABLE CT.PS_OPTIONS ADD CONSTRAINT BD_TYPE_PS_OPT 
    FOREIGN KEY (APP_SID, BREAKDOWN_TYPE_ID) REFERENCES CT.BREAKDOWN_TYPE (APP_SID,BREAKDOWN_TYPE_ID);

ALTER TABLE CT.WORKSHEET_COLUMN_TYPE
      RENAME COLUMN JS_ATTRIBUTE TO JS_KEY;

ALTER TABLE CT.WORKSHEET_COLUMN_TYPE DROP CONSTRAINT CC_WS_COLUMN_TYPE_MANDATORY;
ALTER TABLE CT.WORKSHEET_COLUMN_TYPE DROP CONSTRAINT TUC_WS_COLUMN_TYPE_2;	  
ALTER TABLE CT.WORKSHEET_COLUMN_TYPE DROP COLUMN NAME;
ALTER TABLE CT.WORKSHEET_COLUMN_TYPE DROP COLUMN MANDATORY;

@..\ct\breakdown_pkg
@..\ct\breakdown_body
@..\ct\breakdown_group_pkg
@..\ct\breakdown_group_body
@..\ct\emp_commute_pkg
@..\ct\emp_commute_body
	
@update_tail