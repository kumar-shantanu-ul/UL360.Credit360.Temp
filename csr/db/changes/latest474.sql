-- Please update version.sql too -- this keeps clean builds in sync
define version=474
@update_header

CREATE SEQUENCE FACTOR_TYPE_MAP_ID_SEQ
    START WITH 1
    INCREMENT BY 1
    NOMINVALUE
    NOMAXVALUE
    CACHE 20
    NOORDER
;

CREATE TABLE FACTOR_TYPE_MAP(
    FACTOR_TYPE_MAP_ID    NUMBER(10, 0)    NOT NULL,
    PARENT_ID             NUMBER(10, 0),
    STD_FACTOR_SET_ID     NUMBER(10, 0)    NOT NULL,
    FACTOR_TYPE_ID        NUMBER(10, 0),
    NAME                  VARCHAR2(100)    NOT NULL,
    CONSTRAINT PK770 PRIMARY KEY (FACTOR_TYPE_MAP_ID)
)
;

ALTER TABLE measure_conversion
	DROP COLUMN A;
ALTER TABLE measure_conversion_period
	DROP COLUMN A;
ALTER TABLE measure_conversion
	RENAME COLUMN conversion_factor TO A;
ALTER TABLE measure_conversion_period
	RENAME COLUMN conversion_factor TO A;
ALTER TABLE imp_val
	RENAME COLUMN conversion_factor TO A;
ALTER TABLE imp_val
	ADD B NUMBER(10, 0);
ALTER TABLE imp_val
	ADD C NUMBER(10, 0);

BEGIN
	UPDATE measure_conversion
	SET B = 1;
	UPDATE measure_conversion_period
	SET B = 1;
	UPDATE imp_val
	SET B = 1;
END;
/

-- alter measure conversion tables

ALTER TABLE std_measure_conversion_set
	DROP CONSTRAINT REFSTD_MEASURE1227;

ALTER TABLE std_measure_conversion_set
	DROP PRIMARY KEY CASCADE DROP INDEX;

DROP TABLE std_measure_conv_set_entry;
DROP TABLE std_measure_conversion_set;

ALTER TABLE factor_type
	DROP COLUMN std_measure_conv_set_id;
ALTER TABLE factor_type
	DROP COLUMN parent_id;

delete from factor;
delete from std_factor;
delete from factor_type;

ALTER TABLE factor_type
	ADD std_measure_id NUMBER(10, 0) NOT NULL;

ALTER TABLE FACTOR_TYPE ADD CONSTRAINT RefSTD_MEASURE1647 
    FOREIGN KEY (STD_MEASURE_ID)
    REFERENCES STD_MEASURE(STD_MEASURE_ID)
;

-- drop empty gas type tables

DROP TABLE factor_set_gas_type;

DROP TABLE factor_set CASCADE CONSTRAINTS;

-- alter country, region constraints
ALTER TABLE CSR.FACTOR ADD CONSTRAINT RefCOUNTRY1659 
    FOREIGN KEY (GEO_COUNTRY)
    REFERENCES POSTCODE.COUNTRY(COUNTRY)
;

ALTER TABLE CSR.STD_FACTOR ADD CONSTRAINT RefCOUNTRY1660 
    FOREIGN KEY (GEO_COUNTRY, GEO_REGION)
    REFERENCES POSTCODE.REGION(COUNTRY, REGION)
;

-- alter indicator
ALTER TABLE ind
	DROP COLUMN factor_set_id;
ALTER TABLE ind
	ADD MAP_TO_IND_SID NUMBER(10, 0) NULL;
ALTER TABLE ind
	ADD GAS_MEASURE_SID NUMBER(10, 0) NULL;
ALTER TABLE ind
	ADD GAS_TYPE_ID NUMBER(10, 0) NULL;
ALTER TABLE ind
	ADD FACTOR_TYPE_MAP_ID NUMBER(10,0) NULL;

ALTER TABLE CSR.IND ADD CONSTRAINT RefIND1662 
    FOREIGN KEY (APP_SID, MAP_TO_IND_SID)
    REFERENCES CSR.IND(APP_SID, IND_SID)
;
ALTER TABLE CSR.IND ADD CONSTRAINT RefMEASURE1664 
    FOREIGN KEY (APP_SID, GAS_MEASURE_SID)
    REFERENCES CSR.MEASURE(APP_SID, MEASURE_SID)
;

ALTER TABLE CSR.IND ADD CONSTRAINT RefGAS_TYPE1702 
    FOREIGN KEY (GAS_TYPE_ID)
    REFERENCES CSR.GAS_TYPE(GAS_TYPE_ID)
;

ALTER TABLE CSR.IND ADD CONSTRAINT RefFACTOR_TYPE_MAP1673 
    FOREIGN KEY (FACTOR_TYPE_MAP_ID)
    REFERENCES FACTOR_TYPE_MAP(FACTOR_TYPE_MAP_ID)
;

-- TABLE: FACTOR_TYPE_MAP 

ALTER TABLE FACTOR_TYPE_MAP ADD CONSTRAINT RefFACTOR_TYPE1670 
    FOREIGN KEY (FACTOR_TYPE_ID)
    REFERENCES FACTOR_TYPE(FACTOR_TYPE_ID)
;

ALTER TABLE FACTOR_TYPE_MAP ADD CONSTRAINT RefSTD_FACTOR_SET1671 
    FOREIGN KEY (STD_FACTOR_SET_ID)
    REFERENCES STD_FACTOR_SET(STD_FACTOR_SET_ID)
;

ALTER TABLE FACTOR_TYPE_MAP ADD CONSTRAINT RefFACTOR_TYPE_MAP1672 
    FOREIGN KEY (PARENT_ID)
    REFERENCES FACTOR_TYPE_MAP(FACTOR_TYPE_MAP_ID)
;

-- table factor

ALTER TABLE factor
	MODIFY std_measure_conversion_id NOT NULL;

@..\create_views

@update_tail
