-- Please update version.sql too -- this keeps clean builds in sync
define version=3188
define minor_version=9
@update_header

-- *** DDL ***
-- Create tables
CREATE TABLE CSR.FLOW_TRANSITION_ALERT_CC_ROLE(
    APP_SID                     NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    FLOW_TRANSITION_ALERT_ID    NUMBER(10, 0)    NOT NULL,
    ROLE_SID                    NUMBER(10, 0),
    GROUP_SID                   NUMBER(10, 0),
    CONSTRAINT CHK_FTACCR_ROLE_SID_GROUP_SID CHECK ((ROLE_SID IS NULL AND GROUP_SID IS NOT NULL) OR (ROLE_SID IS NOT NULL AND GROUP_SID IS NULL)),
    CONSTRAINT UK_FLOW_TRANS_ALERT_CC_ROLE UNIQUE (APP_SID, FLOW_TRANSITION_ALERT_ID, ROLE_SID, GROUP_SID)
)
;

CREATE TABLE CSR.FLOW_TRANSITION_ALERT_CC_USER(
    APP_SID                     NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    FLOW_TRANSITION_ALERT_ID    NUMBER(10, 0)    NOT NULL,
    USER_SID                    NUMBER(10, 0)    NOT NULL,
    CONSTRAINT PK_FLOW_TRANS_ALERT_CC_USER PRIMARY KEY (APP_SID, FLOW_TRANSITION_ALERT_ID, USER_SID)
)
;

CREATE TABLE CSRIMP.FLOW_TRANSITION_ALERT_CC_ROLE (
	CSRIMP_SESSION_ID				NUMBER(10) DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
    FLOW_TRANSITION_ALERT_ID    NUMBER(10, 0)    NOT NULL,
    ROLE_SID                    NUMBER(10, 0)    NULL,
    GROUP_SID                   NUMBER(10, 0)    NULL,
    CONSTRAINT UC_FLOW_TRANS_ALERT_CC_ROLE UNIQUE (CSRIMP_SESSION_ID, FLOW_TRANSITION_ALERT_ID, ROLE_SID, GROUP_SID),
    CONSTRAINT FK_FL_TRANS_ALERT_CC_ROLE_IS FOREIGN KEY
    	(CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID)
    	ON DELETE CASCADE
);

CREATE TABLE CSRIMP.FLOW_TRANSITION_ALERT_CC_USER(
	CSRIMP_SESSION_ID			NUMBER(10)		DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
	FLOW_TRANSITION_ALERT_ID	NUMBER(10, 0)	NOT NULL,
	USER_SID					NUMBER(10, 0)	NOT NULL,
	CONSTRAINT PK_FLOW_TRANS_ALERT_CC_USER PRIMARY KEY (CSRIMP_SESSION_ID, FLOW_TRANSITION_ALERT_ID, USER_SID),
	CONSTRAINT FK_FLOW_Cc_CSR_USER FOREIGN KEY
    	(CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID)
    	ON DELETE CASCADE
);

-- Alter tables
ALTER TABLE csr.customer ADD (
	allow_cc_on_alerts NUMBER(1) DEFAULT 0 NOT NULL,
	CONSTRAINT ck_allow_cc_on_alerts CHECK (allow_cc_on_alerts IN (0,1))
);

ALTER TABLE csrimp.customer ADD (
	allow_cc_on_alerts NUMBER(1) NOT NULL,
	CONSTRAINT ck_allow_cc_on_alerts CHECK (allow_cc_on_alerts IN (0,1))
);

ALTER TABLE CSR.FLOW_TRANSITION_ALERT_CC_ROLE ADD CONSTRAINT FK_FLOW_TR_AL_CC_RL_FLOW_TR_AL
    FOREIGN KEY (APP_SID, FLOW_TRANSITION_ALERT_ID)
    REFERENCES CSR.FLOW_TRANSITION_ALERT(APP_SID, FLOW_TRANSITION_ALERT_ID)
;

ALTER TABLE CSR.FLOW_TRANSITION_ALERT_CC_ROLE ADD CONSTRAINT FK_CC_ROLE_FL_TR_AL_ROLE
    FOREIGN KEY (APP_SID, ROLE_SID)
    REFERENCES CSR.ROLE(APP_SID, ROLE_SID)
;

ALTER TABLE CSR.FLOW_TRANSITION_ALERT_CC_USER ADD CONSTRAINT FK_FLOW_CC_CSR_USER
    FOREIGN KEY (APP_SID, USER_SID)
    REFERENCES CSR.CSR_USER(APP_SID, CSR_USER_SID)
;

CREATE INDEX CSR.IX_FLOW_TR_AL_CC_RL_FLOW_TR_AL ON CSR.FLOW_TRANSITION_ALERT_CC_ROLE(APP_SID, FLOW_TRANSITION_ALERT_ID);
CREATE INDEX CSR.IX_CC_ROLE_FL_TR_AL_ROLE ON CSR.FLOW_TRANSITION_ALERT_CC_ROLE(APP_SID, ROLE_SID);
CREATE INDEX CSR.IX_FLOW_CC_CSR_USER ON CSR.FLOW_TRANSITION_ALERT_CC_USER(APP_SID, USER_SID);

ALTER TABLE CSR.T_FLOW_TRANS_ALERT ADD (
	CC_USER_SIDS					VARCHAR2(2000),
	CC_ROLE_SIDS					VARCHAR2(2000),
	CC_GROUP_SIDS					VARCHAR2(2000)
);

-- *** Grants ***
grant select,insert,update,delete on csrimp.flow_transition_alert_cc_role to tool_user;
grant select,insert,update,delete on csrimp.flow_transition_alert_cc_user to tool_user;
grant insert on csr.flow_transition_alert_cc_role to csrimp;
grant insert on csr.flow_transition_alert_cc_user to csrimp;

-- ** Cross schema constraints ***

-- *** Views ***
-- Please paste the content of the view.

-- *** Data changes ***
-- RLS

-- Data
INSERT INTO CSR.UTIL_SCRIPT (UTIL_SCRIPT_ID,UTIL_SCRIPT_NAME,DESCRIPTION,UTIL_SCRIPT_SP,WIKI_ARTICLE) 
VALUES (60, 'Enable CC on workflow alerts', 'Allows adding CC users/roles to workflow alerts. Use with caution!', 'EnableCCOnAlerts', NULL);

INSERT INTO CSR.UTIL_SCRIPT (UTIL_SCRIPT_ID,UTIL_SCRIPT_NAME,DESCRIPTION,UTIL_SCRIPT_SP,WIKI_ARTICLE) 
VALUES (61, 'Disable CC on workflow alerts', 'Turns off ability to add CC users/roles to workflow alerts.', 'DisableCCOnAlerts', NULL);


-- ** New package grants **

-- *** Conditional Packages ***

-- *** Packages ***
@..\util_script_pkg
@..\schema_pkg
@..\flow_pkg

@..\util_script_body
@..\schema_body
@..\flow_body
@..\csrimp\imp_body
@..\customer_body
@..\csr_app_body
@..\..\..\Yam\db\webmail_body

@update_tail
