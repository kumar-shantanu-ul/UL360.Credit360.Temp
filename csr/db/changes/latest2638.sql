-- Please update version.sql too -- this keeps clean builds in sync
define version=2638
@update_header 

 
-- TABLE: CSR.APPROVAL_DASHBOARD_VAL 
--

CREATE TABLE CSR.APPROVAL_DASHBOARD_VAL(
    APP_SID                      NUMBER(10, 0)     DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    APPROVAL_DASHBOARD_VAL_ID    NUMBER(10, 0)     NOT NULL,
    APPROVAL_DASHBOARD_SID       NUMBER(10, 0)     NOT NULL,
    DASHBOARD_INSTANCE_ID        NUMBER(10, 0)     NOT NULL,
    IND_SID                      NUMBER(10, 0)     NOT NULL,
    START_DTM                    DATE              NOT NULL,
    END_DTM                      DATE              NOT NULL,
    VAL_NUMBER                   NUMBER(24, 10)    NOT NULL,
	YTD_VAL_NUMBER               NUMBER(24, 10)    NOT NULL,
	NOTE						 VARCHAR2(2048),
	NOTE_ADDED_BY_SID			 NUMBER(10),
	NOTE_ADDED_DTM				 DATE,
	IS_ESTIMATED_DATA 			 NUMBER(1)		   DEFAULT 0 NOT NULL,
    CONSTRAINT PK_APPROVAL_DASHBOARD_VAL PRIMARY KEY (APP_SID, APPROVAL_DASHBOARD_VAL_ID)
)
;



ALTER TABLE CSR.APPROVAL_DASHBOARD ADD (
    START_DTM                    DATE             DEFAULT '01-JAN-15' NOT NULL,
    END_DTM                      DATE             DEFAULT '01-JAN-16' NOT NULL,
    INTERVAL                     VARCHAR2(10)     DEFAULT 'y' NOT NULL,
	ACTIVE_PERIOD_SCENARIO_RUN_SID   NUMBER(10, 0),
	SIGNED_OFF_SCENARIO_RUN_SID NUMBER(10, 0),
	INSTANCE_CREATION_SCHEDULE XMLTYPE,
    CHECK (INTERVAL IN ('m','q','h','y'))
);
 
 -- 
-- TABLE: CSR.APPROVAL_DASHBOARD_IND 
--

CREATE TABLE CSR.APPROVAL_DASHBOARD_IND(
    APP_SID                   NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    APPROVAL_DASHBOARD_SID    NUMBER(10, 0)    NOT NULL,
    IND_SID                   NUMBER(10, 0)    NOT NULL,
	HIDDEN_DTM				  DATE,
	ALLOW_ESTIMATED_DATA 	  NUMBER(1) 	   DEFAULT 0 NOT NULL,
	POS 					  NUMBER(10) 	   DEFAULT 0 NOT NULL,
    CONSTRAINT PK_APPROVAL_DASHBOARD_IND PRIMARY KEY (APP_SID, APPROVAL_DASHBOARD_SID, IND_SID)
)
;



 
ALTER TABLE CSR.APPROVAL_DASHBOARD_INSTANCE ADD (
    LAST_REFRESHED_DTM        DATE,
    IS_LOCKED                 NUMBER(1, 0)     DEFAULT 0 NOT NULL,
    CONSTRAINT CHK_APPR_DASH_INST_LOCK CHECK (IS_LOCKED IN (0,1))
);
 
 
 -- 
-- TABLE: CSR.APPROVAL_DASHBOARD_VAL_SRC 
--

CREATE TABLE CSR.APPROVAL_DASHBOARD_VAL_SRC(
    APP_SID                      NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    APPROVAL_DASHBOARD_VAL_ID    NUMBER(10, 0)    NOT NULL,
    ID                           NUMBER(10, 0)    NOT NULL,
	LAST_DATE					 DATE			  NOT NULL,
	DESCRIPTION					 VARCHAR2(1024),
    CONSTRAINT PK_APPROVAL_DASHBOARD_VAL_SRC PRIMARY KEY (APP_SID, APPROVAL_DASHBOARD_VAL_ID, ID)
)
;


 -- 
-- TABLE: CSR.APPROVAL_DASH_PEND_CALC_INSTS
--

CREATE TABLE CSR.APPROVAL_DASH_PEND_CALC_INSTS (
    APP_SID                      NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    SCENARIO_RUN_SID    	 	 NUMBER(10, 0)    NOT NULL,
    DASHBOARD_INSTANCE_ID        NUMBER(10, 0)    NOT NULL,
	CONSTRAINT PK_APP_DASH_PEND_CALC PRIMARY KEY (APP_SID, SCENARIO_RUN_SID, DASHBOARD_INSTANCE_ID)
)
;

 -- 
-- TABLE: CSR.AGGREGATE_IND_VAL_DETAIL
--

CREATE TABLE CSR.AGGREGATE_IND_VAL_DETAIL(
  APP_SID 					NUMBER(10, 0) 	DEFAULT SYS_CONTEXT('SECURITY', 'APP') NOT NULL,
  AGGREGATE_IND_GROUP_ID 	NUMBER(10, 0) 	NOT NULL,
  REGION_SID 				NUMBER(10, 0) 	NOT NULL,
  IND_SID 					NUMBER(10, 0) 	NOT NULL,
  PERIOD_START_DTM 			DATE 			NOT NULL,
  PERIOD_END_DTM 			DATE 			NOT NULL,
  SRC_ID 					NUMBER(10, 0) 	NOT NULL,
  DESCRIPTION 				VARCHAR2(1024) 	NOT NULL,
  DTM 						DATE
  --CONSTRAINT PK_AGGREGATE_IND_VAL_DETAIL PRIMARY KEY (APP_SID, REGION_SID, IND_SID, PERIOD_START_DTM, PERIOD_END_DTM)
)
;


 -- 
-- INDEX: CSR.AK_APPROVAL_DASHBOARD_VAL 
--

CREATE UNIQUE INDEX CSR.AK_APPROVAL_DASHBOARD_VAL ON CSR.APPROVAL_DASHBOARD_VAL(APP_SID, DASHBOARD_INSTANCE_ID, START_DTM, IND_SID)
;
-- 
-- INDEX: CSR.UK_APPR_DASH_INSTANCE_2 
--

CREATE UNIQUE INDEX CSR.UK_APPR_DASH_INSTANCE_2 ON CSR.APPROVAL_DASHBOARD_INSTANCE(APP_SID, DASHBOARD_INSTANCE_ID, APPROVAL_DASHBOARD_SID)
;
ALTER TABLE CSR.APPROVAL_DASHBOARD_INSTANCE ADD CONSTRAINT UK_APPR_DASH_INSTANCE_2 UNIQUE (APP_SID, DASHBOARD_INSTANCE_ID, APPROVAL_DASHBOARD_SID);

-- 
 
 
-- 
-- TABLE: CSR.APPROVAL_DASHBOARD_VAL 
--

ALTER TABLE CSR.APPROVAL_DASHBOARD_VAL ADD CONSTRAINT FK_APP_DASH_IND_VAL 
    FOREIGN KEY (APP_SID, APPROVAL_DASHBOARD_SID, IND_SID)
    REFERENCES CSR.APPROVAL_DASHBOARD_IND(APP_SID, APPROVAL_DASHBOARD_SID, IND_SID)
;

ALTER TABLE CSR.APPROVAL_DASHBOARD_VAL ADD CONSTRAINT FK_APP_DASH_INST_VAL 
    FOREIGN KEY (APP_SID, DASHBOARD_INSTANCE_ID, APPROVAL_DASHBOARD_SID)
    REFERENCES CSR.APPROVAL_DASHBOARD_INSTANCE(APP_SID, DASHBOARD_INSTANCE_ID, APPROVAL_DASHBOARD_SID)
;

ALTER TABLE CSR.APPROVAL_DASHBOARD_VAL ADD CONSTRAINT FK_APP_DASH_NOTE_USER
	FOREIGN KEY (APP_SID, NOTE_ADDED_BY_SID)
	REFERENCES CSR.CSR_USER(APP_SID, CSR_USER_SID);

-- 
 -- 
-- TABLE: CSR.APPROVAL_DASHBOARD_IND 
--

ALTER TABLE CSR.APPROVAL_DASHBOARD_IND ADD CONSTRAINT FK_APP_DASH_DASH_IND 
    FOREIGN KEY (APP_SID, APPROVAL_DASHBOARD_SID)
    REFERENCES CSR.APPROVAL_DASHBOARD(APP_SID, APPROVAL_DASHBOARD_SID)
;

ALTER TABLE CSR.APPROVAL_DASHBOARD_IND ADD CONSTRAINT FK_INND_APP_DASH_IND 
    FOREIGN KEY (APP_SID, IND_SID)
    REFERENCES CSR.IND(APP_SID, IND_SID)
;


-- TABLE: CSR.APPROVAL_DASHBOARD_VAL_SRC 
--

ALTER TABLE CSR.APPROVAL_DASHBOARD_VAL_SRC ADD CONSTRAINT RefAPPROVAL_DASHBOARD_VAL4397 
    FOREIGN KEY (APP_SID, APPROVAL_DASHBOARD_VAL_ID)
    REFERENCES CSR.APPROVAL_DASHBOARD_VAL(APP_SID, APPROVAL_DASHBOARD_VAL_ID)
;


-- TABLE: CSR.APPROVAL_DASH_PEND_CALC_INSTS

ALTER TABLE CSR.APPROVAL_DASH_PEND_CALC_INSTS ADD CONSTRAINT FK_APP_DASH_PEND_CALC_SCEN_SID
	FOREIGN KEY(APP_SID, SCENARIO_RUN_SID)
	REFERENCES CSR.SCENARIO_RUN(APP_SID, SCENARIO_RUN_SID)
;

ALTER TABLE CSR.APPROVAL_DASH_PEND_CALC_INSTS ADD CONSTRAINT FK_APP_DASH_PEND_CALC_INST_ID
	FOREIGN KEY(APP_SID, DASHBOARD_INSTANCE_ID)
	REFERENCES CSR.APPROVAL_DASHBOARD_INSTANCE(APP_SID, DASHBOARD_INSTANCE_ID)
;

-- 
-- TABLE: CSR.AGGREGATE_IND_VAL_DETAIL
--

ALTER TABLE CSR.AGGREGATE_IND_VAL_DETAIL ADD CONSTRAINT FK_AGG_IND_VAL_DETAIL_IND
	FOREIGN KEY(APP_SID, IND_SID)
	REFERENCES CSR.IND(APP_SID, IND_SID)
;

ALTER TABLE CSR.AGGREGATE_IND_VAL_DETAIL ADD CONSTRAINT FK_AGG_IND_VAL_DETAIL_REGION
	FOREIGN KEY(APP_SID, REGION_SID)
	REFERENCES CSR.REGION(APP_SID, REGION_SID)
;

ALTER TABLE CSR.AGGREGATE_IND_VAL_DETAIL ADD CONSTRAINT FK_AGG_IND_VAL_DET_AGG_IND_GRP
	FOREIGN KEY(APP_SID, AGGREGATE_IND_GROUP_ID)
	REFERENCES CSR.AGGREGATE_IND_GROUP(APP_SID, AGGREGATE_IND_GROUP_ID)
;

CREATE TABLE CSR.BATCH_JOB_APPROVAL_DASH_VALS (
    APP_SID                      NUMBER(10, 0)     DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    DASHBOARD_INSTANCE_ID        NUMBER(10, 0)     NOT NULL,
    BATCH_JOB_ID                 NUMBER(10, 0)     NOT NULL
);

CREATE UNIQUE INDEX CSR.AK_BATCH_JOB_APP_DASH ON CSR.BATCH_JOB_APPROVAL_DASH_VALS(APP_SID, DASHBOARD_INSTANCE_ID, BATCH_JOB_ID)
;

ALTER TABLE CSR.BATCH_JOB_APPROVAL_DASH_VALS ADD CONSTRAINT FK_BATCH_JOB_APP_DASH_JOB_ID
    FOREIGN KEY (APP_SID, BATCH_JOB_ID)
    REFERENCES CSR.BATCH_JOB(APP_SID, BATCH_JOB_ID)
;
	
ALTER TABLE csr.FLOW_ALERT_CLASS
  ADD ON_SAVE_HELPER_SP varchar2(255);

CREATE SEQUENCE  "CSR"."APPROVAL_DASHBOARD_VAL_ID_SEQ"  
  MINVALUE 1
  INCREMENT BY 1 
  START WITH 1 CACHE 20 NOORDER  NOCYCLE ;
  
BEGIN
	insert into csr.flow_alert_class (FLOW_ALERT_CLASS, LABEL, ON_SAVE_HELPER_SP) values('approvaldashboard', 'Approval dashboard', 'flow_pkg.OnCreateAppDashFlow');
	--insert into csr.CUSTOMER_FLOW_ALERT_CLASS (FLOW_ALERT_CLASS) values ('approvaldashboard');
	insert into csr.batch_job_type (batch_job_type_id, description, sp, plugin_name, one_at_a_time, file_data_sp)
		values (15, 'Approval dashboard', null, 'approval-dashboard', 0, null);
	INSERT INTO CSR.portlet (PORTLET_ID, NAME, TYPE, SCRIPT_PATH) VALUES (1052, 'Approval chart', 'Credit360.Portlets.ApprovalChart', '/csr/site/portal/portlets/ApprovalDashboards/approvalChart.js');
	INSERT INTO CSR.portlet (PORTLET_ID, NAME, TYPE, SCRIPT_PATH) VALUES (1053, 'Approval dashboard value comparer', 'Credit360.Portlets.ApprovalValComparer', '/csr/site/portal/portlets/ApprovalDashboards/valComparer.js');
END;
/

@..\batch_job_pkg
@..\approval_dashboard_pkg
@..\approval_dashboard_body
@..\aggregate_ind_pkg
@..\aggregate_ind_body
@..\scenario_run_pkg
@..\scenario_run_body
@..\stored_calc_datasource_pkg
@..\stored_calc_datasource_body
@..\flow_pkg
@..\flow_body


@update_tail
