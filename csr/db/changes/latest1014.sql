-- Please update version.sql too -- this keeps clean builds in sync
define version=1014
@update_header

-- ******************************************************
-- *********** do not copy this, it wasn't a good idea.
-- ******************************************************
-- when adding RLS then you should copy something like latest1055 where RLS is *added* not
-- *removed then added*
-- (The RLS script ought to be revised to do this -- it is not meant to be run
--  against live, but in case it is it should just add RLS where it is missing and remove
--  it where it needs to be removed).

begin
	-- select from ALL_POLICIES and restrict by OBJECT_OWNER in case we have to run this as another user with grant execute on dbms_rls
	for r in (select object_name, policy_name from all_policies where object_owner='CSR') loop
		dbms_rls.drop_policy(
            object_schema   => 'CSR',
            object_name     => r.object_name,
            policy_name     => r.policy_name
        );
    end loop;
end;
/

declare
	policy_already_exists exception;
	pragma exception_init(policy_already_exists, -28101);

	type t_tabs is table of varchar2(30);
	v_list t_tabs;
	v_null_list t_tabs;
begin	
	v_list := t_tabs(
		'ACCURACY_TYPE',
		'ACCURACY_TYPE_OPTION',
		'AGGREGATE_IND_GROUP',
		'AGGREGATE_IND_GROUP_MEMBER',
		'ALERT_FRAME',
		'ALERT_FRAME_BODY',
		'ALERT_IMAGE',
		'ALERT_TEMPLATE',
		'ALERT_TEMPLATE_BODY',
		'ALL_METER',
		'APPROVAL_DASHBOARD',
		'APPROVAL_DASHBOARD_ALERT_TYPE',  
		'APPROVAL_DASHBOARD_INSTANCE',
		'APPROVAL_DASHBOARD_REGION',
		'APPROVAL_DASHBOARD_TAB',
		'APPROVAL_DASHBOARD_TPL_TAG',
		'APPROVAL_STEP',
		'APPROVAL_STEP_IND',
		'APPROVAL_STEP_MODEL',
		'APPROVAL_STEP_REGION',
		'APPROVAL_STEP_ROLE',
		'APPROVAL_STEP_SHEET',
		'APPROVAL_STEP_SHEET_ALERT',
		'APPROVAL_STEP_SHEET_LOG',
		'APPROVAL_STEP_TEMPLATE',
		'APPROVAL_STEP_USER',
		'APPROVAL_STEP_USER_TEMPLATE',
		'APP_LOCK',
		'ATTACHMENT',
		'ATTACHMENT_HISTORY',
		'AUDIT_LOG',
		'AUTOCREATE_USER',
		'AXIS',
		'AXIS_MEMBER',
		'CALC_DEPENDENCY',
		'CALC_TAG_DEPENDENCY',
		'CHAIN_TPL_DELEGATION',
		'CMS_TAB_ALERT_TYPE',
		'CORRESPONDENT',
		'CSR_USER',
		'CUSTOMER',
		'CUSTOMER_ALERT_TYPE',
		'CUSTOMER_ALERT_TYPE_PARAM',
		'CUSTOMER_HELP_LANG',
		'CUSTOMER_MAP',
		'CUSTOMER_PORTLET',
		'CUSTOMER_REGION_TYPE',
		'CUSTOM_DISTANCE',
		'CUSTOM_LOCATION',
		'DASHBOARD',
		'DASHBOARD_ITEM',
		'DATAVIEW',
		'DATAVIEW_IND_MEMBER',
		'DATAVIEW_REGION_MEMBER',
		'DATAVIEW_SCENARIO_RUN',
		'DATAVIEW_ZONE',
		'DEFAULT_RSS_FEED',
		'DELEGATION',
		'DELEGATION_CHANGE_ALERT',
		'DELEGATION_COMMENT',
		'DELEGATION_GRID',
		'DELEGATION_GRID_AGGREGATE_IND',
		'DELEGATION_IND',
		'DELEGATION_IND_COND',
		'DELEGATION_IND_COND_ACTION',
		'DELEGATION_IND_TAG',
		'DELEGATION_IND_TAG_LIST',
		'DELEGATION_PLUGIN',
		'DELEGATION_REGION',
		'DELEGATION_ROLE',
		'DELEGATION_TAG',
		'DELEGATION_TERMINATED_ALERT',
		'DELEGATION_USER',	
		'DELEGATION_USER_COVER',		
		'DELEG_DATA_CHANGE_ALERT',
		'DELEG_PLAN',
		'DELEG_PLAN_APPLIED',
		'DELEG_PLAN_COL',
		'DELEG_PLAN_COL_DELEG',
		'DELEG_PLAN_COL_SURVEY',
		'DELEG_PLAN_DELEG_REGION',
		'DELEG_PLAN_DELEG_REGION_DELEG',
		'DELEG_PLAN_REGION',
		'DELEG_PLAN_ROLE',
		'DELEG_PLAN_SURVEY_REGION',
		'DELETED_DELEGATION',
		'DIARY_EVENT',
		'DIARY_EVENT_GROUP',
		'DIVISION',
		'DOC',
		'DOC_CURRENT',
		'DOC_DATA',
		'DOC_DOWNLOAD',
		'DOC_FOLDER',
		'DOC_FOLDER_SUBSCRIPTION',
		'DOC_LIBRARY',
		'DOC_NOTIFICATION',
		'DOC_SUBSCRIPTION',
		'DOC_VERSION',
		'EST_ACCOUNT',
		'EST_ATTR_MAPPING_TAG',
		'EST_BUILDING',
		'EST_BUILDING_METRIC',
		'EST_BUILDING_METRIC_MAPPING',
		'EST_CUSTOMER',
		'EST_ENERGY_METER',
		'EST_ENERGY_TYPE_MAPPING',
		'EST_METRIC_MAPPING_TAG',
		'EST_OTHER_MAPPING',
		'EST_OTHER_MAPPING_TAG',
		'EST_SPACE',
		'EST_SPACE_ATTR',
		'EST_SPACE_ATTR_MAPPING',
		'EST_TRANSACTION',
		'EST_TRANSACTION_POLL',
		'EST_WATER_METER',
		'EST_WATER_USE_MAPPING',
		'EVENT',
		'EXCEL_EXPORT_OPTIONS',
		'FACTOR',
		'FACTOR_HISTORY',
		'FEED',
		'FEED_REQUEST',
		'FILE_UPLOAD',
		'FLOW',
		'FLOW_ALERT_TYPE',
		'FLOW_ITEM',
		'FLOW_ITEM_ALERT',
		'FLOW_STATE',
		'FLOW_STATE_LOG',
		'FLOW_STATE_ROLE',
		'FLOW_STATE_TRANSITION',
		'FLOW_STATE_TRANSITION_ROLE',
		'FLOW_TRANSITION_ALERT',
		'FLOW_TRANSITION_ALERT_ROLE',
		'FORM',
		'FORM_ALLOCATION',
		'FORM_ALLOCATION_ITEM',
		'FORM_ALLOCATION_USER',
		'FORM_COMMENT',
		'HELP_IMAGE_TAG',
		'HELP_TAG',
		'IMG_CHART',
		'IMG_CHART_IND',
		'IMP_CONFLICT',
		'IMP_CONFLICT_VAL',
		'IMP_IND',
		'IMP_MEASURE',
		'IMP_REGION',
		'IMP_SESSION',
		'IMP_VAL',
		'IMP_VOCAB',
		'IND',
		'IND_ACCURACY_TYPE',
		'IND_FLAG',
		'IND_SELECTION_GROUP',
		'IND_SELECTION_GROUP_MEMBER',		
		'IND_START_POINT',
		'IND_TAG',
		'IND_VALIDATION_RULE',
		'IND_WINDOW',
		'INSTANCE_DATAVIEW',
		'INTERNAL_AUDIT',
		'INTERNAL_AUDIT_POSTIT',
		'INTERNAL_AUDIT_TYPE',
		'ISSUE',
		'ISSUE_ACTION',		
		'ISSUE_ACTION_LOG',
		'ISSUE_CUSTOM_FIELD',
		'ISSUE_CUSTOM_FIELD_OPTION',
		'ISSUE_CUSTOM_FIELD_OPT_SEL',
		'ISSUE_CUSTOM_FIELD_STR_VAL',
		'ISSUE_LOG',
		'ISSUE_LOG_FILE',
		'ISSUE_LOG_READ',
		'ISSUE_METER',
		'ISSUE_METER_ALARM',
		'ISSUE_METER_DATA_SOURCE',
		'ISSUE_METER_RAW_DATA',
		'ISSUE_NON_COMPLIANCE',
		'ISSUE_PENDING_VAL',
		'ISSUE_PRIORITY',
		'ISSUE_SCHEDULED_TASK',
		'ISSUE_SHEET_VALUE',
		'ISSUE_SURVEY_ANSWER',
		'ISSUE_TYPE',
		'ISSUE_USER',
		'JOB',
		'LAST_USED_MEASURE_CONVERSION',
		'LIVE_DATA_DURATION',
		'LOGISTICS_DEFAULT',
		'LOGISTICS_ERROR_LOG',
		'LOGISTICS_TAB_MODE',
		'MAP_SHPFILE',
		'MASTER_DELEG',
		'MEASURE',
		'MEASURE_CONVERSION',
		'MEASURE_CONVERSION_PERIOD',
		'METER_ALARM',
		'METER_ALARM_COMPARISON',
		'METER_ALARM_EVENT',
		'METER_ALARM_ISSUE_PERIOD',
		'METER_ALARM_STATISTIC',
		'METER_ALARM_STATISTIC_JOB',
		'METER_ALARM_STATISTIC_PERIOD',
		'METER_ALARM_STAT_RUN',
		'METER_ALARM_TEST_TIME',
		'METER_DOCUMENT',
		'METER_EXCEL_MAPPING',
		'METER_EXCEL_OPTION',
		'METER_LIST_CACHE',
		'METER_LIVE_DATA',
		'METER_METER_ALARM_STATISTIC',
		'METER_ORPHAN_DATA',
		'METER_RAW_DATA',
		'METER_RAW_DATA_ERROR',
		'METER_RAW_DATA_SOURCE',
		'METER_READING',
		'METER_SOURCE_DATA',
		'METER_SOURCE_TYPE',
		'METER_UTILITY_CONTRACT',
		'METER_XML_OPTION',
		'MODEL',
		'MODEL_INSTANCE',
		'MODEL_INSTANCE_CHART',
		'MODEL_INSTANCE_MAP',
		'MODEL_INSTANCE_REGION',
		'MODEL_INSTANCE_SHEET',
		'MODEL_MAP',
		'MODEL_RANGE',
		'MODEL_RANGE_CELL',
		'MODEL_REGION_RANGE',
		'MODEL_SHEET',
		'MODEL_VALIDATION',
		'NEW_DELEGATION_ALERT',
		'NON_COMPLIANCE',
		'NON_COMPLIANCE_EXPR_ACTION',
		'NON_COMPLIANCE_FILE_UPLOAD',
		'NON_COMPLIANCE_TAG',
		'OBJECTIVE',
		'OBJECTIVE_STATUS',
		'OPTION_ITEM',
		'OPTION_SET',
		'PCT_OWNERSHIP',
		'PCT_OWNERSHIP_CHANGE',
		'PENDING_DATASET',
		'PENDING_IND',
		'PENDING_IND_ACCURACY_TYPE',
		'PENDING_IND_RULE',
		'PENDING_PERIOD',
		'PENDING_REGION',
		'PENDING_VAL',
		'PENDING_VAL_ACCURACY_TYPE_OPT',
		'PENDING_VAL_CACHE',
		'PENDING_VAL_FILE_UPLOAD',
		'PENDING_VAL_LOG',
		'PENDING_VAL_VARIANCE',
		'PROPERTY',
		'PROPERTY_DIVISION',
		'PVC_REGION_RECALC_JOB',
		'PVC_STORED_CALC_JOB',
		'QS_ANSWER_FILE',
		'QS_ANSWER_LOG',
		'QS_CAMPAIGN',
		'QS_DIMENSION',
		'QS_DIMENSION_QUESTION',
		'QS_EXPR_DEPENDENCY',
		'QS_EXPR_MSG_ACTION',
		'QS_EXPR_NC_ACTION_INVOLVE_ROLE',
		'QS_EXPR_NON_COMPL_ACTION',
		'QS_EXPR_STATUS_ACTION',
		'QS_FILTER_CONDITION',
		'QS_QUESTION_OPTION',
		'QS_QUESTION_REPORT',
		'QS_RESPONSE_POSTIT',
		'QS_RESPONSE_STATUS',
		'QUICK_SURVEY',
		'QUICK_SURVEY_ANSWER',
		'QUICK_SURVEY_EXPR',
		'QUICK_SURVEY_EXPR_ACTION',
		'QUICK_SURVEY_LANG',
		'QUICK_SURVEY_QUESTION',
		'QUICK_SURVEY_RESPONSE',
		'QUICK_SURVEY_TYPE',
		'RANGE_IND_MEMBER',
		'RANGE_REGION_MEMBER',
		'REGION',
		'REGION_EVENT',
		'REGION_INTERNAL_AUDIT',
		'REGION_METER_ALARM',
		'REGION_OWNER',
		'REGION_PROC_DOC',
		'REGION_PROC_FILE',
		'REGION_ROLE_MEMBER',
		'REGION_SURVEY_RESPONSE',
		'REGION_TAG',
		'REGION_TREE',
		'RELATED_AXIS',
		'RELATED_AXIS_MEMBER',
		'REPORTING_PERIOD',
		'RISKS',
		'ROLE',
		'ROLE_GRANT',
		'ROOT_SECTION_USER',
		'RSS_FEED',
		'RSS_FEED_ITEM',
		'SAML_ASSERTION_CACHE',
		'SAML_ASSERTION_LOG',
		'SAML_LOG',
		'SCENARIO',
		'SCENARIO_AUTO_RUN_REQUEST',
		'SCENARIO_IND',
		'SCENARIO_MAN_RUN_REQUEST',
		'SCENARIO_OPTIONS',
		'SCENARIO_REGION',
		'SCENARIO_RULE',
		'SCENARIO_RULE_IND',
		'SCENARIO_RULE_REGION',
		'SCENARIO_RUN',
		'SCENARIO_RUN_VAL',
		'SCRAG_PROGRESS',
		'SECTION',
		'SECTION_APPROVERS',
		'SECTION_COMMENT',
		'SECTION_MODULE',
		'SECTION_STATUS',
		'SECTION_TRANSITION',
		'SECTION_VERSION',
		'SELECTED_AXIS_TASK',
		'SESSION_EXTRA',
		'SHEET',
		'SHEET_ALERT',
		'SHEET_CHANGE_REQ',
		'SHEET_HISTORY',
		'SHEET_INHERITED_VALUE',
		'SHEET_VALUE',
		'SHEET_VALUE_ACCURACY',
		'SHEET_VALUE_CHANGE',
		'SHEET_VALUE_CHANGE_FILE',
		'SHEET_VALUE_FILE',
		'SHEET_VALUE_VAR_EXPL',
		'SNAPSHOT',
		'SNAPSHOT_IND',
		'SNAPSHOT_REGION',
		'SNAPSHOT_TAG_GROUP',
		'SUPPLIER',
		'SUPPLIER_DELEGATION',
		'SUPPLIER_SURVEY_RESPONSE',
		'SURVEY',
		'SURVEY_ALLOCATION',
		'SURVEY_RESPONSE',
		'TAB',
		'TAB_GROUP',
		'TAB_PORTLET',
		'TAB_PORTLET_RSS_FEED',
		'TAB_PORTLET_USER_REGION',
		'TAB_USER',
		'TAG',
		'TAG_GROUP',
		'TAG_GROUP_MEMBER',
		'TARGET_DASHBOARD',
		'TARGET_DASHBOARD_IND_MEMBER',
		'TARGET_DASHBOARD_VALUE',
		'TEMPLATE',
		'TPL_REPORT',
		'TPL_REPORT_TAG',
		'TPL_REPORT_TAG_DATAVIEW',
		'TPL_REPORT_TAG_DV_REGION',
		'TPL_REPORT_TAG_EVAL',
		'TPL_REPORT_TAG_EVAL_COND',
		'TPL_REPORT_TAG_IND',
		'TPL_REPORT_TAG_LOGGING_FORM',
		'TPL_REPORT_TAG_TEXT',
		'TPL_REP_CUST_TAG_TYPE',
		'TRASH',
		'UNAPPROVED_VAL',
		'USER_COVER',
		'USER_MESSAGE_ALERT',
		'USER_SETTING_ENTRY',
		'USER_SURVEY_RESPONSE',
		'UTILITY_CONTRACT',
		'UTILITY_INVOICE',
		'UTILITY_SUPPLIER',
		'VAL',
		'VALIDATION_RULE',
		'VAL_ACCURACY',
		'VAL_CHANGE',
		'VAL_FILE',
		'VAL_NOTE',
		'VAL_TRIGGER',
		'VAL_TRIGGER_FIRED',
		'VAL_TRIGGER_REGION',
		'VAR_EXPL',
		'VAR_EXPL_GROUP'
--		'STORED_CALC_JOB',	
	);
	for i in 1 .. v_list.count loop
		declare
			v_name varchar2(30);
			v_i pls_integer default 1;
		begin
			loop
				begin
					if v_i = 1 then
						v_name := SUBSTR(v_list(i), 1, 23)||'_POLICY';
					else
						v_name := SUBSTR(v_list(i), 1, 21)||'_POLICY_'||v_i;
					end if;
					dbms_output.put_line('doing '||v_name);
				    dbms_rls.add_policy(
				        object_schema   => 'CSR',
				        object_name     => v_list(i),
				        policy_name     => v_name,
				        function_schema => 'CSR',
				        policy_function => 'appSidCheck',
				        statement_types => 'select, insert, update, delete',
				        update_check	=> true,
				        policy_type     => dbms_rls.context_sensitive );
				    -- dbms_output.put_line('done  '||v_name);
				  	exit;
				exception
					when policy_already_exists then
						v_i := v_i + 1;
				end;
			end loop;
		end;
	end loop;
end;
/

declare
	policy_already_exists exception;
	pragma exception_init(policy_already_exists, -28101);

	type t_tabs is table of varchar2(30);
	v_list t_tabs;
	v_null_list t_tabs;
begin	
	v_list := t_tabs(
		'UTILITY_CONTRACT'
	);
	for i in 1 .. v_list.count loop
		declare
			v_name varchar2(30);
			v_i pls_integer default 1;
		begin
			loop
				begin
					if v_i = 1 then
						v_name := SUBSTR(v_list(i), 1, 23)||'_POLICY';
					else
						v_name := SUBSTR(v_list(i), 1, 21)||'_POLICY_'||v_i;
					end if;
					-- dbms_output.put_line('doing '||v_name);
				    dbms_rls.add_policy(
				        object_schema   => 'CSR',
				        object_name     => v_list(i),
				        policy_name     => v_name,
				        function_schema => 'CSR',
				        policy_function => 'utilityContractCheck',
				        statement_types => 'select, insert, update, delete',
				        update_check	=> true,
				        policy_type     => dbms_rls.context_sensitive );
				  	exit;
				exception
					when policy_already_exists then
						v_i := v_i + 1;
				end;
			end loop;
		end;
	end loop;
end;
/


@update_tail