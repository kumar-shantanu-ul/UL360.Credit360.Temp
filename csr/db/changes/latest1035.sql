-- Please update version.sql too -- this keeps clean builds in sync
define version=1035
@update_header

-- or do we recreate the whole TT?
alter table CSRIMP.ROLE add (
	LOOKUP_KEY			   VARCHAR2(255)	
);


CREATE GLOBAL TEMPORARY TABLE CSRIMP.IND_VALIDATION_RULE(
    IND_VALIDATION_RULE_ID    NUMBER(10, 0)     NOT NULL,
    IND_SID                   NUMBER(10, 0)     NOT NULL,
    EXPR                      VARCHAR2(2000)    NOT NULL,
    MESSAGE                   VARCHAR2(2000)    NOT NULL,
    POSITION                  NUMBER(10, 0)     NOT NULL,
    TYPE                      VARCHAR2(1)       DEFAULT 'E' NOT NULL,
    CONSTRAINT CHK_IND_VALID_RULE_TYPE CHECK (TYPE IN ('E','W','X')),
    CONSTRAINT PK_IND_VALIDATION_RULE PRIMARY KEY (IND_VALIDATION_RULE_ID)
) ON COMMIT DELETE ROWS;


CREATE GLOBAL TEMPORARY TABLE CSRIMP.ROLE_GRANT(
    ROLE_SID          NUMBER(10, 0)    NOT NULL,
    GRANT_ROLE_SID    NUMBER(10, 0)    NOT NULL,
    CONSTRAINT PK_ROLE_GRANT PRIMARY KEY (ROLE_SID, GRANT_ROLE_SID)
) ON COMMIT DELETE ROWS;


/*****************************************/
/******** OTHER DELEGATION STUFF *********/
/*****************************************/
CREATE GLOBAL TEMPORARY TABLE CSRIMP.DELEGATION_GRID(
    IND_SID            NUMBER(10, 0)    NOT NULL,
    NAME               VARCHAR2(255)    NOT NULL,
    PATH               VARCHAR2(255)    NOT NULL,
    HELPER_PKG         VARCHAR2(255),
    AGGREGATION_XML    SYS.XMLType,
    CONSTRAINT PK_DELEGATION_GRID PRIMARY KEY (IND_SID)
) ON COMMIT DELETE ROWS;


CREATE GLOBAL TEMPORARY TABLE CSRIMP.DELEGATION_ROLE(
    DELEGATION_SID    NUMBER(10, 0)    NOT NULL,
    ROLE_SID          NUMBER(10, 0)    NOT NULL,
    IS_READ_ONLY      NUMBER(1, 0)     DEFAULT 0 NOT NULL,
    CONSTRAINT PK_DELEGATION_ROLE PRIMARY KEY (DELEGATION_SID, ROLE_SID)
) ON COMMIT DELETE ROWS;


CREATE GLOBAL TEMPORARY TABLE CSRIMP.DELEGATION_IND_COND(
    DELEGATION_SID            NUMBER(10, 0)    NOT NULL,
    IND_SID                   NUMBER(10, 0)    NOT NULL,
    DELEGATION_IND_COND_ID    NUMBER(10, 0)    NOT NULL,
    EXPR                      VARCHAR2(255)    NOT NULL,
    CONSTRAINT PK697 PRIMARY KEY (DELEGATION_SID, IND_SID, DELEGATION_IND_COND_ID)
) ON COMMIT DELETE ROWS;


CREATE GLOBAL TEMPORARY TABLE CSRIMP.DELEGATION_IND_COND_ACTION(
    DELEGATION_SID            NUMBER(10, 0)    NOT NULL,
    IND_SID                   NUMBER(10, 0)    NOT NULL,
    DELEGATION_IND_COND_ID    NUMBER(10, 0)    NOT NULL,
    ACTION                    VARCHAR2(255)    NOT NULL,
    TAG                       VARCHAR2(255)    NOT NULL
) ON COMMIT DELETE ROWS;


CREATE GLOBAL TEMPORARY TABLE CSRIMP.DELEGATION_IND_TAG(
    DELEGATION_SID    NUMBER(10, 0)    NOT NULL,
    IND_SID           NUMBER(10, 0)    NOT NULL,
    TAG               VARCHAR2(255)    NOT NULL,
    CONSTRAINT PK702 PRIMARY KEY (DELEGATION_SID, IND_SID, TAG)
) ON COMMIT DELETE ROWS;


CREATE GLOBAL TEMPORARY TABLE CSRIMP.DELEGATION_IND_TAG_LIST(
    DELEGATION_SID    NUMBER(10, 0)    NOT NULL,
    TAG               VARCHAR2(255)    NOT NULL,
    CONSTRAINT PK_DELEGATION_IND_TAG_LIST PRIMARY KEY (DELEGATION_SID, TAG)
) ON COMMIT DELETE ROWS;



/*****************************************/
/************** DELEG PLANS **************/
/*****************************************/
CREATE GLOBAL TEMPORARY TABLE CSRIMP.DELEG_PLAN(
    DELEG_PLAN_SID     NUMBER(10, 0)     NOT NULL,
    NAME               VARCHAR2(1023)    NOT NULL,
    START_DTM          DATE              NOT NULL,
    END_DTM            DATE              NOT NULL,
    INTERVAL           VARCHAR2(10)      NOT NULL,
    REMINDER_OFFSET    NUMBER(10, 0)     DEFAULT 5 NOT NULL,
    SCHEDULE_XML       CLOB              NOT NULL,
    NAME_TEMPLATE      VARCHAR2(1000),
    ACTIVE             NUMBER(1, 0)      DEFAULT 1 NOT NULL,
    NOTES              CLOB,
    DYNAMIC            NUMBER(1, 0)      DEFAULT 0 NOT NULL,
    CONSTRAINT CK_DELEG_TPL_DATES CHECK (START_DTM = TRUNC(START_DTM, 'MON') AND END_DTM = TRUNC(END_DTM, 'MON') AND END_DTM > START_DTM),
    CONSTRAINT CHK_DELEG_PLAN_ACTIVE CHECK (ACTIVE IN (0,1)),
    CONSTRAINT CK_DYNAMIC CHECK (dynamic in (0,1)),
    CONSTRAINT PK890 PRIMARY KEY (DELEG_PLAN_SID)
) ON COMMIT DELETE ROWS;


CREATE GLOBAL TEMPORARY TABLE CSRIMP.DELEG_PLAN_APPLIED(
    DELEG_PLAN_APPLIED_ID    NUMBER(10, 0)    NOT NULL,
    DELEG_PLAN_SID           NUMBER(10, 0)    NOT NULL,
    APPLIED_BY_USER_SID      NUMBER(10, 0)    NOT NULL,
    APPLIED_DTM              DATE             DEFAULT SYSDATE NOT NULL,
    CONSTRAINT PK_DELEG_PLAN_LOG PRIMARY KEY (DELEG_PLAN_APPLIED_ID)
) ON COMMIT DELETE ROWS;



CREATE GLOBAL TEMPORARY TABLE CSRIMP.DELEG_PLAN_COL(
    DELEG_PLAN_COL_ID           NUMBER(10, 0)    NOT NULL,
    DELEG_PLAN_SID              NUMBER(10, 0)    NOT NULL,
    IS_HIDDEN                   NUMBER(1, 0)     DEFAULT 0 NOT NULL,
    DELEG_PLAN_COL_DELEG_ID     NUMBER(10, 0),
    DELEG_PLAN_COL_SURVEY_ID    NUMBER(10, 0),
    CONSTRAINT CHK_DELEG_PLAN_ENTITY_HIDDEN CHECK (IS_HIDDEN IN (0,1)),
    CONSTRAINT PK_DELEG_PLAN_COL PRIMARY KEY (DELEG_PLAN_COL_ID)
) ON COMMIT DELETE ROWS;


CREATE GLOBAL TEMPORARY TABLE CSRIMP.DELEG_PLAN_COL_DELEG(
    DELEG_PLAN_COL_DELEG_ID    NUMBER(10, 0)    NOT NULL,
    DELEGATION_SID             NUMBER(10, 0)    NOT NULL,
    CONSTRAINT PK_DELEG_PLAN_COL_DELEG PRIMARY KEY (DELEG_PLAN_COL_DELEG_ID)
) ON COMMIT DELETE ROWS;


CREATE GLOBAL TEMPORARY TABLE CSRIMP.DELEG_PLAN_COL_SURVEY(
    DELEG_PLAN_COL_SURVEY_ID    NUMBER(10, 0)    NOT NULL,
    SURVEY_SID                  NUMBER(10, 0)    NOT NULL,
    CONSTRAINT PK_DELEG_PLAN_COL_SURVEY PRIMARY KEY (DELEG_PLAN_COL_SURVEY_ID, SURVEY_SID),
    CONSTRAINT UK_DELEG_PLAN_COL_SURVEY  UNIQUE (DELEG_PLAN_COL_SURVEY_ID)
) ON COMMIT DELETE ROWS;

CREATE GLOBAL TEMPORARY TABLE CSRIMP.DELEG_PLAN_DELEG_REGION(
    DELEG_PLAN_COL_DELEG_ID    NUMBER(10, 0)    NOT NULL,
    REGION_SID                 NUMBER(10, 0)    NOT NULL,
    MAPS_TO_ROOT_DELEG_SID     NUMBER(10, 0),
    PENDING_DELETION           NUMBER(1, 0)     DEFAULT 0 NOT NULL,
    REGION_SELECTION           VARCHAR2(2)      DEFAULT 'R' NOT NULL,
    REGION_COLLATION           VARCHAR2(1)      DEFAULT 'S' NOT NULL,
    TAG_ID                     NUMBER(10, 0),
    CONSTRAINT CHK_DELEG_PLAN_DR_PENDING_DEL CHECK (PENDING_DELETION IN (0,1,2)),
    CONSTRAINT CHK_DLG_PLN_DLG_RGN_RS CHECK (REGION_SELECTION IN ('R','L','P','RT','LT','PT')),
    CONSTRAINT CHK_DLG_PLN_DLG_RGN_RC CHECK (REGION_COLLATION IN ('S','M')),
    CONSTRAINT PK_DELEG_PLAN_DELEG_REGION PRIMARY KEY (DELEG_PLAN_COL_DELEG_ID, REGION_SID)
) ON COMMIT DELETE ROWS;


CREATE GLOBAL TEMPORARY TABLE CSRIMP.DELEG_PLAN_DELEG_REGION_DELEG(
    DELEG_PLAN_COL_DELEG_ID    NUMBER(10, 0)    NOT NULL,
    REGION_SID                 NUMBER(10, 0)    NOT NULL,
    APPLIED_TO_REGION_SID      NUMBER(10, 0)    NOT NULL,
    HAS_MANUAL_AMENDS          NUMBER(1, 0)     DEFAULT 0 NOT NULL,
    MAPS_TO_ROOT_DELEG_SID     NUMBER(10, 0)    NOT NULL,
    CONSTRAINT CK_DELGPLNDLGREGDELG_MAN_AMND CHECK (HAS_MANUAL_AMENDS IN (0,1)),
    CONSTRAINT PK_DLG_PLAN_DLG_REG_DLG PRIMARY KEY (DELEG_PLAN_COL_DELEG_ID, REGION_SID, APPLIED_TO_REGION_SID)
) ON COMMIT DELETE ROWS;


CREATE GLOBAL TEMPORARY TABLE CSRIMP.DELEG_PLAN_REGION(
    DELEG_PLAN_SID    NUMBER(10, 0)    NOT NULL,
    REGION_SID        NUMBER(10, 0)    NOT NULL,
    CONSTRAINT PK894 PRIMARY KEY (DELEG_PLAN_SID, REGION_SID)
) ON COMMIT DELETE ROWS;

CREATE GLOBAL TEMPORARY TABLE CSRIMP.DELEG_PLAN_ROLE(
    DELEG_PLAN_SID    NUMBER(10, 0)    NOT NULL,
    ROLE_SID          NUMBER(10, 0)    NOT NULL,
    POS               NUMBER(10, 0)    NOT NULL,
    CONSTRAINT PK891 PRIMARY KEY (DELEG_PLAN_SID, ROLE_SID)
) ON COMMIT DELETE ROWS;



/************************************/
/************ IMG CHARTS ************/
/************************************/
CREATE GLOBAL TEMPORARY TABLE CSRIMP.IMG_CHART(
    IMG_CHART_SID        NUMBER(10, 0)     NOT NULL,
    LABEL                VARCHAR2(1023)    NOT NULL,
    MIME_TYPE            VARCHAR2(255)     NOT NULL,
    DATA                 BLOB              NOT NULL,
    SHA1                 RAW(20)           NOT NULL,
    LAST_MODIFIED_DTM    DATE              DEFAULT SYSDATE NOT NULL,
    CONSTRAINT PK_IMG_CHART PRIMARY KEY (IMG_CHART_SID)
) ON COMMIT DELETE ROWS;


CREATE GLOBAL TEMPORARY TABLE CSRIMP.IMG_CHART_IND(
    IMG_CHART_SID            NUMBER(10, 0)     NOT NULL,
    IND_SID                  NUMBER(10, 0)     NOT NULL,
    DESCRIPTION              VARCHAR2(1023),
    MEASURE_CONVERSION_ID    NUMBER(10, 0),
    X                        NUMBER(10, 0)     NOT NULL,
    Y                        NUMBER(10, 0)     NOT NULL,
    BACKGROUND_COLOR         NUMBER(10, 0)     NOT NULL,
    BORDER_COLOR             NUMBER(10, 0)     NOT NULL,
    CONSTRAINT PK_IMG_CHART_IND PRIMARY KEY (IMG_CHART_SID, IND_SID)
) ON COMMIT DELETE ROWS;



/****************************************/
/************ MAPPING TABLES ************/
/****************************************/
-- ROLE
CREATE GLOBAL TEMPORARY TABLE CSRIMP.MAP_ROLE(
	OLD_ROLE_SID					NUMBER(10)	NOT NULL,
	NEW_ROLE_SID					NUMBER(10)	NOT NULL,
	CONSTRAINT PK_MAP_ROLE PRIMARY KEY (OLD_ROLE_SID) USING INDEX,
	CONSTRAINT UK_MAP_ROLE UNIQUE (NEW_ROLE_SID) USING INDEX
) ON COMMIT DELETE ROWS;

-- IND VALIDATION RULES
CREATE GLOBAL TEMPORARY TABLE CSRIMP.MAP_IND_VALIDATION_RULE(
	OLD_IND_VALIDATION_RULE_ID					NUMBER(10)	NOT NULL,
	NEW_IND_VALIDATION_RULE_ID					NUMBER(10)	NOT NULL,
	CONSTRAINT PK_MAP_IND_VALIDATION_RULE PRIMARY KEY (OLD_IND_VALIDATION_RULE_ID) USING INDEX,
	CONSTRAINT UK_MAP_IND_VALIDATION_RULE UNIQUE (NEW_IND_VALIDATION_RULE_ID) USING INDEX
) ON COMMIT DELETE ROWS;


-- DELEGATION CONDITIONMAPS
CREATE GLOBAL TEMPORARY TABLE CSRIMP.MAP_DELEGATION_IND_COND(
	OLD_DELEGATION_IND_COND_ID					NUMBER(10)	NOT NULL,
	NEW_DELEGATION_IND_COND_ID					NUMBER(10)	NOT NULL,
	CONSTRAINT PK_MAP_DELEGATION_IND_COND PRIMARY KEY (OLD_DELEGATION_IND_COND_ID) USING INDEX,
	CONSTRAINT UK_MAP_DELEGATION_IND_COND UNIQUE (NEW_DELEGATION_IND_COND_ID) USING INDEX
) ON COMMIT DELETE ROWS;

-- PLAN MAPS
CREATE GLOBAL TEMPORARY TABLE CSRIMP.MAP_DELEG_PLAN(
	OLD_DELEG_PLAN_SID					NUMBER(10)	NOT NULL,
	NEW_DELEG_PLAN_SID					NUMBER(10)	NOT NULL,
	CONSTRAINT PK_MAP_DELEG_PLAN PRIMARY KEY (OLD_DELEG_PLAN_SID) USING INDEX,
	CONSTRAINT UK_MAP_DELEG_PLAN UNIQUE (NEW_DELEG_PLAN_SID) USING INDEX
) ON COMMIT DELETE ROWS;

CREATE GLOBAL TEMPORARY TABLE CSRIMP.MAP_DELEG_PLAN_COL(
	OLD_DELEG_PLAN_COL_ID					NUMBER(10)	NOT NULL,
	NEW_DELEG_PLAN_COL_ID					NUMBER(10)	NOT NULL,
	CONSTRAINT PK_MAP_DELEG_PLAN_COL PRIMARY KEY (OLD_DELEG_PLAN_COL_ID) USING INDEX,
	CONSTRAINT UK_MAP_DELEG_PLAN_COL UNIQUE (NEW_DELEG_PLAN_COL_ID) USING INDEX
) ON COMMIT DELETE ROWS;

CREATE GLOBAL TEMPORARY TABLE CSRIMP.MAP_DELEG_PLAN_COL_DELEG(
	OLD_DELEG_PLAN_COL_DELEG_ID					NUMBER(10)	NOT NULL,
	NEW_DELEG_PLAN_COL_DELEG_ID					NUMBER(10)	NOT NULL,
	CONSTRAINT PK_MAP_DLG_PLAN_COL_DLG PRIMARY KEY (OLD_DELEG_PLAN_COL_DELEG_ID) USING INDEX,
	CONSTRAINT UK_MAP_DLG_PLAN_COL_DLG UNIQUE (NEW_DELEG_PLAN_COL_DELEG_ID) USING INDEX
) ON COMMIT DELETE ROWS;

-- IMG CHART MAP
CREATE GLOBAL TEMPORARY TABLE CSRIMP.MAP_IMG_CHART(
	OLD_IMG_CHART_SID					NUMBER(10)	NOT NULL,
	NEW_IMG_CHART_SID					NUMBER(10)	NOT NULL,
	CONSTRAINT PK_MAP_IMG_CHART PRIMARY KEY (OLD_IMG_CHART_SID) USING INDEX,
	CONSTRAINT UK_MAP_IMG_CHART UNIQUE (NEW_IMG_CHART_SID) USING INDEX
) ON COMMIT DELETE ROWS;

-- object grants
grant insert,select,update on csr.role to csrimp;
grant insert,select on csr.region_role_member to csrimp;
grant insert,select,update on csr.ind_validation_rule to csrimp;
grant select on csr.ind_validation_rule_id_seq to csrimp;
grant insert,select,delete on csr.role_grant to csrimp;
grant select on csr.delegation_ind_cond_id_seq to csrimp;
grant insert,select on csr.delegation_ind_cond to csrimp;
grant insert,select on csr.delegation_ind_cond_action to csrimp;
grant insert,select on csr.delegation_ind_tag to csrimp;
grant insert,select on csr.delegation_ind_tag_list to csrimp;
grant insert,select on csr.delegation_role to csrimp;
grant select,insert,update on csr.delegation_grid to csrimp;
grant insert,select on csr.master_deleg to csrimp;
grant update,select on csr.deleg_plan to csrimp;
grant insert,delete,select on csr.deleg_plan_applied to csrimp;
grant insert,delete,select on csr.deleg_plan_col to csrimp;
grant insert,delete,select on csr.deleg_plan_col_deleg to csrimp;
grant insert,delete,select on csr.deleg_plan_col_survey to csrimp;
grant insert,delete,select on csr.deleg_plan_deleg_region to csrimp;
grant insert,delete,select on csr.deleg_plan_deleg_region_deleg to csrimp;
grant insert,delete,select on csr.deleg_plan_region to csrimp;
grant insert,delete,select on csr.deleg_plan_role to csrimp;
grant insert,delete,select on csr.img_chart_ind to csrimp;
grant execute on csr.delegation_pkg to csrimp;
grant execute on csr.deleg_plan_pkg to csrimp;
grant execute on csr.img_chart_pkg to csrimp;
grant execute on csr.role_pkg to csrimp;
grant execute on aspen2.filecache_pkg to csrimp;
grant update on csr.region to csrimp;
grant select on csr.deleg_plan_col_id_seq to csrimp;
grant select on csr.deleg_plan_col_deleg_id_seq to csrimp;

-- misc bits
GRANT INSERT,SELECT,UPDATE,DELETE ON CSRIMP.IND_VALIDATION_RULE TO WEB_USER;
GRANT INSERT,SELECT,UPDATE,DELETE ON CSRIMP.ROLE_GRANT TO WEB_USER;

-- extended deleg stuff
GRANT INSERT,SELECT,UPDATE,DELETE ON CSRIMP.ROLE TO WEB_USER;
GRANT INSERT,SELECT,UPDATE,DELETE ON CSRIMP.ROLE_GRANT TO WEB_USER;
GRANT INSERT,SELECT,UPDATE,DELETE ON CSRIMP.DELEGATION_GRID TO WEB_USER;
GRANT INSERT,SELECT,UPDATE,DELETE ON CSRIMP.DELEGATION_IND_COND TO WEB_USER;
GRANT INSERT,SELECT,UPDATE,DELETE ON CSRIMP.DELEGATION_IND_COND_ACTION TO WEB_USER;
GRANT INSERT,SELECT,UPDATE,DELETE ON CSRIMP.DELEGATION_IND_TAG TO WEB_USER;
GRANT INSERT,SELECT,UPDATE,DELETE ON CSRIMP.DELEGATION_IND_TAG_LIST TO WEB_USER;
GRANT INSERT,SELECT,UPDATE,DELETE ON CSRIMP.DELEGATION_ROLE TO WEB_USER;

-- plans
GRANT INSERT,SELECT,UPDATE,DELETE ON CSRIMP.DELEG_PLAN TO WEB_USER;
GRANT INSERT,SELECT,UPDATE,DELETE ON CSRIMP.DELEG_PLAN_APPLIED TO WEB_USER;
GRANT INSERT,SELECT,UPDATE,DELETE ON CSRIMP.DELEG_PLAN_COL TO WEB_USER;
GRANT INSERT,SELECT,UPDATE,DELETE ON CSRIMP.DELEG_PLAN_COL_DELEG TO WEB_USER;
GRANT INSERT,SELECT,UPDATE,DELETE ON CSRIMP.DELEG_PLAN_COL_SURVEY TO WEB_USER;
GRANT INSERT,SELECT,UPDATE,DELETE ON CSRIMP.DELEG_PLAN_DELEG_REGION TO WEB_USER;
GRANT INSERT,SELECT,UPDATE,DELETE ON CSRIMP.DELEG_PLAN_REGION TO WEB_USER;
GRANT INSERT,SELECT,UPDATE,DELETE ON CSRIMP.DELEG_PLAN_ROLE TO WEB_USER;

-- img chart
GRANT INSERT,SELECT,UPDATE,DELETE ON CSRIMP.IMG_CHART TO WEB_USER;
GRANT INSERT,SELECT,UPDATE,DELETE ON CSRIMP.IMG_CHART_IND TO WEB_USER;

@..\csr_app_body

@..\csrimp\imp_pkg
@..\schema_pkg

@..\csrimp\imp_body
@..\schema_body

@update_tail
