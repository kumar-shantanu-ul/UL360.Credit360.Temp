-- Please update version.sql too -- this keeps clean builds in sync
define version=1074
@update_header

--
-- ADD EXTRA COLUMNS
--
ALTER TABLE DONATIONS.CUSTOMER_OPTIONS ADD FC_TAG_ID NUMBER(10, 0);
ALTER TABLE DONATIONS.CUSTOMER_OPTIONS ADD FC_AMOUNT_FIELD_LOOKUP_KEY VARCHAR2(255);
ALTER TABLE DONATIONS.SCHEME ADD TRACK_CHARITY_BUDGET    NUMBER(1, 0)      DEFAULT 0 NOT NULL;


-- 
-- TABLE: DONATIONS.FC_BUDGET 
--

CREATE TABLE DONATIONS.FC_BUDGET(
    APP_SID                   NUMBER(10, 0)     DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    BUDGET_ID                 NUMBER(10, 0)     NOT NULL,
    FUNDING_COMMITMENT_SID    NUMBER(10, 0)     NOT NULL,
    AMOUNT                    NUMBER(24, 10),
    CONSTRAINT PK129 PRIMARY KEY (APP_SID, BUDGET_ID, FUNDING_COMMITMENT_SID)
)
;

-- 
-- TABLE: DONATIONS.FC_DONATION 
--

CREATE TABLE DONATIONS.FC_DONATION(
    APP_SID                   NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    FUNDING_COMMITMENT_SID    NUMBER(10, 0)    NOT NULL,
    DONATION_ID               NUMBER(10, 0)    NOT NULL,
    CONSTRAINT PK139 PRIMARY KEY (APP_SID, FUNDING_COMMITMENT_SID, DONATION_ID)
)
;



-- 
-- TABLE: DONATIONS.FC_TAG 
--

CREATE TABLE DONATIONS.FC_TAG(
    TAG_ID                    NUMBER(10, 0)    NOT NULL,
    APP_SID                   NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    FUNDING_COMMITMENT_SID    NUMBER(10, 0)    NOT NULL,
    CONSTRAINT PK137 PRIMARY KEY (TAG_ID, APP_SID, FUNDING_COMMITMENT_SID)
)
;



-- 
-- TABLE: DONATIONS.FC_UPLOAD 
--

CREATE TABLE DONATIONS.FC_UPLOAD(
    APP_SID                   NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    FC_UPLOAD_SID             NUMBER(10, 0)    NOT NULL,
    FUNDING_COMMITMENT_SID    NUMBER(10, 0)    NOT NULL,
    CONSTRAINT PK124 PRIMARY KEY (APP_SID, FC_UPLOAD_SID, FUNDING_COMMITMENT_SID)
)
;



-- 
-- 
-- TABLE: DONATIONS.FUNDING_COMMITMENT 
--

CREATE TABLE DONATIONS.FUNDING_COMMITMENT(
    APP_SID                   NUMBER(10, 0)     DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    FUNDING_COMMITMENT_SID    NUMBER(10, 0)     NOT NULL,
    SCHEME_SID                NUMBER(10, 0)     NOT NULL,
    RECIPIENT_SID             NUMBER(10, 0)     NOT NULL,
    REGION_GROUP_SID          NUMBER(10, 0)     NOT NULL,
    REGION_SID                NUMBER(10, 0)     NOT NULL,
    DONATION_STATUS_SID       NUMBER(10, 0)     NOT NULL,
    CSR_USER_SID              NUMBER(10, 0)     NOT NULL,
    CHARITY_BUDGET_TAG_ID     NUMBER(10, 0),
    NAME                      VARCHAR2(255)     NOT NULL,
    DESCRIPTION               VARCHAR2(1023),
    PAYMENT_DTM               DATE,
    REMINDER_DTM              DATE,
    NOTES                     CLOB,
    REVIEW_ON_EXPIRY          NUMBER(1, 0)      DEFAULT 0 NOT NULL,
    LAST_REVIEW_DTM           DATE,
    CONSTRAINT PK119 PRIMARY KEY (APP_SID, FUNDING_COMMITMENT_SID)
)
;


-- 
-- TABLE: DONATIONS.RECIPIENT_TAG_GROUP 
--

CREATE TABLE DONATIONS.RECIPIENT_TAG_GROUP(
    APP_SID          NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
    TAG_GROUP_SID    NUMBER(10, 0)    NOT NULL,
    POS              NUMBER(10, 0)    DEFAULT 0 NOT NULL,
    CONSTRAINT PK131 PRIMARY KEY (APP_SID, TAG_GROUP_SID)
)
;

ALTER TABLE DONATIONS.CUSTOMER_OPTIONS ADD CONSTRAINT FK_CUSTOPT_FCAM_CUST_FIELD
    FOREIGN KEY (APP_SID, FC_AMOUNT_FIELD_LOOKUP_KEY)
    REFERENCES DONATIONS.CUSTOM_FIELD(APP_SID, LOOKUP_KEY)
;

ALTER TABLE DONATIONS.CUSTOMER_OPTIONS ADD CONSTRAINT RefTAG241 
    FOREIGN KEY (APP_SID, FC_TAG_ID)
    REFERENCES DONATIONS.TAG(APP_SID, TAG_ID)
;

--
-- TABLE: DONATIONS.FC_BUDGET 
--

ALTER TABLE DONATIONS.FC_BUDGET ADD CONSTRAINT RefBUDGET218 
    FOREIGN KEY (APP_SID, BUDGET_ID)
    REFERENCES DONATIONS.BUDGET(APP_SID, BUDGET_ID)
;

ALTER TABLE DONATIONS.FC_BUDGET ADD CONSTRAINT RefFUNDING_COMMITMENT219 
    FOREIGN KEY (APP_SID, FUNDING_COMMITMENT_SID)
    REFERENCES DONATIONS.FUNDING_COMMITMENT(APP_SID, FUNDING_COMMITMENT_SID)
;


-- 
-- TABLE: DONATIONS.FC_DONATION 
--

ALTER TABLE DONATIONS.FC_DONATION ADD CONSTRAINT RefDONATION245 
    FOREIGN KEY (APP_SID, DONATION_ID)
    REFERENCES DONATIONS.DONATION(APP_SID, DONATION_ID)
;

ALTER TABLE DONATIONS.FC_DONATION ADD CONSTRAINT RefFUNDING_COMMITMENT246 
    FOREIGN KEY (APP_SID, FUNDING_COMMITMENT_SID)
    REFERENCES DONATIONS.FUNDING_COMMITMENT(APP_SID, FUNDING_COMMITMENT_SID)
;


-- 
-- TABLE: DONATIONS.FC_TAG 
--

ALTER TABLE DONATIONS.FC_TAG ADD CONSTRAINT RefTAG238 
    FOREIGN KEY (APP_SID, TAG_ID)
    REFERENCES DONATIONS.TAG(APP_SID, TAG_ID)
;

ALTER TABLE DONATIONS.FC_TAG ADD CONSTRAINT RefFUNDING_COMMITMENT239 
    FOREIGN KEY (APP_SID, FUNDING_COMMITMENT_SID)
    REFERENCES DONATIONS.FUNDING_COMMITMENT(APP_SID, FUNDING_COMMITMENT_SID)
;


-- 
-- TABLE: DONATIONS.FC_UPLOAD 
--

ALTER TABLE DONATIONS.FC_UPLOAD ADD CONSTRAINT RefFUNDING_COMMITMENT223 
    FOREIGN KEY (APP_SID, FUNDING_COMMITMENT_SID)
    REFERENCES DONATIONS.FUNDING_COMMITMENT(APP_SID, FUNDING_COMMITMENT_SID)
;


-- 
-- TABLE: DONATIONS.FUNDING_COMMITMENT 
--

ALTER TABLE DONATIONS.FUNDING_COMMITMENT ADD CONSTRAINT RefRECIPIENT199 
    FOREIGN KEY (APP_SID, RECIPIENT_SID)
    REFERENCES DONATIONS.RECIPIENT(APP_SID, RECIPIENT_SID)
;

ALTER TABLE DONATIONS.FUNDING_COMMITMENT ADD CONSTRAINT RefTAG200 
    FOREIGN KEY (APP_SID, CHARITY_BUDGET_TAG_ID)
    REFERENCES DONATIONS.TAG(APP_SID, TAG_ID)
;

ALTER TABLE DONATIONS.FUNDING_COMMITMENT ADD CONSTRAINT RefDONATION_STATUS221 
    FOREIGN KEY (APP_SID, DONATION_STATUS_SID)
    REFERENCES DONATIONS.DONATION_STATUS(APP_SID, DONATION_STATUS_SID)
;

ALTER TABLE DONATIONS.FUNDING_COMMITMENT ADD CONSTRAINT RefSCHEME225 
    FOREIGN KEY (APP_SID, SCHEME_SID)
    REFERENCES DONATIONS.SCHEME(APP_SID, SCHEME_SID)
;

ALTER TABLE DONATIONS.FUNDING_COMMITMENT ADD CONSTRAINT RefREGION_GROUP227 
    FOREIGN KEY (APP_SID, REGION_GROUP_SID)
    REFERENCES DONATIONS.REGION_GROUP(APP_SID, REGION_GROUP_SID)
;


-- seems it's there on live already
--ALTER TABLE DONATIONS.RECIPIENT_TAG ADD CONSTRAINT c 
--    FOREIGN KEY (APP_SID, RECIPIENT_SID)
--    REFERENCES DONATIONS.RECIPIENT(APP_SID, RECIPIENT_SID)
--;

-- 
-- TABLE: DONATIONS.RECIPIENT_TAG_GROUP 
--

ALTER TABLE DONATIONS.RECIPIENT_TAG_GROUP ADD CONSTRAINT RefTAG_GROUP235 
    FOREIGN KEY (APP_SID, TAG_GROUP_SID)
    REFERENCES DONATIONS.TAG_GROUP(APP_SID, TAG_GROUP_SID)
;


DECLARE
	v_act_id			security.security_pkg.T_ACT_ID;
	v_class_id			security.security_pkg.T_CLASS_ID;
	v_tg_class_id		security.security_pkg.T_CLASS_ID;
BEGIN
	security.user_pkg.LogonAuthenticated(security.security_pkg.SID_BUILTIN_ADMINISTRATOR, 600, v_act_id);	
	
	BEGIN
        	security.class_pkg.CreateClass(v_act_id, security.class_pkg.GetClassId('Container'), 'DonationsFundingCommitment', 'donations.funding_commitment_pkg', null, v_class_id);
    EXCEPTION
        WHEN security.security_pkg.DUPLICATE_OBJECT_NAME THEN
            NULL;
    END;

	BEGIN	
		-- get TagGroup class id
		v_tg_class_id := security.class_pkg.getClassID('DonationsTagGroup');
		security.class_pkg.AddPermission(v_act_id, v_tg_class_id , 16777216, 'Update tags on elements');
		security.class_pkg.CreateMapping(v_act_id, security.security_pkg.SO_CONTAINER, 
			security.security_pkg.PERMISSION_WRITE, v_tg_class_id, 16777216);
	EXCEPTION
		WHEN DUP_VAL_ON_INDEX THEN
			NULL;
	END;
	
	COMMIT;
END;
/


create or replace package DONATIONS.funding_commitment_pkg as
procedure dummy;
end;
/
create or replace package body DONATIONS.funding_commitment_pkg as
procedure dummy
as
begin
	null;
end;
end;
/

grant execute on donations.funding_commitment_pkg to security;
grant execute on donations.funding_commitment_pkg to web_user;

GRANT DELETE ON DONATIONS.FC_UPLOAD TO CSR;
GRANT DELETE ON DONATIONS.FC_BUDGET  TO CSR;
GRANT DELETE ON DONATIONS.FC_DONATION TO CSR;
GRANT DELETE ON DONATIONS.FUNDING_COMMITMENT  TO CSR;
GRANT DELETE ON DONATIONS.RECIPIENT_TAG TO CSR;
GRANT DELETE ON DONATIONS.RECIPIENT_TAG_GROUP TO CSR;
GRANT DELETE ON DONATIONS.FC_TAG TO CSR;

-- add created permission to update tags
BEGIN
	UPDATE security.acl
	   SET permission_set = security.bitwise_pkg.bitor(permission_set, 16777216)
	WHERE acl_id IN (
		select dacl_id FROM security.securable_object WHERE sid_id IN (
			SELECT tag_group_sid FROM donations.tag_group
		)
	); 
END;
/

@../donations/scheme_pkg
@../donations/donation_pkg
@../donations/donation_body
@../donations/scheme_body
@../donations/region_group_pkg
@../donations/region_group_body
@../donations/tag_pkg
@../donations/tag_body
@../donations/funding_commitment_pkg
@../donations/funding_commitment_body
@../donations/recipient_pkg
@../donations/recipient_body
@../donations/options_body

@update_tail
