-- Please update version.sql too -- this keeps clean builds in sync
define version=1181
@update_header 

-- Do this first as it might cause constraint violations
delete from csr.qs_campaign where survey_sid is null;
ALTER TABLE CSR.QS_CAMPAIGN MODIFY SURVEY_SID NOT NULL;

ALTER TABLE CSR.QS_CAMPAIGN DROP CONSTRAINT CHK_QS_CAMPAIGN_STATUS;

ALTER TABLE CSR.QS_CAMPAIGN ADD CONSTRAINT CHK_QS_CAMPAIGN_STATUS CHECK (STATUS IN ('draft', 'pending', 'sending', 'sent', 'error'));

ALTER TABLE CSR.DELEG_PLAN_SURVEY_REGION DROP CONSTRAINT FK_QSR_DLG_PLN_SRV_REG;

ALTER TABLE CSR.DELEG_PLAN_SURVEY_REGION DROP CONSTRAINT FK_DLG_PL_COL_SRV_DPSR;

ALTER TABLE CSR.DELEG_PLAN_COL DROP CONSTRAINT FK_DLG_PLN_COL_SRV_DPC;

ALTER TABLE CSR.DELEG_PLAN_COL_SURVEY DROP CONSTRAINT UK_DELEG_PLAN_COL_SURVEY;

ALTER TABLE CSR.DELEG_PLAN_COL_SURVEY DROP CONSTRAINT PK_DELEG_PLAN_COL_SURVEY;

ALTER TABLE CSR.DELEG_PLAN_COL_SURVEY ADD CONSTRAINT PK_DELEG_PLAN_COL_SURVEY PRIMARY KEY (APP_SID, DELEG_PLAN_COL_SURVEY_ID);

ALTER TABLE CSR.DELEG_PLAN_SURVEY_REGION ADD CONSTRAINT FK_DLG_PL_COL_SRV_DPSR 
    FOREIGN KEY (APP_SID, DELEG_PLAN_COL_SURVEY_ID)
    REFERENCES CSR.DELEG_PLAN_COL_SURVEY(APP_SID, DELEG_PLAN_COL_SURVEY_ID)
;

ALTER TABLE CSR.DELEG_PLAN_COL ADD CONSTRAINT FK_DLG_PLN_COL_SRV_DPC 
    FOREIGN KEY (APP_SID, DELEG_PLAN_COL_SURVEY_ID)
    REFERENCES CSR.DELEG_PLAN_COL_SURVEY(APP_SID, DELEG_PLAN_COL_SURVEY_ID) ON DELETE CASCADE
;

ALTER TABLE CSR.DELEG_PLAN_SURVEY_REGION DROP CONSTRAINT CHK_DLG_PLN_SRV_RGN_RS;

ALTER TABLE CSR.DELEG_PLAN_SURVEY_REGION ADD CONSTRAINT CHK_DLG_PLN_SRV_RGN_RS CHECK (REGION_SELECTION IN ('R','L','P','RT','LT','PT'));

ALTER TABLE CSR.DELEG_PLAN_SURVEY_REGION MODIFY REGION_SELECTION VARCHAR2(2);

ALTER TABLE CSR.DELEG_PLAN_SURVEY_REGION DROP CONSTRAINT PK_DELEG_PLAN_SURVEY_REGION;

ALTER TABLE CSR.DELEG_PLAN_SURVEY_REGION ADD CONSTRAINT PK_DELEG_PLAN_SURVEY_REGION PRIMARY KEY (APP_SID, DELEG_PLAN_COL_SURVEY_ID, REGION_SID);

ALTER TABLE CSR.DELEG_PLAN_SURVEY_REGION DROP COLUMN SURVEY_SID;

ALTER TABLE CSR.DELEG_PLAN_COL MODIFY DELEG_PLAN_SID NULL;

ALTER TABLE CSR.DELEG_PLAN_COL ADD (
	QS_CAMPAIGN_SID             NUMBER(10, 0),
	CONSTRAINT CHK_DELEG_PLAN_COL_HAS_PARENT CHECK ((QS_CAMPAIGN_SID IS NOT NULL AND DELEG_PLAN_SID IS NULL) OR
	(QS_CAMPAIGN_SID IS NULL AND DELEG_PLAN_SID IS NOT NULL))
);

ALTER TABLE CSR.DELEG_PLAN_SURVEY_REGION DROP COLUMN MAPS_TO_SURVEY_RESPONSE_ID;

ALTER TABLE CSR.DELEG_PLAN_SURVEY_REGION ADD TAG_ID NUMBER(10, 0);

ALTER TABLE CSR.QS_CAMPAIGN ADD (
    AUDIENCE_TYPE       CHAR(2)          DEFAULT 'LF' NOT NULL,
    FLOW_SID            NUMBER(10, 0),
    INC_REGIONS_WITH_NO_USERS    NUMBER(1, 0)     DEFAULT 0 NOT NULL,
	CONSTRAINT CHK_QS_CAMP_REG_NO_USR_0_1 CHECK (INC_REGIONS_WITH_NO_USERS IN (0, 1)),
	CONSTRAINT CHK_CAMPAIGN_AUD_TYPE CHECK (AUDIENCE_TYPE IN ('LF', 'WF')),
    CONSTRAINT CHK_AUDIENCE_REFERENCES CHECK ((AUDIENCE_TYPE='LF' AND FLOW_SID IS NULL) OR
	(AUDIENCE_TYPE='WF' AND TABLE_SID IS NULL AND FILTER_SID IS NULL))
);

CREATE INDEX CSR.IX_DELEG_PLAN_COL_CAMP_SID ON CSR.DELEG_PLAN_COL(APP_SID, QS_CAMPAIGN_SID)
;

CREATE INDEX CSR.IX_DELEG_PLAN_SRV_REG_TAG_ID ON CSR.DELEG_PLAN_SURVEY_REGION(APP_SID, TAG_ID)
;

CREATE INDEX CSR.IX_QS_CAMPAIGN_FLOW_SID ON CSR.QS_CAMPAIGN(APP_SID, FLOW_SID)
;

CREATE UNIQUE INDEX CSR.UK_DELEG_PLAN_COL_CAMP_SID ON CSR.DELEG_PLAN_COL(APP_SID, NVL(QS_CAMPAIGN_SID, DELEG_PLAN_COL_ID))
;

ALTER TABLE CSR.DELEG_PLAN_COL ADD CONSTRAINT FK_DELEG_PLAN_COL_CAMP_SID 
    FOREIGN KEY (APP_SID, QS_CAMPAIGN_SID)
    REFERENCES CSR.QS_CAMPAIGN(APP_SID, QS_CAMPAIGN_SID)
;

ALTER TABLE CSR.DELEG_PLAN_SURVEY_REGION ADD CONSTRAINT FK_DEL_PLAN_SURV_REG_TAG 
    FOREIGN KEY (APP_SID, TAG_ID)
    REFERENCES CSR.TAG(APP_SID, TAG_ID)
;

ALTER TABLE CSR.QS_CAMPAIGN ADD CONSTRAINT FK_QS_CAMPAIGN_FLOW_SID 
    FOREIGN KEY (APP_SID, FLOW_SID)
    REFERENCES CSR.FLOW(APP_SID, FLOW_SID)
;


CREATE OR REPLACE VIEW csr.V$DELEG_PLAN_SURVEY_REGION AS
	SELECT dpc.deleg_plan_sid, dpsr.deleg_plan_col_survey_id, dpc.deleg_plan_col_id, dpc.is_hidden, 
		dpcs.survey_sid, dpsr.region_sid, dpsr.has_manual_amends, dpsr.pending_deletion,
		dpsr.region_selection, dpsr.tag_id, dpc.qs_campaign_sid
	  FROM deleg_plan_survey_region dpsr
		JOIN deleg_plan_col_survey dpcs ON dpsr.deleg_plan_col_survey_id = dpcs.deleg_plan_col_survey_id
		JOIN deleg_plan_col dpc ON dpcs.deleg_plan_col_survey_id = dpc.deleg_plan_col_survey_id;

CREATE GLOBAL TEMPORARY TABLE CSR.temp_campaign_sid
(
	app_sid				NUMBER(10,0),
	qs_campaign_sid		NUMBER(10,0)
) ON COMMIT DELETE ROWS;

INSERT INTO CSR.PORTLET (PORTLET_ID, NAME, TYPE, SCRIPT_PATH) VALUES (csr.portlet_id_seq.nextval, 'My surveys', 'Credit360.Portlets.MySurveys', '/csr/site/portal/Portlets/MySurveys.js');

@..\quick_survey_pkg
@..\flow_pkg
@..\campaign_pkg

@..\quick_survey_body
@..\flow_body
@..\campaign_body

@update_tail
