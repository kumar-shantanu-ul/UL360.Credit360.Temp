-- Please update version.sql too -- this keeps clean builds in sync
define version=2830
define minor_version=0
@update_header

-- *** DDL ***
-- Create tables

-- Alter tables
-- Add missing csrimp stuff.
ALTER TABLE csrimp.issue_custom_field ADD (
  IS_MANDATORY	NUMBER(1) DEFAULT 0,
  POS			NUMBER(10) NULL
);

ALTER TABLE csrimp.issue_custom_field MODIFY (
	IS_MANDATORY NOT NULL
);

ALTER TABLE csrimp.issue_type ADD (
	ALERT_OVERDUE_DAYS				NUMBER(10),
	ALERT_PENDING_DUE_DAYS			NUMBER(10),
	AUTO_CLOSE_AFTER_RESOLVE_DAYS	NUMBER(10),
	CREATE_RAW						NUMBER(1) DEFAULT 0,
	DEFAULT_ASSIGN_TO_ROLE_SID		NUMBER(10),
	DEFAULT_ASSIGN_TO_USER_SID		NUMBER(10),
	DELETABLE_BY_RAISER				NUMBER(1) DEFAULT 0,
	DELETED							NUMBER(1) DEFAULT 0,
	OWNER_CAN_BE_CHANGED			NUMBER(1) DEFAULT 0,
	POSITION						NUMBER(10),
	PUBLIC_BY_DEFAULT				NUMBER(1) DEFAULT 0,
	REGION_LINK_TYPE				NUMBER(1) DEFAULT 1,
	REQUIRE_DUE_DTM_COMMENT			NUMBER(1) DEFAULT 0,
	SHOW_ONE_ISSUE_POPUP			NUMBER(1) DEFAULT 0
);

ALTER TABLE csrimp.issue_type MODIFY (
	CREATE_RAW 				NOT NULL,
	OWNER_CAN_BE_CHANGED	NOT NULL,
	PUBLIC_BY_DEFAULT		NOT NULL,
	REGION_LINK_TYPE		NOT NULL,
	REQUIRE_DUE_DTM_COMMENT	NOT NULL,
	SHOW_ONE_ISSUE_POPUP	NOT NULL
);

ALTER TABLE csrimp.issue_type ADD (
	CONSTRAINT CHK_CAN_SET_PUBLIC CHECK (CAN_SET_PUBLIC IN (0,1)),
	CONSTRAINT CHK_OWNER_CAN_BE_CHANGED CHECK (OWNER_CAN_BE_CHANGED IN (0,1)),
	CONSTRAINT CHK_DELETABLE_BY_RAISER CHECK (DELETABLE_BY_RAISER IN (0,1)),
	CONSTRAINT CHK_ISSUE_TYPE_DELETED CHECK (DELETED IN (0, 1)),
	CONSTRAINT CHK_ISS_TYPE_REQ_DDTM_CMT CHECK (REQUIRE_DUE_DTM_COMMENT IN (0,1)),
	CONSTRAINT CHK_IT_ACARD_VALID CHECK (AUTO_CLOSE_AFTER_RESOLVE_DAYS >= 1),
	CONSTRAINT CHK_IT_ALERT_OVERDUE_DAYS CHECK (ALERT_OVERDUE_DAYS >= 0),
	CONSTRAINT CHK_IT_ALERT_PENDING_DAYS CHECK (ALERT_PENDING_DUE_DAYS >= 1),
	CONSTRAINT CHK_IT_CREATE_RAW CHECK (CREATE_RAW IN (0, 1)),
	CONSTRAINT CHK_IT_RLT_NONE_OPT_MAND CHECK (REGION_LINK_TYPE IN (0, 1, 2)),
	CONSTRAINT CHK_IT_UNIQUE_ASSIGN CHECK (NOT (DEFAULT_ASSIGN_TO_USER_SID IS NOT NULL AND DEFAULT_ASSIGN_TO_ROLE_SID IS NOT NULL)),
	CONSTRAINT CHK_SHOW_ONE_ISSUE_POPUP CHECK (show_one_issue_popup IN (1, 0))
);

-- This was missing in create_schema + manual_schema_changes so add it again here for people who
-- have created databases since then.
DECLARE
	v_exists NUMBER;
BEGIN
	v_exists := 0;
	
	SELECT COUNT(*)
	  INTO v_exists
	  FROM dba_tab_columns
	 WHERE table_name = 'ISSUE_TYPE'
	   AND owner = 'CSR'
	   AND column_name = 'REGION_LINK_TYPE';
	
	IF v_exists = 0 THEN
		-- Add column + constraint.
		EXECUTE IMMEDIATE 'ALTER TABLE CSR.ISSUE_TYPE ADD (REGION_LINK_TYPE	NUMBER(1, 0) DEFAULT 1 NOT NULL, CONSTRAINT CHK_IT_RLT_NONE_OPT_MAND CHECK (REGION_LINK_TYPE IN (0, 1, 2)))';
	END IF;
	
	v_exists := 0;
	
	SELECT COUNT(*)
	  INTO v_exists
	  FROM dba_tab_columns
	 WHERE table_name = 'ISSUE_TYPE'
	   AND owner = 'CSR'
	   AND column_name = 'REQUIRE_DUE_DTM_COMMENT';
	
	IF v_exists = 0 THEN
		-- Add column + constraint.
		EXECUTE IMMEDIATE 'ALTER TABLE CSR.ISSUE_TYPE ADD (REQUIRE_DUE_DTM_COMMENT NUMBER(1) DEFAULT 0 NOT NULL, CONSTRAINT CHK_ISS_TYPE_REQ_DDTM_CMT CHECK (require_due_dtm_comment IN (0,1)))';
	END IF;
END;
/

-- This portlet was removed at some point but there is no latest script for it.
DELETE FROM csr.customer_portlet WHERE portlet_id = 142;
DELETE FROM csr.portlet where portlet_id = 142;

-- *** Data changes ***
-- RLS
-- Data

-- ** New package grants **

-- *** Packages ***
@../csr_app_body
@../schema_body
@../csrimp/imp_body
@../chain/chain_body

@update_tail
