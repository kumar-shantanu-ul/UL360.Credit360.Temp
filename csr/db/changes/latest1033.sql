-- Please update version.sql too -- this keeps clean builds in sync
define version=1033
@update_header


-- expressions shared across delegations
CREATE TABLE CSR.FORM_EXPR
(
    APP_SID                 NUMBER(10, 0) DEFAULT SYS_CONTEXT('SECURITY', 'APP') NOT NULL,
    FORM_EXPR_ID            NUMBER(10, 0) NOT NULL,
    DELEGATION_SID          NUMBER(10, 0) NOT NULL,
    DESCRIPTION             VARCHAR2(255 BYTE),
    EXPR                    SYS.XMLType NOT NULL,
    CONSTRAINT FORM_EXPR_PK PRIMARY KEY (APP_SID, FORM_EXPR_ID)
);

ALTER TABLE CSR.FORM_EXPR ADD CONSTRAINT FORM_EXPR_DELEG FOREIGN KEY (APP_SID, DELEGATION_SID) REFERENCES CSR.DELEGATION(APP_SID, DELEGATION_SID);


-- expression related to an indicator in a delegation
CREATE TABLE CSR.DELEG_IND_FORM_EXPR
(
    APP_SID                 NUMBER(10, 0) DEFAULT SYS_CONTEXT('SECURITY', 'APP') NOT NULL,
    DELEGATION_SID          NUMBER(10, 0) NOT NULL,
    IND_SID                 NUMBER(10, 0) NOT NULL,
    FORM_EXPR_ID            NUMBER(10, 0) NOT NULL,
    CONSTRAINT DELEG_IND_FORM_EXPR_PK PRIMARY KEY (APP_SID, DELEGATION_SID, IND_SID, FORM_EXPR_ID)
);



ALTER TABLE CSR.DELEG_IND_FORM_EXPR ADD CONSTRAINT DELEG_IND_FRM_EXP_DEL_IND FOREIGN KEY (APP_SID, DELEGATION_SID, IND_SID) REFERENCES CSR.DELEGATION_IND(APP_SID, DELEGATION_SID, IND_SID);
ALTER TABLE CSR.DELEG_IND_FORM_EXPR ADD CONSTRAINT DELEG_IND_FRM_EXP_FRM_EXP FOREIGN KEY (APP_SID, FORM_EXPR_ID) REFERENCES CSR.FORM_EXPR(APP_SID, FORM_EXPR_ID) ON DELETE CASCADE;


CREATE SEQUENCE CSR.FORM_EXPR_ID_SEQ
    START WITH 1
    INCREMENT BY 1
    NOMINVALUE
    NOMAXVALUE
    CACHE 20
    NOORDER
;


-- indicator groups shared across delegations
CREATE TABLE CSR.DELEG_IND_GROUP
(
    APP_SID                 NUMBER(10, 0) DEFAULT SYS_CONTEXT('SECURITY', 'APP') NOT NULL,
    DELEG_IND_GROUP_ID      NUMBER(10, 0) NOT NULL,
    DELEGATION_SID          NUMBER(10, 0) NOT NULL,
    TITLE                   VARCHAR2(255 BYTE),
    CONSTRAINT DELEG_IND_GROUP_PK PRIMARY KEY (APP_SID, DELEGATION_SID, DELEG_IND_GROUP_ID)
);

ALTER TABLE CSR.DELEG_IND_GROUP ADD CONSTRAINT DELEGINDGROUP_DELEG FOREIGN KEY (APP_SID, DELEGATION_SID) REFERENCES CSR.DELEGATION(APP_SID, DELEGATION_SID);

CREATE SEQUENCE CSR.DELEG_IND_GROUP_ID_SEQ
    START WITH 1
    INCREMENT BY 1
    NOMINVALUE
    NOMAXVALUE
    CACHE 20
    NOORDER
;

-- delegation->indicator->group
CREATE TABLE CSR.DELEG_IND_DELEG_IND_GROUP
(
    APP_SID                 NUMBER(10, 0) DEFAULT SYS_CONTEXT('SECURITY', 'APP') NOT NULL,
    DELEGATION_SID          NUMBER(10, 0) NOT NULL,
    IND_SID                 NUMBER(10, 0) NOT NULL,
    DELEG_IND_GROUP_ID      NUMBER(10, 0) NOT NULL,
    CONSTRAINT DEL_IND_DEL_IND_GROUP_PK PRIMARY KEY (APP_SID, DELEGATION_SID, IND_SID, DELEG_IND_GROUP_ID)
);

ALTER TABLE CSR.DELEG_IND_DELEG_IND_GROUP ADD CONSTRAINT DELINDGRPDELIND_DELIND FOREIGN KEY (APP_SID, DELEGATION_SID, IND_SID) REFERENCES CSR.DELEGATION_IND(APP_SID, DELEGATION_SID, IND_SID);
ALTER TABLE CSR.DELEG_IND_DELEG_IND_GROUP ADD CONSTRAINT DELINDGRPDELIND_DELINDGRP FOREIGN KEY (APP_SID, DELEGATION_SID, DELEG_IND_GROUP_ID) REFERENCES CSR.DELEG_IND_GROUP(APP_SID, DELEGATION_SID, DELEG_IND_GROUP_ID);



@update_tail