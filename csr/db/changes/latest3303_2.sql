-- Please update version.sql too -- this keeps clean builds in sync
define version=3303
define minor_version=2
@update_header

-- *** DDL ***
-- Create tables
CREATE TABLE CSR.DATA_BUCKET(
	APP_SID					NUMBER(10, 0)		DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
	DATA_BUCKET_SID			NUMBER(10, 0)		NOT NULL,
	DESCRIPTION				VARCHAR2(1024)		NOT NULL,
	ENABLED					NUMBER(1, 0)		DEFAULT 1 NOT NULL,
	ACTIVE_INSTANCE_ID		NUMBER(10, 0),
	CONSTRAINT CK_DATA_BUCKET_ENABLED CHECK (ENABLED IN (0,1)),
	CONSTRAINT PK_DATA_BUCKET PRIMARY KEY (APP_SID, DATA_BUCKET_SID)
);

CREATE TABLE CSR.DATA_BUCKET_INSTANCE(
	APP_SID						NUMBER(10, 0)		DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
	DATA_BUCKET_SID				NUMBER(10, 0)		NOT NULL,
	DATA_BUCKET_INSTANCE_ID		NUMBER(10, 0)		NOT NULL,
	COMPLETED_DTM				DATE,
	JOB_ID						NUMBER(10, 0),
	FETCH_TIME					NUMBER(10, 2),
	WRITE_TIME					NUMBER(10, 2),
	CONSTRAINT PK_DATA_BUCKET_INSTANCE PRIMARY KEY (APP_SID, DATA_BUCKET_SID, DATA_BUCKET_INSTANCE_ID)
);

CREATE SEQUENCE CSR.DATA_BUCKET_INSTANCE_ID_SEQ CACHE 5;

CREATE TABLE CSR.DATA_BUCKET_VAL(
	APP_SID						NUMBER(10, 0)		DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
	DATA_BUCKET_SID				NUMBER(10, 0)		NOT NULL,
	DATA_BUCKET_INSTANCE_ID		NUMBER(10, 0)		NOT NULL,
	DATA_BUCKET_VAL_ID			NUMBER(10, 0)		NOT NULL,
	IND_SID						NUMBER(10, 0)		NOT NULL,
	REGION_SID					NUMBER(10, 0)		NOT NULL,
	PERIOD_START_DTM			DATE				NOT NULL,
	PERIOD_END_DTM				DATE				NOT NULL,
	SOURCE_TYPE_ID				NUMBER(10, 0)		NOT NULL,
	VAL_NUMBER					NUMBER(24, 10)		NOT NULL,
	VAL_KEY						VARCHAR2(1024),
	CONSTRAINT PK_DATA_BUCKET_VAL PRIMARY KEY (APP_SID, DATA_BUCKET_VAL_ID)
);

CREATE SEQUENCE CSR.DATA_BUCKET_VAL_ID_SEQ CACHE 5;

CREATE TABLE CSR.DATA_BUCKET_SOURCE_DETAIL(
	APP_SID							NUMBER(10, 0)		DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
	DATA_BUCKET_SID					NUMBER(10, 0)		NOT NULL,
	DATA_BUCKET_INSTANCE_ID			NUMBER(10, 0)		NOT NULL,
	DATA_BUCKET_SOURCE_DETAIL_ID	NUMBER(10, 0)		NOT NULL,
	ID								VARCHAR2(1024)		NOT NULL,
	DETAIL_ONE						VARCHAR2(1024),
	DETAIL_TWO						VARCHAR2(1024),
	VAL_KEY							VARCHAR2(1024)		NOT NULL,
	CONSTRAINT PK_DATA_BUCKET_SOURCE_DETAIL PRIMARY KEY (APP_SID, DATA_BUCKET_SOURCE_DETAIL_ID)
);

CREATE SEQUENCE CSR.DATA_BUCKET_SOURCE_DETAIL_ID_SEQ CACHE 5;

CREATE TABLE CSR.BATCH_JOB_DATA_BUCKET_AGG_IND(
	APP_SID					NUMBER(10, 0)		DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
	BATCH_JOB_ID			NUMBER(10, 0)		NOT NULL,
	DATA_BUCKET_SID			NUMBER(10, 0)		NOT NULL,
	AGGREGATE_IND_GROUP_ID	NUMBER(10, 0)		NOT NULL,
	CONSTRAINT PK_DATA_BUCKET_BATCH_JOB PRIMARY KEY (APP_SID, BATCH_JOB_ID)
);

CREATE TABLE CSR.AGG_IND_DATA_BUCKET_PENDING_JOB(
	APP_SID					NUMBER(10, 0)		DEFAULT SYS_CONTEXT('SECURITY','APP') NOT NULL,
	BATCH_JOB_ID			NUMBER(10, 0)		NOT NULL,
	DATA_BUCKET_SID			NUMBER(10, 0)		NOT NULL,
	CONSTRAINT PK_AGG_IND_DATA_BUCKET_PENDING_JOB PRIMARY KEY (APP_SID, DATA_BUCKET_SID)
);

-- Alter tables
ALTER TABLE CSR.DATA_BUCKET ADD CONSTRAINT FK_DATA_BUCKET_ACTIVE_INSTANCE
	FOREIGN KEY (APP_SID, DATA_BUCKET_SID, ACTIVE_INSTANCE_ID)
	REFERENCES CSR.DATA_BUCKET_INSTANCE(APP_SID, DATA_BUCKET_SID, DATA_BUCKET_INSTANCE_ID);

ALTER TABLE CSR.DATA_BUCKET_INSTANCE ADD CONSTRAINT FK_DATA_BUCKET_INSTANCE_BUCKET
	FOREIGN KEY (APP_SID, DATA_BUCKET_SID)
	REFERENCES CSR.DATA_BUCKET(APP_SID, DATA_BUCKET_SID);

ALTER TABLE CSR.DATA_BUCKET_VAL ADD CONSTRAINT FK_DATA_BUCKET_VAL_INSTANCE
	FOREIGN KEY (APP_SID, DATA_BUCKET_SID, DATA_BUCKET_INSTANCE_ID)
	REFERENCES CSR.DATA_BUCKET_INSTANCE(APP_SID, DATA_BUCKET_SID, DATA_BUCKET_INSTANCE_ID);

ALTER TABLE CSR.DATA_BUCKET_VAL ADD CONSTRAINT FK_DATA_BUCKET_VAL_IND
	FOREIGN KEY (APP_SID, IND_SID)
	REFERENCES CSR.IND(APP_SID, IND_SID);

ALTER TABLE CSR.DATA_BUCKET_VAL ADD CONSTRAINT FK_DATA_BUCKET_VAL_REGION
	FOREIGN KEY (APP_SID, REGION_SID)
	REFERENCES CSR.REGION(APP_SID, REGION_SID);

ALTER TABLE CSR.DATA_BUCKET_SOURCE_DETAIL ADD CONSTRAINT DATA_BUCKET_SOURCE_DTL_INSTNC
	FOREIGN KEY (APP_SID, DATA_BUCKET_SID, DATA_BUCKET_INSTANCE_ID)
	REFERENCES CSR.DATA_BUCKET_INSTANCE(APP_SID, DATA_BUCKET_SID, DATA_BUCKET_INSTANCE_ID);

ALTER TABLE CSR.BATCH_JOB_DATA_BUCKET_AGG_IND ADD CONSTRAINT FK_BJ_DTA_BCKT_AGG_IND_JB_ID
	FOREIGN KEY (APP_SID, BATCH_JOB_ID)
	REFERENCES CSR.BATCH_JOB(APP_SID, BATCH_JOB_ID);

ALTER TABLE CSR.BATCH_JOB_DATA_BUCKET_AGG_IND ADD CONSTRAINT FK_BJ_DTA_BCKT_AGG_IND_BCKT_SID
	FOREIGN KEY (APP_SID, DATA_BUCKET_SID)
	REFERENCES CSR.DATA_BUCKET(APP_SID, DATA_BUCKET_SID);

ALTER TABLE CSR.BATCH_JOB_DATA_BUCKET_AGG_IND ADD CONSTRAINT FK_BJ_DTA_BCKT_AGG_IND_GRP_ID
	FOREIGN KEY (APP_SID, AGGREGATE_IND_GROUP_ID)
	REFERENCES CSR.AGGREGATE_IND_GROUP(APP_SID, AGGREGATE_IND_GROUP_ID);

ALTER TABLE CSR.AGG_IND_DATA_BUCKET_PENDING_JOB ADD CONSTRAINT FK_AGG_IND_DT_BCKT_PNDNG_JB_JOB
	FOREIGN KEY (APP_SID, BATCH_JOB_ID)
	REFERENCES CSR.BATCH_JOB(APP_SID, BATCH_JOB_ID);

ALTER TABLE CSR.AGG_IND_DATA_BUCKET_PENDING_JOB ADD CONSTRAINT FK_AGG_IND_DT_BCKT_PNDNG_JB_BCKET
	FOREIGN KEY (APP_SID, DATA_BUCKET_SID)
	REFERENCES CSR.DATA_BUCKET(APP_SID, DATA_BUCKET_SID);

ALTER TABLE CSR.AGGREGATE_IND_GROUP
ADD DATA_BUCKET_SID NUMBER(10, 0);

ALTER TABLE CSR.AGGREGATE_IND_GROUP ADD CONSTRAINT FK_AGGREGATE_IND_GRP_DATA_BCKT
	FOREIGN KEY (APP_SID, DATA_BUCKET_SID)
	REFERENCES CSR.DATA_BUCKET(APP_SID, DATA_BUCKET_SID);

CREATE UNIQUE INDEX CSR.IK_AGG_IND_GRP_DATA_BUCKET 
	ON CSR.AGGREGATE_IND_GROUP(APP_SID, NVL(DATA_BUCKET_SID, AGGREGATE_IND_GROUP_ID))
;

ALTER TABLE CSR.AGGREGATE_IND_GROUP
ADD DATA_BUCKET_FETCH_SP VARCHAR2(255);

ALTER TABLE CSR.AGGREGATE_IND_GROUP ADD CONSTRAINT CK_AGG_IND_GRP_FETCH_SP
	CHECK ((DATA_BUCKET_FETCH_SP IS NULL AND DATA_BUCKET_SID IS NULL) 
	   OR (DATA_BUCKET_FETCH_SP IS NOT NULL AND DATA_BUCKET_SID IS NOT NULL));

CREATE TABLE CSRIMP.DATA_BUCKET (
    CSRIMP_SESSION_ID              NUMBER(10)		 DEFAULT SYS_CONTEXT('SECURITY', 'CSRIMP_SESSION_ID') NOT NULL,
    DATA_BUCKET_SID                NUMBER(10, 0)		NOT NULL,
    DESCRIPTION                    VARCHAR2(1024)		NOT NULL,
    ENABLED                        NUMBER(1, 0)		DEFAULT 1 NOT NULL,
    ACTIVE_INSTANCE_ID             NUMBER(10, 0),
    CONSTRAINT CK_DATA_BUCKET_ENABLED CHECK (ENABLED IN (0,1)),
    CONSTRAINT PK_DATA_BUCKET PRIMARY KEY (CSRIMP_SESSION_ID, DATA_BUCKET_SID),
    CONSTRAINT FK_DATA_BUCKET_IS FOREIGN KEY
        (CSRIMP_SESSION_ID) REFERENCES CSRIMP.CSRIMP_SESSION (CSRIMP_SESSION_ID)
        ON DELETE CASCADE
);

ALTER TABLE CSRIMP.AGGREGATE_IND_GROUP
ADD DATA_BUCKET_SID NUMBER(10, 0);

ALTER TABLE CSRIMP.AGGREGATE_IND_GROUP
ADD DATA_BUCKET_FETCH_SP VARCHAR2(255);


create index csr.ix_aggregate_ind_data_bucket_s on csr.aggregate_ind_group (app_sid, data_bucket_sid);

create index csr.ix_agg_ind_data__batch_job_id on csr.agg_ind_data_bucket_pending_job (app_sid, batch_job_id);

create index csr.ix_batch_job_dat_aggregate_ind on csr.batch_job_data_bucket_agg_ind (app_sid, aggregate_ind_group_id);

create index csr.ix_batch_job_dat_data_bucket_s on csr.batch_job_data_bucket_agg_ind (app_sid, data_bucket_sid);

create index csr.ix_data_bucket_data_bucket_s on csr.data_bucket (app_sid, data_bucket_sid, active_instance_id);

create index csr.ix_data_bucket_s_data_bucket_s on csr.data_bucket_source_detail (app_sid, data_bucket_sid, data_bucket_instance_id);

create index csr.ix_data_bucket_v_ind_sid on csr.data_bucket_val (app_sid, ind_sid);

create index csr.ix_data_bucket_v_region_sid on csr.data_bucket_val (app_sid, region_sid);

create index csr.ix_data_bucket_v_data_bucket_s on csr.data_bucket_val (app_sid, data_bucket_sid, data_bucket_instance_id);

-- *** Grants ***

-- ** Cross schema constraints ***

-- *** Views ***
-- Please paste the content of the view.

-- *** Data changes ***
-- RLS

-- Data
DECLARE
	v_id		NUMBER(10);
BEGIN
	security.user_pkg.logonadmin;
	security.class_pkg.CreateClass(SYS_CONTEXT('SECURITY','ACT'), null, 'CSRDataBucket', 'csr.data_bucket_pkg', null, v_Id);
EXCEPTION
	WHEN security.security_pkg.DUPLICATE_OBJECT_NAME THEN
		NULL;
END;
/

INSERT INTO csr.batch_job_type (batch_job_type_id, description, sp, plugin_name, in_order, file_data_sp)
	VALUES (93, 'Data bucket aggregate ind group processor', NULL, 'data-bucket-agg-ind-processor', 1, NULL);

INSERT INTO csr.module (module_id, module_name, enable_sp, description)
	VALUES (110, 'Data buckets', 'EnableDataBuckets', 'Enable data buckets.');

-- ** New package grants **
CREATE OR REPLACE PACKAGE csr.data_bucket_pkg AS
	PROCEDURE DUMMY;
END;
/
CREATE OR REPLACE PACKAGE BODY csr.data_bucket_pkg AS
	PROCEDURE DUMMY
AS
	BEGIN
		NULL;
	END;
END;
/

GRANT EXECUTE ON csr.data_bucket_pkg TO security;
GRANT EXECUTE ON csr.data_bucket_pkg TO web_user;
GRANT EXECUTE ON csr.aggregate_ind_pkg TO web_user;

GRANT INSERT ON csr.data_bucket TO csrimp;
-- *** Conditional Packages ***

-- *** Packages ***
@../data_bucket_pkg
@../batch_job_pkg
@../aggregate_ind_pkg
@../schema_pkg
@../enable_pkg
@../calc_pkg

@../data_bucket_body
@../aggregate_ind_body
@../schema_body
@../csr_app_body
@../enable_body
@../calc_body

@../csrimp/imp_pkg
@../csrimp/imp_body


@update_tail
