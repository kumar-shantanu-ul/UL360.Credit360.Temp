define rap5_version=6
@update_header

-- drop all temp helper columns named "isnew"
BEGIN
	FOR r IN (
		SELECT ut.table_name
		  FROM user_tab_columns utc, user_tables ut 
		 WHERE utc.table_name = ut.table_name
		   AND NVL(ut.dropped, 'NO') = 'NO'
		   AND utc.column_name = 'ISNEW' 
	) LOOP
		EXECUTE IMMEDIATE 'alter table '||r.table_name||' drop column ISNEW';
	END LOOP;
END;
/


-- drop all component table constraints
BEGIN
	FOR r IN (
	  SELECT * 
	    FROM user_constraints 
	   WHERE constraint_type = 'R' 
	     AND table_name IN (
			'ALL_COMPONENT_TYPE',
			'COMPONENT',
			'COMPONENT_BIND',
			'COMPONENT_RELATIONSHIP',
			'COMPONENT_SOURCE',
			'COMPONENT_TYPE',
			'COMPONENT_TYPE_CONTAINMENT',
			'PRODUCT',
			'PRODUCT_CODE_TYPE',
			'PRODUCT_METRIC',
			'PRODUCT_METRIC_TYPE',
			'PURCHASED_COMPONENT',
			'UNINVITED_SUPPLIER'
		  )
	) LOOP
	  EXECUTE IMMEDIATE 'alter table '||r.table_name||' drop constraint '||r.constraint_name;
	END LOOP;
END;
/

-- now recreate them

-- 
-- TABLE: ALL_COMPONENT_TYPE 
--

ALTER TABLE ALL_COMPONENT_TYPE ADD CONSTRAINT FK_ALL_COMP_TYPE_CARDG 
    FOREIGN KEY (EDITOR_CARD_GROUP_ID)
    REFERENCES CARD_GROUP(CARD_GROUP_ID)
;

-- 
-- TABLE: COMPONENT 
--

ALTER TABLE COMPONENT ADD CONSTRAINT FK_COMPONENT_CHAIN_USER 
    FOREIGN KEY (APP_SID, CREATED_BY_SID)
    REFERENCES CHAIN_USER(APP_SID, USER_SID)
;

ALTER TABLE COMPONENT ADD CONSTRAINT FK_COMPONENT_COPT 
    FOREIGN KEY (APP_SID)
    REFERENCES CUSTOMER_OPTIONS(APP_SID)
;

-- 
-- TABLE: COMPONENT_BIND 
--

ALTER TABLE COMPONENT_BIND ADD CONSTRAINT RefCOMPONENT_TYPE578 
    FOREIGN KEY (APP_SID, COMPONENT_TYPE_ID)
    REFERENCES COMPONENT_TYPE(APP_SID, COMPONENT_TYPE_ID)
;

ALTER TABLE COMPONENT_BIND ADD CONSTRAINT RefCOMPONENT580 
    FOREIGN KEY (APP_SID, COMPONENT_ID)
    REFERENCES COMPONENT(APP_SID, COMPONENT_ID)
;

ALTER TABLE COMPONENT_BIND ADD CONSTRAINT FK_COMPONENT_BIND_COMPANY 
    FOREIGN KEY (APP_SID, COMPANY_SID)
    REFERENCES COMPANY(APP_SID, COMPANY_SID)
;


-- 
-- TABLE: COMPONENT_RELATIONSHIP 
--

ALTER TABLE COMPONENT_RELATIONSHIP ADD CONSTRAINT RefCOMPONENT_BIND581 
    FOREIGN KEY (APP_SID, CONTAINER_COMPONENT_ID, CONTAINER_COMPONENT_TYPE_ID, COMPANY_SID)
    REFERENCES COMPONENT_BIND(APP_SID, COMPONENT_ID, COMPONENT_TYPE_ID, COMPANY_SID)
;

ALTER TABLE COMPONENT_RELATIONSHIP ADD CONSTRAINT RefCOMPONENT_BIND582 
    FOREIGN KEY (APP_SID, CHILD_COMPONENT_ID, CHILD_COMPONENT_TYPE_ID, COMPANY_SID)
    REFERENCES COMPONENT_BIND(APP_SID, COMPONENT_ID, COMPONENT_TYPE_ID, COMPANY_SID)
;

ALTER TABLE COMPONENT_RELATIONSHIP ADD CONSTRAINT RefCOMPONENT_TYPE_CONTAINME583 
    FOREIGN KEY (APP_SID, CONTAINER_COMPONENT_TYPE_ID, CHILD_COMPONENT_TYPE_ID)
    REFERENCES COMPONENT_TYPE_CONTAINMENT(APP_SID, CONTAINER_COMPONENT_TYPE_ID, CHILD_COMPONENT_TYPE_ID)  DEFERRABLE INITIALLY DEFERRED
;


-- 
-- TABLE: COMPONENT_SOURCE 
--

ALTER TABLE COMPONENT_SOURCE ADD CONSTRAINT RefCOMPONENT_TYPE528 
    FOREIGN KEY (APP_SID, COMPONENT_TYPE_ID)
    REFERENCES COMPONENT_TYPE(APP_SID, COMPONENT_TYPE_ID)
;

ALTER TABLE COMPONENT_SOURCE ADD CONSTRAINT FK_COMPONENT_SOUCE_CARDG 
    FOREIGN KEY (CARD_GROUP_ID)
    REFERENCES CARD_GROUP(CARD_GROUP_ID)
;


-- 
-- TABLE: COMPONENT_TYPE 
--

ALTER TABLE COMPONENT_TYPE ADD CONSTRAINT RefALL_COMPONENT_TYPE584 
    FOREIGN KEY (COMPONENT_TYPE_ID)
    REFERENCES ALL_COMPONENT_TYPE(COMPONENT_TYPE_ID)
;

ALTER TABLE COMPONENT_TYPE ADD CONSTRAINT FK_COMPONENT_TYPE_COPT 
    FOREIGN KEY (APP_SID)
    REFERENCES CUSTOMER_OPTIONS(APP_SID)
;


-- 
-- TABLE: COMPONENT_TYPE_CONTAINMENT 
--

ALTER TABLE COMPONENT_TYPE_CONTAINMENT ADD CONSTRAINT RefCOMPONENT_TYPE532 
    FOREIGN KEY (APP_SID, CONTAINER_COMPONENT_TYPE_ID)
    REFERENCES COMPONENT_TYPE(APP_SID, COMPONENT_TYPE_ID)
;

ALTER TABLE COMPONENT_TYPE_CONTAINMENT ADD CONSTRAINT RefCOMPONENT_TYPE533 
    FOREIGN KEY (APP_SID, CHILD_COMPONENT_TYPE_ID)
    REFERENCES COMPONENT_TYPE(APP_SID, COMPONENT_TYPE_ID)
;

-- 
-- TABLE: PRODUCT 
--

ALTER TABLE PRODUCT ADD CONSTRAINT RefCOMPONENT_BIND585 
    FOREIGN KEY (APP_SID, PRODUCT_ID, COMPONENT_TYPE_ID, COMPANY_SID)
    REFERENCES COMPONENT_BIND(APP_SID, COMPONENT_ID, COMPONENT_TYPE_ID, COMPANY_SID)
;

ALTER TABLE PRODUCT ADD CONSTRAINT RefCOMPONENT515 
    FOREIGN KEY (APP_SID, PSEUDO_ROOT_COMPONENT_ID)
    REFERENCES COMPONENT(APP_SID, COMPONENT_ID)
;

ALTER TABLE PRODUCT ADD CONSTRAINT RefCOMPONENT539 
    FOREIGN KEY (APP_SID, PRODUCT_ID)
    REFERENCES COMPONENT(APP_SID, COMPONENT_ID)
;


-- 
-- TABLE: PRODUCT_CODE_TYPE 
--

ALTER TABLE PRODUCT_CODE_TYPE ADD CONSTRAINT FK_PRODUCT_CODE_TYPE_COMPANY 
    FOREIGN KEY (APP_SID, COMPANY_SID)
    REFERENCES COMPANY(APP_SID, COMPANY_SID)
;


-- 
-- TABLE: PRODUCT_METRIC 
--

ALTER TABLE PRODUCT_METRIC ADD CONSTRAINT RefPRODUCT_METRIC_TYPE436 
    FOREIGN KEY (APP_SID, PRODUCT_METRIC_TYPE_ID)
    REFERENCES PRODUCT_METRIC_TYPE(APP_SID, PRODUCT_METRIC_TYPE_ID)
;

ALTER TABLE PRODUCT_METRIC ADD CONSTRAINT RefPRODUCT516 
    FOREIGN KEY (APP_SID, PRODUCT_ID)
    REFERENCES PRODUCT(APP_SID, PRODUCT_ID)
;


-- 
-- TABLE: PRODUCT_METRIC_TYPE 
--

ALTER TABLE PRODUCT_METRIC_TYPE ADD CONSTRAINT RefCUSTOMER_OPTIONS438 
    FOREIGN KEY (APP_SID)
    REFERENCES CUSTOMER_OPTIONS(APP_SID)
;


-- 
-- TABLE: PURCHASED_COMPONENT 
--

ALTER TABLE PURCHASED_COMPONENT ADD CONSTRAINT RefCOMPONENT_BIND586 
    FOREIGN KEY (APP_SID, COMPONENT_ID, COMPONENT_TYPE_ID, COMPANY_SID)
    REFERENCES COMPONENT_BIND(APP_SID, COMPONENT_ID, COMPONENT_TYPE_ID, COMPANY_SID)
;

ALTER TABLE PURCHASED_COMPONENT ADD CONSTRAINT RefCOMPONENT_SUPPLIER_TYPE587 
    FOREIGN KEY (COMPONENT_SUPPLIER_TYPE_ID)
    REFERENCES COMPONENT_SUPPLIER_TYPE(COMPONENT_SUPPLIER_TYPE_ID)
;

ALTER TABLE PURCHASED_COMPONENT ADD CONSTRAINT RefACCEPTANCE_STATUS588 
    FOREIGN KEY (ACCEPTANCE_STATUS_ID)
    REFERENCES ACCEPTANCE_STATUS(ACCEPTANCE_STATUS_ID)
;

ALTER TABLE PURCHASED_COMPONENT ADD CONSTRAINT RefUNINVITED_SUPPLIER589 
    FOREIGN KEY (APP_SID, COMPANY_SID, UNINVITED_SUPPLIER_SID)
    REFERENCES UNINVITED_SUPPLIER(APP_SID, COMPANY_SID, UNINVITED_SUPPLIER_SID)
;

ALTER TABLE PURCHASED_COMPONENT ADD CONSTRAINT RefPRODUCT590 
    FOREIGN KEY (APP_SID, SUPPLIER_PRODUCT_ID)
    REFERENCES PRODUCT(APP_SID, PRODUCT_ID)
;

ALTER TABLE PURCHASED_COMPONENT ADD CONSTRAINT RefCOMPONENT593 
    FOREIGN KEY (APP_SID, COMPONENT_ID)
    REFERENCES COMPONENT(APP_SID, COMPONENT_ID)
;

ALTER TABLE PURCHASED_COMPONENT ADD CONSTRAINT FK_PURCH_COMP_SUPP_REL_1 
    FOREIGN KEY (APP_SID, PURCHASER_COMPANY_SID, COMPANY_SID)
    REFERENCES SUPPLIER_RELATIONSHIP(APP_SID, PURCHASER_COMPANY_SID, SUPPLIER_COMPANY_SID)
;

ALTER TABLE PURCHASED_COMPONENT ADD CONSTRAINT FK_PURCH_COMP_SUPP_REL_2 
    FOREIGN KEY (APP_SID, COMPANY_SID, SUPPLIER_COMPANY_SID)
    REFERENCES SUPPLIER_RELATIONSHIP(APP_SID, PURCHASER_COMPANY_SID, SUPPLIER_COMPANY_SID)
;

-- 
-- TABLE: UNINVITED_SUPPLIER 
--

ALTER TABLE UNINVITED_SUPPLIER ADD CONSTRAINT RefCOMPANY616 
    FOREIGN KEY (APP_SID, CREATED_AS_COMPANY_SID)
    REFERENCES COMPANY(APP_SID, COMPANY_SID)
;

ALTER TABLE UNINVITED_SUPPLIER ADD CONSTRAINT FK_UNINVITED_SUPPLIER_COMPANY 
    FOREIGN KEY (APP_SID, COMPANY_SID)
    REFERENCES COMPANY(APP_SID, COMPANY_SID)
;

ALTER TABLE UNINVITED_SUPPLIER ADD CONSTRAINT FK_UNINVITED_SUPPLIER_COUNTRY 
    FOREIGN KEY (COUNTRY_CODE)
    REFERENCES POSTCODE.COUNTRY(COUNTRY)
;

@..\..\rls

@update_tail