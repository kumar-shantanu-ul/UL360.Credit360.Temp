define version=89
@update_header

-- drop dead constraints
ALTER TABLE chain.TASK DROP CONSTRAINT RefTASK_NODE133;
ALTER TABLE chain.TASK DROP CONSTRAINT RefCOMPANY174; 
ALTER TABLE chain.TASK DROP CONSTRAINT RefQUESTIONNAIRE175; 
ALTER TABLE chain.TASK DROP CONSTRAINT RefACTION176; 
ALTER TABLE chain.TASK_DOC DROP CONSTRAINT RefDOC_VERSION134;
ALTER TABLE chain.TASK_DOC DROP CONSTRAINT RefTASK_ENTRY135;
ALTER TABLE chain.TASK_ENTRY DROP CONSTRAINT RefTASK_ENTRY_TYPE136;
ALTER TABLE chain.TASK_ENTRY DROP CONSTRAINT RefCUSTOMER_OPTIONS137;
ALTER TABLE chain.TASK_NODE DROP CONSTRAINT RefCUSTOMER_OPTIONS142; 
ALTER TABLE chain.TASK_NODE DROP CONSTRAINT RefTASK_NODE143; 
ALTER TABLE chain.TASK_NODE DROP CONSTRAINT RefCOMPANY184; 
ALTER TABLE chain.TASK_NODE DROP CONSTRAINT RefTASK_NODE_TYPE242; 
ALTER TABLE chain.TASK_USER_RESPONSIBLE DROP CONSTRAINT RefTASK145;
ALTER TABLE chain.TASK_USER_RESPONSIBLE DROP CONSTRAINT RefCHAIN_USER526;

-- create new tables
CREATE TABLE chain.TASK_FILE(
    APP_SID            NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY', 'APP') NOT NULL,
    TASK_ID            NUMBER(10, 0)    NOT NULL,
    FILE_UPLOAD_SID    NUMBER(10, 0)    NOT NULL,
    CONSTRAINT PK325 PRIMARY KEY (APP_SID, TASK_ID, FILE_UPLOAD_SID)
);

-- drop dead columns
ALTER TABLE chain.FILE_UPLOAD DROP COLUMN BYTES;

ALTER TABLE chain.TASK_NODE DROP COLUMN COMPANY_SID;
ALTER TABLE chain.TASK_NODE DROP COLUMN HEADING;
ALTER TABLE chain.TASK_NODE DROP COLUMN DESCRIPTION;

ALTER TABLE chain.TASK DROP COLUMN QUESTIONNAIRE_ID;
ALTER TABLE chain.TASK DROP COLUMN ACTION_ID;
ALTER TABLE chain.TASK DROP COLUMN HEADING;
ALTER TABLE chain.TASK DROP COLUMN DESCRIPTION;

-- muck about with companies
ALTER TABLE chain.TASK RENAME COLUMN COMPANY_SID TO SUPPLIER_COMPANY_SID;
ALTER TABLE chain.TASK ADD (OWNER_COMPANY_SID NUMBER(10));
ALTER TABLE chain.TASK ADD (TASK_NODE_TYPE_ID NUMBER(10));

ALTER TABLE chain.TASK_TYPE ADD (MANDATORY NUMBER(1, 0) DEFAULT 0 NOT NULL);
ALTER TABLE chain.TASK_TYPE ADD (DUE_DATE_EDITABLE NUMBER(1, 0) DEFAULT 1 NOT NULL);
ALTER TABLE chain.TASK_TYPE ADD (REVIEW_EVERY_N_DAYS NUMBER(10, 0));
ALTER TABLE chain.TASK_TYPE ADD (TASK_NODE_TYPE_ID NUMBER(10, 0));

-- fixup data
UPDATE chain.task t
   SET owner_company_sid = (
		SELECT top_company_sid 
		  FROM chain.customer_options co
		 WHERE t.app_sid = co.app_sid
	);

UPDATE chain.task t
   SET task_node_type_id = (
   		SELECT task_node_type_id
   		  FROM chain.task_node tn
   		 WHERE tn.app_sid = t.app_sid
   		   AND tn.task_node_id = t.task_node_id
   );

UPDATE chain.task_type tt
   SET (mandatory, due_date_editable, review_every_n_days) = (
   		SELECT mandatory, due_date_editable, review_every_n_days
   		  FROM (
   		  		SELECT UNIQUE app_sid, task_type_id, mandatory, due_date_editable, review_every_n_days
   		  		  FROM chain.task
   		  		) t
   		 WHERE t.app_sid = tt.app_sid
   		   AND t.task_type_id = tt.task_type_id
   	)
 WHERE (tt.app_sid, tt.task_type_id) IN (SELECT app_sid, task_type_id FROM chain.task);
 
UPDATE chain.task_type tt
   SET task_node_type_id = (
    	SELECT task_node_type_id
    	  FROM (SELECT UNIQUE app_sid, task_node_type_id FROM chain.task) t
    	 WHERE t.app_sid = tt.app_sid
    );

commit;

-- no idea if this is right   
UPDATE chain.task set owner_company_sid = supplier_company_sid where owner_company_sid is null;
-- fix up not nullable
ALTER TABLE chain.TASK MODIFY OWNER_COMPANY_SID NOT NULL;
ALTER TABLE chain.TASK MODIFY CREATED_DTM DEFAULT SYSDATE;
ALTER TABLE chain.TASK MODIFY CREATED_BY_SID DEFAULT SYS_CONTEXT('SECURITY','SID');

-- fk will prevent this if there are tasks attached - this only seems to come up on 
-- dev systems where things have been cleaned.
delete from task_type where TASK_NODE_TYPE_ID is null;

ALTER TABLE chain.TASK_TYPE MODIFY TASK_NODE_TYPE_ID NOT NULL;

ALTER TABLE chain.TASK DROP COLUMN TASK_NODE_ID;
ALTER TABLE chain.TASK DROP COLUMN MANDATORY;
ALTER TABLE chain.TASK DROP COLUMN DUE_DATE_EDITABLE;
ALTER TABLE chain.TASK DROP COLUMN REVIEW_EVERY_N_DAYS;
ALTER TABLE chain.TASK DROP COLUMN TASK_NODE_TYPE_ID;

-- drop dead tables
DROP TABLE chain.TASK_DOC;
DROP TABLE chain.TASK_NODE;
DROP TABLE chain.TASK_ENTRY;
DROP TABLE chain.TASK_ENTRY_TYPE;
DROP TABLE chain.TASK_USER_RESPONSIBLE;
DROP SEQUENCE TASK_NODE_ID_SEQ;

-- add new constraints
ALTER TABLE chain.TASK ADD CONSTRAINT RefSUPPLIER_RELATIONSHIP809 
    FOREIGN KEY (APP_SID, OWNER_COMPANY_SID, SUPPLIER_COMPANY_SID)
    REFERENCES chain.SUPPLIER_RELATIONSHIP(APP_SID, PURCHASER_COMPANY_SID, SUPPLIER_COMPANY_SID)
;

ALTER TABLE chain.TASK_TYPE ADD CONSTRAINT RefTASK_NODE_TYPE815 
    FOREIGN KEY (APP_SID, TASK_NODE_TYPE_ID)
    REFERENCES chain.TASK_NODE_TYPE(APP_SID, TASK_NODE_TYPE_ID)
;

ALTER TABLE chain.TASK_FILE ADD CONSTRAINT RefFILE_UPLOAD810 
    FOREIGN KEY (APP_SID, FILE_UPLOAD_SID)
    REFERENCES chain.FILE_UPLOAD(APP_SID, FILE_UPLOAD_SID)
;

ALTER TABLE chain.TASK_FILE ADD CONSTRAINT RefTASK811 
    FOREIGN KEY (APP_SID, TASK_ID)
    REFERENCES chain.TASK(APP_SID, TASK_ID)
;

-- rename task_node_type to task_scheme
ALTER TABLE chain.TASK_NODE_TYPE DROP CONSTRAINT RefCUSTOMER_OPTIONS247;
ALTER TABLE chain.TASK_TYPE DROP CONSTRAINT RefTASK_NODE_TYPE815;

ALTER TABLE chain.TASK_TYPE RENAME COLUMN TASK_NODE_TYPE_ID TO TASK_SCHEME_ID;
ALTER TABLE chain.TASK_NODE_TYPE RENAME COLUMN TASK_NODE_TYPE_ID TO TASK_SCHEME_ID;
ALTER TABLE chain.TASK_NODE_TYPE RENAME TO TASK_SCHEME;

ALTER TABLE chain.TASK_SCHEME ADD CONSTRAINT RefCUSTOMER_OPTIONS816 
    FOREIGN KEY (APP_SID)
    REFERENCES chain.CUSTOMER_OPTIONS(APP_SID)
;

ALTER TABLE chain.TASK_TYPE ADD CONSTRAINT RefTASK_SCHEME817 
    FOREIGN KEY (APP_SID, TASK_SCHEME_ID)
    REFERENCES chain.TASK_SCHEME(APP_SID, TASK_SCHEME_ID)
;

@..\rls
@..\task_pkg
@..\task_body
@..\company_body
@..\upload_body

@update_tail

