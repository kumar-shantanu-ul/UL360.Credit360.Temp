define version=119
@update_header


CREATE SEQUENCE chain.FILTER_ID_SEQ
    START WITH 1
    INCREMENT BY 1
    NOMINVALUE
    NOMAXVALUE
    CACHE 20
    NOORDER;

CREATE SEQUENCE chain.FILTER_TYPE_ID_SEQ
    START WITH 1
    INCREMENT BY 1
    NOMINVALUE
    NOMAXVALUE
    CACHE 20
    NOORDER;


CREATE TABLE chain.COMPANY_FILTER(
    APP_SID      NUMBER(10, 0)    NOT NULL,
    FILTER_ID    NUMBER(10, 0)    NOT NULL,
    CONSTRAINT PK_COMPANY_FILTER PRIMARY KEY (APP_SID, FILTER_ID)
);


CREATE TABLE chain.COMPOUND_FILTER(
    COMPOUND_FILTER_SID    NUMBER(10, 0)    NOT NULL,
    APP_SID                NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY', 'APP') NOT NULL,
    NAME                   VARCHAR2(255),
    OPERATOR_TYPE          VARCHAR2(8)      NOT NULL,
    CREATED_DTM            DATE             DEFAULT SYSDATE NOT NULL,
    CREATED_BY_SID         NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY','SID') NOT NULL,
    CONSTRAINT CHK_COMP_FIL_OP_TYPE CHECK (OPERATOR_TYPE IN ('and','or')),
    CONSTRAINT PK_COMPOUND_FILTER PRIMARY KEY (COMPOUND_FILTER_SID)
);

CREATE TABLE chain.CUSTOMER_FILTER_TYPE(
    APP_SID           NUMBER(10, 0)    DEFAULT SYS_CONTEXT('SECURITY', 'APP') NOT NULL,
    FILTER_TYPE_ID    NUMBER(10, 0)    NOT NULL,
    CONSTRAINT PK_CUSTOMER_FILTER_TYPE PRIMARY KEY (APP_SID, FILTER_TYPE_ID)
);


CREATE TABLE chain.FILTER(
    FILTER_ID              NUMBER(10, 0)    NOT NULL,
    APP_SID                NUMBER(10, 0)    NOT NULL,
    FILTER_TYPE_ID         NUMBER(10, 0)    NOT NULL,
    COMPOUND_FILTER_SID    NUMBER(10, 0)    NOT NULL,
    CONSTRAINT PK_FILTER_ID PRIMARY KEY (FILTER_ID, APP_SID)
);

CREATE TABLE chain.FILTER_TYPE(
    FILTER_TYPE_ID    NUMBER(10, 0)    NOT NULL,
    HELPER_PKG        VARCHAR2(255)    NOT NULL,
    JS_INCLUDE        VARCHAR2(255)    NOT NULL,
    JS_CLASS_TYPE     VARCHAR2(255),
    CONSTRAINT PK_FILTER_TYPE PRIMARY KEY (FILTER_TYPE_ID)
);

ALTER TABLE chain.COMPANY_FILTER ADD CONSTRAINT FK_CUS_OPT_COMP_FIL 
    FOREIGN KEY (APP_SID)
    REFERENCES chain.CUSTOMER_OPTIONS(APP_SID);

ALTER TABLE chain.COMPANY_FILTER ADD CONSTRAINT FK_FILTER_COMP_FILTER 
    FOREIGN KEY (FILTER_ID, APP_SID)
    REFERENCES chain.FILTER(FILTER_ID, APP_SID) ON DELETE CASCADE;

ALTER TABLE chain.COMPOUND_FILTER ADD CONSTRAINT FK_USER_COMP_FILTER 
    FOREIGN KEY (APP_SID, CREATED_BY_SID)
    REFERENCES csr.CSR_USER(APP_SID, CSR_USER_SID);

ALTER TABLE chain.CUSTOMER_FILTER_TYPE ADD CONSTRAINT FK_CUS_OPT_CUS_FIL_TYPE 
    FOREIGN KEY (APP_SID)
    REFERENCES chain.CUSTOMER_OPTIONS(APP_SID);

ALTER TABLE chain.CUSTOMER_FILTER_TYPE ADD CONSTRAINT FK_FIL_TYPE_CUS_FIL_TYPE 
    FOREIGN KEY (FILTER_TYPE_ID)
    REFERENCES chain.FILTER_TYPE(FILTER_TYPE_ID);


@update_tail
